<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkAnisotropicRegistrationCommon.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include &lt;mitkAnisotropicRegistrationCommon.h&gt;
#include &lt;mitkPointSet.h&gt;
#include &lt;vtkPoints.h&gt;

mitk::AnisotropicRegistrationCommon::WeightMatrix mitk::AnisotropicRegistrationCommon::CalculateWeightMatrix(
  const CovarianceMatrix &amp;sigma_X, const CovarianceMatrix &amp;sigma_Y)
<span style = "background-color:#fdd">{
  WeightMatrix returnValue;</span>

<span style = "background-color:#fdd">  WeightMatrix sum = sigma_X + sigma_Y;
  vnl_svd&lt;double&gt; svd(sum.GetVnlMatrix().as_ref());</span>

<span style = "background-color:#fdd">  WeightMatrix diag;
  diag.Fill(0.0);
  diag[0][0] = 1.0 / sqrt(svd.W(0));
  diag[1][1] = 1.0 / sqrt(svd.W(1));
  diag[2][2] = 1.0 / sqrt(svd.W(2));</span>

<span style = "background-color:#fdd">  WeightMatrix V; // convert vnl matrix to itk matrix...
  for (unsigned int i = 0; i &lt; 3; ++i)
    for (unsigned int j = 0; j &lt; 3; ++j)
      V[i][j] = svd.V()[i][j];</span>

  // add weighting matrix for point j1 (corresponding to identity transform)
<span style = "background-color:#fdd">  returnValue = V * diag * V.GetTranspose();</span>

<span style = "background-color:#fdd">  return returnValue;
}</span>

void mitk::AnisotropicRegistrationCommon::TransformPoints(vtkPoints *src,
                                                          vtkPoints *dst,
                                                          const Rotation &amp;rotation,
                                                          const Translation &amp;translation)
<span style = "background-color:#fdd">{
#pragma omp parallel for
  for (int i = 0; i &lt; src-&gt;GetNumberOfPoints(); ++i)</span>
  {
    double p_in[3];
    double p_out[3];
<span style = "background-color:#fdd">    src-&gt;GetPoint(i, p_in);</span>

<span style = "background-color:#fdd">    for (unsigned int j = 0; j &lt; 3; ++j)</span>
    {
<span style = "background-color:#fdd">      p_out[j] = p_in[0] * rotation[j][0] + p_in[1] * rotation[j][1] + p_in[2] * rotation[j][2] + translation[j];
    }</span>

<span style = "background-color:#fdd">    dst-&gt;SetPoint(i, p_out);
  }
}</span>

void mitk::AnisotropicRegistrationCommon::PropagateMatrices(const MatrixList &amp;src,
                                                            MatrixList &amp;dst,
                                                            const Rotation &amp;rotation)
<span style = "background-color:#fdd">{
  const vnl_matrix_fixed&lt;double, 3, 3&gt; rotationT = rotation.GetTranspose();</span>

<span style = "background-color:#fdd">#pragma omp parallel for
  for (int i = 0; i &lt; static_cast&lt;int&gt;(src.size()); ++i)</span>
  {
<span style = "background-color:#fdd">    dst[i] = rotation * src[i] * rotationT;
  }
}</span>

double mitk::AnisotropicRegistrationCommon::ComputeTargetRegistrationError(const mitk::PointSet *movingTargets,
                                                                           const mitk::PointSet *fixedTargets,
                                                                           const Rotation &amp;rotation,
                                                                           const Translation &amp;translation)
<span style = "background-color:#fdd">{
  double tre = 0.0;</span>

<span style = "background-color:#fdd">  for (int i = 0; i &lt; movingTargets-&gt;GetSize(); ++i)</span>
  {
<span style = "background-color:#fdd">    mitk::Point3D pm = movingTargets-&gt;GetPoint(i);
    mitk::Point3D ps = fixedTargets-&gt;GetPoint(i);</span>

    // transform point
<span style = "background-color:#fdd">    pm = rotation * pm + translation;</span>

<span style = "background-color:#fdd">    const double dist =</span>
      (ps[0] - pm[0]) * (ps[0] - pm[0]) + (ps[1] - pm[1]) * (ps[1] - pm[1]) + (ps[2] - pm[2]) * (ps[2] - pm[2]);

<span style = "background-color:#fdd">    tre += dist;
  }</span>

<span style = "background-color:#fdd">  tre /= movingTargets-&gt;GetSize();</span>

<span style = "background-color:#fdd">  return sqrt(tre);
}</span></pre>
	</body>
</html>
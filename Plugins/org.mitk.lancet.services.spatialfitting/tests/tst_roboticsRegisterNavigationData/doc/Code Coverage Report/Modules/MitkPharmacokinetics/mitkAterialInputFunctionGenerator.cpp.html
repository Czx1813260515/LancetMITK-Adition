<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkAterialInputFunctionGenerator.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkAterialInputFunctionGenerator.h"

#include "mitkMaskedDynamicImageStatisticsGenerator.h"
#include "mitkImageTimeSelector.h"
#include "mitkImageCast.h"
#include "itkArray2D.h"
#include "mitkImageAccessByItk.h"
#include "mitkExtractTimeGrid.h"
#include "mitkAIFBasedModelBase.h"
#include "mitkImageCast.h"

#include &lt;iostream&gt;
#include &lt;fstream&gt;

const double mitk::AterialInputFunctionGenerator::DEFAULT_HEMATOCRIT_LEVEL = 0.45;

mitk::AIFBasedModelBase::AterialInputFunctionType  mitk::AterialInputFunctionGenerator::GetAterialInputFunction()
<span style = "background-color:#fdd">{
    if(this-&gt;HasOutdatedResults())</span>
    {
<span style = "background-color:#fdd">        CheckValidInputs();
        CalculateAIFAndGetResult();</span>
    }
<span style = "background-color:#fdd">    return this-&gt;m_AIFValues;</span>

<span style = "background-color:#fdd">}</span>

mitk::ModelBase::TimeGridType mitk::AterialInputFunctionGenerator::GetAterialInputFunctionTimeGrid()
<span style = "background-color:#fdd">{
    if(this-&gt;HasOutdatedResults()){
        CheckValidInputs();
        CalculateAIFAndGetResult();</span>
    }
<span style = "background-color:#fdd">    return this-&gt;m_AIFTimeGrid;</span>

<span style = "background-color:#fdd">}</span>




void mitk::AterialInputFunctionGenerator::CalculateAIFAndGetResult()
<span style = "background-color:#fdd">{</span>

<span style = "background-color:#fdd">   mitk::MaskedDynamicImageStatisticsGenerator::Pointer signalGenerator = mitk::MaskedDynamicImageStatisticsGenerator::New();</span>



<span style = "background-color:#fdd">    m_AIFValues.SetSize(this-&gt;m_DynamicImage-&gt;GetTimeSteps());
    m_AIFValues.Fill(0.);
    m_AIFTimeGrid.SetSize(this-&gt;m_DynamicImage-&gt;GetTimeSteps());
    m_AIFTimeGrid.Fill(0.);</span>


    // = not defined for array???
<span style = "background-color:#fdd">    mitk::ModelBase::TimeGridType timeGrid = ExtractTimeGrid(m_DynamicImage);
    m_AIFTimeGrid = timeGrid;</span>


<span style = "background-color:#fdd">    signalGenerator-&gt;SetDynamicImage(m_DynamicImage);
    signalGenerator-&gt;SetMask(m_Mask);
    signalGenerator-&gt;Generate();</span>


    //Convert from aterial curve Ca to Plasma curve Cp
  //  m_AIFValues = signalGenerator-&gt;GetMean()/(1-this-&gt;m_HCL);
<span style = "background-color:#fdd">    mitk::MaskedDynamicImageStatisticsGenerator::ResultType temp = signalGenerator-&gt;GetMean();</span>


<span style = "background-color:#fdd">    mitk::AIFBasedModelBase::AterialInputFunctionType::iterator aif = this-&gt;m_AIFValues.begin();
    for( mitk::MaskedDynamicImageStatisticsGenerator::ResultType::const_iterator pos = temp.begin(); pos != temp.end(); ++pos, ++aif)</span>
    {
<span style = "background-color:#fdd">        *aif = *pos /(1-this-&gt;m_HCL);</span>

<span style = "background-color:#fdd">    }</span>


<span style = "background-color:#fdd">    this-&gt;m_GenerationTimeStamp.Modified();</span>

<span style = "background-color:#fdd">}</span>



void
  mitk::AterialInputFunctionGenerator::CheckValidInputs() const
<span style = "background-color:#fdd">{</span>

<span style = "background-color:#fdd">  if (m_DynamicImage.IsNull())</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cannot generate Aterial Input Function. Input dynamic image is not set.";</span>
  }
<span style = "background-color:#fdd">  if (m_Mask.IsNull())</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cannot generate Aterial Input Function. ROI is not set.";</span>
  }
<span style = "background-color:#fdd">}</span>

bool mitk::AterialInputFunctionGenerator::HasOutdatedResults()
<span style = "background-color:#fdd">{
    bool result = false;</span>

<span style = "background-color:#fdd">    if (m_DynamicImage.IsNull())</span>
    {
<span style = "background-color:#fdd">        result = true;
    }</span>
    else
    {
<span style = "background-color:#fdd">        if (m_DynamicImage-&gt;GetMTime() &gt; this-&gt;m_GenerationTimeStamp)</span>
    {
<span style = "background-color:#fdd">    result = true;</span>
    }
    }

<span style = "background-color:#fdd">    if (m_Mask.IsNull())</span>
    {
<span style = "background-color:#fdd">        result = true;
    }</span>
    else
    {
<span style = "background-color:#fdd">        if (m_Mask-&gt;GetMTime() &gt; this-&gt;m_GenerationTimeStamp)</span>
        {
<span style = "background-color:#fdd">            result = true;</span>
        }
    }
<span style = "background-color:#fdd">    return result;
};</span></pre>
	</body>
</html>
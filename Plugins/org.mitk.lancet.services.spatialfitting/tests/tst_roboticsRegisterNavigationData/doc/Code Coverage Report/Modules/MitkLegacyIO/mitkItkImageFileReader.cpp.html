<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkItkImageFileReader.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkItkImageFileReader.h"
#include "mitkConfig.h"
#include "mitkException.h"
#include &lt;mitkLocaleSwitch.h&gt;
#include &lt;mitkProportionalTimeGeometry.h&gt;

#include &lt;itkImage.h&gt;
#include &lt;itkImageFileReader.h&gt;
#include &lt;itksys/Directory.hxx&gt;
#include &lt;itksys/SystemTools.hxx&gt;
//#include &lt;itkImageSeriesReader.h&gt;
#include &lt;itkImageFileReader.h&gt;
#include &lt;itkImageIOFactory.h&gt;
#include &lt;itkImageIORegion.h&gt;
#include &lt;itkMetaDataObject.h&gt;
//#include &lt;itkImageSeriesReader.h&gt;
//#include &lt;itkDICOMImageIO2.h&gt;
//#include &lt;itkDICOMSeriesFileNames.h&gt;
//#include &lt;itkGDCMImageIO.h&gt;
//#include &lt;itkGDCMSeriesFileNames.h&gt;
//#include &lt;itkNumericSeriesFileNames.h&gt;

void mitk::ItkImageFileReader::GenerateData()
<span style = "background-color:#fdd">{
  mitk::LocaleSwitch localeSwitch("C");
  mitk::Image::Pointer image = this-&gt;GetOutput();</span>

<span style = "background-color:#fdd">  const unsigned int MINDIM = 2;
  const unsigned int MAXDIM = 4;</span>

<span style = "background-color:#fdd">  MITK_INFO("mitkItkImageFileReader") &lt;&lt; "loading " &lt;&lt; m_FileName &lt;&lt; " via itk::ImageIOFactory... " &lt;&lt; std::endl;</span>

  // Check to see if we can read the file given the name or prefix
<span style = "background-color:#fdd">  if (m_FileName == "")</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Empty filename in mitk::ItkImageFileReader ";
    return;</span>
  }

<span style = "background-color:#fdd">  itk::ImageIOBase::Pointer imageIO =</span>
    itk::ImageIOFactory::CreateImageIO(m_FileName.c_str(), itk::IOFileModeEnum::ReadMode);
<span style = "background-color:#fdd">  if (imageIO.IsNull())</span>
  {
    // itkWarningMacro( &lt;&lt; "File Type not supported!" );
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Could not create itk::ImageIOBase object for filename " &lt;&lt; m_FileName;
    return;</span>
  }

  // Got to allocate space for the image. Determine the characteristics of
  // the image.
<span style = "background-color:#fdd">  imageIO-&gt;SetFileName(m_FileName.c_str());
  imageIO-&gt;ReadImageInformation();</span>

<span style = "background-color:#fdd">  unsigned int ndim = imageIO-&gt;GetNumberOfDimensions();
  if (ndim &lt; MINDIM || ndim &gt; MAXDIM)</span>
  {
<span style = "background-color:#fdd">    itkWarningMacro(&lt;&lt; "Sorry, only dimensions 2, 3 and 4 are supported. The given file has " &lt;&lt; ndim</span>
                    &lt;&lt; " dimensions! Reading as 4D.");
<span style = "background-color:#fdd">    ndim = MAXDIM;</span>
  }

<span style = "background-color:#fdd">  itk::ImageIORegion ioRegion(ndim);
  itk::ImageIORegion::SizeType ioSize = ioRegion.GetSize();
  itk::ImageIORegion::IndexType ioStart = ioRegion.GetIndex();</span>

  unsigned int dimensions[MAXDIM];
<span style = "background-color:#fdd">  dimensions[0] = 0;
  dimensions[1] = 0;
  dimensions[2] = 0;
  dimensions[3] = 0;</span>

  ScalarType spacing[MAXDIM];
<span style = "background-color:#fdd">  spacing[0] = 1.0f;
  spacing[1] = 1.0f;
  spacing[2] = 1.0f;
  spacing[3] = 1.0f;</span>

<span style = "background-color:#fdd">  Point3D origin;
  origin.Fill(0);</span>

  unsigned int i;
<span style = "background-color:#fdd">  for (i = 0; i &lt; ndim; ++i)</span>
  {
<span style = "background-color:#fdd">    ioStart[i] = 0;
    ioSize[i] = imageIO-&gt;GetDimensions(i);
    if (i &lt; MAXDIM)</span>
    {
<span style = "background-color:#fdd">      dimensions[i] = imageIO-&gt;GetDimensions(i);
      spacing[i] = imageIO-&gt;GetSpacing(i);
      if (spacing[i] &lt;= 0)
        spacing[i] = 1.0f;</span>
    }
<span style = "background-color:#fdd">    if (i &lt; 3)</span>
    {
<span style = "background-color:#fdd">      origin[i] = imageIO-&gt;GetOrigin(i);</span>
    }
<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  ioRegion.SetSize(ioSize);
  ioRegion.SetIndex(ioStart);</span>

<span style = "background-color:#fdd">  MITK_INFO("mitkItkImageFileReader") &lt;&lt; "ioRegion: " &lt;&lt; ioRegion &lt;&lt; std::endl;
  imageIO-&gt;SetIORegion(ioRegion);
  void *buffer = new unsigned char[imageIO-&gt;GetImageSizeInBytes()];
  imageIO-&gt;Read(buffer);</span>

<span style = "background-color:#fdd">  image-&gt;Initialize(MakePixelType(imageIO), ndim, dimensions);
  image-&gt;SetImportChannel(buffer, 0, Image::ManageMemory);</span>

  // access direction of itk::Image and include spacing
<span style = "background-color:#fdd">  mitk::Matrix3D matrix;
  matrix.SetIdentity();
  unsigned int j, itkDimMax3 = (ndim &gt;= 3 ? 3 : ndim);
  for (i = 0; i &lt; itkDimMax3; ++i)
    for (j = 0; j &lt; itkDimMax3; ++j)
      matrix[i][j] = imageIO-&gt;GetDirection(j)[i];</span>

  // re-initialize PlaneGeometry with origin and direction
<span style = "background-color:#fdd">  PlaneGeometry *planeGeometry = static_cast&lt;PlaneGeometry *&gt;(image-&gt;GetSlicedGeometry(0)-&gt;GetPlaneGeometry(0));
  planeGeometry-&gt;SetOrigin(origin);
  planeGeometry-&gt;GetIndexToWorldTransform()-&gt;SetMatrix(matrix);</span>

  // re-initialize SlicedGeometry3D
<span style = "background-color:#fdd">  SlicedGeometry3D *slicedGeometry = image-&gt;GetSlicedGeometry(0);
  slicedGeometry-&gt;InitializeEvenlySpaced(planeGeometry, image-&gt;GetDimension(2));
  slicedGeometry-&gt;SetSpacing(spacing);</span>

<span style = "background-color:#fdd">  MITK_INFO("mitkItkImageFileReader") &lt;&lt; slicedGeometry-&gt;GetCornerPoint(false, false, false);
  MITK_INFO("mitkItkImageFileReader") &lt;&lt; slicedGeometry-&gt;GetCornerPoint(true, true, true);</span>

  // re-initialize TimeGeometry
<span style = "background-color:#fdd">  ProportionalTimeGeometry::Pointer timeGeometry = ProportionalTimeGeometry::New();
  timeGeometry-&gt;Initialize(slicedGeometry, image-&gt;GetDimension(3));
  image-&gt;SetTimeGeometry(timeGeometry);</span>

<span style = "background-color:#fdd">  buffer = nullptr;
  MITK_INFO("mitkItkImageFileReader") &lt;&lt; "number of image components: " &lt;&lt; image-&gt;GetPixelType().GetNumberOfComponents()</span>
                                      &lt;&lt; std::endl;
  //  mitk::DataNode::Pointer node = this-&gt;GetOutput();
  //  node-&gt;SetData( image );

  // add level-window property
  // if ( image-&gt;GetPixelType().GetNumberOfComponents() == 1 )
  //{
  //  SetDefaultImageProperties( node );
  //}
<span style = "background-color:#fdd">  MITK_INFO("mitkItkImageFileReader") &lt;&lt; "...finished!" &lt;&lt; std::endl;
}</span>

bool mitk::ItkImageFileReader::CanReadFile(const std::string filename,
                                           const std::string filePrefix,
                                           const std::string filePattern)
<span style = "background-color:#fdd">{</span>
  // First check the extension
<span style = "background-color:#fdd">  if (filename == "")
    return false;</span>

  // check if image is serie
<span style = "background-color:#fdd">  if (filePattern != "" &amp;&amp; filePrefix != "")
    return false;</span>

<span style = "background-color:#fdd">  itk::ImageIOBase::Pointer imageIO =</span>
    itk::ImageIOFactory::CreateImageIO(filename.c_str(), itk::IOFileModeEnum::ReadMode);
<span style = "background-color:#fdd">  if (imageIO.IsNull())
    return false;</span>

  try
  {
<span style = "background-color:#fdd">    imageIO-&gt;SetFileName(filename.c_str());
    imageIO-&gt;ReadImageInformation();
    itk::MetaDataDictionary imgMetaDictionary = imageIO-&gt;GetMetaDataDictionary();
    std::vector&lt;std::string&gt; imgMetaKeys = imgMetaDictionary.GetKeys();
    std::vector&lt;std::string&gt;::const_iterator itKey = imgMetaKeys.begin();
    std::string metaString;</span>

<span style = "background-color:#fdd">    for (; itKey != imgMetaKeys.end(); itKey++)</span>
    {
<span style = "background-color:#fdd">      itk::ExposeMetaData&lt;std::string&gt;(imgMetaDictionary, *itKey, metaString);
      if (itKey-&gt;find("modality") != std::string::npos)</span>
      {
<span style = "background-color:#fdd">        if (metaString.find("DWMRI") != std::string::npos)</span>
        {
<span style = "background-color:#fdd">          return false; // DiffusionImageReader should handle this</span>
        }
      }
<span style = "background-color:#fdd">    }
  }</span>
  catch (...)
<span style = "background-color:#fdd">  {
    MITK_INFO("mitkItkImageFileReader") &lt;&lt; "Could not read ImageInformation ";
  }</span>

<span style = "background-color:#fdd">  return true;
}</span>

<span style = "background-color:#fdd">mitk::ItkImageFileReader::ItkImageFileReader() : m_FileName(""), m_FilePrefix(""), m_FilePattern("")
{
}</span>

mitk::ItkImageFileReader::~ItkImageFileReader()
<span style = "background-color:#fdd">{
}</span></pre>
	</body>
</html>
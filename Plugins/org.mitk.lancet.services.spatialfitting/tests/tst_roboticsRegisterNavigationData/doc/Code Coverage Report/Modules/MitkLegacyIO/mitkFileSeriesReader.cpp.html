<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkFileSeriesReader.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkFileSeriesReader.h"
#include &lt;itkImageFileReader.h&gt;
#include &lt;itksys/Directory.hxx&gt;
#include &lt;itksys/SystemTools.hxx&gt;
#include &lt;map&gt;

bool mitk::FileSeriesReader::GenerateFileList()
<span style = "background-color:#fdd">{</span>
  typedef std::vector&lt;std::string&gt; StringContainer;
  typedef std::map&lt;unsigned int, std::string&gt; SortedStringContainer;

<span style = "background-color:#fdd">  if (m_FileName == "")</span>
  {
<span style = "background-color:#fdd">    throw itk::ImageFileReaderException(__FILE__, __LINE__, "FileName must be non-empty");</span>
  }
  // MITK_INFO &lt;&lt; "FileName: "&lt;&lt; m_FileName &lt;&lt;", FilePrefix: "&lt;&lt; m_FilePrefix &lt;&lt; ", FilePattern: "&lt;&lt; m_FilePattern &lt;&lt;
  // std::endl;

  // determine begin and end idexes of the last digit sequence in the
  // filename from the sample file name
  // Therefore, walk backwards from the end of the filename until
  // a number is found. The string in front of the number is the prefix,
  // the string after the number is the extension.
<span style = "background-color:#fdd">  std::string basename, path;
  path = itksys::SystemTools::GetFilenamePath(m_FileName);
  basename = itksys::SystemTools::GetFilenameName(m_FileName);</span>

<span style = "background-color:#fdd">  unsigned int digitBegin = 0;
  unsigned int digitEnd = 0;
  bool digitFound = false;
  for (unsigned int i = basename.length() - 1;; --i)</span>
  {
<span style = "background-color:#fdd">    char character = basename[i];
    if (character &gt;= '0' &amp;&amp; character &lt;= '9')</span>
    {
<span style = "background-color:#fdd">      if (!digitFound)</span>
      {
<span style = "background-color:#fdd">        digitEnd = i;
        digitBegin = i;
        digitFound = true;
      }</span>
      else
<span style = "background-color:#fdd">        digitBegin = i;
    }</span>
    else
    {
      // end of digit series found, jump out of loop!
<span style = "background-color:#fdd">      if (digitFound)
        break;</span>
    }
<span style = "background-color:#fdd">    if (i == 0)
      break;
  }</span>

  //
  // if there is no digit in the filename, then we have a problem
  // no matching filenames can be identified!
  //
<span style = "background-color:#fdd">  if (!digitFound)</span>
  {
<span style = "background-color:#fdd">    itkWarningMacro("Filename contains no digit!");
    return false;</span>
  }

  //
  // determine prefix and extension start and length
  //
<span style = "background-color:#fdd">  unsigned int prefixBegin = 0;
  unsigned int prefixLength = digitBegin;
  unsigned int extensionBegin = digitEnd + 1;
  unsigned int extensionLength = (digitEnd == basename.length() - 1 ? 0 : basename.length() - 1 - digitEnd);
  unsigned int numberLength = digitEnd - digitBegin + 1;</span>

  //
  // extract prefix and extension
  //
<span style = "background-color:#fdd">  std::string prefix = "";
  if (prefixLength != 0)
    prefix = basename.substr(prefixBegin, prefixLength);
  std::string extension = "";
  if (extensionLength != 0)
    extension = basename.substr(extensionBegin, extensionLength);</span>

  //
  // print debug information
  //
  /*
  MITK_INFO &lt;&lt; "digitBegin      : " &lt;&lt; digitBegin &lt;&lt; std::endl;
  MITK_INFO &lt;&lt; "digitEnd        : " &lt;&lt; digitEnd &lt;&lt; std::endl;
  MITK_INFO &lt;&lt; "number of digits: " &lt;&lt; numberLength &lt;&lt; std::endl;
  MITK_INFO &lt;&lt; "prefixBegin     : " &lt;&lt; prefixBegin &lt;&lt; std::endl;
  MITK_INFO &lt;&lt; "prefixLength    : " &lt;&lt; prefixLength &lt;&lt; std::endl;
  MITK_INFO &lt;&lt; "prefix          : " &lt;&lt; prefix &lt;&lt; std::endl;
  MITK_INFO &lt;&lt; "extensionBegin  : " &lt;&lt; extensionBegin &lt;&lt; std::endl;
  MITK_INFO &lt;&lt; "extensionLength : " &lt;&lt; extensionLength &lt;&lt; std::endl;
  MITK_INFO &lt;&lt; "extension       : " &lt;&lt; extension &lt;&lt; std::endl;
  */
<span style = "background-color:#fdd">  if ((prefixLength + extensionLength + numberLength) != basename.length())</span>
  {
<span style = "background-color:#fdd">    throw itk::ImageFileReaderException(</span>
      __FILE__, __LINE__, "prefixLength + extensionLength + numberLength != basenameLength");
  }

  //
  // Load Directory
  //
<span style = "background-color:#fdd">  std::string directory = itksys::SystemTools::GetFilenamePath(m_FileName);
  itksys::Directory itkDir;
  if (!itkDir.Load(directory.c_str()))</span>
  {
<span style = "background-color:#fdd">    itkWarningMacro(&lt;&lt; "Directory " &lt;&lt; directory &lt;&lt; " cannot be read!");
    return false;</span>
  }

  //
  // Get a list of all files in the directory
  //
<span style = "background-color:#fdd">  StringContainer unmatchedFiles;</span>
  // unsigned long i;
<span style = "background-color:#fdd">  for (unsigned long i = 0; i &lt; itkDir.GetNumberOfFiles(); i++)</span>
  {
    // Only read files
<span style = "background-color:#fdd">    std::string filename = directory + "/" + itkDir.GetFile(i);
    if (itksys::SystemTools::FileIsDirectory(filename.c_str()))
      continue;</span>

    // store the filenames without path
<span style = "background-color:#fdd">    unmatchedFiles.push_back(itkDir.GetFile(i));
  }</span>

  //
  // Match the file list against the file prefix and extension,
  // the result should be only the files that should be read
  //
<span style = "background-color:#fdd">  StringContainer matchedFiles;
  for (auto it = unmatchedFiles.begin(); it != unmatchedFiles.end(); ++it)</span>
  {
<span style = "background-color:#fdd">    bool prefixMatch = false;
    bool extensionMatch = false;</span>

    // check if the file prefix matches the current file
<span style = "background-color:#fdd">    if (prefixLength != 0)
      prefixMatch = (it-&gt;find(prefix) == prefixBegin); // check if prefix is found</span>
    else
<span style = "background-color:#fdd">      prefixMatch = (((*it)[0] &gt;= '0') &amp;&amp; ((*it)[0] &lt;= '9')); // check if filename begins with digit</span>

    // check if the file extension matches the current file
<span style = "background-color:#fdd">    if (extensionLength != 0)
      extensionMatch = (it-&gt;find(extension) == it-&gt;length() - extensionLength); // check if prefix is found</span>
    else
<span style = "background-color:#fdd">      extensionMatch =</span>
        (((*it)[it-&gt;length() - 1] &gt;= '0') &amp;&amp; ((*it)[it-&gt;length() - 1] &lt;= '9')); // check if filename ends with digit

<span style = "background-color:#fdd">    if (prefixMatch &amp;&amp; extensionMatch)</span>
    {
<span style = "background-color:#fdd">      matchedFiles.push_back(*it);
    }
  }
  if (matchedFiles.size() == 0)</span>
  {
<span style = "background-color:#fdd">    itkWarningMacro(&lt;&lt; "Sorry, none of the files matched the prefix!");
    return false;</span>
  }

  //
  // parse the file names from back to front for digits
  // and convert them to a number. Store the filename and number
  // in a SortedStringContainer
  //
<span style = "background-color:#fdd">  SortedStringContainer sortedFiles;
  for (auto it = matchedFiles.begin(); it != matchedFiles.end(); ++it)</span>
  {
    // parse the filename starting from pos digitBegin until we reach a non-digit
    // or the end of filename
<span style = "background-color:#fdd">    std::string number = "";
    std::string currentFilename(*it);
    for (unsigned int i = digitBegin; i &lt; currentFilename.length(); ++i)</span>
    {
<span style = "background-color:#fdd">      char character = currentFilename[i];</span>
      // do we have a digit?
<span style = "background-color:#fdd">      if (character &gt;= '0' &amp;&amp; character &lt;= '9')
        number += character;</span>
      else
<span style = "background-color:#fdd">        break; // end of digit series found, jump out of loop!
    }
    if (number.length() == 0)</span>
    {
      // The file is not numbered, this is an error!
      // Nevertheless, we try the next files.
<span style = "background-color:#fdd">      itkWarningMacro(&lt;&lt; "The filename " &lt;&lt; *it</span>
                      &lt;&lt; "does not contain a valid digit sequence but matches prefix and extension. Skipping file!");
<span style = "background-color:#fdd">    }</span>
    else
    {
<span style = "background-color:#fdd">      if ((number.length() + prefix.length() + extension.length()) != it-&gt;length())</span>
      {
<span style = "background-color:#fdd">        itkWarningMacro(</span>
          "The file "
          &lt;&lt; *it
          &lt;&lt; " matches prefix and extension, but the string in beteen is not a single digit-sequence. Skipping file!");
<span style = "background-color:#fdd">      }</span>
      else
      {
        // convert the number string into an integer and
        // insert the filname (including directory) into the SortedStringContainer
<span style = "background-color:#fdd">        unsigned int num = atoi(number.c_str());
        sortedFiles.insert(std::make_pair(num, directory + "/" + *it));</span>
      }
    }
<span style = "background-color:#fdd">  }
  if (sortedFiles.size() == 0)</span>
  {
<span style = "background-color:#fdd">    itkWarningMacro(&lt;&lt; "Sorry, no numbered files found, I can't load anything...");
    return false;</span>
  }

  //
  // Convert the sorted string container in a plain sorted vector of strings;
  //
<span style = "background-color:#fdd">  m_MatchedFileNames.clear();
  m_MatchedFileNames.resize(sortedFiles.size());
  unsigned long index = 0;
  for (auto it = sortedFiles.begin(); it != sortedFiles.end(); ++it, ++index)</span>
  {
<span style = "background-color:#fdd">    m_MatchedFileNames[index] = it-&gt;second;
    MITK_INFO &lt;&lt; "Added " &lt;&lt; it-&gt;second &lt;&lt; " to the set of matched files!" &lt;&lt; std::endl;
  }
  return true;
}</span>

mitk::FileSeriesReader::MatchedFileNames mitk::FileSeriesReader::GetMatchedFileNames()
<span style = "background-color:#fdd">{
  return m_MatchedFileNames;
}</span>

<span style = "background-color:#fdd">mitk::FileSeriesReader::FileSeriesReader() : m_FileName(""), m_FilePrefix(""), m_FilePattern("")
{
}</span>

mitk::FileSeriesReader::~FileSeriesReader()
<span style = "background-color:#fdd">{
}</span></pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>vtkPointSetXMLParser.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "vtkPointSetXMLParser.h"
#include "mitkInteractionConst.h"
#include "mitkOperation.h"
#include "mitkPointOperation.h"
#include "mitkPointSetWriter.h"
#include "vtkObjectFactory.h"

namespace mitk
{
<span style = "background-color:#fdd">  vtkStandardNewMacro(vtkPointSetXMLParser);</span>
}

mitk::vtkPointSetXMLParser::vtkPointSetXMLParser()
<span style = "background-color:#fdd">{
}</span>

mitk::vtkPointSetXMLParser::~vtkPointSetXMLParser()
<span style = "background-color:#fdd">{
}</span>

int mitk::vtkPointSetXMLParser::InitializeParser()
<span style = "background-color:#fdd">{
  vtkXMLParser::InitializeParser();
  std::istream *stream = this-&gt;GetStream();
  if (!stream)</span>
  {
<span style = "background-color:#fdd">    vtkErrorMacro("no stream available in XML file reader");
    this-&gt;ParseError = 1;
    return 0;</span>
  }
<span style = "background-color:#fdd">  m_PreviousLocale = stream-&gt;getloc();
  std::locale I("C");
  stream-&gt;imbue(I);
  return 1;
}</span>

int mitk::vtkPointSetXMLParser::CleanupParser()
<span style = "background-color:#fdd">{
  std::istream *stream = this-&gt;GetStream();
  if (!stream)</span>
  {
<span style = "background-color:#fdd">    vtkErrorMacro("no stream available in XML file reader");
    this-&gt;ParseError = 1;
    return 0;</span>
  }
<span style = "background-color:#fdd">  stream-&gt;imbue(m_PreviousLocale);
  vtkXMLParser::CleanupParser();
  return 1;
}</span>

void mitk::vtkPointSetXMLParser::StartElement(const char *name, const char ** /*atts */)
<span style = "background-color:#fdd">{
  std::string currentElement = name;</span>
  //
  // when a new point set begins in the file, create a new
  // mitk::point set and store it in m_PointSetList
  //
<span style = "background-color:#fdd">  if (currentElement == mitk::PointSetWriter::XML_POINT_SET)</span>
  {
<span style = "background-color:#fdd">    m_CurrentPointSet = PointSetType::New();
  }</span>
  //
  // when a new point begins, initialize it to zero.
  //
<span style = "background-color:#fdd">  else if (currentElement == mitk::PointSetWriter::XML_POINT)</span>
  {
<span style = "background-color:#fdd">    m_CurrentPoint[0] = 0.0f;
    m_CurrentPoint[1] = 0.0f;
    m_CurrentPoint[2] = 0.0f;
    m_CurId.clear();
    m_CurXString.clear();
    m_CurYString.clear();
    m_CurZString.clear();</span>
  }

  //
  // the current element is pushed on to the stack
  // to be able to detect some errors in the xml file
  //
<span style = "background-color:#fdd">  m_ParseStack.push(currentElement);
}</span>

void mitk::vtkPointSetXMLParser::EndElement(const char *name)
<span style = "background-color:#fdd">{
  std::string currentElement = name;</span>

  //
  // make sure, that the current end element matches with the
  // last start tag
  //
<span style = "background-color:#fdd">  if (m_ParseStack.top() != currentElement)</span>
  {
<span style = "background-color:#fdd">    MITK_ERROR &lt;&lt; "Top of parse stack ( " &lt;&lt; m_ParseStack.top() &lt;&lt; " ) is != currentEndElement ( " &lt;&lt; currentElement</span>
               &lt;&lt; " )!" &lt;&lt; std::endl;
  }
<span style = "background-color:#fdd">  m_ParseStack.pop();</span>

  //
  // After a complete point set has been parsed, its
  // output information is updated and it is inserted into the list
  // of parsed point sets.
  //
<span style = "background-color:#fdd">  if (currentElement == mitk::PointSetWriter::XML_POINT_SET)</span>
  {
<span style = "background-color:#fdd">    m_CurrentPointSet-&gt;UpdateOutputInformation();
    m_PointSetList.push_back(m_CurrentPointSet);
  }</span>
  //
  // if we have finished parsing a point, insert it to the current
  // point set.
  //
<span style = "background-color:#fdd">  else if (currentElement == mitk::PointSetWriter::XML_POINT)</span>
  {
<span style = "background-color:#fdd">    m_CurrentPointId = ParsePointIdentifier(m_CurId);
    m_CurrentPoint[0] = ParseScalarType(m_CurXString);
    m_CurrentPoint[1] = ParseScalarType(m_CurYString);
    m_CurrentPoint[2] = ParseScalarType(m_CurZString);</span>

<span style = "background-color:#fdd">    mitk::PointOperation popInsert(mitk::OpINSERT, m_CurrentPoint, m_CurrentPointId);
    mitk::PointOperation popDeactivate(mitk::OpDESELECTPOINT, m_CurrentPoint, m_CurrentPointId);
    assert(m_CurrentPointSet.IsNotNull());
    m_CurrentPointSet-&gt;ExecuteOperation(&amp;popInsert);
    m_CurrentPointSet-&gt;ExecuteOperation(&amp;popDeactivate);
  }
}</span>

void mitk::vtkPointSetXMLParser::CharacterDataHandler(const char *inData, int inLength)
<span style = "background-color:#fdd">{
  std::string currentElement = m_ParseStack.top();
  if (currentElement == mitk::PointSetWriter::XML_ID)</span>
  {
<span style = "background-color:#fdd">    m_CurId.append(inData, inLength);
  }
  else if (currentElement == mitk::PointSetWriter::XML_X)</span>
  {
<span style = "background-color:#fdd">    m_CurXString.append(inData, inLength);
  }
  else if (currentElement == mitk::PointSetWriter::XML_Y)</span>
  {
<span style = "background-color:#fdd">    m_CurYString.append(inData, inLength);
  }
  else if (currentElement == mitk::PointSetWriter::XML_Z)</span>
  {
<span style = "background-color:#fdd">    m_CurZString.append(inData, inLength);</span>
  }
<span style = "background-color:#fdd">}</span>

mitk::ScalarType mitk::vtkPointSetXMLParser::ParseScalarType(const std::string &amp;data)
<span style = "background-color:#fdd">{
  std::istringstream stm;
  stm.str(data);</span>
  ScalarType number;
<span style = "background-color:#fdd">  stm &gt;&gt; number;
  return number;
}</span>

mitk::vtkPointSetXMLParser::PointIdentifier mitk::vtkPointSetXMLParser::ParsePointIdentifier(const std::string &amp;data)
<span style = "background-color:#fdd">{
  std::istringstream stm;
  stm.str(data);</span>
  PointIdentifier pointID;
<span style = "background-color:#fdd">  stm &gt;&gt; pointID;
  return pointID;
}</span>

mitk::vtkPointSetXMLParser::PointSetList mitk::vtkPointSetXMLParser::GetParsedPointSets()
<span style = "background-color:#fdd">{
  return m_PointSetList;
}</span></pre>
	</body>
</html>
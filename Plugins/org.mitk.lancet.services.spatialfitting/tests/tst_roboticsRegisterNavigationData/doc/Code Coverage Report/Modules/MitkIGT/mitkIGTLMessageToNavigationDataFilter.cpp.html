<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkIGTLMessageToNavigationDataFilter.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkIGTLMessageToNavigationDataFilter.h"
#include "igtlTrackingDataMessage.h"
#include "igtlQuaternionTrackingDataMessage.h"
#include "igtlTransformMessage.h"
#include "mitkQuaternion.h"
#include &lt;vnl/vnl_det.h&gt;

mitk::IGTLMessageToNavigationDataFilter::IGTLMessageToNavigationDataFilter()
<span style = "background-color:#fdd">  : mitk::NavigationDataSource()
{
  mitk::NavigationData::Pointer output = mitk::NavigationData::New();
  this-&gt;SetNumberOfRequiredOutputs(1);
  this-&gt;SetNthOutput(0, output.GetPointer());
}</span>

mitk::IGTLMessageToNavigationDataFilter::~IGTLMessageToNavigationDataFilter()
<span style = "background-color:#fdd">{
}</span>

void mitk::IGTLMessageToNavigationDataFilter::SetInput(const IGTLMessage* msg)
<span style = "background-color:#fdd">{
  this-&gt;SetInput(0, msg);
}</span>

void mitk::IGTLMessageToNavigationDataFilter::SetInput(unsigned int idx, const IGTLMessage* msg)
<span style = "background-color:#fdd">{
  if (msg == nullptr) // if an input is set to nullptr, remove it</span>
  {
<span style = "background-color:#fdd">    this-&gt;RemoveInput(idx);
  }</span>
  else
  {
    // ProcessObject is not const-correct so a const_cast is required here
<span style = "background-color:#fdd">    this-&gt;ProcessObject::SetNthInput(idx, const_cast&lt;IGTLMessage*&gt;(msg));</span>
  }
<span style = "background-color:#fdd">  this-&gt;CreateOutputsForAllInputs();
}</span>

const mitk::IGTLMessage*
mitk::IGTLMessageToNavigationDataFilter::GetInput(void) const
<span style = "background-color:#fdd">{
  if (this-&gt;GetNumberOfInputs() &lt; 1)
    return nullptr;</span>

<span style = "background-color:#fdd">  return static_cast&lt;const IGTLMessage*&gt;(this-&gt;ProcessObject::GetInput(0));
}</span>

const mitk::IGTLMessage*
mitk::IGTLMessageToNavigationDataFilter::GetInput(unsigned int idx) const
<span style = "background-color:#fdd">{
  if (this-&gt;GetNumberOfInputs() &lt; 1)
    return nullptr;</span>

<span style = "background-color:#fdd">  return static_cast&lt;const IGTLMessage*&gt;(this-&gt;ProcessObject::GetInput(idx));
}</span>

const mitk::IGTLMessage*
mitk::IGTLMessageToNavigationDataFilter::GetInput(std::string messageName) const
<span style = "background-color:#fdd">{
  const DataObjectPointerArray&amp; inputs = const_cast&lt;Self*&gt;(this)-&gt;GetInputs();
  for (DataObjectPointerArray::const_iterator it = inputs.begin();
    it != inputs.end(); ++it)</span>
  {
<span style = "background-color:#fdd">    if (std::string(messageName) ==</span>
      (static_cast&lt;IGTLMessage*&gt;(it-&gt;GetPointer()))-&gt;GetName())
    {
<span style = "background-color:#fdd">      return static_cast&lt;IGTLMessage*&gt;(it-&gt;GetPointer());
    }
  }
  return nullptr;
}</span>

itk::ProcessObject::DataObjectPointerArraySizeType
mitk::IGTLMessageToNavigationDataFilter::GetInputIndex(std::string messageName)
<span style = "background-color:#fdd">{
  DataObjectPointerArray outputs = this-&gt;GetInputs();
  for (DataObjectPointerArray::size_type i = 0; i &lt; outputs.size(); ++i)</span>
  {
<span style = "background-color:#fdd">    if (messageName ==</span>
      (static_cast&lt;IGTLMessage*&gt;(outputs.at(i).GetPointer()))-&gt;GetName())
    {
<span style = "background-color:#fdd">      return i;</span>
    }
<span style = "background-color:#fdd">  }
  throw std::invalid_argument("output name does not exist");
}</span>

void mitk::IGTLMessageToNavigationDataFilter::ConnectTo(
  mitk::IGTLMessageSource* UpstreamFilter)
<span style = "background-color:#fdd">{
  for (DataObjectPointerArraySizeType i = 0;
    i &lt; UpstreamFilter-&gt;GetNumberOfOutputs(); i++)</span>
  {
<span style = "background-color:#fdd">    this-&gt;SetInput(i, UpstreamFilter-&gt;GetOutput(i));
  }
}</span>

void mitk::IGTLMessageToNavigationDataFilter::SetNumberOfExpectedOutputs(
  unsigned int numOutputs)
<span style = "background-color:#fdd">{
  this-&gt;SetNumberOfIndexedOutputs(numOutputs);
  this-&gt;CreateOutputsForAllInputs();
}</span>

void mitk::IGTLMessageToNavigationDataFilter::CreateOutputsForAllInputs()
<span style = "background-color:#fdd">{</span>
  // create outputs for all inputs
  //  this-&gt;SetNumberOfIndexedOutputs(this-&gt;GetNumberOfIndexedInputs());
<span style = "background-color:#fdd">  bool isModified = false;
  for (unsigned int idx = 0; idx &lt; this-&gt;GetNumberOfIndexedOutputs(); ++idx)</span>
  {
<span style = "background-color:#fdd">    if (this-&gt;GetOutput(idx) == nullptr)</span>
    {
<span style = "background-color:#fdd">      mitk::NavigationData::Pointer newOutput = mitk::NavigationData::New();
      this-&gt;SetNthOutput(idx, newOutput);
      isModified = true;
    }
  }</span>

<span style = "background-color:#fdd">  if (isModified)
    this-&gt;Modified();
}</span>

void mitk::IGTLMessageToNavigationDataFilter::GenerateTransformData()
<span style = "background-color:#fdd">{
  const mitk::IGTLMessage* input = this-&gt;GetInput(0);
  assert(input);</span>

  //cast the input message into the proper type
<span style = "background-color:#fdd">  igtl::TransformMessage* tMsg =</span>
    (igtl::TransformMessage*)(input-&gt;GetMessage().GetPointer());

  //check if cast was successful
<span style = "background-color:#fdd">  if (!tMsg)</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cast from igtl::MessageBase to igtl::TransformMessage "</span>
      &lt;&lt; "failed! Please check the message.";
  }

  /* update outputs with tracking data from tools */
<span style = "background-color:#fdd">  for (unsigned int i = 0; i &lt; this-&gt;GetNumberOfOutputs(); ++i)</span>
  {
<span style = "background-color:#fdd">    mitk::NavigationData* output = this-&gt;GetOutput(i);
    assert(output);</span>

<span style = "background-color:#fdd">    if (input-&gt;IsDataValid() == false)</span>
    {
<span style = "background-color:#fdd">      output-&gt;SetDataValid(false);
      continue;</span>
    }

    //get the transformation matrix and convert it into an affinetransformation
    igtl::Matrix4x4 transformation_;
<span style = "background-color:#fdd">    tMsg-&gt;GetMatrix(transformation_);
    mitk::AffineTransform3D::Pointer affineTransformation =</span>
      mitk::AffineTransform3D::New();
<span style = "background-color:#fdd">    mitk::Matrix3D transformation;
    mitk::Vector3D offset;
    for (unsigned int r = 0; r &lt; 3; r++)</span>
    {
<span style = "background-color:#fdd">      for (unsigned int c = 0; c &lt; 3; c++)</span>
      {
<span style = "background-color:#fdd">        transformation.GetVnlMatrix().set(r, c, transformation_[r][c]);
      }
      offset.SetElement(r, transformation_[r][3]);
    }</span>
    //convert the igtl matrix here and set it in the affine transformation
<span style = "background-color:#fdd">    affineTransformation-&gt;SetMatrix(transformation);
    affineTransformation-&gt;SetOffset(offset);</span>

    //create a new navigation data here, there is a neat constructor for
    //affine transformations that sets the orientation, position according to
    //the affine transformation. The other values are initialized with standard
    //values
<span style = "background-color:#fdd">    mitk::NavigationData::Pointer nd =</span>
      mitk::NavigationData::New(affineTransformation, true);
    //set the time stamp
<span style = "background-color:#fdd">    nd-&gt;SetIGTTimeStamp(input-&gt;GetTimeStamp());</span>
    //set the name
<span style = "background-color:#fdd">    nd-&gt;SetName(input-&gt;GetName());</span>

<span style = "background-color:#fdd">    output-&gt;Graft(nd);
  }
}</span>

void mitk::IGTLMessageToNavigationDataFilter::GenerateTrackingDataData()
<span style = "background-color:#fdd">{
  const mitk::IGTLMessage* input = this-&gt;GetInput(0);
  assert(input);</span>

  //cast the input message into the proper type
<span style = "background-color:#fdd">  igtl::TrackingDataMessage* tdMsg =</span>
    (igtl::TrackingDataMessage*)(input-&gt;GetMessage().GetPointer());

  //check if cast was successful
<span style = "background-color:#fdd">  if (!tdMsg)</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cast from igtl::MessageBase to igtl::TrackingDataMessage "</span>
      &lt;&lt; "failed! Please check the message.";
  }

  //get the number of tracking data elements
<span style = "background-color:#fdd">  unsigned int numTrackingDataElements =</span>
    tdMsg-&gt;GetNumberOfTrackingDataElements();

<span style = "background-color:#fdd">  if (!numTrackingDataElements)</span>
  {
<span style = "background-color:#fdd">    MITK_ERROR("IGTLMsgToNavDataFilter") &lt;&lt; "There are no tracking data "</span>
      "elements in this message";
  }

  /* update outputs with tracking data from tools */
<span style = "background-color:#fdd">  for (unsigned int i = 0; i &lt; this-&gt;GetNumberOfOutputs(); ++i)</span>
  {
<span style = "background-color:#fdd">    mitk::NavigationData* output = this-&gt;GetOutput(i);
    assert(output);</span>

    //invalidate the output
<span style = "background-color:#fdd">    output-&gt;SetDataValid(false);</span>

    //check if the current index, all outputs that have no corresponding input
    //tracking element stay invalidated, the others are validated according to
    //the tracking element
<span style = "background-color:#fdd">    if (input-&gt;IsDataValid() == false) { continue; }
    output-&gt;SetDataValid(true);</span>

    //get the tracking data element which holds all the data
<span style = "background-color:#fdd">    igtl::TrackingDataElement::Pointer td;
    tdMsg-&gt;GetTrackingDataElement(i, td);</span>

    //get the transformation matrix and convert it into an affinetransformation
    igtl::Matrix4x4 transformation_;
<span style = "background-color:#fdd">    td-&gt;GetMatrix(transformation_);
    mitk::AffineTransform3D::Pointer affineTransformation =</span>
      mitk::AffineTransform3D::New();
<span style = "background-color:#fdd">    mitk::Matrix3D transformation;
    mitk::Vector3D offset;
    for (unsigned int r = 0; r &lt; 3; r++)</span>
    {
<span style = "background-color:#fdd">      for (unsigned int c = 0; c &lt; 3; c++)</span>
      {
<span style = "background-color:#fdd">        transformation.GetVnlMatrix().set(r, c, transformation_[r][c]);
      }
      offset.SetElement(r, transformation_[r][3]);
    }</span>
    //convert the igtl matrix here and set it in the affine transformation
<span style = "background-color:#fdd">    affineTransformation-&gt;SetMatrix(transformation);
    affineTransformation-&gt;SetOffset(offset);</span>

<span style = "background-color:#fdd">    mitk::NavigationData::Pointer nd;</span>

    //check the rotation matrix
<span style = "background-color:#fdd">    vnl_matrix_fixed&lt;ScalarType, 3, 3&gt; rotationMatrix =</span>
      affineTransformation-&gt;GetMatrix().GetVnlMatrix();
    vnl_matrix_fixed&lt;ScalarType, 3, 3&gt; rotationMatrixTransposed =
<span style = "background-color:#fdd">      rotationMatrix.transpose();</span>
    // a quadratic matrix is a rotation matrix exactly when determinant is 1
    // and transposed is inverse
    if (!Equal(1.0, vnl_det(rotationMatrix), 0.1)
<span style = "background-color:#fdd">      || !((rotationMatrix*rotationMatrixTransposed).is_identity(0.1)))</span>
    {
<span style = "background-color:#fdd">      MITK_ERROR("IGTLMsgToNavDataFilter") &lt;&lt; "tried to initialize NavData "</span>
        &lt;&lt; "with non-rotation matrix :" &lt;&lt; rotationMatrix &lt;&lt; " (Does your "
        "AffineTransform3D object include spacing? This is not "
        "supported by NavigationData objects!)";
<span style = "background-color:#fdd">      nd = mitk::NavigationData::New();
    }</span>
    else
    {
      //create a new navigation data here, there is a neat constructor for
      //affine transformations that sets the orientation, position according to
      //the affine transformation. The other values are initialized with standard
      //values
<span style = "background-color:#fdd">      nd = mitk::NavigationData::New(affineTransformation, true);</span>
    }
    //set the time stamp
<span style = "background-color:#fdd">    nd-&gt;SetIGTTimeStamp(input-&gt;GetIGTTimeStamp());</span>
    //set the name
<span style = "background-color:#fdd">    nd-&gt;SetName(td-&gt;GetName());
    output-&gt;Graft(nd);
  }
}</span>

void
mitk::IGTLMessageToNavigationDataFilter::GenerateQuaternionTrackingDataData()
<span style = "background-color:#fdd">{
  const mitk::IGTLMessage* input = this-&gt;GetInput(0);
  assert(input);</span>

  //cast the input message into the proper type
<span style = "background-color:#fdd">  igtl::QuaternionTrackingDataMessage* tdMsg =</span>
    (igtl::QuaternionTrackingDataMessage*)(input-&gt;GetMessage().GetPointer());

  //check if cast was successful
<span style = "background-color:#fdd">  if (!tdMsg)</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cast from igtl::MessageBase to igtl::TrackingDataMessage "</span>
      &lt;&lt; "failed! Please check the message.";
  }

  //get the number of tracking data elements
<span style = "background-color:#fdd">  unsigned int numTrackingDataElements =</span>
    tdMsg-&gt;GetNumberOfQuaternionTrackingDataElements();

<span style = "background-color:#fdd">  if (!numTrackingDataElements)</span>
  {
<span style = "background-color:#fdd">    MITK_ERROR("IGTLMsgToNavDataFilter") &lt;&lt; "There are no tracking data "</span>
      "elements in this message";
  }

  /* update outputs with tracking data from tools */
<span style = "background-color:#fdd">  for (unsigned int i = 0; i &lt; this-&gt;GetNumberOfOutputs(); ++i)</span>
  {
<span style = "background-color:#fdd">    mitk::NavigationData* output = this-&gt;GetOutput(i);
    assert(output);</span>

    //invalidate the output
<span style = "background-color:#fdd">    output-&gt;SetDataValid(false);</span>

    //check if the current index, all outputs that have no corresponding input
    //tracking element stay invalidated, the others are validated according to
    //the tracking element
<span style = "background-color:#fdd">    if (input-&gt;IsDataValid() == false || i &gt;= numTrackingDataElements)</span>
    {
<span style = "background-color:#fdd">      continue;</span>
    }
<span style = "background-color:#fdd">    output-&gt;SetDataValid(true);</span>

    //get the tracking data element which holds all the data
<span style = "background-color:#fdd">    igtl::QuaternionTrackingDataElement::Pointer td;
    tdMsg-&gt;GetQuaternionTrackingDataElement(i, td);</span>

    //get the quaternion and set it
    float quaternion_[4];                          //igtl quat type
<span style = "background-color:#fdd">    td-&gt;GetQuaternion(quaternion_);</span>
    mitk::Quaternion quaternion;
<span style = "background-color:#fdd">    quaternion.put(0, quaternion_[0]);
    quaternion.put(1, quaternion_[1]);
    quaternion.put(2, quaternion_[2]);
    quaternion.put(3, quaternion_[3]);
    output-&gt;SetOrientation(quaternion);
    output-&gt;SetHasOrientation(true);</span>

    //get the position and set it
    float position_[3];                          //igtl position type
<span style = "background-color:#fdd">    td-&gt;GetPosition(position_);
    mitk::NavigationData::PositionType position; //mitk position type
    position.SetElement(0, position_[0]);
    position.SetElement(1, position_[1]);
    position.SetElement(2, position_[2]);
    output-&gt;SetPosition(position);
    output-&gt;SetHasPosition(true);</span>
    //set the time stamp
<span style = "background-color:#fdd">    output-&gt;SetIGTTimeStamp(input-&gt;GetTimeStamp());</span>
    //set the name
<span style = "background-color:#fdd">    output-&gt;SetName(td-&gt;GetName());</span>

    //there is no explicit covarience matrix
<span style = "background-color:#fdd">    output-&gt;SetCovErrorMatrix(mitk::NavigationData::CovarianceMatrixType());
  }
}</span>

void mitk::IGTLMessageToNavigationDataFilter::GenerateData()
<span style = "background-color:#fdd">{</span>
  //get the IGTLMessage from the previous filter
<span style = "background-color:#fdd">  const mitk::IGTLMessage* input = this-&gt;GetInput(0);
  assert(input);</span>

  //check if the message is valid, if it is not valid we do not generate new
  //outputs
<span style = "background-color:#fdd">  if (!input-&gt;IsDataValid())</span>
  {
<span style = "background-color:#fdd">    MITK_DEBUG("IGTLMessageToNavigationDataFilter") &lt;&lt; "Input data is invalid.";
    return;</span>
  }

  //get the message type
<span style = "background-color:#fdd">  const char* msgType = input-&gt;GetIGTLMessageType();</span>

  //check if the IGTL message has the proper type
<span style = "background-color:#fdd">  if (strcmp(msgType, "TRANSFORM") == 0)</span>
  {
<span style = "background-color:#fdd">    this-&gt;GenerateTransformData();
  }
  else if (strcmp(msgType, "TDATA") == 0)</span>
  {
<span style = "background-color:#fdd">    this-&gt;GenerateTrackingDataData();
  }
  else if (strcmp(msgType, "QTDATA") == 0)</span>
  {
<span style = "background-color:#fdd">    this-&gt;GenerateQuaternionTrackingDataData();
  }</span>
  else
  {
    //the message has another type
    //ignore
<span style = "background-color:#fdd">    MITK_INFO("IGTLMessageToNavigationDataFilter") &lt;&lt; "The input has a unknown "</span>
      &lt;&lt; "message type: "
      &lt;&lt; msgType;
  }
<span style = "background-color:#fdd">}</span>

void mitk::IGTLMessageToNavigationDataFilter::GenerateOutputInformation()
<span style = "background-color:#fdd">{</span>
  //  Superclass::GenerateOutputInformation();

  //  mitk::NavigationData* output = this-&gt;GetOutput(0);
  //  assert(output);
  //  const mitk::IGTLMessage* input = this-&gt;GetInput(0);
  //  assert(input);

<span style = "background-color:#fdd">  itkDebugMacro(&lt;&lt; "GenerateOutputInformation()");</span>

  //  output-&gt;Initialize(input-&gt;GetPixelType(), input-&gt;GetDimension(), input-&gt;GetDimensions());

  //  // initialize geometry
  //  output-&gt;SetPropertyList(input-&gt;GetPropertyList()-&gt;Clone());
  //  mitk::TimeGeometry::Pointer clonGeometry = input-&gt;GetTimeGeometry()-&gt;Clone();
  //  output-&gt;SetTimeGeometry(clonGeometry.GetPointer());
<span style = "background-color:#fdd">}</span></pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkNavigationDataPlayer.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkNavigationDataPlayer.h"

#include &lt;itksys/SystemTools.hxx&gt;
#include &lt;mitkIGTTimeStamp.h&gt;
#include &lt;fstream&gt;

#include "mitkIGTException.h"

mitk::NavigationDataPlayer::NavigationDataPlayer()
<span style = "background-color:#fdd">  : m_CurPlayerState(PlayerStopped),
  m_StartPlayingTimeStamp(0.0), m_PauseTimeStamp(0.0)
{</span>
  // to get a start time
<span style = "background-color:#fdd">  mitk::IGTTimeStamp::GetInstance()-&gt;Start(this);
}</span>

mitk::NavigationDataPlayer::~NavigationDataPlayer()
<span style = "background-color:#fdd">{
  StopPlaying();
}</span>

void mitk::NavigationDataPlayer::GenerateData()
<span style = "background-color:#fdd">{
  if ( m_NavigationDataSet-&gt;Size() == 0 )</span>
  {
<span style = "background-color:#fdd">    MITK_WARN &lt;&lt; "Cannot do anything with empty set of navigation datas.";
    return;</span>
  }

  //Only produce new output if the player is started
<span style = "background-color:#fdd">  if (m_CurPlayerState != PlayerRunning)</span>
  {
    //The output is not valid anymore
<span style = "background-color:#fdd">    this-&gt;GraftEmptyOutput();
    return;</span>
  }

  // get elapsed time since start of playing
<span style = "background-color:#fdd">  m_TimeStampSinceStart = mitk::IGTTimeStamp::GetInstance()-&gt;GetElapsed() - m_StartPlayingTimeStamp;</span>

  // add offset of the first navigation data to the timestamp to start playing
  // imediatly with the first navigation data (not to wait till the first time
  // stamp is reached)
<span style = "background-color:#fdd">  TimeStampType timeStampSinceStartWithOffset = m_TimeStampSinceStart</span>
      + m_NavigationDataSet-&gt;Begin()-&gt;at(0)-&gt;GetIGTTimeStamp();

  // iterate through all NavigationData objects of the given tool index
  // till the timestamp of the NavigationData is greater then the given timestamp
<span style = "background-color:#fdd">  for (; m_NavigationDataSetIterator != m_NavigationDataSet-&gt;End(); ++m_NavigationDataSetIterator)</span>
  {
    // test if the timestamp of the successor is greater than the time stamp
<span style = "background-color:#fdd">    if ( m_NavigationDataSetIterator+1 == m_NavigationDataSet-&gt;End() ||</span>
        (m_NavigationDataSetIterator+1)-&gt;at(0)-&gt;GetIGTTimeStamp() &gt; timeStampSinceStartWithOffset )
    {
<span style = "background-color:#fdd">      break;</span>
    }
<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  for (unsigned int index = 0; index &lt; GetNumberOfOutputs(); index++)</span>
  {
<span style = "background-color:#fdd">    mitk::NavigationData* output = this-&gt;GetOutput(index);
    if( !output ) { mitkThrowException(mitk::IGTException) &lt;&lt; "Output of index "&lt;&lt;index&lt;&lt;" is null."; }</span>

<span style = "background-color:#fdd">    output-&gt;Graft(m_NavigationDataSetIterator-&gt;at(index));
  }</span>

  // stop playing if the last NavigationData objects were grafted
<span style = "background-color:#fdd">  if (m_NavigationDataSetIterator+1 == m_NavigationDataSet-&gt;End())</span>
  {
<span style = "background-color:#fdd">    this-&gt;StopPlaying();</span>

    // start playing again if repeat is enabled
<span style = "background-color:#fdd">    if ( m_Repeat ) { this-&gt;StartPlaying(); }</span>
  }
<span style = "background-color:#fdd">}</span>

void mitk::NavigationDataPlayer::UpdateOutputInformation()
<span style = "background-color:#fdd">{
  this-&gt;Modified();  // make sure that we need to be updated
  Superclass::UpdateOutputInformation();
}</span>

void mitk::NavigationDataPlayer::StartPlaying()
<span style = "background-color:#fdd">{</span>
  // make sure that player is initialized before playing starts
<span style = "background-color:#fdd">  this-&gt;InitPlayer();</span>

  // set state and iterator for playing from start
<span style = "background-color:#fdd">  m_CurPlayerState = PlayerRunning;
  m_NavigationDataSetIterator = m_NavigationDataSet-&gt;Begin();</span>

  // reset playing timestamps
<span style = "background-color:#fdd">  m_PauseTimeStamp = 0;
  m_TimeStampSinceStart = 0;</span>

  // timestamp for indicating playing start set to current elapsed time
<span style = "background-color:#fdd">  m_StartPlayingTimeStamp = mitk::IGTTimeStamp::GetInstance()-&gt;GetElapsed();
}</span>

void mitk::NavigationDataPlayer::StopPlaying()
<span style = "background-color:#fdd">{
  m_CurPlayerState = PlayerStopped;
}</span>

void mitk::NavigationDataPlayer::Pause()
<span style = "background-color:#fdd">{</span>
  //player runs and pause was called -&gt; pause the player
<span style = "background-color:#fdd">  if(m_CurPlayerState == PlayerRunning)</span>
  {
<span style = "background-color:#fdd">    m_CurPlayerState = PlayerPaused;
    m_PauseTimeStamp = mitk::IGTTimeStamp::GetInstance()-&gt;GetElapsed();
  }</span>
  else
  {
<span style = "background-color:#fdd">    MITK_ERROR &lt;&lt; "Player is either not started or already is paused" &lt;&lt; std::endl;</span>
  }
<span style = "background-color:#fdd">}</span>

void mitk::NavigationDataPlayer::Resume()
<span style = "background-color:#fdd">{</span>
  // player is in pause mode -&gt; play at the last position
<span style = "background-color:#fdd">  if(m_CurPlayerState == PlayerPaused)</span>
  {
<span style = "background-color:#fdd">    m_CurPlayerState = PlayerRunning;</span>

    // in this case m_StartPlayingTimeStamp is set to the total elapsed time with NO playback
<span style = "background-color:#fdd">    m_StartPlayingTimeStamp = mitk::IGTTimeStamp::GetInstance()-&gt;GetElapsed()</span>
      - (m_PauseTimeStamp - m_StartPlayingTimeStamp);
<span style = "background-color:#fdd">  }</span>
  else
  {
<span style = "background-color:#fdd">    MITK_ERROR &lt;&lt; "Player is not paused!" &lt;&lt; std::endl;</span>
  }
<span style = "background-color:#fdd">}</span>

mitk::NavigationDataPlayer::PlayerState mitk::NavigationDataPlayer::GetCurrentPlayerState()
<span style = "background-color:#fdd">{
  return m_CurPlayerState;
}</span>

mitk::NavigationDataPlayer::TimeStampType mitk::NavigationDataPlayer::GetTimeStampSinceStart()
<span style = "background-color:#fdd">{
  return m_TimeStampSinceStart;
}</span></pre>
	</body>
</html>
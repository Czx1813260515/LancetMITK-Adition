<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkLabelSet.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkLabelSet.h"
#include "mitkDICOMSegmentationPropertyHelper.h"

#include &lt;itkCommand.h&gt;

<span style = "background-color:#fdd">mitk::LabelSet::LabelSet() : m_ActiveLabelValue(0), m_Layer(0)
{
  m_LookupTable = mitk::LookupTable::New();
  m_LookupTable-&gt;SetType(mitk::LookupTable::MULTILABEL);
}</span>

mitk::LabelSet::~LabelSet()
<span style = "background-color:#fdd">{
  m_LabelContainer.clear();
}</span>

mitk::LabelSet::LabelSet(const LabelSet &amp;other)
<span style = "background-color:#fdd">  : itk::Object(),
    m_LookupTable(other.GetLookupTable()-&gt;Clone()),
    m_ActiveLabelValue(other.GetActiveLabel()-&gt;GetValue()),
    m_Layer(other.GetLayer())
{</span>
  // clone Labels
<span style = "background-color:#fdd">  auto otherIt = other.IteratorConstBegin();
  for (; otherIt != other.IteratorConstEnd(); ++otherIt)</span>
  {
<span style = "background-color:#fdd">    m_LabelContainer[otherIt-&gt;first] = otherIt-&gt;second-&gt;Clone();</span>

<span style = "background-color:#fdd">    itk::SimpleMemberCommand&lt;LabelSet&gt;::Pointer command = itk::SimpleMemberCommand&lt;LabelSet&gt;::New();
    command-&gt;SetCallbackFunction(this, &amp;LabelSet::OnLabelModified);
    m_LabelContainer[otherIt-&gt;first]-&gt;AddObserver(itk::ModifiedEvent(), command);
  }
}</span>

void mitk::LabelSet::OnLabelModified()
<span style = "background-color:#fdd">{
  ModifyLabelEvent.Send();
  Superclass::Modified();
}</span>

mitk::LabelSet::LabelContainerConstIteratorType mitk::LabelSet::IteratorConstEnd() const
<span style = "background-color:#fdd">{
  return m_LabelContainer.end();
}</span>

mitk::LabelSet::LabelContainerConstIteratorType mitk::LabelSet::IteratorConstBegin() const
<span style = "background-color:#fdd">{
  return m_LabelContainer.begin();
}</span>

mitk::LabelSet::LabelContainerIteratorType mitk::LabelSet::IteratorEnd()
<span style = "background-color:#fdd">{
  return m_LabelContainer.end();
}</span>

mitk::LabelSet::LabelContainerIteratorType mitk::LabelSet::IteratorBegin()
<span style = "background-color:#fdd">{
  return m_LabelContainer.begin();
}</span>

unsigned int mitk::LabelSet::GetNumberOfLabels() const
<span style = "background-color:#fdd">{
  return m_LabelContainer.size();
}</span>

void mitk::LabelSet::SetLayer(unsigned int layer)
<span style = "background-color:#fdd">{
  m_Layer = layer;
  Modified();
}</span>

void mitk::LabelSet::SetActiveLabel(PixelType pixelValue)
<span style = "background-color:#fdd">{
  m_ActiveLabelValue = pixelValue;
  ActiveLabelEvent.Send(pixelValue);
  Modified();
}</span>

bool mitk::LabelSet::ExistLabel(PixelType pixelValue)
<span style = "background-color:#fdd">{
  return m_LabelContainer.count(pixelValue) &gt; 0 ? true : false;
}</span>

// TODO Parameter as Smartpointer
void mitk::LabelSet::AddLabel(mitk::Label *label)
<span style = "background-color:#fdd">{
  unsigned int max_size = mitk::Label::MAX_LABEL_VALUE + 1;
  if (m_LabelContainer.size() &gt;= max_size)
    return;</span>

<span style = "background-color:#fdd">  mitk::Label::Pointer newLabel(label-&gt;Clone());</span>

  // TODO use layer of label parameter
<span style = "background-color:#fdd">  newLabel-&gt;SetLayer(m_Layer);</span>

  PixelType pixelValue;
<span style = "background-color:#fdd">  if (m_LabelContainer.empty())</span>
  {
<span style = "background-color:#fdd">    pixelValue = newLabel-&gt;GetValue();
  }</span>
  else
  {
<span style = "background-color:#fdd">    pixelValue = m_LabelContainer.rbegin()-&gt;first;</span>

<span style = "background-color:#fdd">    if (pixelValue &gt;= newLabel-&gt;GetValue() &amp;&amp; m_LabelContainer.find(newLabel-&gt;GetValue()) != m_LabelContainer.end())</span>
    {
<span style = "background-color:#fdd">      ++pixelValue;
      newLabel-&gt;SetValue(pixelValue);
    }</span>
    else
    {
<span style = "background-color:#fdd">      pixelValue = newLabel-&gt;GetValue();</span>
    }
  }

  // new map entry
<span style = "background-color:#fdd">  m_LabelContainer[pixelValue] = newLabel;
  UpdateLookupTable(pixelValue);</span>

  // add DICOM information of the label
<span style = "background-color:#fdd">  DICOMSegmentationPropertyHelper::SetDICOMSegmentProperties(newLabel);</span>

<span style = "background-color:#fdd">  itk::SimpleMemberCommand&lt;LabelSet&gt;::Pointer command = itk::SimpleMemberCommand&lt;LabelSet&gt;::New();
  command-&gt;SetCallbackFunction(this, &amp;LabelSet::OnLabelModified);
  newLabel-&gt;AddObserver(itk::ModifiedEvent(), command);</span>
  // newLabel-&gt;AddObserver(itk::ModifiedEvent(),command);

<span style = "background-color:#fdd">  SetActiveLabel(newLabel-&gt;GetValue());
  AddLabelEvent.Send();
  Modified();
}</span>

void mitk::LabelSet::AddLabel(const std::string &amp;name, const mitk::Color &amp;color)
<span style = "background-color:#fdd">{
  mitk::Label::Pointer newLabel = mitk::Label::New();
  newLabel-&gt;SetName(name);
  newLabel-&gt;SetColor(color);
  AddLabel(newLabel);
}</span>

void mitk::LabelSet::RenameLabel(PixelType pixelValue, const std::string &amp;name, const mitk::Color &amp;color)
<span style = "background-color:#fdd">{
  mitk::Label *label = GetLabel(pixelValue);
  label-&gt;SetName(name);
  label-&gt;SetColor(color);</span>

  // change DICOM information of the label
<span style = "background-color:#fdd">  DICOMSegmentationPropertyHelper::SetDICOMSegmentProperties(label);
}</span>

void mitk::LabelSet::SetLookupTable(mitk::LookupTable *lut)
<span style = "background-color:#fdd">{
  m_LookupTable = lut;
  Modified();
}</span>

void mitk::LabelSet::PrintSelf(std::ostream &amp; /*os*/, itk::Indent /*indent*/) const
<span style = "background-color:#fdd">{
}</span>

void mitk::LabelSet::RemoveLabel(PixelType pixelValue)
<span style = "background-color:#fdd">{
  auto it = m_LabelContainer.rbegin();
  PixelType nextActivePixelValue = it-&gt;first;</span>

<span style = "background-color:#fdd">  for (; it != m_LabelContainer.rend(); ++it)</span>
  {
<span style = "background-color:#fdd">    if (it-&gt;first == pixelValue)</span>
    {
<span style = "background-color:#fdd">      it-&gt;second-&gt;RemoveAllObservers();
      m_LabelContainer.erase(pixelValue);
      break;</span>
    }
<span style = "background-color:#fdd">    nextActivePixelValue = it-&gt;first;
  }</span>

<span style = "background-color:#fdd">  if (m_ActiveLabelValue == pixelValue)</span>
  {
<span style = "background-color:#fdd">    if (ExistLabel(nextActivePixelValue))
      SetActiveLabel(nextActivePixelValue);</span>
    else
<span style = "background-color:#fdd">      SetActiveLabel(m_LabelContainer.rbegin()-&gt;first);</span>
  }

<span style = "background-color:#fdd">  RemoveLabelEvent.Send();</span>

<span style = "background-color:#fdd">  Modified();
}</span>

void mitk::LabelSet::RemoveAllLabels()
<span style = "background-color:#fdd">{
  auto _it = IteratorBegin();
  for (; _it != IteratorConstEnd();)</span>
  {
<span style = "background-color:#fdd">    RemoveLabelEvent.Send();
    m_LabelContainer.erase(_it++);
  }
  AllLabelsModifiedEvent.Send();
}</span>

void mitk::LabelSet::SetNextActiveLabel()
<span style = "background-color:#fdd">{
  auto it = m_LabelContainer.begin();</span>

<span style = "background-color:#fdd">  for (; it != m_LabelContainer.end(); ++it)</span>
  {
<span style = "background-color:#fdd">    if (it-&gt;first == m_ActiveLabelValue)</span>
    {
      // go to next label
<span style = "background-color:#fdd">      ++it;
      if (it == m_LabelContainer.end())</span>
      {
        // end of container; next label is first label
<span style = "background-color:#fdd">        it = m_LabelContainer.begin();</span>
      }
<span style = "background-color:#fdd">      break; // found the active label; finish loop</span>
    }
<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  SetActiveLabel(it-&gt;first);
}</span>

void mitk::LabelSet::SetAllLabelsLocked(bool value)
<span style = "background-color:#fdd">{
  auto _end = m_LabelContainer.end();
  auto _it = m_LabelContainer.begin();
  for (; _it != _end; ++_it)
    _it-&gt;second-&gt;SetLocked(value);
  AllLabelsModifiedEvent.Send();
  Modified();
}</span>

void mitk::LabelSet::SetAllLabelsVisible(bool value)
<span style = "background-color:#fdd">{
  auto _end = m_LabelContainer.end();
  auto _it = m_LabelContainer.begin();
  for (; _it != _end; ++_it)</span>
  {
<span style = "background-color:#fdd">    _it-&gt;second-&gt;SetVisible(value);
    UpdateLookupTable(_it-&gt;first);
  }
  AllLabelsModifiedEvent.Send();
  Modified();
}</span>

void mitk::LabelSet::UpdateLookupTable(PixelType pixelValue)
<span style = "background-color:#fdd">{
  const mitk::Color &amp;color = GetLabel(pixelValue)-&gt;GetColor();</span>

  double rgba[4];
<span style = "background-color:#fdd">  m_LookupTable-&gt;GetTableValue(static_cast&lt;int&gt;(pixelValue), rgba);
  rgba[0] = color.GetRed();
  rgba[1] = color.GetGreen();
  rgba[2] = color.GetBlue();
  if (GetLabel(pixelValue)-&gt;GetVisible())
    rgba[3] = GetLabel(pixelValue)-&gt;GetOpacity();</span>
  else
<span style = "background-color:#fdd">    rgba[3] = 0.0;
  m_LookupTable-&gt;SetTableValue(static_cast&lt;int&gt;(pixelValue), rgba);
}</span>

mitk::Label *mitk::LabelSet::GetLabel(PixelType pixelValue)
<span style = "background-color:#fdd">{
  if (m_LabelContainer.find(pixelValue) == m_LabelContainer.end())
    return nullptr;
  return m_LabelContainer[pixelValue];
}</span>

const mitk::Label *mitk::LabelSet::GetLabel(PixelType pixelValue) const
<span style = "background-color:#fdd">{
  auto it = m_LabelContainer.find(pixelValue);
  if (it == m_LabelContainer.end())
    return nullptr;
  return it-&gt;second.GetPointer();
}</span>

bool mitk::Equal(const mitk::LabelSet &amp;leftHandSide, const mitk::LabelSet &amp;rightHandSide, ScalarType eps, bool verbose)
<span style = "background-color:#fdd">{
  bool returnValue = true;</span>
  // LabelSetmembers

<span style = "background-color:#fdd">  MITK_INFO(verbose) &lt;&lt; "--- LabelSet Equal ---";</span>

  // m_LookupTable;
<span style = "background-color:#fdd">  const mitk::LookupTable *lhsLUT = leftHandSide.GetLookupTable();
  const mitk::LookupTable *rhsLUT = rightHandSide.GetLookupTable();</span>

<span style = "background-color:#fdd">  returnValue = *lhsLUT == *rhsLUT;
  if (!returnValue)</span>
  {
<span style = "background-color:#fdd">    MITK_INFO(verbose) &lt;&lt; "Lookup tabels not equal.";
    return returnValue;</span>
    ;
  }

  // m_ActiveLabel;
<span style = "background-color:#fdd">  returnValue = mitk::Equal(*leftHandSide.GetActiveLabel(), *rightHandSide.GetActiveLabel(), eps, verbose);
  if (!returnValue)</span>
  {
<span style = "background-color:#fdd">    MITK_INFO(verbose) &lt;&lt; "Active label not equal.";
    return returnValue;</span>
    ;
  }

  // m_Layer;
<span style = "background-color:#fdd">  returnValue = leftHandSide.GetLayer() == rightHandSide.GetLayer();
  if (!returnValue)</span>
  {
<span style = "background-color:#fdd">    MITK_INFO(verbose) &lt;&lt; "Layer index not equal.";
    return returnValue;</span>
    ;
  }

  // container size;
<span style = "background-color:#fdd">  returnValue = leftHandSide.GetNumberOfLabels() == rightHandSide.GetNumberOfLabels();
  if (!returnValue)</span>
  {
<span style = "background-color:#fdd">    MITK_INFO(verbose) &lt;&lt; "Number of labels not equal.";
    return returnValue;</span>
    ;
  }

  // Label container (map)

  // m_LabelContainer;
<span style = "background-color:#fdd">  auto lhsit = leftHandSide.IteratorConstBegin();
  auto rhsit = rightHandSide.IteratorConstBegin();
  for (; lhsit != leftHandSide.IteratorConstEnd(); ++lhsit, ++rhsit)</span>
  {
<span style = "background-color:#fdd">    returnValue = rhsit-&gt;first == lhsit-&gt;first;
    if (!returnValue)</span>
    {
<span style = "background-color:#fdd">      MITK_INFO(verbose) &lt;&lt; "Label in label container not equal.";
      return returnValue;</span>
      ;
    }

<span style = "background-color:#fdd">    returnValue = mitk::Equal(*(rhsit-&gt;second), *(lhsit-&gt;second), eps, verbose);
    if (!returnValue)</span>
    {
<span style = "background-color:#fdd">      MITK_INFO(verbose) &lt;&lt; "Label in label container not equal.";
      return returnValue;</span>
      ;
    }
<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  return returnValue;
}</span></pre>
	</body>
</html>
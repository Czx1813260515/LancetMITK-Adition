<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkIGTLMessageSource.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkIGTLMessageSource.h"
#include "mitkUIDGenerator.h"

//Microservices
#include &lt;usGetModuleContext.h&gt;
#include &lt;usModule.h&gt;
#include &lt;usServiceProperties.h&gt;
#include &lt;usModuleContext.h&gt;

<span style = "background-color:#dfd">const std::string mitk::IGTLMessageSource::US_INTERFACE_NAME =
    "org.mitk.services.IGTLMessageSource";</span>
const std::string mitk::IGTLMessageSource::US_PROPKEY_DEVICENAME =
<span style = "background-color:#dfd">    US_INTERFACE_NAME + ".devicename";</span>
const std::string mitk::IGTLMessageSource::US_PROPKEY_DEVICETYPE =
<span style = "background-color:#dfd">    US_INTERFACE_NAME + ".devicetype";</span>
const std::string mitk::IGTLMessageSource::US_PROPKEY_ID =
<span style = "background-color:#dfd">    US_INTERFACE_NAME + ".id";</span>
const std::string mitk::IGTLMessageSource::US_PROPKEY_ISACTIVE =
<span style = "background-color:#dfd">    US_INTERFACE_NAME + ".isActive";</span>

mitk::IGTLMessageSource::IGTLMessageSource()
<span style = "background-color:#fdd">  : itk::ProcessObject(), m_Name("IGTLMessageSource (no defined type)"),
    m_Type("NONE"), m_StreamingFPS(0)
{
}</span>

mitk::IGTLMessageSource::~IGTLMessageSource()
<span style = "background-color:#fdd">{</span>
  //this-&gt;UnRegisterMicroservice();
<span style = "background-color:#fdd">}</span>

mitk::IGTLMessage* mitk::IGTLMessageSource::GetOutput()
<span style = "background-color:#fdd">{
  if (this-&gt;GetNumberOfIndexedOutputs() &lt; 1)</span>
  {
<span style = "background-color:#fdd">    MITK_WARN &lt;&lt; "IGTLMessageSource contained no outputs. Returning nullptr.";
    return nullptr;</span>
  }

<span style = "background-color:#fdd">  return static_cast&lt;IGTLMessage*&gt;(this-&gt;ProcessObject::GetPrimaryOutput());
}</span>

mitk::IGTLMessage* mitk::IGTLMessageSource::GetOutput(
    DataObjectPointerArraySizeType idx)
<span style = "background-color:#fdd">{
  IGTLMessage* out =</span>
      dynamic_cast&lt;IGTLMessage*&gt;( this-&gt;ProcessObject::GetOutput(idx) );
<span style = "background-color:#fdd">  if ( out == nullptr &amp;&amp; this-&gt;ProcessObject::GetOutput(idx) != nullptr )</span>
  {
<span style = "background-color:#fdd">    itkWarningMacro (&lt;&lt; "Unable to convert output number " &lt;&lt; idx &lt;&lt; " to type "</span>
                     &lt;&lt;  typeid( IGTLMessage ).name () );
  }
<span style = "background-color:#fdd">  return out;
}</span>

mitk::IGTLMessage* mitk::IGTLMessageSource::GetOutput(
    const std::string&amp; messageName)
<span style = "background-color:#fdd">{
  DataObjectPointerArray outputs = this-&gt;GetOutputs();
  for (DataObjectPointerArray::iterator it = outputs.begin();
       it != outputs.end();
       ++it)</span>
  {
<span style = "background-color:#fdd">    if (messageName ==</span>
        (static_cast&lt;IGTLMessage*&gt;(it-&gt;GetPointer()))-&gt;GetName())
    {
<span style = "background-color:#fdd">      return static_cast&lt;IGTLMessage*&gt;(it-&gt;GetPointer());
    }
  }
  return nullptr;
}</span>

itk::ProcessObject::DataObjectPointerArraySizeType
mitk::IGTLMessageSource::GetOutputIndex( std::string messageName )
<span style = "background-color:#fdd">{
  DataObjectPointerArray outputs = this-&gt;GetOutputs();
  for (DataObjectPointerArray::size_type i = 0; i &lt; outputs.size(); ++i)</span>
  {
<span style = "background-color:#fdd">    if (messageName ==</span>
        (static_cast&lt;IGTLMessage*&gt;(outputs.at(i).GetPointer()))-&gt;GetName())
    {
<span style = "background-color:#fdd">      return i;</span>
    }
<span style = "background-color:#fdd">  }
  throw std::invalid_argument("output name does not exist");
}</span>

void mitk::IGTLMessageSource::RegisterAsMicroservice()
<span style = "background-color:#fdd">{</span>
  // Get Context
<span style = "background-color:#fdd">  us::ModuleContext* context = us::GetModuleContext();</span>

  // Define ServiceProps
<span style = "background-color:#fdd">  us::ServiceProperties props;
  mitk::UIDGenerator uidGen =</span>
      mitk::UIDGenerator ("org.mitk.services.IGTLMessageSource.id_");
<span style = "background-color:#fdd">  props[ US_PROPKEY_ID ] = uidGen.GetUID();
  props[ US_PROPKEY_DEVICENAME ] = m_Name;
  props[ US_PROPKEY_DEVICETYPE ] = m_Type;
  m_ServiceRegistration = context-&gt;RegisterService(this, props);
}</span>

void mitk::IGTLMessageSource::UnRegisterMicroservice()
<span style = "background-color:#fdd">{
  if (m_ServiceRegistration != nullptr)</span>
  {
<span style = "background-color:#fdd">    m_ServiceRegistration.Unregister();</span>
  }
<span style = "background-color:#fdd">  m_ServiceRegistration = 0;
}</span>

std::string mitk::IGTLMessageSource::GetMicroserviceID()
<span style = "background-color:#fdd">{
  us::Any referenceProperty =</span>
      this-&gt;m_ServiceRegistration.GetReference().GetProperty(US_PROPKEY_ID);
<span style = "background-color:#fdd">  return referenceProperty.ToString();
}</span>

void mitk::IGTLMessageSource::GraftOutput(itk::DataObject *graft)
<span style = "background-color:#fdd">{
  this-&gt;GraftNthOutput(0, graft);
}</span>

void mitk::IGTLMessageSource::GraftNthOutput(unsigned int idx,
                                             itk::DataObject *graft)
<span style = "background-color:#fdd">{
  if ( idx &gt;= this-&gt;GetNumberOfIndexedOutputs() )</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro(&lt;&lt;"Requested to graft output " &lt;&lt; idx &lt;&lt; " but this filter"</span>
                "only has " &lt;&lt; this-&gt;GetNumberOfIndexedOutputs() &lt;&lt; " Outputs.");
  }

<span style = "background-color:#fdd">  if ( !graft )</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro(&lt;&lt;"Requested to graft output with a nullptr pointer object" );</span>
  }

<span style = "background-color:#fdd">  itk::DataObject* output = this-&gt;GetOutput(idx);
  if ( !output )</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro(&lt;&lt;"Requested to graft output that is a nullptr pointer" );</span>
  }
  // Call Graft on IGTLMessage to copy member data
<span style = "background-color:#fdd">  output-&gt;Graft( graft );
}</span>

itk::DataObject::Pointer mitk::IGTLMessageSource::MakeOutput ( DataObjectPointerArraySizeType /*idx*/ )
<span style = "background-color:#fdd">{
  return IGTLMessage::New().GetPointer();
}</span>

itk::DataObject::Pointer mitk::IGTLMessageSource::MakeOutput( const DataObjectIdentifierType &amp; name )
<span style = "background-color:#fdd">{
  itkDebugMacro("MakeOutput(" &lt;&lt; name &lt;&lt; ")");
  if( this-&gt;IsIndexedOutputName(name) )</span>
  {
<span style = "background-color:#fdd">    return this-&gt;MakeOutput( this-&gt;MakeIndexFromOutputName(name) );</span>
  }
<span style = "background-color:#fdd">  return static_cast&lt;itk::DataObject *&gt;(IGTLMessage::New().GetPointer());
}</span>

mitk::PropertyList::ConstPointer mitk::IGTLMessageSource::GetParameters() const
<span style = "background-color:#fdd">{
  mitk::PropertyList::Pointer p = mitk::PropertyList::New();</span>
  // add properties to p like this:
  //p-&gt;SetProperty("MyFilter_MyParameter", mitk::PropertyDataType::New(m_MyParameter));
<span style = "background-color:#fdd">  return mitk::PropertyList::ConstPointer(p);
}</span>

void mitk::IGTLMessageSource::SetFPS(unsigned int fps)
<span style = "background-color:#fdd">{
  this-&gt;m_StreamingFPSMutex.lock();
  this-&gt;m_StreamingFPS = fps;
  this-&gt;m_StreamingFPSMutex.unlock();
}</span>


unsigned int mitk::IGTLMessageSource::GetFPS()
<span style = "background-color:#fdd">{
  unsigned int fps = 0;
  this-&gt;m_StreamingFPSMutex.lock();
  fps = this-&gt;m_StreamingFPS;
  this-&gt;m_StreamingFPSMutex.unlock();
  return fps;
}</span></pre>
	</body>
</html>
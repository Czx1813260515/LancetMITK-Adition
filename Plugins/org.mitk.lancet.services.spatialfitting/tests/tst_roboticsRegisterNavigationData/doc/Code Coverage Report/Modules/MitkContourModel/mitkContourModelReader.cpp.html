<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkContourModelReader.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkContourModelReader.h"
#include &lt;fstream&gt;
#include &lt;iostream&gt;
#include &lt;regex&gt;
#include &lt;mitkCustomMimeType.h&gt;
#include &lt;mitkLocaleSwitch.h&gt;
#include &lt;tinyxml2.h&gt;

namespace
{
  // Previous versions of the ContourModelSetWriter produced flawed
  // XML files with multiple XML declarations.
  std::string RemoveErroneousXMLDeclarations(const std::string&amp; filename)
<span style = "background-color:#fdd">  {
    std::ifstream file(filename);
    file.seekg(0, std::ios_base::end);
    auto size = file.tellg();
    std::string string(size, '\0');
    file.seekg(0);
    file.read(&amp;string[0], size);
    file.close();
    std::regex regex("&gt;&lt;\\?xml.+\\?&gt;");
    return std::regex_replace(string, regex, "&gt;");
  }</span>
}

<span style = "background-color:#fdd">mitk::ContourModelReader::ContourModelReader(const mitk::ContourModelReader &amp;other) : mitk::AbstractFileReader(other)
{
}</span>

<span style = "background-color:#dfd">mitk::ContourModelReader::ContourModelReader() : AbstractFileReader()
{
  std::string category = "Contour File";
  mitk::CustomMimeType customMimeType;
  customMimeType.SetCategory(category);
  customMimeType.AddExtension("cnt");</span>

<span style = "background-color:#dfd">  this-&gt;SetDescription(category);
  this-&gt;SetMimeType(customMimeType);</span>

<span style = "background-color:#dfd">  m_ServiceReg = this-&gt;RegisterService();
}</span>

mitk::ContourModelReader::~ContourModelReader()
<span style = "background-color:#dfd">{
}</span>

std::vector&lt;itk::SmartPointer&lt;mitk::BaseData&gt;&gt; mitk::ContourModelReader::DoRead()
<span style = "background-color:#fdd">{
  std::vector&lt;itk::SmartPointer&lt;mitk::BaseData&gt;&gt; result;
  std::string location = GetInputLocation();</span>

  // Switch the current locale to "C"
<span style = "background-color:#fdd">  LocaleSwitch localeSwitch("C");</span>

  try
  {
<span style = "background-color:#fdd">    auto string = RemoveErroneousXMLDeclarations(location);</span>

<span style = "background-color:#fdd">    tinyxml2::XMLDocument doc;
    if (tinyxml2::XML_SUCCESS == doc.Parse(string.c_str()))</span>
    {
<span style = "background-color:#fdd">      tinyxml2::XMLHandle docHandle(&amp;doc);</span>

      /*++++ handle n contourModels within data tags ++++*/
<span style = "background-color:#fdd">      for (auto *currentContourElement = docHandle.FirstChildElement("contourModel").ToElement();
           currentContourElement != nullptr;
           currentContourElement = currentContourElement-&gt;NextSiblingElement())</span>
      {
<span style = "background-color:#fdd">        mitk::ContourModel::Pointer newContourModel = mitk::ContourModel::New();
        if (currentContourElement-&gt;FirstChildElement("data")-&gt;FirstChildElement("timestep") != nullptr)</span>
        {
          /*++++ handle n timesteps within timestep tags ++++*/
<span style = "background-color:#fdd">          for (auto *currentTimeSeries =</span>
                 currentContourElement-&gt;FirstChildElement("data")-&gt;FirstChildElement("timestep")-&gt;ToElement();
<span style = "background-color:#fdd">               currentTimeSeries != nullptr;
               currentTimeSeries = currentTimeSeries-&gt;NextSiblingElement())</span>
          {
<span style = "background-color:#fdd">            unsigned int currentTimeStep(0);</span>

<span style = "background-color:#fdd">            currentTimeStep = atoi(currentTimeSeries-&gt;Attribute("n"));</span>

<span style = "background-color:#fdd">            this-&gt;ReadPoints(newContourModel, currentTimeSeries, currentTimeStep);</span>

            int isClosed;
<span style = "background-color:#fdd">            currentTimeSeries-&gt;QueryIntAttribute("isClosed", &amp;isClosed);
            if (isClosed)</span>
            {
<span style = "background-color:#fdd">              newContourModel-&gt;Close(currentTimeStep);</span>
            }
<span style = "background-color:#fdd">          }</span>
          /*++++ END handle n timesteps within timestep tags ++++*/
<span style = "background-color:#fdd">        }</span>
        else
        {
          // this should not happen
<span style = "background-color:#fdd">          MITK_WARN &lt;&lt; "wrong file format!";</span>
          // newContourModel = this-&gt;ReadPoint(newContourModel, currentContourElement, 0);
        }
<span style = "background-color:#fdd">        newContourModel-&gt;UpdateOutputInformation();
        result.push_back(dynamic_cast&lt;mitk::BaseData *&gt;(newContourModel.GetPointer()));
      }</span>
      /*++++ END handle n contourModels within data tags ++++*/
<span style = "background-color:#fdd">    }</span>
    else
    {
<span style = "background-color:#fdd">      MITK_WARN &lt;&lt; "XML parser error!";</span>
    }
<span style = "background-color:#fdd">  }</span>
  catch (...)
<span style = "background-color:#fdd">  {
    MITK_ERROR &lt;&lt; "Cannot read contourModel.";
  }</span>

<span style = "background-color:#fdd">  return result;
}</span>

mitk::ContourModelReader *mitk::ContourModelReader::Clone() const
<span style = "background-color:#fdd">{
  return new ContourModelReader(*this);
}</span>

void mitk::ContourModelReader::ReadPoints(mitk::ContourModel::Pointer newContourModel,
                                          const tinyxml2::XMLElement *currentTimeSeries,
                                          unsigned int currentTimeStep)
<span style = "background-color:#fdd">{</span>
  // check if the timesteps in contourModel have to be expanded
<span style = "background-color:#fdd">  if (currentTimeStep != newContourModel-&gt;GetTimeSteps())</span>
  {
<span style = "background-color:#fdd">    newContourModel-&gt;Expand(currentTimeStep + 1);</span>
  }

  // read all points within controlPoints tag
<span style = "background-color:#fdd">  if (currentTimeSeries-&gt;FirstChildElement("controlPoints")-&gt;FirstChildElement("point") != nullptr)</span>
  {
<span style = "background-color:#fdd">    for (auto *currentPoint =</span>
           currentTimeSeries-&gt;FirstChildElement("controlPoints")-&gt;FirstChildElement("point")-&gt;ToElement();
<span style = "background-color:#fdd">         currentPoint != nullptr;
         currentPoint = currentPoint-&gt;NextSiblingElement())</span>
    {
<span style = "background-color:#fdd">      double x(0.0);
      double y(0.0);
      double z(0.0);</span>

<span style = "background-color:#fdd">      x = atof(currentPoint-&gt;FirstChildElement("x")-&gt;GetText());
      y = atof(currentPoint-&gt;FirstChildElement("y")-&gt;GetText());
      z = atof(currentPoint-&gt;FirstChildElement("z")-&gt;GetText());</span>

      int isActivePoint;
<span style = "background-color:#fdd">      currentPoint-&gt;QueryIntAttribute("isActive", &amp;isActivePoint);</span>

<span style = "background-color:#fdd">      mitk::Point3D point;
      mitk::FillVector3D(point, x, y, z);
      newContourModel-&gt;AddVertex(point, isActivePoint, currentTimeStep);
    }</span>
  }
  else
  {
    // nothing to read
  }
<span style = "background-color:#fdd">}</span></pre>
	</body>
</html>
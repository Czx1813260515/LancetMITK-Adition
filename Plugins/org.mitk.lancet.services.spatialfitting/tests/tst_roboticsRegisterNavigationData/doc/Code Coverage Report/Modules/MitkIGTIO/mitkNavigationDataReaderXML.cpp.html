<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkNavigationDataReaderXML.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

// MITK
#include "mitkNavigationDataReaderXML.h"
#include &lt;mitkIGTMimeTypes.h&gt;
#include &lt;mitkLocaleSwitch.h&gt;

// Third Party
#include &lt;itksys/SystemTools.hxx&gt;
#include &lt;fstream&gt;
#include &lt;tinyxml2.h&gt;

namespace
{
  mitk::NavigationData::Pointer ReadNavigationData(const tinyxml2::XMLElement* ndElem)
<span style = "background-color:#fdd">  {
    if (nullptr == ndElem)
      return nullptr;</span>

<span style = "background-color:#fdd">    mitk::NavigationData::TimeStampType timeStamp = -1;</span>

<span style = "background-color:#fdd">    ndElem-&gt;QueryDoubleAttribute("Time", &amp;timeStamp);</span>

<span style = "background-color:#fdd">    if (-1 == timeStamp)
      return nullptr;</span>

<span style = "background-color:#fdd">    mitk::NavigationData::PositionType position;
    position.Fill(0.0);</span>

<span style = "background-color:#fdd">    ndElem-&gt;QueryDoubleAttribute("X", &amp;position[0]);
    ndElem-&gt;QueryDoubleAttribute("Y", &amp;position[1]);
    ndElem-&gt;QueryDoubleAttribute("Z", &amp;position[2]);</span>

    mitk::NavigationData::OrientationType orientation;

<span style = "background-color:#fdd">    ndElem-&gt;QueryDoubleAttribute("QX", &amp;orientation[0]);
    ndElem-&gt;QueryDoubleAttribute("QY", &amp;orientation[1]);
    ndElem-&gt;QueryDoubleAttribute("QZ", &amp;orientation[2]);
    ndElem-&gt;QueryDoubleAttribute("QR", &amp;orientation[3]);</span>

<span style = "background-color:#fdd">    mitk::NavigationData::CovarianceMatrixType matrix;
    matrix.SetIdentity();</span>

<span style = "background-color:#fdd">    ndElem-&gt;QueryDoubleAttribute("C00", &amp;matrix[0][0]);
    ndElem-&gt;QueryDoubleAttribute("C01", &amp;matrix[0][1]);
    ndElem-&gt;QueryDoubleAttribute("C02", &amp;matrix[0][2]);
    ndElem-&gt;QueryDoubleAttribute("C03", &amp;matrix[0][3]);
    ndElem-&gt;QueryDoubleAttribute("C04", &amp;matrix[0][4]);
    ndElem-&gt;QueryDoubleAttribute("C05", &amp;matrix[0][5]);
    ndElem-&gt;QueryDoubleAttribute("C10", &amp;matrix[1][0]);
    ndElem-&gt;QueryDoubleAttribute("C11", &amp;matrix[1][1]);
    ndElem-&gt;QueryDoubleAttribute("C12", &amp;matrix[1][2]);
    ndElem-&gt;QueryDoubleAttribute("C13", &amp;matrix[1][3]);
    ndElem-&gt;QueryDoubleAttribute("C14", &amp;matrix[1][4]);
    ndElem-&gt;QueryDoubleAttribute("C15", &amp;matrix[1][5]);</span>

<span style = "background-color:#fdd">    int attrib = 0;
    ndElem-&gt;QueryIntAttribute("Valid", &amp;attrib);
    bool isValid = 0 != attrib;</span>

<span style = "background-color:#fdd">    attrib = 0;
    ndElem-&gt;QueryIntAttribute("hP", &amp;attrib);
    bool hasPosition = 0 != attrib;</span>

<span style = "background-color:#fdd">    attrib = 0;
    ndElem-&gt;QueryIntAttribute("hO", &amp;attrib);
    bool hasOrientation = 0 != attrib;</span>

<span style = "background-color:#fdd">    auto navData = mitk::NavigationData::New();</span>

<span style = "background-color:#fdd">    navData-&gt;SetIGTTimeStamp(timeStamp);
    navData-&gt;SetPosition(position);
    navData-&gt;SetOrientation(orientation);
    navData-&gt;SetCovErrorMatrix(matrix);
    navData-&gt;SetDataValid(isValid);
    navData-&gt;SetHasPosition(hasPosition);
    navData-&gt;SetHasOrientation(hasOrientation);</span>

<span style = "background-color:#fdd">    return navData;
  }</span>
}

mitk::NavigationDataReaderXML::NavigationDataReaderXML()
<span style = "background-color:#dfd">  : AbstractFileReader(IGTMimeTypes::NAVIGATIONDATASETXML_MIMETYPE(), "MITK NavigationData Reader (XML)")
{
  this-&gt;RegisterService();
}</span>

mitk::NavigationDataReaderXML::~NavigationDataReaderXML()
<span style = "background-color:#dfd">{
}</span>

mitk::NavigationDataReaderXML::NavigationDataReaderXML(const mitk::NavigationDataReaderXML&amp; other)
<span style = "background-color:#fdd">  : AbstractFileReader(other)
{
}</span>

mitk::NavigationDataReaderXML* mitk::NavigationDataReaderXML::Clone() const
<span style = "background-color:#fdd">{
  return new NavigationDataReaderXML(*this);
}</span>

std::vector&lt;itk::SmartPointer&lt;mitk::BaseData&gt;&gt; mitk::NavigationDataReaderXML::DoRead()
<span style = "background-color:#fdd">{
  mitk::NavigationDataSet::Pointer dataset = nullptr == this-&gt;GetInputStream()</span>
    ? this-&gt;Read(this-&gt;GetInputLocation())
    : this-&gt;Read(*this-&gt;GetInputStream());

<span style = "background-color:#fdd">  std::vector&lt;mitk::BaseData::Pointer&gt; result;
  result.emplace_back(dataset.GetPointer());</span>

<span style = "background-color:#fdd">  return result;
}</span>

mitk::NavigationDataSet::Pointer mitk::NavigationDataReaderXML::Read(const std::string&amp; fileName)
<span style = "background-color:#fdd">{
  std::ifstream stream(fileName);
  stream.imbue(std::locale::classic());</span>

<span style = "background-color:#fdd">  return this-&gt;Read(stream);
}</span>

mitk::NavigationDataSet::Pointer mitk::NavigationDataReaderXML::Read(std::istream&amp; stream)
<span style = "background-color:#fdd">{
  std::string string(std::istreambuf_iterator&lt;char&gt;(stream), {});
  tinyxml2::XMLDocument doc;</span>

<span style = "background-color:#fdd">  if (tinyxml2::XML_SUCCESS != doc.Parse(string.c_str()))
    mitkThrowException(IGTIOException) &lt;&lt; "Could not parse stream.";</span>

<span style = "background-color:#fdd">  const auto* rootElem = doc.RootElement();
  decltype(rootElem) dataElem = nullptr;</span>

<span style = "background-color:#fdd">  if (nullptr == rootElem)
    return nullptr;</span>

<span style = "background-color:#fdd">  int version = 0;
  auto err = tinyxml2::XML_SUCCESS;</span>
    
<span style = "background-color:#fdd">  std::string rootElemVal = rootElem-&gt;Value();</span>

<span style = "background-color:#fdd">  if ("Version" == rootElemVal)</span>
  {
<span style = "background-color:#fdd">    err = rootElem-&gt;QueryIntAttribute("Ver", &amp;version);
    dataElem = rootElem-&gt;NextSiblingElement("Data");
  }
  else if ("Data" == rootElemVal)</span>
  {
<span style = "background-color:#fdd">    err = rootElem-&gt;QueryIntAttribute("version", &amp;version);
    dataElem = rootElem;</span>
  }

<span style = "background-color:#fdd">  if (err != tinyxml2::XML_SUCCESS)
    mitkThrowException(IGTIOException) &lt;&lt; "Could not parse file format version.";</span>

<span style = "background-color:#fdd">  if (version != 1)
    mitkThrowException(IGTIOException) &lt;&lt; "File format version " &lt;&lt; version &lt;&lt; " is not supported.";</span>

<span style = "background-color:#fdd">  if (nullptr == dataElem)
    mitkThrowException(IGTIOException) &lt;&lt; "Data element not found.";</span>

<span style = "background-color:#fdd">  int toolCount = 0;</span>

<span style = "background-color:#fdd">  if (tinyxml2::XML_SUCCESS != dataElem-&gt;QueryIntAttribute("ToolCount", &amp;toolCount))
    mitkThrowException(IGTIOException) &lt;&lt; "ToolCount attribute missing from Data element.";</span>

<span style = "background-color:#fdd">  if (0 &gt;= toolCount)
    mitkThrowException(IGTIOException) &lt;&lt; "Invalid ToolCount: " &lt;&lt; toolCount &lt;&lt; ".";</span>

<span style = "background-color:#fdd">  auto navDataSet = NavigationDataSet::New(static_cast&lt;unsigned int&gt;(toolCount));
  NavigationData::Pointer navData;</span>

<span style = "background-color:#fdd">  const auto* ndElem = dataElem-&gt;FirstChildElement();</span>

<span style = "background-color:#fdd">  if (nullptr != ndElem)</span>
  {
    do
    {
<span style = "background-color:#fdd">      std::vector&lt;NavigationData::Pointer&gt; navDatas(toolCount);</span>

<span style = "background-color:#fdd">      for (decltype(toolCount) i = 0; i &lt; toolCount; ++i)</span>
      {
<span style = "background-color:#fdd">        navData = ReadNavigationData(ndElem);</span>

<span style = "background-color:#fdd">        if (navData.IsNull())</span>
        {
<span style = "background-color:#fdd">          if (0 != i)
            MITK_WARN("mitkNavigationDataReaderXML") &lt;&lt; "Different number of NavigationData objects for different tools. Ignoring last ones.";</span>

<span style = "background-color:#fdd">          break;</span>
        }

<span style = "background-color:#fdd">        navDatas[i] = navData;
        ndElem = ndElem-&gt;NextSiblingElement();
      }</span>

<span style = "background-color:#fdd">      if (navData.IsNotNull())
        navDataSet-&gt;AddNavigationDatas(navDatas);</span>

<span style = "background-color:#fdd">    } while (nullptr != ndElem &amp;&amp; navData.IsNotNull());</span>
  }

<span style = "background-color:#fdd">  return navDataSet;
}</span></pre>
	</body>
</html>
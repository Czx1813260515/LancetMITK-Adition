<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkPixelBasedParameterFitImageGenerator.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "itkCommand.h"
#include "itkMultiOutputNaryFunctorImageFilter.h"

#include "mitkPixelBasedParameterFitImageGenerator.h"
#include "mitkImageTimeSelector.h"
#include "mitkImageAccessByItk.h"
#include "mitkImageCast.h"
#include "mitkModelFitFunctorPolicy.h"

#include "mitkExtractTimeGrid.h"

void
  mitk::PixelBasedParameterFitImageGenerator::
  onFitProgressEvent(::itk::Object* caller, const ::itk::EventObject&amp; /*eventObject*/)
<span style = "background-color:#fdd">{
  this-&gt;InvokeEvent(::itk::ProgressEvent());</span>

<span style = "background-color:#fdd">  auto* process = dynamic_cast&lt;itk::ProcessObject*&gt;(caller);
  if (process)</span>
  {
<span style = "background-color:#fdd">    this-&gt;m_Progress = process-&gt;GetProgress();</span>
  }
<span style = "background-color:#fdd">};</span>

template &lt;typename TPixel, unsigned int VDim&gt;
void
  mitk::PixelBasedParameterFitImageGenerator::DoPrepareMask(itk::Image&lt;TPixel, VDim&gt;* image)
<span style = "background-color:#fdd">{
  m_InternalMask = dynamic_cast&lt;InternalMaskType*&gt;(image);</span>

<span style = "background-color:#fdd">  if (m_InternalMask.IsNull())</span>
  {
<span style = "background-color:#fdd">    MITK_INFO &lt;&lt; "Parameter Fit Generator. Need to cast mask for parameter fit.";</span>
    using InputImageType = itk::Image&lt;TPixel, VDim&gt;;
    using CastFilterType = itk::CastImageFilter&lt; InputImageType, InternalMaskType &gt;;
<span style = "background-color:#fdd">    typename CastFilterType::Pointer  spImageCaster =  CastFilterType::New();</span>

<span style = "background-color:#fdd">    spImageCaster-&gt;SetInput(image);</span>

<span style = "background-color:#fdd">    m_InternalMask = spImageCaster-&gt;GetOutput();
    spImageCaster-&gt;Update();
  }
}</span>

template&lt;typename TImage&gt;
mitk::PixelBasedParameterFitImageGenerator::ParameterImageMapType StoreResultImages( mitk::ModelFitFunctorBase::ParameterNamesType &amp;paramNames, itk::ImageSource&lt;TImage&gt;* source, mitk::ModelFitFunctorBase::ParameterNamesType::size_type startPos, mitk::ModelFitFunctorBase::ParameterNamesType::size_type&amp; endPos )
<span style = "background-color:#fdd">{
  mitk::PixelBasedParameterFitImageGenerator::ParameterImageMapType result;
  for (mitk::ModelFitFunctorBase::ParameterNamesType::size_type j = 0; j &lt; paramNames.size(); ++j)</span>
  {
<span style = "background-color:#fdd">    if (source-&gt;GetNumberOfOutputs() &lt; startPos+j)</span>
    {
<span style = "background-color:#fdd">      mitkThrow() &lt;&lt; "Error while generating fitted parameter images. Number of sources is too low and does not match expected parameter number. Output size: "&lt;&lt; source-&gt;GetNumberOfOutputs()&lt;&lt;"; number of param names: "&lt;&lt;paramNames.size()&lt;&lt;";source start pos: " &lt;&lt; startPos;</span>
    }

<span style = "background-color:#fdd">    mitk::Image::Pointer paramImage = mitk::Image::New();
    typename TImage::ConstPointer outputImg = source-&gt;GetOutput(startPos+j);
    mitk::CastToMitkImage(outputImg, paramImage);</span>

<span style = "background-color:#fdd">    result.insert(std::make_pair(paramNames[j],paramImage));
  }</span>

<span style = "background-color:#fdd">  endPos = startPos + paramNames.size();</span>

<span style = "background-color:#fdd">  return result;
}</span>

template &lt;typename TPixel, unsigned int VDim&gt;
void
  mitk::PixelBasedParameterFitImageGenerator::DoParameterFit(itk::Image&lt;TPixel, VDim&gt;* /*image*/)
<span style = "background-color:#fdd">{</span>
  using InputFrameImageType = itk::Image&lt;TPixel, VDim-1&gt;;
  using ParameterImageType = itk::Image&lt;ScalarType, VDim-1&gt;;

  using FitFilterType = itk::MultiOutputNaryFunctorImageFilter&lt;InputFrameImageType, ParameterImageType, ModelFitFunctorPolicy, InternalMaskType&gt;;

<span style = "background-color:#fdd">  typename FitFilterType::Pointer fitFilter = FitFilterType::New();</span>

<span style = "background-color:#fdd">  typename ::itk::MemberCommand&lt;Self&gt;::Pointer spProgressCommand = ::itk::MemberCommand&lt;Self&gt;::New();
  spProgressCommand-&gt;SetCallbackFunction(this, &amp;Self::onFitProgressEvent);
  fitFilter-&gt;AddObserver(::itk::ProgressEvent(), spProgressCommand);</span>

  //add the time frames to the fit filter
<span style = "background-color:#fdd">  mitk::ImageTimeSelector::Pointer imageTimeSelector = mitk::ImageTimeSelector::New();
  imageTimeSelector-&gt;SetInput(this-&gt;m_DynamicImage);
  std::vector&lt;Image::Pointer&gt; frameCache;
  for (unsigned int i = 0; i &lt; this-&gt;m_DynamicImage-&gt;GetTimeSteps(); ++i)</span>
  {
<span style = "background-color:#fdd">    typename InputFrameImageType::Pointer frameImage;
    imageTimeSelector-&gt;SetTimeNr(i);
    imageTimeSelector-&gt;UpdateLargestPossibleRegion();</span>

<span style = "background-color:#fdd">    Image::Pointer frameMITKImage = imageTimeSelector-&gt;GetOutput();
    frameCache.push_back(frameMITKImage);
    mitk::CastToItkImage(frameMITKImage, frameImage);
    fitFilter-&gt;SetInput(i,frameImage);
  }</span>

<span style = "background-color:#fdd">  ModelBaseType::TimeGridType timeGrid = ExtractTimeGrid(m_DynamicImage);
  if (m_TimeGridByParameterizer)</span>
  {
<span style = "background-color:#fdd">    if (timeGrid.GetSize() != m_ModelParameterizer-&gt;GetDefaultTimeGrid().GetSize())</span>
    {
<span style = "background-color:#fdd">      mitkThrow() &lt;&lt; "Cannot do fitting. Filter is set to use default time grid of the parameterizer, but grid size does not match the number of input image frames. Grid size: " &lt;&lt; m_ModelParameterizer-&gt;GetDefaultTimeGrid().GetSize() &lt;&lt; "; frame count: " &lt;&lt; timeGrid.GetSize();</span>
    }

<span style = "background-color:#fdd">  }</span>
  else
  {
<span style = "background-color:#fdd">    this-&gt;m_ModelParameterizer-&gt;SetDefaultTimeGrid(timeGrid);</span>
  }

<span style = "background-color:#fdd">  ModelFitFunctorPolicy functor;</span>

<span style = "background-color:#fdd">  functor.SetModelFitFunctor(this-&gt;m_FitFunctor);
  functor.SetModelParameterizer(this-&gt;m_ModelParameterizer);
  fitFilter-&gt;SetFunctor(functor);
  if (this-&gt;m_InternalMask.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    fitFilter-&gt;SetMask(this-&gt;m_InternalMask);</span>
  }

  //generate the fits
<span style = "background-color:#fdd">  fitFilter-&gt;Update();</span>

  //convert the outputs into mitk images and fill the parameter image map
<span style = "background-color:#fdd">  ModelBaseType::Pointer refModel = this-&gt;m_ModelParameterizer-&gt;GenerateParameterizedModel();
  ModelFitFunctorBase::ParameterNamesType paramNames = refModel-&gt;GetParameterNames();
  ModelFitFunctorBase::ParameterNamesType derivedParamNames = refModel-&gt;GetDerivedParameterNames();
  ModelFitFunctorBase::ParameterNamesType criterionNames = this-&gt;m_FitFunctor-&gt;GetCriterionNames();
  ModelFitFunctorBase::ParameterNamesType evaluationParamNames = this-&gt;m_FitFunctor-&gt;GetEvaluationParameterNames();
  ModelFitFunctorBase::ParameterNamesType debugParamNames = this-&gt;m_FitFunctor-&gt;GetDebugParameterNames();</span>

<span style = "background-color:#fdd">  if (fitFilter-&gt;GetNumberOfOutputs() != (paramNames.size() + derivedParamNames.size() + criterionNames.size() + evaluationParamNames.size() + debugParamNames.size()))</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Error while generating fitted parameter images. Fit filter output size does not match expected parameter number. Output size: "&lt;&lt; fitFilter-&gt;GetNumberOfOutputs();</span>
  }

<span style = "background-color:#fdd">  ModelFitFunctorBase::ParameterNamesType::size_type resultPos = 0;
  this-&gt;m_TempResultMap = StoreResultImages&lt;ParameterImageType&gt;(paramNames,fitFilter,resultPos, resultPos);
  this-&gt;m_TempDerivedResultMap = StoreResultImages&lt;ParameterImageType&gt;(derivedParamNames,fitFilter,resultPos, resultPos);
  this-&gt;m_TempCriterionResultMap = StoreResultImages&lt;ParameterImageType&gt;(criterionNames,fitFilter,resultPos, resultPos);
  this-&gt;m_TempEvaluationResultMap = StoreResultImages&lt;ParameterImageType&gt;(evaluationParamNames,fitFilter,resultPos, resultPos);</span>
  //also add debug params (if generated) to the evaluation result map
<span style = "background-color:#fdd">  mitk::PixelBasedParameterFitImageGenerator::ParameterImageMapType debugMap = StoreResultImages&lt;ParameterImageType&gt;(debugParamNames, fitFilter, resultPos, resultPos);
  this-&gt;m_TempEvaluationResultMap.insert(debugMap.begin(), debugMap.end());
}</span>

bool
  mitk::PixelBasedParameterFitImageGenerator::HasOutdatedResult() const
<span style = "background-color:#fdd">{
  bool result = Superclass::HasOutdatedResult();</span>

<span style = "background-color:#fdd">  if (m_ModelParameterizer.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    if (m_ModelParameterizer-&gt;GetMTime() &gt; this-&gt;m_GenerationTimeStamp)</span>
    {
<span style = "background-color:#fdd">      result = true;</span>
    }
  }

<span style = "background-color:#fdd">  if (m_FitFunctor.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    if (m_FitFunctor-&gt;GetMTime() &gt; this-&gt;m_GenerationTimeStamp)</span>
    {
<span style = "background-color:#fdd">      result = true;</span>
    }
  }

<span style = "background-color:#fdd">  if (m_DynamicImage.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    if (m_DynamicImage-&gt;GetMTime() &gt; this-&gt;m_GenerationTimeStamp)</span>
    {
<span style = "background-color:#fdd">      result = true;</span>
    }
  }

<span style = "background-color:#fdd">  if (m_Mask.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    if (m_Mask-&gt;GetMTime() &gt; this-&gt;m_GenerationTimeStamp)</span>
    {
<span style = "background-color:#fdd">      result = true;</span>
    }
  }

<span style = "background-color:#fdd">  return result;</span>

<span style = "background-color:#fdd">};</span>

void
  mitk::PixelBasedParameterFitImageGenerator::CheckValidInputs() const
<span style = "background-color:#fdd">{
  Superclass::CheckValidInputs();</span>

<span style = "background-color:#fdd">  if (m_DynamicImage.IsNull())</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cannot generate fitted parameter images. Input dynamic image is not set.";</span>
  }

<span style = "background-color:#fdd">};</span>

void mitk::PixelBasedParameterFitImageGenerator::DoFitAndGetResults(ParameterImageMapType&amp; parameterImages, ParameterImageMapType&amp; derivedParameterImages, ParameterImageMapType&amp; criterionImages, ParameterImageMapType&amp; evaluationParameterImages)
<span style = "background-color:#fdd">{
  this-&gt;m_Progress = 0;</span>

<span style = "background-color:#fdd">  if(this-&gt;m_Mask.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    AccessFixedDimensionByItk(m_Mask, mitk::PixelBasedParameterFitImageGenerator::DoPrepareMask, 3);
  }</span>
  else
  {
<span style = "background-color:#fdd">    this-&gt;m_InternalMask = nullptr;</span>
  }

<span style = "background-color:#fdd">  AccessFixedDimensionByItk(m_DynamicImage, mitk::PixelBasedParameterFitImageGenerator::DoParameterFit, 4);</span>

<span style = "background-color:#fdd">  parameterImages = this-&gt;m_TempResultMap;
  derivedParameterImages = this-&gt;m_TempDerivedResultMap;
  criterionImages = this-&gt;m_TempCriterionResultMap;
  evaluationParameterImages = this-&gt;m_TempEvaluationResultMap;</span>

<span style = "background-color:#fdd">};</span>

double
  mitk::PixelBasedParameterFitImageGenerator::GetProgress() const
<span style = "background-color:#fdd">{
  return m_Progress;
};</span>

mitk::PixelBasedParameterFitImageGenerator::ParameterNamesType
mitk::PixelBasedParameterFitImageGenerator::GetParameterNames() const
<span style = "background-color:#fdd">{
  ParameterizerType::ModelBasePointer parameterizedModel =</span>
    m_ModelParameterizer-&gt;GenerateParameterizedModel();

<span style = "background-color:#fdd">  return parameterizedModel-&gt;GetParameterNames();
}</span>

mitk::PixelBasedParameterFitImageGenerator::ParameterNamesType
mitk::PixelBasedParameterFitImageGenerator::GetDerivedParameterNames() const
<span style = "background-color:#fdd">{
  ParameterizerType::ModelBasePointer parameterizedModel =</span>
    m_ModelParameterizer-&gt;GenerateParameterizedModel();

<span style = "background-color:#fdd">  return parameterizedModel-&gt;GetDerivedParameterNames();
}</span>

mitk::PixelBasedParameterFitImageGenerator::ParameterNamesType
mitk::PixelBasedParameterFitImageGenerator::GetCriterionNames() const
<span style = "background-color:#fdd">{
  return this-&gt;m_FitFunctor-&gt;GetCriterionNames();
}</span>

mitk::PixelBasedParameterFitImageGenerator::ParameterNamesType
mitk::PixelBasedParameterFitImageGenerator::GetEvaluationParameterNames() const
<span style = "background-color:#fdd">{
  auto evals = this-&gt;m_FitFunctor-&gt;GetEvaluationParameterNames();
  auto debugs = this-&gt;m_FitFunctor-&gt;GetDebugParameterNames();</span>

<span style = "background-color:#fdd">  evals.insert(evals.end(), debugs.begin(), debugs.end());</span>

<span style = "background-color:#fdd">  return evals;
}</span></pre>
	</body>
</html>
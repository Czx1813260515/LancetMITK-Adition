<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkParRecFileReader.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkParRecFileReader.h"
#include &lt;itkImageFileReader.h&gt;
#include &lt;mitkLocaleSwitch.h&gt;

#ifdef __GNUC__
#define stricmp strcasecmp
#endif

void mitk::ParRecFileReader::GenerateOutputInformation()
<span style = "background-color:#fdd">{
  mitk::Image::Pointer output = this-&gt;GetOutput();</span>

<span style = "background-color:#fdd">  if ((output-&gt;IsInitialized()) &amp;&amp; (this-&gt;GetMTime() &lt;= m_ReadHeaderTime.GetMTime()))
    return;</span>

<span style = "background-color:#fdd">  itkDebugMacro(&lt;&lt; "Reading PAR file for GenerateOutputInformation()" &lt;&lt; m_FileName);</span>

  // Check to see if we can read the file given the name or prefix
  //
<span style = "background-color:#fdd">  if (m_FileName == "" &amp;&amp; m_FilePrefix == "")</span>
  {
<span style = "background-color:#fdd">    throw itk::ImageFileReaderException(__FILE__, __LINE__, "One of FileName or FilePrefix must be non-empty");</span>
  }

<span style = "background-color:#fdd">  m_RecFileName = "";
  if (m_FileName != "")</span>
  {
<span style = "background-color:#fdd">    int extPos = m_FileName.find_last_of(".");
    if (extPos &gt;= -1)</span>
    {
<span style = "background-color:#fdd">      const char *ext = m_FileName.c_str() + extPos + 1;
      if (stricmp(ext, "par") == 0)
        m_RecFileName = m_FileName.substr(0, extPos);</span>
      else
<span style = "background-color:#fdd">        m_RecFileName = m_FileName;
    }</span>
    else
<span style = "background-color:#fdd">      m_RecFileName = m_FileName;</span>

<span style = "background-color:#fdd">    m_RecFileName.append(".rec");</span>

<span style = "background-color:#fdd">    bool headerRead = false;</span>

<span style = "background-color:#fdd">    bool signedCharType = true;
    unsigned int dimension = 0;
    unsigned int dimensions[4] = {0, 0, 1, 1};
    float sliceThickness = 0.0;
    float sliceGap = 0.0;
    float sliceSpacing = 0.0;
    mitk::Vector3D thickness;
    thickness.Fill(1.0);
    mitk::Vector3D gap;
    gap.Fill(0.0);
    mitk::Vector3D spacing;</span>

    FILE *f;
<span style = "background-color:#fdd">    f = fopen(m_FileName.c_str(), "r");
    if (f != nullptr)</span>
    {
<span style = "background-color:#fdd">      while (!feof(f))</span>
      {
        char s[300], *p;
<span style = "background-color:#fdd">        char *ignored = fgets(s, 200, f);
        ++ignored;
        if (strstr(s, "Max. number of cardiac phases"))</span>
        {
<span style = "background-color:#fdd">          p = strchr(s, ':') + 1;
          dimensions[3] = atoi(p);
          if (dimensions[3] &gt; 1)
            dimension = 4;
        }
        else if (strstr(s, "Max. number of slices/locations"))</span>
        {
<span style = "background-color:#fdd">          p = strchr(s, ':') + 1;
          dimensions[2] = atoi(p);
          if (dimension == 0)</span>
          {
<span style = "background-color:#fdd">            if (dimensions[2] &gt; 1)
              dimension = 3;</span>
            else
<span style = "background-color:#fdd">              dimension = 2;</span>
          }
<span style = "background-color:#fdd">        }
        else if (strstr(s, "Image pixel size"))</span>
        {
<span style = "background-color:#fdd">          p = strchr(s, ':') + 1;
          int bpe = atoi(p);
          if (bpe != 8)
            signedCharType = false;
        }
        else if (strstr(s, "Recon resolution"))</span>
        {
<span style = "background-color:#fdd">          p = s + strcspn(s, "0123456789");
          sscanf(p, "%u %u", dimensions, dimensions + 1);
        }
        else if (strstr(s, "FOV (ap,fh,rl) [mm]"))</span>
        {
<span style = "background-color:#fdd">          p = s + strcspn(s, "0123456789");
          mitk::LocaleSwitch localeSwitch("C");
          sscanf(p, "%lf %lf %lf", &amp;thickness[0], &amp;thickness[1], &amp;thickness[2]);
        }
        else if (strstr(s, "Slice thickness [mm]"))</span>
        {
<span style = "background-color:#fdd">          p = s + strcspn(s, "0123456789");
          mitk::LocaleSwitch localeSwitch("C");
          sscanf(p, "%f", &amp;sliceThickness);
        }
        else if (strstr(s, "Slice gap [mm]"))</span>
        {
<span style = "background-color:#fdd">          p = s + strcspn(s, "-0123456789");
          mitk::LocaleSwitch localeSwitch("C");
          sscanf(p, "%f", &amp;sliceGap);
        }
      }
      fclose(f);</span>

      // C:\home\ivo\data\coronaries\ucsf-wholeheart-2.par
<span style = "background-color:#fdd">      sliceSpacing = sliceThickness + sliceGap;
      if ((dimension &gt; 0) &amp;&amp; (dimensions[0] &gt; 0) &amp;&amp; (dimensions[1] &gt; 0) &amp;&amp; (sliceThickness &gt; 0) &amp;&amp; (sliceSpacing &gt; 0))</span>
      {
<span style = "background-color:#fdd">        headerRead = true;
        if (fabs(thickness[0] / dimensions[2] - sliceSpacing) &lt; 0.0001)
          thickness[0] = thickness[1];
        else if (fabs(thickness[1] / dimensions[2] - sliceSpacing) &lt; 0.0001)
          thickness[1] = thickness[0];
        thickness[2] = sliceSpacing;</span>

<span style = "background-color:#fdd">        thickness[0] /= dimensions[0];
        thickness[1] /= dimensions[1];
        spacing = thickness + gap;</span>
      }
    }

<span style = "background-color:#fdd">    if (headerRead == false)</span>
    {
<span style = "background-color:#fdd">      itk::ImageFileReaderException e(__FILE__, __LINE__);
      std::ostringstream msg;
      msg &lt;&lt; " Could not read file " &lt;&lt; m_FileName.c_str();
      e.SetDescription(msg.str().c_str());
      throw e;
      return;</span>
    }

    // define types
<span style = "background-color:#fdd">    mitk::PixelType SCType = mitk::MakeScalarPixelType&lt;signed char&gt;();
    mitk::PixelType SSType = mitk::MakeScalarPixelType&lt;signed short&gt;();</span>

<span style = "background-color:#fdd">    if (signedCharType)
      output-&gt;Initialize(SCType, dimension, dimensions);</span>
    else
<span style = "background-color:#fdd">      output-&gt;Initialize(SSType, dimension, dimensions);</span>

<span style = "background-color:#fdd">    output-&gt;GetSlicedGeometry()-&gt;SetSpacing(spacing);</span>

    // output-&gt;GetSlicedGeometry()-&gt;SetPlaneGeometry(mitk::Image::BuildStandardPlanePlaneGeometry(output-&gt;GetSlicedGeometry(),
    // dimensions).GetPointer(), 0);
<span style = "background-color:#fdd">    output-&gt;GetSlicedGeometry()-&gt;SetEvenlySpaced();
  }</span>

<span style = "background-color:#fdd">  m_ReadHeaderTime.Modified();
}</span>

void mitk::ParRecFileReader::GenerateData()
<span style = "background-color:#fdd">{
  mitk::Image::Pointer output = this-&gt;GetOutput();</span>

  // Check to see if we can read the file given the name or prefix
  //
<span style = "background-color:#fdd">  if (m_RecFileName == "")</span>
  {
<span style = "background-color:#fdd">    throw itk::ImageFileReaderException(__FILE__, __LINE__, "FileName for rec-file empty");</span>
  }

<span style = "background-color:#fdd">  if (m_RecFileName != "")</span>
  {
<span style = "background-color:#fdd">    FILE *f = fopen(m_RecFileName.c_str(), "r");
    if (f == nullptr)</span>
    {
<span style = "background-color:#fdd">      throw itk::ImageFileReaderException(__FILE__, __LINE__, "Could not open rec-file.");</span>
    }

    int zstart, zmax;
    int tstart, tmax;

<span style = "background-color:#fdd">    zstart = output-&gt;GetRequestedRegion().GetIndex(2);
    tstart = output-&gt;GetRequestedRegion().GetIndex(3);</span>

<span style = "background-color:#fdd">    zmax = zstart + output-&gt;GetRequestedRegion().GetSize(2);
    tmax = tstart + output-&gt;GetRequestedRegion().GetSize(3);</span>

<span style = "background-color:#fdd">    int sliceSize = output-&gt;GetDimension(0) * output-&gt;GetDimension(1) * output-&gt;GetPixelType().GetBpe() / 8;
    void *data = malloc(sliceSize);</span>

<span style = "background-color:#fdd">    bool ignore4Dtopogram = false;</span>
    {
<span style = "background-color:#fdd">      int slicePlusTimeSize = output-&gt;GetDimension(0) * output-&gt;GetDimension(1) * output-&gt;GetDimension(3) *</span>
                              output-&gt;GetPixelType().GetBpe() / 8;
<span style = "background-color:#fdd">      if (output-&gt;GetDimension(3) &gt; 1)
        ignore4Dtopogram = true;</span>

      int z, t;
<span style = "background-color:#fdd">      for (t = tstart; t &lt; tmax; ++t)
        for (z = zstart; z &lt; zmax; ++z)</span>
        {
<span style = "background-color:#fdd">          if (ignore4Dtopogram)
            fseek(f, slicePlusTimeSize * z + (sliceSize + 1) * t, SEEK_SET);</span>
          else
<span style = "background-color:#fdd">            fseek(f, slicePlusTimeSize * z + sliceSize * t, SEEK_SET);
          size_t ignored = fread(data, sliceSize, 1, f);
          ++ignored;
          output-&gt;SetSlice(data, z, t, 0);
        }</span>
    }
    // else
    //{
    //  for(;z&lt;zmax;++z)
    //  {
    //    fseek(f,sliceSize*z,SEEK_SET);
    //    fread(data, sliceSize, 1, f);
    //    output-&gt;SetSlice(data,z,0,0);
    //  }
    //}
<span style = "background-color:#fdd">    free(data);</span>

<span style = "background-color:#fdd">    fclose(f);</span>
  }
<span style = "background-color:#fdd">}</span>

bool mitk::ParRecFileReader::CanReadFile(const std::string filename,
                                         const std::string /*filePrefix*/,
                                         const std::string /*filePattern*/)
<span style = "background-color:#fdd">{</span>
  // First check the extension
<span style = "background-color:#fdd">  if (filename == "")</span>
  {
    // MITK_INFO&lt;&lt;"No filename specified."&lt;&lt;std::endl;
<span style = "background-color:#fdd">    return false;</span>
  }

<span style = "background-color:#fdd">  bool extensionFound = false;
  std::string::size_type PARPos = filename.rfind(".par");
  if ((PARPos != std::string::npos) &amp;&amp; (PARPos == filename.length() - 4))</span>
  {
<span style = "background-color:#fdd">    extensionFound = true;</span>
  }

<span style = "background-color:#fdd">  PARPos = filename.rfind(".PAR");
  if ((PARPos != std::string::npos) &amp;&amp; (PARPos == filename.length() - 4))</span>
  {
<span style = "background-color:#fdd">    extensionFound = true;</span>
  }

<span style = "background-color:#fdd">  if (!extensionFound)</span>
  {
    // MITK_INFO&lt;&lt;"The filename extension is not recognized."&lt;&lt;std::endl;
<span style = "background-color:#fdd">    return false;</span>
  }

<span style = "background-color:#fdd">  return true;
}</span>

<span style = "background-color:#fdd">mitk::ParRecFileReader::ParRecFileReader() : m_FileName(""), m_FilePrefix(""), m_FilePattern("")
{
}</span>

mitk::ParRecFileReader::~ParRecFileReader()
<span style = "background-color:#fdd">{
}</span></pre>
	</body>
</html>
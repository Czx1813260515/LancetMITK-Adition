<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkUnstructuredGridVtkWriter.txx</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#ifndef _MITK_UNSTRUCTURED_GRID_VTKWRITER_TXX_
#define _MITK_UNSTRUCTURED_GRID_VTKWRITER_TXX_

#include &lt;itkLightObject.h&gt;
#include &lt;vtkLinearTransform.h&gt;
#include &lt;vtkTransformFilter.h&gt;
#include &lt;vtkUnstructuredGrid.h&gt;
#include &lt;vtkUnstructuredGridWriter.h&gt;
#include &lt;vtkXMLPUnstructuredGridWriter.h&gt;
#include &lt;vtkXMLUnstructuredGridWriter.h&gt;

#include &lt;sstream&gt;
#include &lt;cstdio&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/types.h&gt;

namespace mitk
{
  template &lt;class VTKWRITER&gt;
<span style = "background-color:#dfd">  UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::UnstructuredGridVtkWriter() : m_Success(false)
  {
    this-&gt;SetNumberOfRequiredInputs(1);
  }</span>

  template &lt;class VTKWRITER&gt;
  UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::~UnstructuredGridVtkWriter()
<span style = "background-color:#dfd">  {
  }</span>

  template &lt;class VTKWRITER&gt;
  void UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::GenerateData()
<span style = "background-color:#fdd">  {
    m_Success = false;
    if (m_FileName == "")</span>
    {
<span style = "background-color:#fdd">      itkWarningMacro(&lt;&lt; "Sorry, filename has not been set!");
      return;</span>
    }

<span style = "background-color:#fdd">    mitk::UnstructuredGrid::Pointer input = const_cast&lt;mitk::UnstructuredGrid *&gt;(this-&gt;GetInput());</span>

<span style = "background-color:#fdd">    if (input.IsNull())</span>
    {
<span style = "background-color:#fdd">      itkWarningMacro(&lt;&lt; "Sorry, input to mitk::UnstructuredGridVtkWriter is NULL");
      return;</span>
    }

<span style = "background-color:#fdd">    VTKWRITER *unstructuredGridWriter = VTKWRITER::New();
    vtkTransformFilter *transformPointSet = vtkTransformFilter::New();</span>
    vtkUnstructuredGrid *unstructuredGrid;
    BaseGeometry *geometry;

<span style = "background-color:#fdd">    if (input-&gt;GetTimeGeometry()-&gt;CountTimeSteps() &gt; 1)</span>
    {
      int t, timesteps;

<span style = "background-color:#fdd">      timesteps = input-&gt;GetTimeGeometry()-&gt;CountTimeSteps();
      for (t = 0; t &lt; timesteps; ++t)</span>
      {
<span style = "background-color:#fdd">        std::ostringstream filename;
        geometry = input-&gt;GetGeometry(t);
        if (input-&gt;GetTimeGeometry()-&gt;IsValidTimeStep(t))</span>
        {
<span style = "background-color:#fdd">          const mitk::TimeBounds timebounds = input-&gt;GetTimeGeometry()-&gt;GetTimeBounds(t);
          filename &lt;&lt; m_FileName.c_str() &lt;&lt; "_S" &lt;&lt; std::setprecision(0) &lt;&lt; timebounds[0] &lt;&lt; "_E"</span>
                   &lt;&lt; std::setprecision(0) &lt;&lt; timebounds[1] &lt;&lt; "_T" &lt;&lt; t &lt;&lt; GetDefaultExtension();
<span style = "background-color:#fdd">        }</span>
        else
        {
<span style = "background-color:#fdd">          itkWarningMacro(&lt;&lt; "Error on write: TimeGeometry invalid of unstructured grid " &lt;&lt; filename.str() &lt;&lt; ".");
          filename &lt;&lt; m_FileName.c_str() &lt;&lt; "_T" &lt;&lt; t &lt;&lt; GetDefaultExtension();</span>
        }
<span style = "background-color:#fdd">        transformPointSet-&gt;SetInputData(input-&gt;GetVtkUnstructuredGrid(t));
        transformPointSet-&gt;SetTransform(geometry-&gt;GetVtkTransform());
        transformPointSet-&gt;UpdateWholeExtent();
        unstructuredGrid = static_cast&lt;vtkUnstructuredGrid *&gt;(transformPointSet-&gt;GetOutput());</span>

<span style = "background-color:#fdd">        unstructuredGridWriter-&gt;SetFileName(filename.str().c_str());
        unstructuredGridWriter-&gt;SetInputData(unstructuredGrid);</span>

<span style = "background-color:#fdd">        ExecuteWrite(unstructuredGridWriter);
      }
    }</span>
    else
    {
<span style = "background-color:#fdd">      geometry = input-&gt;GetGeometry();
      transformPointSet-&gt;SetInputData(input-&gt;GetVtkUnstructuredGrid());
      transformPointSet-&gt;SetTransform(geometry-&gt;GetVtkTransform());
      transformPointSet-&gt;UpdateWholeExtent();
      unstructuredGrid = static_cast&lt;vtkUnstructuredGrid *&gt;(transformPointSet-&gt;GetOutput());</span>

<span style = "background-color:#fdd">      unstructuredGridWriter-&gt;SetFileName(m_FileName.c_str());
      unstructuredGridWriter-&gt;SetInputData(unstructuredGrid);</span>

<span style = "background-color:#fdd">      ExecuteWrite(unstructuredGridWriter);</span>
    }
<span style = "background-color:#fdd">    transformPointSet-&gt;Delete();
    unstructuredGridWriter-&gt;Delete();</span>

<span style = "background-color:#fdd">    m_Success = true;
  }</span>

  template &lt;class VTKWRITER&gt;
  void UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::ExecuteWrite(VTKWRITER *vtkWriter)
<span style = "background-color:#fdd">  {</span>
    struct stat fileStatus;
<span style = "background-color:#fdd">    time_t timeBefore = 0;
    if (!stat(vtkWriter-&gt;GetFileName(), &amp;fileStatus))</span>
    {
<span style = "background-color:#fdd">      timeBefore = fileStatus.st_mtime;</span>
    }
<span style = "background-color:#fdd">    if (!vtkWriter-&gt;Write())</span>
    {
<span style = "background-color:#fdd">      itkExceptionMacro(&lt;&lt; "Error during unstructured grid writing.");</span>
    }

    // check if file can be written because vtkWriter doesn't check that
<span style = "background-color:#fdd">    if (stat(vtkWriter-&gt;GetFileName(), &amp;fileStatus) || (timeBefore == fileStatus.st_mtime))</span>
    {
<span style = "background-color:#fdd">      itkExceptionMacro(&lt;&lt; "Error during unstructured grid writing: file could not be written");</span>
    }
<span style = "background-color:#fdd">  }</span>

  template &lt;class VTKWRITER&gt;
  void UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::SetInput(BaseData *input)
<span style = "background-color:#fdd">  {
    this-&gt;ProcessObject::SetNthInput(0, input);
  }</span>

  template &lt;class VTKWRITER&gt;
  const UnstructuredGrid *UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::GetInput()
<span style = "background-color:#fdd">  {
    if (this-&gt;GetNumberOfInputs() &lt; 1)</span>
    {
<span style = "background-color:#fdd">      return nullptr;
    }</span>
    else
    {
<span style = "background-color:#fdd">      return dynamic_cast&lt;UnstructuredGrid *&gt;(this-&gt;ProcessObject::GetInput(0));</span>
    }
<span style = "background-color:#fdd">  }</span>

  template &lt;class VTKWRITER&gt;
  bool UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::CanWriteBaseDataType(BaseData::Pointer data)
<span style = "background-color:#fdd">  {
    return (dynamic_cast&lt;mitk::UnstructuredGrid *&gt;(data.GetPointer()) != nullptr);
  }</span>

  template &lt;class VTKWRITER&gt;
  void UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::DoWrite(BaseData::Pointer data)
<span style = "background-color:#fdd">  {
    if (CanWriteBaseDataType(data))</span>
    {
<span style = "background-color:#fdd">      this-&gt;SetInput(dynamic_cast&lt;mitk::UnstructuredGrid *&gt;(data.GetPointer()));
      this-&gt;Update();</span>
    }
<span style = "background-color:#fdd">  }</span>

  template &lt;class VTKWRITER&gt;
  std::vector&lt;std::string&gt; UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::GetPossibleFileExtensions()
  {
    throw std::exception(); // no specialization available!
  }

  template &lt;class VTKWRITER&gt;
  const char *UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::GetDefaultFilename()
  {
    throw std::exception(); // no specialization available!
  }

  template &lt;class VTKWRITER&gt;
  const char *UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::GetFileDialogPattern()
  {
    throw std::exception(); // no specialization available!
  }

  template &lt;class VTKWRITER&gt;
  const char *UnstructuredGridVtkWriter&lt;VTKWRITER&gt;::GetDefaultExtension()
  {
    throw std::exception(); // no specialization available!
  }
}

#endif</pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>usSharedLibrary.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

  Library: CppMicroServices

  Copyright (c) German Cancer Research Center (DKFZ)
  All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

============================================================================*/

#include "usSharedLibrary.h"

#include &lt;stdexcept&gt;

#include &lt;usUtils_p.h&gt;
#include &lt;usModuleRegistry.h&gt;
#include &lt;usModuleActivator.h&gt;


#if defined(US_PLATFORM_POSIX)
  #include &lt;dlfcn.h&gt;
#elif defined(US_PLATFORM_WINDOWS)
  #ifndef WIN32_LEAN_AND_MEAN
    #define WIN32_LEAN_AND_MEAN
  #endif
  #include &lt;windows.h&gt;
  #include &lt;strsafe.h&gt;
#else
  #error Unsupported platform
#endif


US_BEGIN_NAMESPACE

#ifdef US_PLATFORM_POSIX
static const char PATH_SEPARATOR = '/';
#else
static const char PATH_SEPARATOR = '\\';
#endif

class SharedLibraryPrivate : public SharedData
{
public:

  SharedLibraryPrivate()
<span style = "background-color:#fdd">    : m_Handle(nullptr)</span>
  #ifdef US_PLATFORM_WINDOWS
<span style = "background-color:#fdd">    , m_Suffix(".dll")</span>
  #elif defined(US_PLATFORM_APPLE)
    , m_Suffix(".dylib")
    , m_Prefix("lib")
  #else
    , m_Suffix(".so")
    , m_Prefix("lib")
  #endif
<span style = "background-color:#fdd">  {}</span>

  void* m_Handle;

  std::string m_Name;
  std::string m_Path;
  std::string m_FilePath;
  std::string m_Suffix;
  std::string m_Prefix;

};

SharedLibrary::SharedLibrary()
<span style = "background-color:#fdd">  : d(new SharedLibraryPrivate)
{
}</span>

SharedLibrary::SharedLibrary(const SharedLibrary&amp; other)
<span style = "background-color:#fdd">  : d(other.d)
{
}</span>

SharedLibrary::SharedLibrary(const std::string&amp; libPath, const std::string&amp; name)
<span style = "background-color:#fdd">  : d(new SharedLibraryPrivate)
{
  d-&gt;m_Name = name;
  d-&gt;m_Path = libPath;
}</span>

SharedLibrary::SharedLibrary(const std::string&amp; absoluteFilePath)
<span style = "background-color:#fdd">  : d(new SharedLibraryPrivate)
{
  d-&gt;m_FilePath = absoluteFilePath;
  SetFilePath(absoluteFilePath);
}</span>

SharedLibrary::~SharedLibrary()
<span style = "background-color:#fdd">{
}</span>

SharedLibrary&amp; SharedLibrary::operator =(const SharedLibrary&amp; other)
<span style = "background-color:#fdd">{
  d = other.d;
  return *this;
}</span>

void SharedLibrary::Load(int flags)
<span style = "background-color:#fdd">{
  if (d-&gt;m_Handle) throw std::logic_error(std::string("Library already loaded: ") + GetFilePath());
  std::string libPath = GetFilePath();</span>
#ifdef US_PLATFORM_POSIX
  d-&gt;m_Handle = dlopen(libPath.c_str(), flags);
  if (!d-&gt;m_Handle)
  {
    const char* err = dlerror();
    throw std::runtime_error(err ? std::string(err) : (std::string("Error loading ") + libPath));
  }
#else
<span style = "background-color:#fdd">  d-&gt;m_Handle = LoadLibrary(libPath.c_str());
  if (!d-&gt;m_Handle)</span>
  {
<span style = "background-color:#fdd">    std::string errMsg = "Loading ";
    errMsg.append(libPath).append("failed with error: ").append(GetLastErrorStr());</span>

<span style = "background-color:#fdd">    throw std::runtime_error(errMsg);
  }</span>
#endif
<span style = "background-color:#fdd">}</span>

void SharedLibrary::Load()
<span style = "background-color:#fdd">{</span>
#ifdef US_PLATFORM_POSIX
#ifdef US_GCC_RTTI_WORKAROUND_NEEDED
  Load(RTLD_LAZY | RTLD_GLOBAL);
#else
  Load(RTLD_LAZY | RTLD_LOCAL);
#endif
#else
<span style = "background-color:#fdd">  Load(0);</span>
#endif
<span style = "background-color:#fdd">}</span>

void SharedLibrary::Unload()
<span style = "background-color:#fdd">{
  if (d-&gt;m_Handle)</span>
  {
#ifdef US_PLATFORM_POSIX
    if (dlclose(d-&gt;m_Handle))
    {
      const char* err = dlerror();
      throw std::runtime_error(err ? std::string(err) : (std::string("Error unloading ") + GetLibraryPath()));
    }
#else
<span style = "background-color:#fdd">    if (!FreeLibrary((HMODULE)d-&gt;m_Handle))</span>
    {
<span style = "background-color:#fdd">      std::string errMsg = "Unloading ";
      errMsg.append(GetLibraryPath()).append("failed with error: ").append(GetLastErrorStr());</span>

<span style = "background-color:#fdd">      throw std::runtime_error(errMsg);
    }</span>
#endif
<span style = "background-color:#fdd">    d-&gt;m_Handle = nullptr;</span>
  }
<span style = "background-color:#fdd">}</span>

void SharedLibrary::SetName(const std::string&amp; name)
<span style = "background-color:#fdd">{
  if (IsLoaded() || !d-&gt;m_FilePath.empty()) return;
  d.Detach();
  d-&gt;m_Name = name;
}</span>

std::string SharedLibrary::GetName() const
<span style = "background-color:#fdd">{
  return d-&gt;m_Name;
}</span>

std::string SharedLibrary::GetFilePath(const std::string&amp; name) const
<span style = "background-color:#fdd">{
  if (!d-&gt;m_FilePath.empty()) return d-&gt;m_FilePath;
  return GetLibraryPath() + PATH_SEPARATOR + GetPrefix() + name + GetSuffix();
}</span>

void SharedLibrary::SetFilePath(const std::string&amp; absoluteFilePath)
<span style = "background-color:#fdd">{
  if (IsLoaded()) return;</span>

<span style = "background-color:#fdd">  d.Detach();
  d-&gt;m_FilePath = absoluteFilePath;</span>

<span style = "background-color:#fdd">  std::string name = d-&gt;m_FilePath;
  std::size_t pos = d-&gt;m_FilePath.find_last_of(PATH_SEPARATOR);
  if (pos != std::string::npos)</span>
  {
<span style = "background-color:#fdd">    d-&gt;m_Path = d-&gt;m_FilePath.substr(0, pos);
    name = d-&gt;m_FilePath.substr(pos+1);
  }</span>
  else
  {
<span style = "background-color:#fdd">    d-&gt;m_Path.clear();</span>
  }

<span style = "background-color:#fdd">  if (name.size() &gt;= d-&gt;m_Prefix.size() &amp;&amp;</span>
      name.compare(0, d-&gt;m_Prefix.size(), d-&gt;m_Prefix) == 0)
  {
<span style = "background-color:#fdd">    name = name.substr(d-&gt;m_Prefix.size());</span>
  }
<span style = "background-color:#fdd">  if (name.size() &gt;= d-&gt;m_Suffix.size() &amp;&amp;</span>
      name.compare(name.size()-d-&gt;m_Suffix.size(), d-&gt;m_Suffix.size(), d-&gt;m_Suffix) == 0)
  {
<span style = "background-color:#fdd">    name = name.substr(0, name.size()-d-&gt;m_Suffix.size());</span>
  }
<span style = "background-color:#fdd">  d-&gt;m_Name = name;
}</span>

std::string SharedLibrary::GetFilePath() const
<span style = "background-color:#fdd">{
  return GetFilePath(d-&gt;m_Name);
}</span>

void SharedLibrary::SetLibraryPath(const std::string&amp; path)
<span style = "background-color:#fdd">{
  if (IsLoaded() || !d-&gt;m_FilePath.empty()) return;
  d.Detach();
  d-&gt;m_Path = path;
}</span>

std::string SharedLibrary::GetLibraryPath() const
<span style = "background-color:#fdd">{
  return d-&gt;m_Path;
}</span>

void SharedLibrary::SetSuffix(const std::string&amp; suffix)
<span style = "background-color:#fdd">{
  if (IsLoaded() || !d-&gt;m_FilePath.empty()) return;
  d.Detach();
  d-&gt;m_Suffix = suffix;
}</span>

std::string SharedLibrary::GetSuffix() const
<span style = "background-color:#fdd">{
  return d-&gt;m_Suffix;
}</span>

void SharedLibrary::SetPrefix(const std::string&amp; prefix)
<span style = "background-color:#fdd">{
  if (IsLoaded() || !d-&gt;m_FilePath.empty()) return;
  d.Detach();
  d-&gt;m_Prefix = prefix;
}</span>

std::string SharedLibrary::GetPrefix() const
<span style = "background-color:#fdd">{
  return d-&gt;m_Prefix;
}</span>

void* SharedLibrary::GetHandle() const
<span style = "background-color:#fdd">{
  return d-&gt;m_Handle;
}</span>

bool SharedLibrary::IsLoaded() const
<span style = "background-color:#fdd">{
  return d-&gt;m_Handle != nullptr;
}</span>

US_END_NAMESPACE</pre>
	</body>
</html>
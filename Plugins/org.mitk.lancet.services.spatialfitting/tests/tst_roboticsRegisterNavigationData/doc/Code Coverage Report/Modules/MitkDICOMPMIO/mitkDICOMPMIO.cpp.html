<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkDICOMPMIO.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#ifndef __mitkDICOMPMIO__cpp
#define __mitkDICOMPMIO__cpp

#include "mitkDICOMPMIO.h"
#include "mitkDICOMPMIOMimeTypes.h"
#include &lt;mitkDICOMDCMTKTagScanner.h&gt;
#include &lt;mitkDICOMIOHelper.h&gt;
#include &lt;mitkDICOMProperty.h&gt;
#include &lt;mitkIDICOMTagsOfInterest.h&gt;
#include &lt;mitkImageAccessByItk.h&gt;
#include &lt;mitkImageCast.h&gt;
#include &lt;mitkLocaleSwitch.h&gt;
#include &lt;mitkPropertyNameHelper.h&gt;
#include &lt;dcmqi/ParaMapConverter.h&gt;
#include "mitkParamapPresetsParser.h"


// us
#include &lt;usGetModuleContext.h&gt;
#include &lt;usModuleContext.h&gt;

// model fit parameters
#include "mitkModelFitConstants.h"


namespace mitk
{
  DICOMPMIO::DICOMPMIO()
<span style = "background-color:#dfd">    : AbstractFileIO(Image::GetStaticNameOfClass(),</span>
                     mitk::MitkDICOMPMIOMimeTypes::DICOMPM_MIMETYPE_NAME(),
                     "DICOM PM")

<span style = "background-color:#dfd">  {
    AbstractFileWriter::SetRanking(10);
    AbstractFileReader::SetRanking(10);
    this-&gt;RegisterService();
  }</span>

  IFileIO::ConfidenceLevel DICOMPMIO::GetWriterConfidenceLevel() const
<span style = "background-color:#fdd">  {
  if (AbstractFileIO::GetWriterConfidenceLevel() == Unsupported)
    return Unsupported;</span>

<span style = "background-color:#fdd">  const Image *PMinput = static_cast&lt;const Image *&gt;(this-&gt;GetInput());
  if (PMinput)</span>
  {
<span style = "background-color:#fdd">    auto modalityProperty = PMinput-&gt;GetProperty(mitk::GeneratePropertyNameForDICOMTag(0x0008, 0x0060).c_str());
    if (modalityProperty.IsNotNull())</span>
    {
<span style = "background-color:#fdd">      std::string modality = modalityProperty-&gt;GetValueAsString();
      if (modality == "PM")</span>
      {
<span style = "background-color:#fdd">        return Supported;
      }
      else return Unsupported;
    }
    else return Unsupported;
  }
  else return Unsupported;
  }</span>

  void DICOMPMIO::Write()
<span style = "background-color:#fdd">  {
    ValidateOutputLocation();
    mitk::LocaleSwitch localeSwitch("C");
    LocalFile localFile(this);
    const std::string path = localFile.GetFileName();</span>

<span style = "background-color:#fdd">	auto PMinput = dynamic_cast&lt;const Image *&gt;(this-&gt;GetInput());
	if (PMinput == nullptr)
		mitkThrow() &lt;&lt; "Cannot write non-image data";</span>

    // Get DICOM information from referenced image
<span style = "background-color:#fdd">    vector&lt;std::unique_ptr&lt;DcmDataset&gt;&gt; dcmDatasetsSourceImage;
    std::unique_ptr&lt;DcmFileFormat&gt; readFileFormat(new DcmFileFormat());</span>

    try
    {
      // Generate dcmdataset witk DICOM tags from property list; ATM the source are the filepaths from the
      // property list
<span style = "background-color:#fdd">      mitk::StringLookupTableProperty::Pointer filesProp =</span>
        dynamic_cast&lt;mitk::StringLookupTableProperty *&gt;(PMinput-&gt;GetProperty("referenceFiles").GetPointer());

<span style = "background-color:#fdd">      if (filesProp.IsNull())</span>
      {
<span style = "background-color:#fdd">        mitkThrow() &lt;&lt; "No property with dicom file path.";
        return;</span>
      }

	  // returns a list of all referenced files
<span style = "background-color:#fdd">      StringLookupTable filesLut = filesProp-&gt;GetValue();</span>

<span style = "background-color:#fdd">      const StringLookupTable::LookupTableType &amp;lookUpTableMap = filesLut.GetLookupTable();
      for (const auto &amp;it : lookUpTableMap)</span>
      {
<span style = "background-color:#fdd">        const char *fileName = (it.second).c_str();
        if (readFileFormat-&gt;loadFile(fileName, EXS_Unknown).good())</span>
        {
<span style = "background-color:#fdd">          std::unique_ptr&lt;DcmDataset&gt; readDCMDataset(readFileFormat-&gt;getAndRemoveDataset());
          dcmDatasetsSourceImage.push_back(std::move(readDCMDataset));
        }
      }
    }</span>
    catch (const std::exception &amp;e)
<span style = "background-color:#fdd">    {
      MITK_ERROR &lt;&lt; "An error occurred while getting the dicom information: " &lt;&lt; e.what() &lt;&lt; endl;
      return;
    }</span>

<span style = "background-color:#fdd">	mitk::Image *mitkPMImage = const_cast&lt;mitk::Image *&gt;(PMinput);</span>
	// Cast input PMinput to itk image
<span style = "background-color:#fdd">	ImageToItk&lt;PMitkInputImageType&gt;::Pointer PMimageToItkFilter = ImageToItk&lt;PMitkInputImageType&gt;::New();
	PMimageToItkFilter-&gt;SetInput(mitkPMImage);</span>

	// Cast from original itk type to dcmqi input itk image type
	typedef itk::CastImageFilter&lt;PMitkInputImageType, PMitkInternalImageType&gt; castItkImageFilterType;
<span style = "background-color:#fdd">	castItkImageFilterType::Pointer castFilter = castItkImageFilterType::New();
	castFilter-&gt;SetInput(PMimageToItkFilter-&gt;GetOutput());
	castFilter-&gt;Update();
	PMitkInternalImageType::Pointer itkParamapImage = castFilter-&gt;GetOutput();</span>

	// Create PM meta information
<span style = "background-color:#fdd">    const std::string tmpMetaInfoFile = this-&gt;CreateMetaDataJsonFilePM();</span>
	// Convert itk PM images to dicom image
<span style = "background-color:#fdd">	MITK_INFO &lt;&lt; "Writing PM image: " &lt;&lt; path &lt;&lt; std::endl;</span>
	try
	  {
	    // convert from unique to raw pointer
<span style = "background-color:#fdd">	    vector&lt;DcmDataset*&gt; rawVecDataset;
	    for ( const auto&amp; dcmDataSet : dcmDatasetsSourceImage ) { rawVecDataset.push_back( dcmDataSet.get() ); }</span>

<span style = "background-color:#fdd">	    std::unique_ptr&lt;dcmqi::ParaMapConverter&gt; PMconverter(new dcmqi::ParaMapConverter());
	    std::unique_ptr&lt;DcmDataset&gt; PMresult (PMconverter-&gt;itkimage2paramap(itkParamapImage, rawVecDataset, tmpMetaInfoFile));</span>
	    // Write dicom file
<span style = "background-color:#fdd">	    DcmFileFormat dcmFileFormat(PMresult.get());
	    std::string filePath = path.substr(0, path.find_last_of("."));
	    filePath = filePath + ".dcm";
	    dcmFileFormat.saveFile(filePath.c_str(), EXS_LittleEndianExplicit);</span>

<span style = "background-color:#fdd">	  }</span>
	catch (const std::exception &amp;e)
<span style = "background-color:#fdd">	  {
		MITK_ERROR &lt;&lt; "An error occurred during writing the DICOM Paramap: " &lt;&lt; e.what() &lt;&lt; endl;
		return;
	  }</span>

<span style = "background-color:#fdd">  }</span>

  const std::string mitk::DICOMPMIO::CreateMetaDataJsonFilePM() const
<span style = "background-color:#fdd">  {
	  const mitk::Image *PMimage = dynamic_cast&lt;const mitk::Image *&gt;(this-&gt;GetInput());
	  dcmqi::JSONParametricMapMetaInformationHandler PMhandler;</span>


	  // Get Metadata from modelFitConstants
<span style = "background-color:#fdd">	  std::string parameterName;
	  PMimage-&gt;GetPropertyList()-&gt;GetStringProperty(ModelFitConstants::PARAMETER_NAME_PROPERTY_NAME().c_str(), parameterName);
	  std::string modelName;
	  PMimage-&gt;GetPropertyList()-&gt;GetStringProperty(ModelFitConstants::MODEL_NAME_PROPERTY_NAME().c_str(), modelName);</span>

<span style = "background-color:#fdd">    mitk::ParamapPresetsParser* pmPresets = mitk::ParamapPresetsParser::New();</span>
      // Here the mitkParamapPresets.xml file containing the Coding Schmeme Designator and Code Value are parsed and the relevant values extracted
<span style = "background-color:#fdd">	  pmPresets-&gt;LoadPreset();
	  auto pmType_parameterName = pmPresets-&gt;GetType(parameterName);
	  auto pmType_modelName = pmPresets-&gt;GetType(modelName);</span>

	  // Pass codes to Paramap Converter
<span style = "background-color:#fdd">	  PMhandler.setDerivedPixelContrast("TCS");
	  PMhandler.setFrameLaterality("U");
	  PMhandler.setQuantityValueCode(pmType_parameterName.codeValue, pmType_parameterName.codeScheme, parameterName);
	  PMhandler.setMeasurementMethodCode(pmType_modelName.codeValue, pmType_modelName.codeScheme, modelName);
	  PMhandler.setMeasurementUnitsCode("/min", "UCUM", "/m");
	  PMhandler.setSeriesNumber("1");
	  PMhandler.setInstanceNumber("1");
	  PMhandler.setDerivationCode("129104", "DCM", "Perfusion image analysis");
	  PMhandler.setRealWorldValueSlope("1");</span>

<span style = "background-color:#fdd">	  return PMhandler.getJSONOutputAsString();
  }</span>


  std::vector&lt;BaseData::Pointer&gt; DICOMPMIO::DoRead()
<span style = "background-color:#fdd">  {
	  mitk::LocaleSwitch localeSwitch("C");
	  std::vector&lt;BaseData::Pointer&gt; result;</span>

<span style = "background-color:#fdd">	  return result;
  }</span>

  IFileIO::ConfidenceLevel DICOMPMIO::GetReaderConfidenceLevel() const
<span style = "background-color:#fdd">  {
	  return Unsupported;
  }</span>



<span style = "background-color:#fdd">  DICOMPMIO *DICOMPMIO::IOClone() const { return new DICOMPMIO(*this); }</span>
} // namespace






#endif //__mitkDICOMPMIO__cpp</pre>
	</body>
</html>
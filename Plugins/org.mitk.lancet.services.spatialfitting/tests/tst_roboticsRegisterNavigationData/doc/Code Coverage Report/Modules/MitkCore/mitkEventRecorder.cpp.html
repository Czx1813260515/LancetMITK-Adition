<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkEventRecorder.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkEventRecorder.h"
#include "mitkEventFactory.h"
#include "mitkInteractionEvent.h"
#include "mitkInteractionEventConst.h"

#include "vtkCamera.h"

#include "mitkBaseRenderer.h"

static void WriteEventXMLHeader(std::ofstream &amp;stream)
<span style = "background-color:#fdd">{
  stream &lt;&lt; mitk::InteractionEventConst::xmlHead() &lt;&lt; "\n";
}</span>

static void WriteEventXMLConfig(std::ofstream &amp;stream)
<span style = "background-color:#fdd">{</span>
  // &lt;config&gt;
<span style = "background-color:#fdd">  stream &lt;&lt; " &lt;" &lt;&lt; mitk::InteractionEventConst::xmlTagConfigRoot() &lt;&lt; "&gt;\n";</span>

  // write renderer config
  // for all registered 2D renderers write name and viewdirection.
<span style = "background-color:#fdd">  auto rendererIterator = mitk::BaseRenderer::baseRendererMap.begin();
  auto end = mitk::BaseRenderer::baseRendererMap.end();</span>

<span style = "background-color:#fdd">  for (; rendererIterator != end; ++rendererIterator)</span>
  {
<span style = "background-color:#fdd">    std::string rendererName = (*rendererIterator).second-&gt;GetName();</span>

<span style = "background-color:#fdd">    mitk::SliceNavigationController::ViewDirection viewDirection =</span>
      (*rendererIterator).second-&gt;GetSliceNavigationController()-&gt;GetDefaultViewDirection();
<span style = "background-color:#fdd">    mitk::BaseRenderer::MapperSlotId mapperID = (*rendererIterator).second-&gt;GetMapperID();</span>

    //  &lt;renderer RendererName="stdmulti.widget1" ViewDirection="1" MapperID="1" SizeX="200" SizeY="200" SizeZ="1"/&gt;
<span style = "background-color:#fdd">    stream &lt;&lt; "  &lt;" &lt;&lt; mitk::InteractionEventConst::xmlTagRenderer() &lt;&lt; " "</span>
           &lt;&lt; mitk::InteractionEventConst::xmlEventPropertyRendererName() &lt;&lt; "=\"" &lt;&lt; rendererName &lt;&lt; "\" "
           &lt;&lt; mitk::InteractionEventConst::xmlEventPropertyViewDirection() &lt;&lt; "=\"" &lt;&lt; viewDirection &lt;&lt; "\" "
           &lt;&lt; mitk::InteractionEventConst::xmlEventPropertyMapperID() &lt;&lt; "=\"" &lt;&lt; mapperID &lt;&lt; "\" "
           &lt;&lt; mitk::InteractionEventConst::xmlRenderSizeX() &lt;&lt; "=\"" &lt;&lt; (*rendererIterator).second-&gt;GetSize()[0]
           &lt;&lt; "\" " &lt;&lt; mitk::InteractionEventConst::xmlRenderSizeY() &lt;&lt; "=\""
           &lt;&lt; (*rendererIterator).second-&gt;GetSize()[1] &lt;&lt; "\" " &lt;&lt; mitk::InteractionEventConst::xmlRenderSizeZ()
           &lt;&lt; "=\"" &lt;&lt; (*rendererIterator).second-&gt;GetSize()[2] &lt;&lt; "\" ";
    ;

<span style = "background-color:#fdd">    if ((*rendererIterator).second-&gt;GetMapperID() == mitk::BaseRenderer::Standard3D)</span>
    {
      // For a 3D render window, rotation and zoom settings are determined by the vtkCamera parameters
      // these are recorded here:
<span style = "background-color:#fdd">      stream &lt;&lt; mitk::InteractionEventConst::xmlViewUpX() &lt;&lt; "=\""</span>
             &lt;&lt; (*rendererIterator).second-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;GetViewUp()[0] &lt;&lt; "\" "
             &lt;&lt; mitk::InteractionEventConst::xmlViewUpY() &lt;&lt; "=\""
             &lt;&lt; (*rendererIterator).second-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;GetViewUp()[1] &lt;&lt; "\" "
             &lt;&lt; mitk::InteractionEventConst::xmlViewUpZ() &lt;&lt; "=\""
             &lt;&lt; (*rendererIterator).second-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;GetViewUp()[2] &lt;&lt; "\" "
             &lt;&lt; mitk::InteractionEventConst::xmlCameraFocalPointX() &lt;&lt; "=\""
             &lt;&lt; (*rendererIterator).second-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;GetFocalPoint()[0] &lt;&lt; "\" "
             &lt;&lt; mitk::InteractionEventConst::xmlCameraFocalPointY() &lt;&lt; "=\""
             &lt;&lt; (*rendererIterator).second-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;GetFocalPoint()[1] &lt;&lt; "\" "
             &lt;&lt; mitk::InteractionEventConst::xmlCameraFocalPointZ() &lt;&lt; "=\""
             &lt;&lt; (*rendererIterator).second-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;GetFocalPoint()[2] &lt;&lt; "\" "
             &lt;&lt; mitk::InteractionEventConst::xmlCameraPositionX() &lt;&lt; "=\""
             &lt;&lt; (*rendererIterator).second-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;GetPosition()[0] &lt;&lt; "\" "
             &lt;&lt; mitk::InteractionEventConst::xmlCameraPositionY() &lt;&lt; "=\""
             &lt;&lt; (*rendererIterator).second-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;GetPosition()[1] &lt;&lt; "\" "
             &lt;&lt; mitk::InteractionEventConst::xmlCameraPositionZ() &lt;&lt; "=\""
             &lt;&lt; (*rendererIterator).second-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;GetPosition()[2] &lt;&lt; "\" ";
    }
<span style = "background-color:#fdd">    stream &lt;&lt; "/&gt;\n";
  }</span>

  // &lt;/config&gt;
<span style = "background-color:#fdd">  stream &lt;&lt; " &lt;/" &lt;&lt; mitk::InteractionEventConst::xmlTagConfigRoot() &lt;&lt; "&gt;\n";
}</span>

static void WriteEventXMLEventsOpen(std::ofstream &amp;stream)
<span style = "background-color:#fdd">{
  stream &lt;&lt; " &lt;" &lt;&lt; mitk::InteractionEventConst::xmlTagEvents() &lt;&lt; "&gt;\n";
}</span>

static void WriteEventXMLEventsClose(std::ofstream &amp;stream)
<span style = "background-color:#fdd">{
  stream &lt;&lt; " &lt;/" &lt;&lt; mitk::InteractionEventConst::xmlTagEvents() &lt;&lt; "&gt;\n";
}</span>

static void WriteEventXMLInteractionsOpen(std::ofstream &amp;stream)
<span style = "background-color:#fdd">{
  stream &lt;&lt; "&lt;" &lt;&lt; mitk::InteractionEventConst::xmlTagInteractions() &lt;&lt; "&gt;\n";
}</span>

static void WriteEventXMLInteractionsClose(std::ofstream &amp;stream)
<span style = "background-color:#fdd">{
  stream &lt;&lt; "&lt;/" &lt;&lt; mitk::InteractionEventConst::xmlTagInteractions() &lt;&lt; "&gt;";
}</span>

static void WriteEventXMLClose(std::ofstream &amp;stream)
<span style = "background-color:#fdd">{
  WriteEventXMLEventsClose(stream);
  WriteEventXMLInteractionsClose(stream);
}</span>

<span style = "background-color:#fdd">mitk::EventRecorder::EventRecorder() : m_Active(false)
{
}</span>

mitk::EventRecorder::~EventRecorder()
<span style = "background-color:#fdd">{
  if (m_FileStream.is_open())</span>
  {
<span style = "background-color:#fdd">    m_FileStream.flush();
    m_FileStream.close();</span>
  }
<span style = "background-color:#fdd">}</span>

void mitk::EventRecorder::Notify(mitk::InteractionEvent *interactionEvent, bool /*isHandled*/)
<span style = "background-color:#fdd">{
  if (m_FileStream.is_open())
    m_FileStream &lt;&lt; EventFactory::EventToXML(interactionEvent) &lt;&lt; "\n";
}</span>

void mitk::EventRecorder::SetEventIgnoreList(std::vector&lt;std::string&gt; list)
<span style = "background-color:#fdd">{
  m_IgnoreList = list;
}</span>

void mitk::EventRecorder::StartRecording()
<span style = "background-color:#fdd">{
  if (m_FileName == "")</span>
  {
<span style = "background-color:#fdd">    MITK_ERROR &lt;&lt; "EventRecorder::StartRecording - Filename needs to be set first.";
    return;</span>
  }
<span style = "background-color:#fdd">  if (m_FileStream.is_open())</span>
  {
<span style = "background-color:#fdd">    MITK_ERROR &lt;&lt; "EventRecorder::StartRecording - Still recording. Stop recording before starting it again.";
    return;</span>
  }

<span style = "background-color:#fdd">  m_FileStream.open(m_FileName.c_str(), std::ofstream::out);
  if (!m_FileStream.good())</span>
  {
<span style = "background-color:#fdd">    MITK_ERROR &lt;&lt; "File " &lt;&lt; m_FileName &lt;&lt; " could not be opened!";
    m_FileStream.close();
    return;</span>
  }

<span style = "background-color:#fdd">  m_Active = true;</span>

  // write head and config
  // &lt;?xml version="1.0"?&gt;
  //  &lt;interactions&gt;
  //   &lt;config&gt;
  //    &lt;renderer RendererName="stdmulti.widget1" ViewDirection="1"/&gt;
  //    &lt;renderer RendererName="stdmulti.widget0" ViewDirection="0"/&gt;
  //     ...
  //   &lt;/config&gt;
  //   &lt;events&gt;
<span style = "background-color:#fdd">  WriteEventXMLHeader(m_FileStream);
  WriteEventXMLInteractionsOpen(m_FileStream);
  WriteEventXMLConfig(m_FileStream);
  WriteEventXMLEventsOpen(m_FileStream);
}</span>

void mitk::EventRecorder::StopRecording()
<span style = "background-color:#fdd">{
  if (m_FileStream.is_open())</span>
  {
    // write end tag
    //  &lt;/events&gt;
    // &lt;/interactions&gt;
<span style = "background-color:#fdd">    WriteEventXMLClose(m_FileStream);</span>

<span style = "background-color:#fdd">    m_FileStream.flush();
    m_FileStream.close();</span>

<span style = "background-color:#fdd">    m_Active = false;</span>
  }
<span style = "background-color:#fdd">}</span></pre>
	</body>
</html>
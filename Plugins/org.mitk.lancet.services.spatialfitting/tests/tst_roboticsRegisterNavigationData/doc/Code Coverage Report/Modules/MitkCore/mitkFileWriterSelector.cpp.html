<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkFileWriterSelector.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkFileWriterSelector.h"

#include &lt;mitkBaseData.h&gt;
#include &lt;mitkCoreServices.h&gt;
#include &lt;mitkFileWriterRegistry.h&gt;
#include &lt;mitkIMimeTypeProvider.h&gt;
#include &lt;mitkUtf8Util.h&gt;

#include &lt;usAny.h&gt;
#include &lt;usServiceProperties.h&gt;
#include &lt;usServiceReference.h&gt;

#include &lt;itksys/SystemTools.hxx&gt;

#include &lt;iterator&gt;
#include &lt;limits&gt;
#include &lt;set&gt;

namespace mitk
{
  struct FileWriterSelector::Item::Impl : us::SharedData
  {
<span style = "background-color:#fdd">    Impl() : m_FileWriter(nullptr), m_ConfidenceLevel(IFileWriter::Unsupported), m_BaseDataIndex(0), m_Id(-1) {}</span>
    us::ServiceReference&lt;IFileWriter&gt; m_FileWriterRef;
    IFileWriter *m_FileWriter;
    IFileWriter::ConfidenceLevel m_ConfidenceLevel;
    std::size_t m_BaseDataIndex;
    MimeType m_MimeType;
    long m_Id;
  };

  struct FileWriterSelector::Impl : us::SharedData
  {
<span style = "background-color:#fdd">    Impl() : m_BestId(-1), m_SelectedId(m_BestId) {}</span>
    Impl(const Impl &amp;other) : us::SharedData(other), m_BestId(-1), m_SelectedId(m_BestId) {}
    FileWriterRegistry m_WriterRegistry;
    std::map&lt;long, FileWriterSelector::Item&gt; m_Items;
    std::set&lt;MimeType&gt; m_MimeTypes;
    long m_BestId;
    long m_SelectedId;
  };

<span style = "background-color:#fdd">  FileWriterSelector::FileWriterSelector(const FileWriterSelector &amp;other) : m_Data(other.m_Data) {}</span>
  FileWriterSelector::FileWriterSelector(const BaseData *baseData, const std::string &amp;mimeType, const std::string &amp;path)
<span style = "background-color:#fdd">    : m_Data(new Impl)
  {
    mitk::CoreServicePointer&lt;mitk::IMimeTypeProvider&gt; mimeTypeProvider(mitk::CoreServices::GetMimeTypeProvider());</span>

<span style = "background-color:#fdd">    std::vector&lt;FileWriterRegistry::WriterReference&gt; refs;</span>

<span style = "background-color:#fdd">    std::string destMimeType = mimeType;
    if (destMimeType.empty() &amp;&amp; !path.empty())</span>
    {
      // try to derive a mime-type from the file
<span style = "background-color:#fdd">      std::vector&lt;MimeType&gt; mimeTypes = mimeTypeProvider-&gt;GetMimeTypesForFile(path);
      if (!mimeTypes.empty())</span>
      {
<span style = "background-color:#fdd">        for (unsigned int index = 0; index &lt; mimeTypes.size(); index++)</span>
        {
<span style = "background-color:#fdd">          std::vector&lt;FileWriterRegistry::WriterReference&gt; tempRefs =</span>
            m_Data-&gt;m_WriterRegistry.GetReferences(baseData, mimeTypes.at(index).GetName());
<span style = "background-color:#fdd">          for (unsigned int innerIndex = 0; innerIndex &lt; tempRefs.size(); innerIndex++)</span>
          {
<span style = "background-color:#fdd">            refs.push_back(tempRefs.at(innerIndex));
          }
        }
      }
      else if (!itksys::SystemTools::GetFilenameExtension(Utf8Util::Local8BitToUtf8(path)).empty())</span>
      {
        // If there are no suitable mime-type for the file AND an extension
        // was supplied, we stop here.
<span style = "background-color:#fdd">        return;
      }</span>
      else
      {
<span style = "background-color:#fdd">        refs = m_Data-&gt;m_WriterRegistry.GetReferences(baseData, destMimeType);</span>
      }
<span style = "background-color:#fdd">    }</span>
    else
    {
<span style = "background-color:#fdd">      refs = m_Data-&gt;m_WriterRegistry.GetReferences(baseData, destMimeType);</span>
    }

<span style = "background-color:#fdd">    std::vector&lt;std::string&gt; classHierarchy = baseData-&gt;GetClassHierarchy();</span>

    // Get all writers and their mime types for the given base data type
<span style = "background-color:#fdd">    Item bestItem;
    for (std::vector&lt;FileWriterRegistry::WriterReference&gt;::const_iterator iter = refs.begin(), iterEnd = refs.end();
         iter != iterEnd;
         ++iter)</span>
    {
<span style = "background-color:#fdd">      std::string mimeTypeName = iter-&gt;GetProperty(IFileWriter::PROP_MIMETYPE()).ToString();
      if (!mimeTypeName.empty())</span>
      {
<span style = "background-color:#fdd">        MimeType mimeType = mimeTypeProvider-&gt;GetMimeTypeForName(mimeTypeName);
        if (mimeType.IsValid())</span>
        {
          // There is a registered mime-type for this writer. Now get the confidence level
          // of this writer for writing the given base data object.

<span style = "background-color:#fdd">          IFileWriter *writer = m_Data-&gt;m_WriterRegistry.GetWriter(*iter);
          if (writer == nullptr)
            continue;</span>
          try
          {
<span style = "background-color:#fdd">            writer-&gt;SetInput(baseData);
            IFileWriter::ConfidenceLevel confidenceLevel = writer-&gt;GetConfidenceLevel();
            if (confidenceLevel == IFileWriter::Unsupported)</span>
            {
<span style = "background-color:#fdd">              continue;</span>
            }

<span style = "background-color:#fdd">            std::string baseDataType = iter-&gt;GetProperty(IFileWriter::PROP_BASEDATA_TYPE()).ToString();
            auto idxIter =</span>
              std::find(classHierarchy.begin(), classHierarchy.end(), baseDataType);
<span style = "background-color:#fdd">            std::size_t baseDataIndex = std::numeric_limits&lt;std::size_t&gt;::max();
            if (idxIter != classHierarchy.end())</span>
            {
<span style = "background-color:#fdd">              baseDataIndex = std::distance(classHierarchy.begin(), idxIter);</span>
            }

<span style = "background-color:#fdd">            Item item;
            item.d-&gt;m_FileWriterRef = *iter;
            item.d-&gt;m_FileWriter = writer;
            item.d-&gt;m_ConfidenceLevel = confidenceLevel;
            item.d-&gt;m_BaseDataIndex = baseDataIndex;
            item.d-&gt;m_MimeType = mimeType;
            item.d-&gt;m_Id = us::any_cast&lt;long&gt;(iter-&gt;GetProperty(us::ServiceConstants::SERVICE_ID()));
            m_Data-&gt;m_Items.insert(std::make_pair(item.d-&gt;m_Id, item));
            m_Data-&gt;m_MimeTypes.insert(mimeType);
            if (!bestItem.GetReference() || bestItem &lt; item)</span>
            {
<span style = "background-color:#fdd">              bestItem = item;</span>
            }
<span style = "background-color:#fdd">          }</span>
          catch (const us::BadAnyCastException &amp;e)
<span style = "background-color:#fdd">          {
            MITK_WARN &lt;&lt; "Unexpected: " &lt;&lt; e.what();
          }</span>
          catch (const std::exception &amp;e)
<span style = "background-color:#fdd">          {</span>
            // Log the error but continue
<span style = "background-color:#fdd">            MITK_WARN &lt;&lt; "IFileWriter::GetConfidenceLevel exception: " &lt;&lt; e.what();
          }</span>
        }
<span style = "background-color:#fdd">      }
    }</span>

<span style = "background-color:#fdd">    if (bestItem.GetReference())</span>
    {
<span style = "background-color:#fdd">      m_Data-&gt;m_BestId = bestItem.GetServiceId();
      m_Data-&gt;m_SelectedId = m_Data-&gt;m_BestId;</span>
    }
<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  FileWriterSelector::~FileWriterSelector() {}</span>
  FileWriterSelector &amp;FileWriterSelector::operator=(const FileWriterSelector &amp;other)
<span style = "background-color:#fdd">  {
    m_Data = other.m_Data;
    return *this;
  }</span>

<span style = "background-color:#fdd">  bool FileWriterSelector::IsEmpty() const { return m_Data-&gt;m_Items.empty(); }</span>
  std::vector&lt;FileWriterSelector::Item&gt; FileWriterSelector::Get(const std::string &amp;mimeType) const
<span style = "background-color:#fdd">  {
    std::vector&lt;Item&gt; result;
    for (std::map&lt;long, Item&gt;::const_iterator iter = m_Data-&gt;m_Items.begin(), iterEnd = m_Data-&gt;m_Items.end();
         iter != iterEnd;
         ++iter)</span>
    {
<span style = "background-color:#fdd">      if (mimeType.empty() || iter-&gt;second.GetMimeType().GetName() == mimeType)</span>
      {
<span style = "background-color:#fdd">        result.push_back(iter-&gt;second);
      }
    }
    std::sort(result.begin(), result.end());
    return result;
  }</span>

  std::vector&lt;FileWriterSelector::Item&gt; FileWriterSelector::Get() const
<span style = "background-color:#fdd">  {
    return Get(this-&gt;GetSelected().d-&gt;m_MimeType.GetName());
  }</span>

  FileWriterSelector::Item FileWriterSelector::Get(long id) const
<span style = "background-color:#fdd">  {
    std::map&lt;long, Item&gt;::const_iterator iter = m_Data-&gt;m_Items.find(id);
    if (iter != m_Data-&gt;m_Items.end())</span>
    {
<span style = "background-color:#fdd">      return iter-&gt;second;</span>
    }
<span style = "background-color:#fdd">    return Item();
  }</span>

<span style = "background-color:#fdd">  FileWriterSelector::Item FileWriterSelector::GetDefault() const { return Get(m_Data-&gt;m_BestId); }
  long FileWriterSelector::GetDefaultId() const { return m_Data-&gt;m_BestId; }
  FileWriterSelector::Item FileWriterSelector::GetSelected() const { return Get(m_Data-&gt;m_SelectedId); }
  long FileWriterSelector::GetSelectedId() const { return m_Data-&gt;m_SelectedId; }</span>
  bool FileWriterSelector::Select(const std::string &amp;mimeType)
<span style = "background-color:#fdd">  {
    std::vector&lt;Item&gt; items = Get(mimeType);
    if (items.empty())
      return false;
    return Select(items.back());
  }</span>

<span style = "background-color:#fdd">  bool FileWriterSelector::Select(const FileWriterSelector::Item &amp;item) { return Select(item.d-&gt;m_Id); }</span>
  bool FileWriterSelector::Select(long id)
<span style = "background-color:#fdd">  {
    if (id &gt; -1)</span>
    {
<span style = "background-color:#fdd">      if (m_Data-&gt;m_Items.find(id) == m_Data-&gt;m_Items.end())</span>
      {
<span style = "background-color:#fdd">        return false;</span>
      }
<span style = "background-color:#fdd">      m_Data-&gt;m_SelectedId = id;
      return true;</span>
    }
<span style = "background-color:#fdd">    return false;
  }</span>

  std::vector&lt;MimeType&gt; FileWriterSelector::GetMimeTypes() const
<span style = "background-color:#fdd">  {
    std::vector&lt;MimeType&gt; result;
    result.reserve(m_Data-&gt;m_MimeTypes.size());
    result.assign(m_Data-&gt;m_MimeTypes.begin(), m_Data-&gt;m_MimeTypes.end());
    return result;
  }</span>

<span style = "background-color:#fdd">  void FileWriterSelector::Swap(FileWriterSelector &amp;fws) { m_Data.Swap(fws.m_Data); }
  FileWriterSelector::Item::Item(const FileWriterSelector::Item &amp;other) : d(other.d) {}
  FileWriterSelector::Item::~Item() {}</span>
  FileWriterSelector::Item &amp;FileWriterSelector::Item::operator=(const FileWriterSelector::Item &amp;other)
<span style = "background-color:#fdd">  {
    d = other.d;
    return *this;
  }</span>

<span style = "background-color:#fdd">  IFileWriter *FileWriterSelector::Item::GetWriter() const { return d-&gt;m_FileWriter; }</span>
  std::string FileWriterSelector::Item::GetDescription() const
<span style = "background-color:#fdd">  {
    us::Any descr = d-&gt;m_FileWriterRef.GetProperty(IFileWriter::PROP_DESCRIPTION());
    if (descr.Empty())
      return std::string();
    return descr.ToString();
  }</span>

<span style = "background-color:#fdd">  IFileWriter::ConfidenceLevel FileWriterSelector::Item::GetConfidenceLevel() const { return d-&gt;m_ConfidenceLevel; }
  MimeType FileWriterSelector::Item::GetMimeType() const { return d-&gt;m_MimeType; }</span>
  std::string FileWriterSelector::Item::GetBaseDataType() const
<span style = "background-color:#fdd">  {
    us::Any any = d-&gt;m_FileWriterRef.GetProperty(IFileWriter::PROP_BASEDATA_TYPE());
    if (any.Empty())
      return std::string();
    return any.ToString();
  }</span>

<span style = "background-color:#fdd">  us::ServiceReference&lt;IFileWriter&gt; FileWriterSelector::Item::GetReference() const { return d-&gt;m_FileWriterRef; }
  long FileWriterSelector::Item::GetServiceId() const { return d-&gt;m_Id; }</span>
  bool FileWriterSelector::Item::operator&lt;(const FileWriterSelector::Item &amp;other) const
<span style = "background-color:#fdd">  {</span>
    // sort by confidence level first (ascending)
<span style = "background-color:#fdd">    if (d-&gt;m_ConfidenceLevel == other.d-&gt;m_ConfidenceLevel)</span>
    {
      // sort by class hierarchy index (writers for more derived
      // based data types are considered a better match)
<span style = "background-color:#fdd">      if (d-&gt;m_BaseDataIndex == other.d-&gt;m_BaseDataIndex)</span>
      {
        // sort by file writer service ranking
<span style = "background-color:#fdd">        return d-&gt;m_FileWriterRef &lt; other.d-&gt;m_FileWriterRef;</span>
      }
<span style = "background-color:#fdd">      return other.d-&gt;m_BaseDataIndex &lt; d-&gt;m_BaseDataIndex;</span>
    }
<span style = "background-color:#fdd">    return d-&gt;m_ConfidenceLevel &lt; other.d-&gt;m_ConfidenceLevel;
  }</span>

<span style = "background-color:#fdd">  FileWriterSelector::Item::Item() : d(new Impl()) {}
  void swap(FileWriterSelector &amp;fws1, FileWriterSelector &amp;fws2) { fws1.Swap(fws2); }</span>
}</pre>
	</body>
</html>
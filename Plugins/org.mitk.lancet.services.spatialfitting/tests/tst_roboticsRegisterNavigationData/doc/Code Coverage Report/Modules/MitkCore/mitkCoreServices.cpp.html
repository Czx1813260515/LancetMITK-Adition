<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkCoreServices.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkCoreServices.h"

#include &lt;mitkIMimeTypeProvider.h&gt;
#include &lt;mitkIPropertyAliases.h&gt;
#include &lt;mitkIPropertyDescriptions.h&gt;
#include &lt;mitkIPropertyExtensions.h&gt;
#include &lt;mitkIPropertyFilters.h&gt;
#include &lt;mitkIPropertyPersistence.h&gt;
#include &lt;mitkIPropertyRelations.h&gt;

#include &lt;usGetModuleContext.h&gt;
#include &lt;usModuleContext.h&gt;
#include &lt;usServiceReference.h&gt;
#include &lt;usServiceTracker.h&gt;

#include &lt;mutex&gt;

namespace mitk
{
  std::mutex &amp;s_ContextToServicesMapMutex()
<span style = "background-color:#dfd">  {
    static std::mutex mutex;
    return mutex;
  }</span>

  std::map&lt;us::ModuleContext *, std::map&lt;void *, us::ServiceReferenceU&gt;&gt; &amp;s_ContextToServicesMap()
<span style = "background-color:#dfd">  {
    static std::map&lt;us::ModuleContext *, std::map&lt;void *, us::ServiceReferenceU&gt;&gt; serviceMap;
    return serviceMap;
  }</span>

  template &lt;class S&gt;
  static S *GetCoreService(us::ModuleContext *context)
<span style = "background-color:#dfd">  {
    if (context == nullptr)</span>
<span style = "background-color:#fdd">      context = us::GetModuleContext();</span>

<span style = "background-color:#dfd">    S *coreService = nullptr;
    us::ServiceReference&lt;S&gt; serviceRef = context-&gt;GetServiceReference&lt;S&gt;();
    if (serviceRef)</span>
    {
<span style = "background-color:#dfd">      coreService = context-&gt;GetService(serviceRef);</span>
    }

<span style = "background-color:#dfd">    assert(coreService &amp;&amp; "Asserting non-nullptr MITK core service");</span>
    {
<span style = "background-color:#dfd">      std::lock_guard&lt;std::mutex&gt; l(s_ContextToServicesMapMutex());
      s_ContextToServicesMap()[context].insert(std::make_pair(coreService, serviceRef));
    }</span>

<span style = "background-color:#dfd">    return coreService;
  }</span>

  IPropertyAliases *CoreServices::GetPropertyAliases(us::ModuleContext *context)
<span style = "background-color:#fdd">  {
    return GetCoreService&lt;IPropertyAliases&gt;(context);
  }</span>

  IPropertyDescriptions *CoreServices::GetPropertyDescriptions(us::ModuleContext *context)
<span style = "background-color:#dfd">  {
    return GetCoreService&lt;IPropertyDescriptions&gt;(context);
  }</span>

  IPropertyExtensions *CoreServices::GetPropertyExtensions(us::ModuleContext *context)
<span style = "background-color:#fdd">  {
    return GetCoreService&lt;IPropertyExtensions&gt;(context);
  }</span>

  IPropertyFilters *CoreServices::GetPropertyFilters(us::ModuleContext *context)
<span style = "background-color:#fdd">  {
    return GetCoreService&lt;IPropertyFilters&gt;(context);
  }</span>

  IPropertyPersistence *CoreServices::GetPropertyPersistence(us::ModuleContext *context)
<span style = "background-color:#dfd">  {
    return GetCoreService&lt;IPropertyPersistence&gt;(context);
  }</span>

  IPropertyRelations *CoreServices::GetPropertyRelations(us::ModuleContext *context)
<span style = "background-color:#fdd">  {
    return GetCoreService&lt;IPropertyRelations&gt;(context);
  }</span>

  IMimeTypeProvider *CoreServices::GetMimeTypeProvider(us::ModuleContext *context)
<span style = "background-color:#dfd">  {
    return GetCoreService&lt;IMimeTypeProvider&gt;(context);
  }</span>

  bool CoreServices::Unget(us::ModuleContext *context, const std::string &amp; /*interfaceId*/, void *service)
<span style = "background-color:#dfd">  {
    bool success = false;</span>

<span style = "background-color:#dfd">    std::lock_guard&lt;std::mutex&gt; l(s_ContextToServicesMapMutex());
    auto iter =</span>
      s_ContextToServicesMap().find(context);
<span style = "background-color:#dfd">    if (iter != s_ContextToServicesMap().end())</span>
    {
<span style = "background-color:#dfd">      auto iter2 = iter-&gt;second.find(service);
      if (iter2 != iter-&gt;second.end())</span>
      {
<span style = "background-color:#dfd">        us::ServiceReferenceU serviceRef = iter2-&gt;second;
        if (serviceRef)</span>
        {
<span style = "background-color:#dfd">          success = context-&gt;UngetService(serviceRef);
          if (success)</span>
          {
<span style = "background-color:#dfd">            iter-&gt;second.erase(iter2);</span>
          }
        }
<span style = "background-color:#dfd">      }
    }</span>

<span style = "background-color:#dfd">    return success;
  }</span>
}</pre>
	</body>
</html>
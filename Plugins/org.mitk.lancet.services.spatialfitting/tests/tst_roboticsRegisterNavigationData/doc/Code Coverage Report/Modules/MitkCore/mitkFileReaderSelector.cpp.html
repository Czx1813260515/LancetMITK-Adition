<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkFileReaderSelector.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkFileReaderSelector.h"

#include &lt;mitkCoreServices.h&gt;
#include &lt;mitkFileReaderRegistry.h&gt;
#include &lt;mitkIMimeTypeProvider.h&gt;
#include &lt;mitkUtf8Util.h&gt;

#include &lt;usAny.h&gt;
#include &lt;usServiceProperties.h&gt;
#include &lt;usServiceReference.h&gt;

#include &lt;itksys/SystemTools.hxx&gt;

namespace mitk
{
  struct FileReaderSelector::Item::Impl : us::SharedData
  {
<span style = "background-color:#fdd">    Impl() : m_FileReader(nullptr), m_ConfidenceLevel(IFileReader::Unsupported), m_Id(-1) {}</span>
    us::ServiceReference&lt;IFileReader&gt; m_FileReaderRef;
    IFileReader *m_FileReader;
    IFileReader::ConfidenceLevel m_ConfidenceLevel;
    MimeType m_MimeType;
    long m_Id;
  };

  struct FileReaderSelector::Impl : us::SharedData
  {
<span style = "background-color:#fdd">    Impl() : m_BestId(-1), m_SelectedId(m_BestId) {}</span>
    Impl(const Impl &amp;other) : us::SharedData(other), m_BestId(-1), m_SelectedId(m_BestId) {}
    FileReaderRegistry m_ReaderRegistry;
    std::map&lt;long, FileReaderSelector::Item&gt; m_Items;
    std::vector&lt;MimeType&gt; m_MimeTypes;
    long m_BestId;
    long m_SelectedId;
  };

<span style = "background-color:#fdd">  FileReaderSelector::FileReaderSelector(const FileReaderSelector &amp;other) : m_Data(other.m_Data) {}
  FileReaderSelector::FileReaderSelector(const std::string &amp;path) : m_Data(new Impl)
  {
    if (!itksys::SystemTools::FileExists(Utf8Util::Local8BitToUtf8(path).c_str()))</span>
    {
<span style = "background-color:#fdd">      return;</span>
    }

<span style = "background-color:#fdd">    mitk::CoreServicePointer&lt;mitk::IMimeTypeProvider&gt; mimeTypeProvider(mitk::CoreServices::GetMimeTypeProvider());</span>

    // Get all mime types and associated readers for the given file path

<span style = "background-color:#fdd">    m_Data-&gt;m_MimeTypes = mimeTypeProvider-&gt;GetMimeTypesForFile(path);
    if (m_Data-&gt;m_MimeTypes.empty())
      return;</span>

<span style = "background-color:#fdd">    for (std::vector&lt;MimeType&gt;::const_iterator mimeTypeIter = m_Data-&gt;m_MimeTypes.begin(),
                                               mimeTypeIterEnd = m_Data-&gt;m_MimeTypes.end();
         mimeTypeIter != mimeTypeIterEnd;
         ++mimeTypeIter)</span>
    {
<span style = "background-color:#fdd">      std::vector&lt;FileReaderRegistry::ReaderReference&gt; refs = m_Data-&gt;m_ReaderRegistry.GetReferences(*mimeTypeIter);
      for (std::vector&lt;FileReaderRegistry::ReaderReference&gt;::const_iterator readerIter = refs.begin(),
                                                                            iterEnd = refs.end();
           readerIter != iterEnd;
           ++readerIter)</span>
      {
<span style = "background-color:#fdd">        IFileReader *reader = m_Data-&gt;m_ReaderRegistry.GetReader(*readerIter);
        if (reader == nullptr)
          continue;</span>
        try
        {
<span style = "background-color:#fdd">          reader-&gt;SetInput(path);
          IFileReader::ConfidenceLevel confidenceLevel = reader-&gt;GetConfidenceLevel();
          if (confidenceLevel == IFileReader::Unsupported)</span>
          {
<span style = "background-color:#fdd">            continue;</span>
          }

<span style = "background-color:#fdd">          Item item;
          item.d-&gt;m_FileReaderRef = *readerIter;
          item.d-&gt;m_FileReader = reader;
          item.d-&gt;m_ConfidenceLevel = confidenceLevel;
          item.d-&gt;m_MimeType = *mimeTypeIter;
          item.d-&gt;m_Id = us::any_cast&lt;long&gt;(readerIter-&gt;GetProperty(us::ServiceConstants::SERVICE_ID()));
          m_Data-&gt;m_Items.insert(std::make_pair(item.d-&gt;m_Id, item));</span>
          // m_Data-&gt;m_MimeTypes.insert(mimeType);
<span style = "background-color:#fdd">        }</span>
        catch (const us::BadAnyCastException &amp;e)
<span style = "background-color:#fdd">        {
          MITK_WARN &lt;&lt; "Unexpected: " &lt;&lt; e.what();
        }</span>
        catch (const std::exception &amp;e)
<span style = "background-color:#fdd">        {</span>
          // Log the error but continue
<span style = "background-color:#fdd">          MITK_WARN &lt;&lt; "IFileWriter::GetConfidenceLevel exception: " &lt;&lt; e.what();
        }
      }
    }</span>

    // get the "best" reader

<span style = "background-color:#fdd">    if (!m_Data-&gt;m_Items.empty())</span>
    {
<span style = "background-color:#fdd">      std::set&lt;Item&gt; sortedItems;
      for (std::map&lt;long, Item&gt;::const_iterator iter = m_Data-&gt;m_Items.begin(), iterEnd = m_Data-&gt;m_Items.end();
           iter != iterEnd;
           ++iter)</span>
      {
<span style = "background-color:#fdd">        sortedItems.insert(iter-&gt;second);
      }
      m_Data-&gt;m_BestId = sortedItems.rbegin()-&gt;GetServiceId();
      m_Data-&gt;m_SelectedId = m_Data-&gt;m_BestId;
    }
  }</span>

<span style = "background-color:#fdd">  FileReaderSelector::~FileReaderSelector() {}</span>
  FileReaderSelector &amp;FileReaderSelector::operator=(const FileReaderSelector &amp;other)
<span style = "background-color:#fdd">  {
    m_Data = other.m_Data;
    return *this;
  }</span>

<span style = "background-color:#fdd">  bool FileReaderSelector::IsEmpty() const { return m_Data-&gt;m_Items.empty(); }
  std::vector&lt;MimeType&gt; FileReaderSelector::GetMimeTypes() const { return m_Data-&gt;m_MimeTypes; }</span>
  std::vector&lt;FileReaderSelector::Item&gt; FileReaderSelector::Get() const
<span style = "background-color:#fdd">  {
    std::vector&lt;Item&gt; result;
    for (std::map&lt;long, Item&gt;::const_iterator iter = m_Data-&gt;m_Items.begin(), iterEnd = m_Data-&gt;m_Items.end();
         iter != iterEnd;
         ++iter)</span>
    {
<span style = "background-color:#fdd">      result.push_back(iter-&gt;second);
    }
    std::sort(result.begin(), result.end());
    return result;
  }</span>

  FileReaderSelector::Item FileReaderSelector::Get(long id) const
<span style = "background-color:#fdd">  {
    std::map&lt;long, Item&gt;::const_iterator iter = m_Data-&gt;m_Items.find(id);
    if (iter != m_Data-&gt;m_Items.end())</span>
    {
<span style = "background-color:#fdd">      return iter-&gt;second;</span>
    }
<span style = "background-color:#fdd">    return Item();
  }</span>

<span style = "background-color:#fdd">  FileReaderSelector::Item FileReaderSelector::GetDefault() const { return Get(m_Data-&gt;m_BestId); }
  long FileReaderSelector::GetDefaultId() const { return m_Data-&gt;m_BestId; }
  FileReaderSelector::Item FileReaderSelector::GetSelected() const { return Get(m_Data-&gt;m_SelectedId); }
  long FileReaderSelector::GetSelectedId() const { return m_Data-&gt;m_SelectedId; }
  bool FileReaderSelector::Select(const FileReaderSelector::Item &amp;item) { return Select(item.d-&gt;m_Id); }</span>
  bool FileReaderSelector::Select(long id)
<span style = "background-color:#fdd">  {
    if (id &gt; -1)</span>
    {
<span style = "background-color:#fdd">      if (m_Data-&gt;m_Items.find(id) == m_Data-&gt;m_Items.end())</span>
      {
<span style = "background-color:#fdd">        return false;</span>
      }
<span style = "background-color:#fdd">      m_Data-&gt;m_SelectedId = id;
      return true;</span>
    }
<span style = "background-color:#fdd">    return false;
  }</span>

<span style = "background-color:#fdd">  void FileReaderSelector::Swap(FileReaderSelector &amp;fws) { m_Data.Swap(fws.m_Data); }
  FileReaderSelector::Item::Item(const FileReaderSelector::Item &amp;other) : d(other.d) {}
  FileReaderSelector::Item::~Item() {}</span>
  FileReaderSelector::Item &amp;FileReaderSelector::Item::operator=(const FileReaderSelector::Item &amp;other)
<span style = "background-color:#fdd">  {
    d = other.d;
    return *this;
  }</span>

<span style = "background-color:#fdd">  IFileReader *FileReaderSelector::Item::GetReader() const { return d-&gt;m_FileReader; }</span>
  std::string FileReaderSelector::Item::GetDescription() const
<span style = "background-color:#fdd">  {
    us::Any descr = d-&gt;m_FileReaderRef.GetProperty(IFileReader::PROP_DESCRIPTION());
    if (descr.Empty())
      return std::string();
    return descr.ToString();
  }</span>

<span style = "background-color:#fdd">  IFileReader::ConfidenceLevel FileReaderSelector::Item::GetConfidenceLevel() const { return d-&gt;m_ConfidenceLevel; }
  MimeType FileReaderSelector::Item::GetMimeType() const { return d-&gt;m_MimeType; }
  us::ServiceReference&lt;IFileReader&gt; FileReaderSelector::Item::GetReference() const { return d-&gt;m_FileReaderRef; }
  long FileReaderSelector::Item::GetServiceId() const { return d-&gt;m_Id; }</span>
  bool FileReaderSelector::Item::operator&lt;(const FileReaderSelector::Item &amp;other) const
<span style = "background-color:#fdd">  {</span>
    // sort by confidence level first (ascending)
<span style = "background-color:#fdd">    if (d-&gt;m_ConfidenceLevel == other.d-&gt;m_ConfidenceLevel)</span>
    {
      // sort by mime-type ranking
<span style = "background-color:#fdd">      if (d-&gt;m_MimeType &lt; other.d-&gt;m_MimeType)</span>
      {
<span style = "background-color:#fdd">        return true;
      }
      else if (other.d-&gt;m_MimeType &lt; d-&gt;m_MimeType)</span>
      {
<span style = "background-color:#fdd">        return false;
      }</span>
      else
      {
        // sort by file writer service ranking
<span style = "background-color:#fdd">        return d-&gt;m_FileReaderRef &lt; other.d-&gt;m_FileReaderRef;</span>
      }
    }
<span style = "background-color:#fdd">    return d-&gt;m_ConfidenceLevel &lt; other.d-&gt;m_ConfidenceLevel;
  }</span>

<span style = "background-color:#fdd">  FileReaderSelector::Item::Item() : d(new Impl()) {}
  void swap(FileReaderSelector &amp;frs1, FileReaderSelector &amp;frs2) { frs1.Swap(frs2); }</span>
}</pre>
	</body>
</html>
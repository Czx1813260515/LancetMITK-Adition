<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkAbstractFileWriter.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include &lt;mitkAbstractFileWriter.h&gt;

#include &lt;mitkBaseData.h&gt;
#include &lt;mitkCustomMimeType.h&gt;
#include &lt;mitkExceptionMacro.h&gt;
#include &lt;mitkIOUtil.h&gt;
#include &lt;mitkUtf8Util.h&gt;

#include &lt;mitkFileReaderWriterBase.h&gt;

#include &lt;usGetModuleContext.h&gt;
#include &lt;usModuleContext.h&gt;
#include &lt;usPrototypeServiceFactory.h&gt;

#include &lt;itksys/SystemTools.hxx&gt;

#include &lt;fstream&gt;

namespace mitk
{
  struct AbstractFileWriter::LocalFile::Impl
  {
<span style = "background-color:#fdd">    Impl(const std::string &amp;location, std::ostream *os) : m_Location(location), m_Stream(os) {}</span>
    std::string m_Location;
    std::string m_TmpFileName;
    std::ostream *m_Stream;
  };

  AbstractFileWriter::LocalFile::LocalFile(IFileWriter *writer)
<span style = "background-color:#fdd">    : d(new Impl(writer-&gt;GetOutputLocation(), writer-&gt;GetOutputStream()))
  {
  }</span>

  AbstractFileWriter::LocalFile::~LocalFile()
<span style = "background-color:#fdd">  {
    if (d-&gt;m_Stream &amp;&amp; !d-&gt;m_TmpFileName.empty())</span>
    {
<span style = "background-color:#fdd">      std::ifstream ifs(d-&gt;m_TmpFileName.c_str(), std::ios_base::binary);
      *d-&gt;m_Stream &lt;&lt; ifs.rdbuf();
      d-&gt;m_Stream-&gt;flush();
      ifs.close();
      std::remove(d-&gt;m_TmpFileName.c_str());
    }
  }</span>

  std::string AbstractFileWriter::LocalFile::GetFileName()
<span style = "background-color:#fdd">  {
    if (d-&gt;m_Stream == nullptr)</span>
    {
<span style = "background-color:#fdd">      return d-&gt;m_Location;
    }
    else if (d-&gt;m_TmpFileName.empty())</span>
    {
<span style = "background-color:#fdd">      std::string ext = Utf8Util::Utf8ToLocal8Bit(itksys::SystemTools::GetFilenameExtension(Utf8Util::Local8BitToUtf8(d-&gt;m_Location)));
      d-&gt;m_TmpFileName = IOUtil::CreateTemporaryFile("XXXXXX" + ext);
    }
    return d-&gt;m_TmpFileName;
  }</span>

  AbstractFileWriter::OutputStream::OutputStream(IFileWriter *writer, std::ios_base::openmode mode)
<span style = "background-color:#fdd">    : std::ostream(nullptr), m_Stream(nullptr)
  {
    std::ostream *stream = writer-&gt;GetOutputStream();
    if (stream)</span>
    {
<span style = "background-color:#fdd">      this-&gt;init(stream-&gt;rdbuf());
    }</span>
    else
    {
<span style = "background-color:#fdd">      m_Stream = new std::ofstream(writer-&gt;GetOutputLocation().c_str(), mode);
      this-&gt;init(m_Stream-&gt;rdbuf());</span>
    }
<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  AbstractFileWriter::OutputStream::~OutputStream() { delete m_Stream; }</span>
  class AbstractFileWriter::Impl : public FileReaderWriterBase
  {
  public:
<span style = "background-color:#dfd">    Impl() : FileReaderWriterBase(), m_BaseData(nullptr), m_Stream(nullptr), m_PrototypeFactory(nullptr) {}</span>
    Impl(const Impl &amp;other)
<span style = "background-color:#fdd">      : FileReaderWriterBase(other),
        m_BaseDataType(other.m_BaseDataType),
        m_BaseData(nullptr),
        m_Stream(nullptr),
        m_PrototypeFactory(nullptr)
    {
    }</span>

    std::string m_BaseDataType;
    const BaseData *m_BaseData;
    std::string m_Location;
    std::ostream *m_Stream;

    us::PrototypeServiceFactory *m_PrototypeFactory;
    us::ServiceRegistration&lt;IFileWriter&gt; m_Reg;
  };

<span style = "background-color:#fdd">  void AbstractFileWriter::SetInput(const BaseData *data) { d-&gt;m_BaseData = data; }
  const BaseData *AbstractFileWriter::GetInput() const { return d-&gt;m_BaseData; }</span>
  void AbstractFileWriter::SetOutputLocation(const std::string &amp;location)
<span style = "background-color:#fdd">  {
    d-&gt;m_Location = location;
    d-&gt;m_Stream = nullptr;
  }</span>

<span style = "background-color:#fdd">  std::string AbstractFileWriter::GetOutputLocation() const { return d-&gt;m_Location; }</span>
  void AbstractFileWriter::SetOutputStream(const std::string &amp;location, std::ostream *os)
<span style = "background-color:#fdd">  {
    d-&gt;m_Location = location;
    d-&gt;m_Stream = os;
  }</span>

<span style = "background-color:#fdd">  std::ostream *AbstractFileWriter::GetOutputStream() const { return d-&gt;m_Stream; }</span>
  AbstractFileWriter::~AbstractFileWriter()
<span style = "background-color:#dfd">  {
    UnregisterService();</span>

<span style = "background-color:#dfd">    delete d-&gt;m_PrototypeFactory;
  }</span>

<span style = "background-color:#fdd">  AbstractFileWriter::AbstractFileWriter(const AbstractFileWriter &amp;other) : IFileWriter(), d(new Impl(*other.d.get()))
  {
  }</span>

<span style = "background-color:#dfd">  AbstractFileWriter::AbstractFileWriter(const std::string &amp;baseDataType) : d(new Impl)
  {
    d-&gt;m_BaseDataType = baseDataType;
  }</span>

  AbstractFileWriter::AbstractFileWriter(const std::string &amp;baseDataType,
                                         const CustomMimeType &amp;mimeType,
                                         const std::string &amp;description)
<span style = "background-color:#dfd">    : d(new Impl)
  {
    d-&gt;m_BaseDataType = baseDataType;
    d-&gt;SetMimeType(mimeType);
    d-&gt;SetDescription(description);
  }</span>

  ////////////////////// Writing /////////////////////////

  IFileWriter::ConfidenceLevel AbstractFileWriter::GetConfidenceLevel() const
<span style = "background-color:#fdd">  {
    if (d-&gt;m_BaseData == nullptr)
      return Unsupported;</span>

<span style = "background-color:#fdd">    std::vector&lt;std::string&gt; classHierarchy = d-&gt;m_BaseData-&gt;GetClassHierarchy();
    if (std::find(classHierarchy.begin(), classHierarchy.end(), d-&gt;m_BaseDataType) == classHierarchy.end())</span>
    {
<span style = "background-color:#fdd">      return Unsupported;</span>
    }
<span style = "background-color:#fdd">    return Supported;
  }</span>

<span style = "background-color:#fdd">  MimeType AbstractFileWriter::GetRegisteredMimeType() const { return d-&gt;GetRegisteredMimeType(); }</span>
  //////////// ÂµS Registration &amp; Properties //////////////

  us::ServiceRegistration&lt;IFileWriter&gt; AbstractFileWriter::RegisterService(us::ModuleContext *context)
<span style = "background-color:#dfd">  {
    if (d-&gt;m_PrototypeFactory)</span>
<span style = "background-color:#fdd">      return us::ServiceRegistration&lt;IFileWriter&gt;();</span>

<span style = "background-color:#dfd">    if (context == nullptr)</span>
    {
<span style = "background-color:#fdd">      context = us::GetModuleContext();</span>
    }

<span style = "background-color:#dfd">    d-&gt;RegisterMimeType(context);</span>

<span style = "background-color:#dfd">    if (this-&gt;GetMimeType()-&gt;GetName().empty())</span>
    {
<span style = "background-color:#fdd">      MITK_WARN &lt;&lt; "Not registering writer due to empty MIME type.";
      return us::ServiceRegistration&lt;IFileWriter&gt;();</span>
    }

    struct PrototypeFactory : public us::PrototypeServiceFactory
    {
      AbstractFileWriter *const m_Prototype;

<span style = "background-color:#dfd">      PrototypeFactory(AbstractFileWriter *prototype) : m_Prototype(prototype) {}</span>
      us::InterfaceMap GetService(us::Module * /*module*/,
                                  const us::ServiceRegistrationBase &amp; /*registration*/) override
<span style = "background-color:#fdd">      {
        return us::MakeInterfaceMap&lt;IFileWriter&gt;(m_Prototype-&gt;Clone());
      }</span>

      void UngetService(us::Module * /*module*/,
                        const us::ServiceRegistrationBase &amp; /*registration*/,
                        const us::InterfaceMap &amp;service) override
<span style = "background-color:#fdd">      {
        delete us::ExtractInterface&lt;IFileWriter&gt;(service);
      }</span>
    };

<span style = "background-color:#dfd">    d-&gt;m_PrototypeFactory = new PrototypeFactory(this);
    us::ServiceProperties props = this-&gt;GetServiceProperties();
    d-&gt;m_Reg = context-&gt;RegisterService&lt;IFileWriter&gt;(d-&gt;m_PrototypeFactory, props);
    return d-&gt;m_Reg;
  }</span>

  void AbstractFileWriter::UnregisterService()
<span style = "background-color:#dfd">  {</span>
    try
    {
<span style = "background-color:#dfd">      d-&gt;m_Reg.Unregister();</span>
    }
    catch (const std::exception &amp;)
<span style = "background-color:#dfd">    {
    }
  }</span>

  us::ServiceProperties AbstractFileWriter::GetServiceProperties() const
<span style = "background-color:#dfd">  {
    us::ServiceProperties result;
    result[IFileWriter::PROP_DESCRIPTION()] = this-&gt;GetDescription();
    result[IFileWriter::PROP_MIMETYPE()] = this-&gt;GetMimeType()-&gt;GetName();
    result[IFileWriter::PROP_BASEDATA_TYPE()] = d-&gt;m_BaseDataType;
    result[us::ServiceConstants::SERVICE_RANKING()] = this-&gt;GetRanking();</span>

    //  for (IFileWriter::OptionList::const_iterator it = d-&gt;m_Options.begin(); it != d-&gt;m_Options.end(); ++it)
    //  {
    //    result[it-&gt;first] = std::string("true");
    //  }
<span style = "background-color:#dfd">    return result;
  }</span>

<span style = "background-color:#dfd">  const CustomMimeType *AbstractFileWriter::GetMimeType() const { return d-&gt;GetMimeType(); }
  void AbstractFileWriter::SetMimeTypePrefix(const std::string &amp;prefix) { d-&gt;SetMimeTypePrefix(prefix); }</span>
<span style = "background-color:#fdd">  std::string AbstractFileWriter::GetMimeTypePrefix() const { return d-&gt;GetMimeTypePrefix(); }</span>
  us::ServiceRegistration&lt;CustomMimeType&gt; AbstractFileWriter::RegisterMimeType(us::ModuleContext *context)
<span style = "background-color:#fdd">  {
    return d-&gt;RegisterMimeType(context);
  }</span>

<span style = "background-color:#dfd">  void AbstractFileWriter::SetMimeType(const CustomMimeType &amp;mimeType) { d-&gt;SetMimeType(mimeType); }
  void AbstractFileWriter::SetRanking(int ranking) { d-&gt;SetRanking(ranking); }</span>
  //////////////////////// Options ///////////////////////

  void AbstractFileWriter::SetDefaultOptions(const IFileWriter::Options &amp;defaultOptions)
<span style = "background-color:#dfd">  {
    d-&gt;SetDefaultOptions(defaultOptions);
  }</span>

<span style = "background-color:#fdd">  IFileWriter::Options AbstractFileWriter::GetDefaultOptions() const { return d-&gt;GetDefaultOptions(); }
  IFileWriter::Options AbstractFileWriter::GetOptions() const { return d-&gt;GetOptions(); }
  us::Any AbstractFileWriter::GetOption(const std::string &amp;name) const { return d-&gt;GetOption(name); }
  void AbstractFileWriter::SetOption(const std::string &amp;name, const us::Any &amp;value) { d-&gt;SetOption(name, value); }
  void AbstractFileWriter::SetOptions(const Options &amp;options) { d-&gt;SetOptions(options); }</span>
  ////////////////// MISC //////////////////

<span style = "background-color:#fdd">  void AbstractFileWriter::AddProgressCallback(const ProgressCallback &amp;callback) { d-&gt;AddProgressCallback(callback); }</span>
  void AbstractFileWriter::RemoveProgressCallback(const ProgressCallback &amp;callback)
<span style = "background-color:#fdd">  {
    d-&gt;RemoveProgressCallback(callback);
  }</span>

  ////////////////// ÂµS related Getters //////////////////

<span style = "background-color:#dfd">  int AbstractFileWriter::GetRanking() const { return d-&gt;GetRanking(); }</span>
<span style = "background-color:#fdd">  void AbstractFileWriter::SetBaseDataType(const std::string &amp;baseDataType) { d-&gt;m_BaseDataType = baseDataType; }</span>
<span style = "background-color:#dfd">  std::string AbstractFileWriter::GetDescription() const { return d-&gt;GetDescription(); }</span>
<span style = "background-color:#fdd">  std::string AbstractFileWriter::GetBaseDataType() const { return d-&gt;m_BaseDataType; }</span>
  void AbstractFileWriter::ValidateOutputLocation() const
<span style = "background-color:#fdd">  {
    if (this-&gt;GetOutputStream() == nullptr)</span>
    {
      // check if a file name is set and if we can write to it
<span style = "background-color:#fdd">      const std::string fileName = this-&gt;GetOutputLocation();
      if (fileName.empty())</span>
      {
<span style = "background-color:#fdd">        mitkThrow() &lt;&lt; "No output location or stream specified";</span>
      }
<span style = "background-color:#fdd">    }
  }</span>

<span style = "background-color:#dfd">  void AbstractFileWriter::SetDescription(const std::string &amp;description) { d-&gt;SetDescription(description); }</span>
}</pre>
	</body>
</html>
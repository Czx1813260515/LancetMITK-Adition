<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkITKImageImport.txx</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#ifndef __mitkITKImageImport_txx
#define __mitkITKImageImport_txx
#include "mitkITKImageImport.h"
#include "mitkImageReadAccessor.h"

template &lt;class TInputImage&gt;
mitk::ITKImageImport&lt;TInputImage&gt;::ITKImageImport()
<span style = "background-color:#fdd">{
}</span>

template &lt;class TInputImage&gt;
mitk::ITKImageImport&lt;TInputImage&gt;::~ITKImageImport()
<span style = "background-color:#fdd">{
}</span>

template &lt;class TInputImage&gt;
typename mitk::ITKImageImport&lt;TInputImage&gt;::InputImageType *mitk::ITKImageImport&lt;TInputImage&gt;::GetInput(void)
<span style = "background-color:#fdd">{
  return static_cast&lt;TInputImage *&gt;(this-&gt;ProcessObject::GetInput(0));
}</span>

template &lt;class TInputImage&gt;
void mitk::ITKImageImport&lt;TInputImage&gt;::SetInput(const InputImageType *input)
<span style = "background-color:#fdd">{
  this-&gt;ProcessObject::SetNthInput(0, const_cast&lt;TInputImage *&gt;(input));
}</span>

template &lt;class TInputImage&gt;
void mitk::ITKImageImport&lt;TInputImage&gt;::SetGeometry(const BaseGeometry *geometry)
<span style = "background-color:#fdd">{
  if (geometry != nullptr)</span>
  {
<span style = "background-color:#fdd">    m_Geometry = static_cast&lt;mitk::BaseGeometry *&gt;(geometry-&gt;Clone().GetPointer());
  }</span>
  else
  {
<span style = "background-color:#fdd">    m_Geometry = nullptr;</span>
  }
<span style = "background-color:#fdd">  Modified();
}</span>

template &lt;class TInputImage&gt;
void mitk::ITKImageImport&lt;TInputImage&gt;::GenerateOutputInformation()
<span style = "background-color:#fdd">{
  InputImageConstPointer input = this-&gt;GetInput();
  mitk::Image::Pointer output = this-&gt;GetOutput();</span>

<span style = "background-color:#fdd">  itkDebugMacro(&lt;&lt; "GenerateOutputInformation()");</span>

<span style = "background-color:#fdd">  output-&gt;InitializeByItk(input.GetPointer());</span>

<span style = "background-color:#fdd">  if (m_Geometry.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    output-&gt;SetGeometry(m_Geometry);</span>
  }
<span style = "background-color:#fdd">}</span>

template &lt;class TInputImage&gt;
void mitk::ITKImageImport&lt;TInputImage&gt;::GenerateData()
<span style = "background-color:#fdd">{
  InputImageConstPointer input = this-&gt;GetInput();
  mitk::Image::Pointer output = this-&gt;GetOutput();</span>

<span style = "background-color:#fdd">  output-&gt;SetImportChannel((void *)input-&gt;GetBufferPointer(), 0, mitk::Image::ReferenceMemory);
}</span>

template &lt;class TInputImage&gt;
void mitk::ITKImageImport&lt;TInputImage&gt;::GenerateInputRequestedRegion()
<span style = "background-color:#fdd">{
  Superclass::GenerateInputRequestedRegion();</span>

  // Input is an image, cast away the constness so we can set
  // the requested region.
<span style = "background-color:#fdd">  InputImagePointer input = const_cast&lt;TInputImage *&gt;(this-&gt;GetInput());</span>

  // Use the function object RegionCopier to copy the output region
  // to the input.  The default region copier has default implementations
  // to handle the cases where the input and output are the same
  // dimension, the input a higher dimension than the output, and the
  // input a lower dimension than the output.
<span style = "background-color:#fdd">  InputImageRegionType inputRegion;
  OutputToInputRegionCopierType regionCopier;
  regionCopier(inputRegion, this-&gt;GetOutput()-&gt;GetRequestedRegion());
  input-&gt;SetRequestedRegion(inputRegion);
}</span>

template &lt;class TInputImage&gt;
void mitk::ITKImageImport&lt;TInputImage&gt;::SetNthOutput(DataObjectPointerArraySizeType idx, itk::DataObject *output)
<span style = "background-color:#fdd">{
  if ((output == nullptr) &amp;&amp; (idx == 0))</span>
  {
    // we are disconnected from our output:
    // copy buffer of input to output, because we
    // cannot guarantee that the input (to which our
    // output is refering) will stay alive.
<span style = "background-color:#fdd">    InputImageConstPointer input = this-&gt;GetInput();
    mitk::Image::Pointer currentOutput = this-&gt;GetOutput();
    if (input.IsNotNull() &amp;&amp; currentOutput.IsNotNull())
      currentOutput-&gt;SetChannel(input-&gt;GetBufferPointer());
  }
  Superclass::SetNthOutput(idx, output);
}</span>

template &lt;typename ItkOutputImageType&gt;
mitk::Image::Pointer mitk::ImportItkImage(const itk::SmartPointer&lt;ItkOutputImageType&gt; &amp;itkimage,
                                          const BaseGeometry *geometry,
                                          bool update)
{
  typename mitk::ITKImageImport&lt;ItkOutputImageType&gt;::Pointer importer = mitk::ITKImageImport&lt;ItkOutputImageType&gt;::New();
  importer-&gt;SetInput(itkimage);
  importer-&gt;SetGeometry(geometry);
  if (update)
    importer-&gt;Update();
  return importer-&gt;GetOutput();
}

template &lt;typename ItkOutputImageType&gt;
mitk::Image::Pointer mitk::ImportItkImage(const ItkOutputImageType *itkimage, const BaseGeometry *geometry, bool update)
<span style = "background-color:#fdd">{
  typename mitk::ITKImageImport&lt;ItkOutputImageType&gt;::Pointer importer = mitk::ITKImageImport&lt;ItkOutputImageType&gt;::New();
  importer-&gt;SetInput(itkimage);
  importer-&gt;SetGeometry(geometry);
  if (update)
    importer-&gt;Update();
  return importer-&gt;GetOutput();
}</span>

template &lt;typename ItkOutputImageType&gt;
mitk::Image::Pointer mitk::GrabItkImageMemory(itk::SmartPointer&lt;ItkOutputImageType&gt; &amp;itkimage,
                                              mitk::Image *mitkImage,
                                              const BaseGeometry *geometry,
                                              bool update)
<span style = "background-color:#fdd">{
  return GrabItkImageMemory(itkimage.GetPointer(), mitkImage, geometry, update);
}</span>

template &lt;typename ItkOutputImageType&gt;
mitk::Image::Pointer mitk::GrabItkImageMemory(ItkOutputImageType *itkimage,
                                              mitk::Image *mitkImage,
                                              const BaseGeometry *geometry,
                                              bool update)
<span style = "background-color:#fdd">{
  if (update)
    itkimage-&gt;Update();</span>

<span style = "background-color:#fdd">  mitk::Image::Pointer resultImage;
  if (mitkImage != nullptr)</span>
  {
<span style = "background-color:#fdd">    resultImage = mitkImage;</span>

    // test the pointer equality with read accessor only if mitk Image is intialized, otherwise an Exception is thrown
    // by the ReadAccessor
<span style = "background-color:#fdd">    if (mitkImage-&gt;IsInitialized())</span>
    {
      // check the data pointer, for that, we need to ignore the lock of the mitkImage
<span style = "background-color:#fdd">      mitk::ImageReadAccessor read_probe(mitk::Image::Pointer(mitkImage), nullptr, mitk::ImageAccessorBase::IgnoreLock);
      if (itkimage-&gt;GetBufferPointer() == read_probe.GetData())
        return resultImage;
    }
  }</span>
  else
  {
<span style = "background-color:#fdd">    resultImage = mitk::Image::New();</span>
  }
<span style = "background-color:#fdd">  resultImage-&gt;InitializeByItk(itkimage);
  resultImage-&gt;SetImportVolume(itkimage-&gt;GetBufferPointer(), 0, 0, Image::ManageMemory);
  itkimage-&gt;GetPixelContainer()-&gt;ContainerManageMemoryOff();</span>

<span style = "background-color:#fdd">  if (geometry != nullptr)
    resultImage-&gt;SetGeometry(static_cast&lt;mitk::BaseGeometry *&gt;(geometry-&gt;Clone().GetPointer()));</span>

<span style = "background-color:#fdd">  return resultImage;
}</span>

#endif //__mitkITKImageImport_txx</pre>
	</body>
</html>
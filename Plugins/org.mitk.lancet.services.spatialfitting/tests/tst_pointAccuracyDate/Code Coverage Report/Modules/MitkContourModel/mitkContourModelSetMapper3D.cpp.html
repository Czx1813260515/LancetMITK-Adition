<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkContourModelSetMapper3D.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/
#include &lt;mitkContourModelSetMapper3D.h&gt;

#include "mitkSurface.h"
#include &lt;vtkCellArray.h&gt;
#include &lt;vtkPoints.h&gt;
#include &lt;vtkPolyLine.h&gt;
#include &lt;vtkProperty.h&gt;

mitk::ContourModelSetMapper3D::ContourModelSetMapper3D()
<span style = "background-color:#fdd">{
}</span>

mitk::ContourModelSetMapper3D::~ContourModelSetMapper3D()
<span style = "background-color:#fdd">{
}</span>

const mitk::ContourModelSet *mitk::ContourModelSetMapper3D::GetInput(void)
<span style = "background-color:#fdd">{</span>
  // convenient way to get the data from the dataNode
<span style = "background-color:#fdd">  return static_cast&lt;const mitk::ContourModelSet *&gt;(GetDataNode()-&gt;GetData());
}</span>

vtkProp *mitk::ContourModelSetMapper3D::GetVtkProp(mitk::BaseRenderer *renderer)
<span style = "background-color:#fdd">{</span>
  // return the actor corresponding to the renderer
<span style = "background-color:#fdd">  return m_LSH.GetLocalStorage(renderer)-&gt;m_Assembly;
}</span>

void mitk::ContourModelSetMapper3D::GenerateDataForRenderer(mitk::BaseRenderer *renderer)
<span style = "background-color:#fdd">{</span>
  /* First convert the contourModel to vtkPolyData, then tube filter it and
   * set it input for our mapper
   */

<span style = "background-color:#fdd">  LocalStorage *localStorage = m_LSH.GetLocalStorage(renderer);</span>

<span style = "background-color:#fdd">  auto *contourModelSet = dynamic_cast&lt;ContourModelSet *&gt;(this-&gt;GetDataNode()-&gt;GetData());</span>

<span style = "background-color:#fdd">  if (contourModelSet != nullptr)</span>
  {
<span style = "background-color:#fdd">    vtkSmartPointer&lt;vtkPoints&gt; points = vtkSmartPointer&lt;vtkPoints&gt;::New();
    vtkSmartPointer&lt;vtkCellArray&gt; cells = vtkSmartPointer&lt;vtkCellArray&gt;::New();
    vtkIdType baseIndex = 0;</span>

<span style = "background-color:#fdd">    auto it = contourModelSet-&gt;Begin();
    auto end = contourModelSet-&gt;End();</span>

<span style = "background-color:#fdd">    while (it != end)</span>
    {
<span style = "background-color:#fdd">      ContourModel *contourModel = it-&gt;GetPointer();</span>

<span style = "background-color:#fdd">      auto vertIt = contourModel-&gt;Begin();
      auto vertEnd = contourModel-&gt;End();</span>

<span style = "background-color:#fdd">      while (vertIt != vertEnd)</span>
      {
<span style = "background-color:#fdd">        points-&gt;InsertNextPoint((*vertIt)-&gt;Coordinates[0], (*vertIt)-&gt;Coordinates[1], (*vertIt)-&gt;Coordinates[2]);
        ++vertIt;
      }</span>

<span style = "background-color:#fdd">      vtkSmartPointer&lt;vtkPolyLine&gt; line = vtkSmartPointer&lt;vtkPolyLine&gt;::New();
      vtkIdList *pointIds = line-&gt;GetPointIds();</span>

<span style = "background-color:#fdd">      vtkIdType numPoints = contourModel-&gt;GetNumberOfVertices();
      pointIds-&gt;SetNumberOfIds(numPoints + 1);</span>

<span style = "background-color:#fdd">      for (vtkIdType i = 0; i &lt; numPoints; ++i)
        pointIds-&gt;SetId(i, baseIndex + i);</span>

<span style = "background-color:#fdd">      pointIds-&gt;SetId(numPoints, baseIndex);</span>

<span style = "background-color:#fdd">      cells-&gt;InsertNextCell(line);</span>

<span style = "background-color:#fdd">      baseIndex += numPoints;</span>

<span style = "background-color:#fdd">      ++it;
    }</span>

<span style = "background-color:#fdd">    vtkSmartPointer&lt;vtkPolyData&gt; polyData = vtkSmartPointer&lt;vtkPolyData&gt;::New();
    polyData-&gt;SetPoints(points);
    polyData-&gt;SetLines(cells);</span>

<span style = "background-color:#fdd">    vtkSmartPointer&lt;vtkPolyDataMapper&gt; mapper = vtkSmartPointer&lt;vtkPolyDataMapper&gt;::New();
    vtkSmartPointer&lt;vtkActor&gt; actor = vtkSmartPointer&lt;vtkActor&gt;::New();
    actor-&gt;SetMapper(mapper);</span>

<span style = "background-color:#fdd">    mapper-&gt;SetInputData(polyData);</span>

<span style = "background-color:#fdd">    localStorage-&gt;m_Assembly-&gt;AddPart(actor);
  }
  this-&gt;ApplyContourProperties(renderer);
  this-&gt;ApplyContourModelSetProperties(renderer);
}</span>

void mitk::ContourModelSetMapper3D::Update(mitk::BaseRenderer *renderer)
<span style = "background-color:#fdd">{
  bool visible = true;
  GetDataNode()-&gt;GetVisibility(visible, renderer, "visible");</span>

<span style = "background-color:#fdd">  auto *data = static_cast&lt;mitk::ContourModel *&gt;(GetDataNode()-&gt;GetData());
  if (data == nullptr)</span>
  {
<span style = "background-color:#fdd">    return;</span>
  }

  // Calculate time step of the input data for the specified renderer (integer value)
<span style = "background-color:#fdd">  this-&gt;CalculateTimeStep(renderer);</span>

<span style = "background-color:#fdd">  LocalStorage *localStorage = m_LSH.GetLocalStorage(renderer);</span>

<span style = "background-color:#fdd">  if (this-&gt;GetTimestep() == -1)</span>
  {
<span style = "background-color:#fdd">    return;</span>
  }

<span style = "background-color:#fdd">  const DataNode *node = this-&gt;GetDataNode();
  data-&gt;UpdateOutputInformation();</span>

  // check if something important has changed and we need to rerender
  if ((localStorage-&gt;m_LastUpdateTime &lt; node-&gt;GetMTime()) // was the node modified?
      ||
      (localStorage-&gt;m_LastUpdateTime &lt; data-&gt;GetPipelineMTime()) // Was the data modified?
      ||
      (localStorage-&gt;m_LastUpdateTime &lt;
       renderer-&gt;GetCurrentWorldPlaneGeometryUpdateTime()) // was the geometry modified?
      ||
      (localStorage-&gt;m_LastUpdateTime &lt; renderer-&gt;GetCurrentWorldPlaneGeometry()-&gt;GetMTime()) ||
      (localStorage-&gt;m_LastUpdateTime &lt; node-&gt;GetPropertyList()-&gt;GetMTime()) // was a property modified?
<span style = "background-color:#fdd">      ||</span>
      (localStorage-&gt;m_LastUpdateTime &lt; node-&gt;GetPropertyList(renderer)-&gt;GetMTime()))
  {
<span style = "background-color:#fdd">    this-&gt;GenerateDataForRenderer(renderer);</span>
  }

  // since we have checked that nothing important has changed, we can set
  // m_LastUpdateTime to the current time
<span style = "background-color:#fdd">  localStorage-&gt;m_LastUpdateTime.Modified();
}</span>

vtkSmartPointer&lt;vtkPolyData&gt; mitk::ContourModelSetMapper3D::CreateVtkPolyDataFromContour(
  mitk::ContourModel *inputContour, mitk::BaseRenderer *renderer)
<span style = "background-color:#fdd">{
  const auto timestep = this-&gt;GetTimestep();</span>

<span style = "background-color:#fdd">  LocalStorage *localStorage = m_LSH.GetLocalStorage(renderer);</span>

<span style = "background-color:#fdd">  localStorage-&gt;m_contourToPolyData-&gt;SetInput(inputContour);
  localStorage-&gt;m_contourToPolyData-&gt;Update();</span>

<span style = "background-color:#fdd">  vtkSmartPointer&lt;vtkPolyData&gt; polyData = vtkSmartPointer&lt;vtkPolyData&gt;::New();
  polyData = localStorage-&gt;m_contourToPolyData-&gt;GetOutput()-&gt;GetVtkPolyData(timestep);</span>

<span style = "background-color:#fdd">  return polyData;
}</span>

void mitk::ContourModelSetMapper3D::ApplyContourModelSetProperties(BaseRenderer *renderer)
<span style = "background-color:#fdd">{
  LocalStorage *localStorage = m_LSH.GetLocalStorage(renderer);
  DataNode *dataNode = this-&gt;GetDataNode();</span>

<span style = "background-color:#fdd">  if (dataNode != nullptr)</span>
  {
<span style = "background-color:#fdd">    float lineWidth = 1;
    dataNode-&gt;GetFloatProperty("contour.3D.width", lineWidth, renderer);</span>

<span style = "background-color:#fdd">    vtkSmartPointer&lt;vtkPropCollection&gt; collection = vtkSmartPointer&lt;vtkPropCollection&gt;::New();
    localStorage-&gt;m_Assembly-&gt;GetActors(collection);
    collection-&gt;InitTraversal();
    for (vtkIdType i = 0; i &lt; collection-&gt;GetNumberOfItems(); i++)</span>
    {
<span style = "background-color:#fdd">      vtkActor::SafeDownCast(collection-&gt;GetNextProp())-&gt;GetProperty()-&gt;SetLineWidth(lineWidth);
    }
  }
}</span>

void mitk::ContourModelSetMapper3D::ApplyContourProperties(mitk::BaseRenderer *renderer)
<span style = "background-color:#fdd">{
  LocalStorage *localStorage = m_LSH.GetLocalStorage(renderer);</span>

<span style = "background-color:#fdd">  mitk::ColorProperty::Pointer colorprop =</span>
    dynamic_cast&lt;mitk::ColorProperty *&gt;(GetDataNode()-&gt;GetProperty("contour.color", renderer));
<span style = "background-color:#fdd">  if (colorprop)</span>
  {
    // set the color of the contour
<span style = "background-color:#fdd">    double red = colorprop-&gt;GetColor().GetRed();
    double green = colorprop-&gt;GetColor().GetGreen();
    double blue = colorprop-&gt;GetColor().GetBlue();</span>

<span style = "background-color:#fdd">    vtkSmartPointer&lt;vtkPropCollection&gt; collection = vtkSmartPointer&lt;vtkPropCollection&gt;::New();
    localStorage-&gt;m_Assembly-&gt;GetActors(collection);
    collection-&gt;InitTraversal();
    for (vtkIdType i = 0; i &lt; collection-&gt;GetNumberOfItems(); i++)</span>
    {
<span style = "background-color:#fdd">      vtkActor::SafeDownCast(collection-&gt;GetNextProp())-&gt;GetProperty()-&gt;SetColor(red, green, blue);
    }
  }
}</span>

/*+++++++++++++++++++ LocalStorage part +++++++++++++++++++++++++*/

mitk::ContourModelSetMapper3D::LocalStorage *mitk::ContourModelSetMapper3D::GetLocalStorage(
  mitk::BaseRenderer *renderer)
<span style = "background-color:#fdd">{
  return m_LSH.GetLocalStorage(renderer);
}</span>

mitk::ContourModelSetMapper3D::LocalStorage::LocalStorage()
<span style = "background-color:#fdd">{
  m_Assembly = vtkSmartPointer&lt;vtkAssembly&gt;::New();
  m_contourToPolyData = mitk::ContourModelToSurfaceFilter::New();
}</span>

void mitk::ContourModelSetMapper3D::SetDefaultProperties(mitk::DataNode *node,
                                                         mitk::BaseRenderer *renderer,
                                                         bool overwrite)
<span style = "background-color:#fdd">{
  node-&gt;AddProperty("color", ColorProperty::New(1.0, 0.0, 0.0), renderer, overwrite);
  node-&gt;AddProperty("contour.3D.width", mitk::FloatProperty::New(0.5), renderer, overwrite);</span>

<span style = "background-color:#fdd">  Superclass::SetDefaultProperties(node, renderer, overwrite);
}</span></pre>
	</body>
</html>
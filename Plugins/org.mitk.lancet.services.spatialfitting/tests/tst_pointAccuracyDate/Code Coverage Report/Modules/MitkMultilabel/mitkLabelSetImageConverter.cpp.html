<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkLabelSetImageConverter.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include &lt;mitkITKImageImport.h&gt;
#include &lt;mitkImageAccessByItk.h&gt;
#include &lt;mitkImageCast.h&gt;
#include &lt;mitkLabelSetImageConverter.h&gt;

#include &lt;itkComposeImageFilter.h&gt;
#include &lt;itkExtractImageFilter.h&gt;
#include &lt;itkImageDuplicator.h&gt;
#include &lt;itkVectorIndexSelectionCastImageFilter.h&gt;

template &lt;typename TPixel, unsigned int VDimension&gt;
static void ConvertLabelSetImageToImage(const itk::Image&lt;TPixel, VDimension&gt; *,
                                        mitk::LabelSetImage::ConstPointer labelSetImage,
                                        mitk::Image::Pointer &amp;image)
<span style = "background-color:#fdd">{</span>
  typedef itk::Image&lt;TPixel, VDimension&gt; ImageType;
  typedef itk::ComposeImageFilter&lt;ImageType&gt; ComposeFilterType;
  typedef itk::ImageDuplicator&lt;ImageType&gt; DuplicatorType;

<span style = "background-color:#fdd">  auto numberOfLayers = labelSetImage-&gt;GetNumberOfLayers();</span>

<span style = "background-color:#fdd">  if (numberOfLayers &gt; 1)</span>
  {
<span style = "background-color:#fdd">    auto vectorImageComposer = ComposeFilterType::New();
    auto activeLayer = labelSetImage-&gt;GetActiveLayer();</span>

<span style = "background-color:#fdd">    for (decltype(numberOfLayers) layer = 0; layer &lt; numberOfLayers; ++layer)</span>
    {
<span style = "background-color:#fdd">      auto layerImage = mitk::ImageToItkImage&lt;TPixel, VDimension&gt;(</span>
        layer != activeLayer ? labelSetImage-&gt;GetLayerImage(layer) : labelSetImage);

<span style = "background-color:#fdd">      vectorImageComposer-&gt;SetInput(layer, layerImage);
    }</span>

<span style = "background-color:#fdd">    vectorImageComposer-&gt;Update();</span>
    // mitk::GrabItkImageMemory does not support 4D, this will handle 4D correctly
    // and create a memory managed copy
<span style = "background-color:#fdd">    image = mitk::ImportItkImage(vectorImageComposer-&gt;GetOutput())-&gt;Clone();
  }</span>
  else
  {
<span style = "background-color:#fdd">    auto layerImage = mitk::ImageToItkImage&lt;TPixel, VDimension&gt;(labelSetImage);</span>

<span style = "background-color:#fdd">    auto duplicator = DuplicatorType::New();
    duplicator-&gt;SetInputImage(layerImage);
    duplicator-&gt;Update();</span>

    // mitk::GrabItkImageMemory does not support 4D, this will handle 4D correctly
    // and create a memory managed copy
<span style = "background-color:#fdd">    image = mitk::ImportItkImage(duplicator-&gt;GetOutput())-&gt;Clone();
  }
}</span>

mitk::Image::Pointer mitk::ConvertLabelSetImageToImage(LabelSetImage::ConstPointer labelSetImage)
<span style = "background-color:#fdd">{
  Image::Pointer image;</span>

<span style = "background-color:#fdd">  if (labelSetImage-&gt;GetNumberOfLayers() &gt; 0)</span>
  {
<span style = "background-color:#fdd">    if (labelSetImage-&gt;GetDimension() == 4)</span>
    {
<span style = "background-color:#fdd">      AccessFixedDimensionByItk_n(labelSetImage, ::ConvertLabelSetImageToImage, 4, (labelSetImage, image));
    }</span>
    else
    {
<span style = "background-color:#fdd">      AccessByItk_2(labelSetImage-&gt;GetLayerImage(0), ::ConvertLabelSetImageToImage, labelSetImage, image);</span>
    }

<span style = "background-color:#fdd">    image-&gt;SetTimeGeometry(labelSetImage-&gt;GetTimeGeometry()-&gt;Clone());</span>
  }

<span style = "background-color:#fdd">  return image;
}</span>

template &lt;typename TPixel, unsigned int VDimensions&gt;
static void ConvertImageToLabelSetImage(const itk::VectorImage&lt;TPixel, VDimensions&gt; *image,
                                        mitk::LabelSetImage::Pointer &amp;labelSetImage)
<span style = "background-color:#fdd">{</span>
  typedef itk::VectorImage&lt;TPixel, VDimensions&gt; VectorImageType;
  typedef itk::Image&lt;TPixel, VDimensions&gt; ImageType;
  typedef itk::VectorIndexSelectionCastImageFilter&lt;VectorImageType, ImageType&gt; VectorIndexSelectorType;

<span style = "background-color:#fdd">  labelSetImage = mitk::LabelSetImage::New();</span>

<span style = "background-color:#fdd">  auto numberOfLayers = image-&gt;GetVectorLength();
  for (decltype(numberOfLayers) layer = 0; layer &lt; numberOfLayers; ++layer)</span>
  {
<span style = "background-color:#fdd">    auto layerSelector = VectorIndexSelectorType::New();
    layerSelector-&gt;SetInput(image);
    layerSelector-&gt;SetIndex(layer);
    layerSelector-&gt;Update();</span>

<span style = "background-color:#fdd">    mitk::Image::Pointer layerImage;
    mitk::CastToMitkImage(layerSelector-&gt;GetOutput(), layerImage);</span>

<span style = "background-color:#fdd">    if (layer == 0)</span>
    {
<span style = "background-color:#fdd">      labelSetImage-&gt;InitializeByLabeledImage(layerImage);
    }</span>
    else
    {
<span style = "background-color:#fdd">      labelSetImage-&gt;AddLayer(layerImage);</span>
    }
<span style = "background-color:#fdd">  }
}</span>

mitk::LabelSetImage::Pointer mitk::ConvertImageToLabelSetImage(Image::Pointer image)
<span style = "background-color:#fdd">{
  LabelSetImage::Pointer labelSetImage;</span>

<span style = "background-color:#fdd">  if (image.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    if (image-&gt;GetChannelDescriptor().GetPixelType().GetPixelType() == itk::IOPixelEnum::VECTOR)</span>
    {
<span style = "background-color:#fdd">      if (4 == image-&gt;GetDimension())</span>
      {
<span style = "background-color:#fdd">        AccessVectorFixedDimensionByItk_n(image, ::ConvertImageToLabelSetImage, 4, (labelSetImage));
      }</span>
      else
      {
<span style = "background-color:#fdd">        AccessVectorPixelTypeByItk_n(image, ::ConvertImageToLabelSetImage, (labelSetImage));</span>
      }
<span style = "background-color:#fdd">    }</span>
    else
    {
<span style = "background-color:#fdd">      labelSetImage = mitk::LabelSetImage::New();
      labelSetImage-&gt;InitializeByLabeledImage(image);</span>
    }
<span style = "background-color:#fdd">    labelSetImage-&gt;SetTimeGeometry(image-&gt;GetTimeGeometry()-&gt;Clone());</span>
  }

<span style = "background-color:#fdd">  return labelSetImage;
}</span></pre>
	</body>
</html>
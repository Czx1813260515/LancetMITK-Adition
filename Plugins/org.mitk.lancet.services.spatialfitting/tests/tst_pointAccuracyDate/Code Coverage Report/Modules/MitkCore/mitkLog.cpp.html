<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkLog.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include &lt;mitkExceptionMacro.h&gt;
#include &lt;mitkLog.h&gt;
#include &lt;mitkLogMacros.h&gt;

#include &lt;itkOutputWindow.h&gt;

#include &lt;cstdio&gt;
#include &lt;fstream&gt;
#include &lt;iostream&gt;
#include &lt;mutex&gt;

<span style = "background-color:#dfd">static std::mutex logMutex;</span>
static mitk::LoggingBackend *mitkLogBackend = nullptr;
static std::ofstream *logFile = nullptr;
<span style = "background-color:#dfd">static std::string logFileName = "";</span>
static std::stringstream *outputWindow = nullptr;
static bool logOutputWindow = false;

void mitk::LoggingBackend::EnableAdditionalConsoleWindow(bool enable)
<span style = "background-color:#fdd">{
  logOutputWindow = enable;
}</span>

void mitk::LoggingBackend::ProcessMessage(const mbilog::LogMessage &amp;l)
<span style = "background-color:#fdd">{
  logMutex.lock();</span>
#ifdef _WIN32
<span style = "background-color:#fdd">  FormatSmart(l, (int)GetCurrentThreadId());</span>
#else
  FormatSmart(l);
#endif

<span style = "background-color:#fdd">  if (logFile)</span>
  {
#ifdef _WIN32
<span style = "background-color:#fdd">    FormatFull(*logFile, l, (int)GetCurrentThreadId());</span>
#else
    FormatFull(*logFile, l);
#endif
  }
<span style = "background-color:#fdd">  if (logOutputWindow)</span>
  {
<span style = "background-color:#fdd">    if (outputWindow == nullptr)</span>
    {
<span style = "background-color:#fdd">      outputWindow = new std::stringstream();</span>
    }
<span style = "background-color:#fdd">    outputWindow-&gt;str("");
    outputWindow-&gt;clear();</span>
#ifdef _WIN32
<span style = "background-color:#fdd">    FormatFull(*outputWindow, l, (int)GetCurrentThreadId());</span>
#else
    FormatFull(*outputWindow, l);
#endif
<span style = "background-color:#fdd">    itk::OutputWindow::GetInstance()-&gt;DisplayText(outputWindow-&gt;str().c_str());</span>
  }
<span style = "background-color:#fdd">  logMutex.unlock();
}</span>

void mitk::LoggingBackend::Register()
<span style = "background-color:#fdd">{
  if (mitkLogBackend)
    return;
  mitkLogBackend = new mitk::LoggingBackend();
  mbilog::RegisterBackend(mitkLogBackend);
}</span>

void mitk::LoggingBackend::Unregister()
<span style = "background-color:#fdd">{
  if (mitkLogBackend)</span>
  {
<span style = "background-color:#fdd">    SetLogFile(nullptr);
    mbilog::UnregisterBackend(mitkLogBackend);
    delete mitkLogBackend;
    mitkLogBackend = nullptr;</span>
  }
<span style = "background-color:#fdd">}</span>

void mitk::LoggingBackend::SetLogFile(const char *file)
<span style = "background-color:#fdd">{</span>
  // closing old logfile
  {
<span style = "background-color:#fdd">    bool closed = false;
    std::string closedFileName;</span>

<span style = "background-color:#fdd">    logMutex.lock();
    if (logFile)</span>
    {
<span style = "background-color:#fdd">      closed = true;
      closedFileName = logFileName;
      logFile-&gt;close();
      delete logFile;
      logFile = nullptr;
      logFileName = "";</span>
    }
<span style = "background-color:#fdd">    logMutex.unlock();
    if (closed)</span>
    {
<span style = "background-color:#fdd">      MITK_INFO &lt;&lt; "closing logfile (" &lt;&lt; closedFileName &lt;&lt; ")";</span>
    }
<span style = "background-color:#fdd">  }</span>

  // opening new logfile
<span style = "background-color:#fdd">  if (file)</span>
  {
<span style = "background-color:#fdd">    logMutex.lock();</span>

<span style = "background-color:#fdd">    logFileName = file;
    logFile = new std::ofstream();</span>

<span style = "background-color:#fdd">    logFile-&gt;open(file, std::ios_base::out | std::ios_base::app);</span>

<span style = "background-color:#fdd">    if (logFile-&gt;good())</span>
    {
<span style = "background-color:#fdd">      logMutex.unlock();
      MITK_INFO &lt;&lt; "Logfile: " &lt;&lt; logFileName;
    }</span>
    else
    {
<span style = "background-color:#fdd">      delete logFile;
      logFile = nullptr;
      logMutex.unlock();
      MITK_WARN &lt;&lt; "opening logfile '" &lt;&lt; file &lt;&lt; "' for writing failed";</span>
    }

    // mutex is now unlocked
  }
<span style = "background-color:#fdd">}</span>

std::string mitk::LoggingBackend::GetLogFile()
<span style = "background-color:#fdd">{
  return logFileName;
}</span>

void mitk::LoggingBackend::CatchLogFileCommandLineParameter(int &amp;argc, char **argv)
<span style = "background-color:#fdd">{</span>
  int r;

<span style = "background-color:#fdd">  for (r = 1; r &lt; argc; r++)</span>
  {
<span style = "background-color:#fdd">    if (std::string(argv[r]) == "--logfile")</span>
    {
<span style = "background-color:#fdd">      if (r + 1 &gt;= argc)</span>
      {
<span style = "background-color:#fdd">        --argc;
        MITK_ERROR &lt;&lt; "--logfile parameter found, but no file given";
        return;</span>
      }

<span style = "background-color:#fdd">      mitk::LoggingBackend::SetLogFile(argv[r + 1]);</span>

<span style = "background-color:#fdd">      for (r += 2; r &lt; argc; r++)
        argv[r - 2] = argv[r];</span>

<span style = "background-color:#fdd">      argc -= 2;
      return;</span>
    }
<span style = "background-color:#fdd">  }
}</span>

void mitk::LoggingBackend::RotateLogFiles(const std::string &amp;prefixPath)
<span style = "background-color:#fdd">{</span>
  static const int numLogFiles = 10;
<span style = "background-color:#fdd">  std::string newEmptyLogFileName;</span>

  // first: rotate the old log files to get a new, free logfile name
<span style = "background-color:#fdd">  newEmptyLogFileName = IncrementLogFileNames(prefixPath, numLogFiles);</span>

  // now: use the new empty logfile name as name for this run
<span style = "background-color:#fdd">  mitk::LoggingBackend::SetLogFile(newEmptyLogFileName.c_str());
}</span>

std::string mitk::LoggingBackend::IncrementLogFileNames(const std::string &amp;prefixPath, int numLogFiles)
<span style = "background-color:#fdd">{</span>
  // delete last one
  {
<span style = "background-color:#fdd">    std::stringstream s;
    s &lt;&lt; prefixPath.c_str() &lt;&lt; "-" &lt;&lt; numLogFiles - 1 &lt;&lt; ".log";</span>
    // check if the file exists
<span style = "background-color:#fdd">    if (CheckIfFileExists(s.str())) // if yes: delete it</span>
    {
<span style = "background-color:#fdd">      int retVal = ::remove(s.str().c_str());
      if (retVal != 0)</span>
      {
<span style = "background-color:#fdd">        mitkThrow()</span>
          &lt;&lt; "Problem while deleting the oldest log file. Maybe the access to this files is blocked. Aborting!";
      }
    }
<span style = "background-color:#fdd">  }</span>

  // rename the others
<span style = "background-color:#fdd">  for (int r = numLogFiles - 1; r &gt;= 1; r--)</span>
  {
<span style = "background-color:#fdd">    std::stringstream dst;
    dst &lt;&lt; prefixPath.c_str() &lt;&lt; "-" &lt;&lt; r &lt;&lt; ".log";</span>

<span style = "background-color:#fdd">    std::stringstream src;
    src &lt;&lt; prefixPath.c_str() &lt;&lt; "-" &lt;&lt; r - 1 &lt;&lt; ".log";</span>

    // check if the source exists
<span style = "background-color:#fdd">    if (CheckIfFileExists(src.str())) // if yes: rename it</span>
    {
<span style = "background-color:#fdd">      int retVal = ::rename(src.str().c_str(), dst.str().c_str());
      if (retVal != 0)</span>
      {
<span style = "background-color:#fdd">        mitkThrow() &lt;&lt; "Problem while renaming the log files. Maybe the access to this files is blocked. Aborting!";</span>
      }
    }
<span style = "background-color:#fdd">  }</span>

  // create new empty name and return it
  {
<span style = "background-color:#fdd">    std::stringstream s;
    s &lt;&lt; prefixPath.c_str() &lt;&lt; "-0.log";
    return s.str();</span>
  }
<span style = "background-color:#fdd">}</span>

bool mitk::LoggingBackend::CheckIfFileExists(const std::string &amp;filename)
<span style = "background-color:#fdd">{
  bool returnValue = false;
  std::ifstream File(filename.c_str());
  if (File.good())</span>
  {
<span style = "background-color:#fdd">    returnValue = true;
  }</span>
  else
  {
<span style = "background-color:#fdd">    returnValue = false;</span>
  }
<span style = "background-color:#fdd">  File.close();
  return returnValue;
}</span>

mbilog::OutputType mitk::LoggingBackend::GetOutputType() const
<span style = "background-color:#fdd">{
  return mbilog::Console;
}</span></pre>
	</body>
</html>
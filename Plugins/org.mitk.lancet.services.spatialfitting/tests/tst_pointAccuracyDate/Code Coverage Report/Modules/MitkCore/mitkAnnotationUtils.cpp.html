<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkAnnotationUtils.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkAnnotationUtils.h"
#include "mitkAnnotation.h"
#include "vtkCallbackCommand.h"
#include "vtkCommand.h"
#include &lt;mitkAbstractAnnotationRenderer.h&gt;

namespace mitk
{
<span style = "background-color:#fdd">  AnnotationUtils::AnnotationUtils() {}
  AnnotationUtils::~AnnotationUtils() {}</span>
  AbstractAnnotationRenderer *AnnotationUtils::GetAnnotationRenderer(const std::string &amp;arTypeID,
                                                                     const std::string &amp;rendererID)
<span style = "background-color:#fdd">  {</span>
    // get the context
<span style = "background-color:#fdd">    us::ModuleContext *context = us::GetModuleContext();</span>

    // specify a filter that defines the requested type
<span style = "background-color:#fdd">    std::string filter = "(&amp;(" + AbstractAnnotationRenderer::US_PROPKEY_ID + "=" + arTypeID + ")(" +</span>
                         AbstractAnnotationRenderer::US_PROPKEY_RENDERER_ID + "=" + rendererID + "))";
    // find the fitting service
<span style = "background-color:#fdd">    std::vector&lt;us::ServiceReferenceU&gt; serviceReferences =</span>
      context-&gt;GetServiceReferences(AbstractAnnotationRenderer::US_INTERFACE_NAME, filter);

    // check if a service reference was found. It is also possible that several
    // services were found. This is not checked here, just the first one is taken.
<span style = "background-color:#fdd">    AbstractAnnotationRenderer *ar = nullptr;
    if (serviceReferences.size())</span>
    {
<span style = "background-color:#fdd">      ar = context-&gt;GetService&lt;AbstractAnnotationRenderer&gt;(serviceReferences.front());</span>
    }
    // no service reference was found or found service reference has no valid source
<span style = "background-color:#fdd">    return ar;
  }</span>

  void AnnotationUtils::RegisterAnnotationRenderer(AbstractAnnotationRenderer *annotationRenderer)
<span style = "background-color:#fdd">  {
    static AnnotationRendererServices AnnotationRendererServices;</span>
    // Define ServiceProps
<span style = "background-color:#fdd">    us::ServiceProperties props;
    props[AbstractAnnotationRenderer::US_PROPKEY_RENDERER_ID] = annotationRenderer-&gt;GetRendererID();
    props[AbstractAnnotationRenderer::US_PROPKEY_ID] = annotationRenderer-&gt;GetID();</span>

<span style = "background-color:#fdd">    us::GetModuleContext()-&gt;RegisterService(annotationRenderer, props);
    AnnotationRendererServices.push_back(std::unique_ptr&lt;AbstractAnnotationRenderer&gt;(annotationRenderer));
  }</span>

  void AnnotationUtils::UpdateAnnotationRenderer(const std::string &amp;rendererID)
<span style = "background-color:#fdd">  {
    for (AbstractAnnotationRenderer *annotationRenderer : GetAnnotationRenderer(rendererID))</span>
    {
<span style = "background-color:#fdd">      annotationRenderer-&gt;Update();
    }
  }</span>

  void AnnotationUtils::BaseRendererChanged(BaseRenderer *renderer)
<span style = "background-color:#fdd">  {
    for (AbstractAnnotationRenderer *annotationRenderer : GetAnnotationRenderer(renderer-&gt;GetName()))</span>
    {
<span style = "background-color:#fdd">      annotationRenderer-&gt;CurrentBaseRendererChanged();
    }
    vtkCallbackCommand *renderCallbackCommand = vtkCallbackCommand::New();
    renderCallbackCommand-&gt;SetCallback(AnnotationUtils::RenderWindowCallback);
    renderer-&gt;GetRenderWindow()-&gt;AddObserver(vtkCommand::ModifiedEvent, renderCallbackCommand);
    renderCallbackCommand-&gt;Delete();
  }</span>

  void AnnotationUtils::RenderWindowCallback(vtkObject *caller, unsigned long, void *, void *)
<span style = "background-color:#fdd">  {
    auto *renderWindow = dynamic_cast&lt;vtkRenderWindow *&gt;(caller);
    if (!renderWindow)
      return;
    BaseRenderer *renderer = BaseRenderer::GetInstance(renderWindow);</span>

<span style = "background-color:#fdd">    if (nullptr != renderer)</span>
    {
<span style = "background-color:#fdd">      for (AbstractAnnotationRenderer *annotationRenderer : GetAnnotationRenderer(renderer-&gt;GetName()))
        annotationRenderer-&gt;OnRenderWindowModified();</span>
    }
<span style = "background-color:#fdd">  }</span>

  Annotation *AnnotationUtils::GetAnnotation(const std::string &amp;AnnotationID)
<span style = "background-color:#fdd">  {
    std::string ldapFilter = "(" + Annotation::US_PROPKEY_ID + "=" + AnnotationID + ")";
    us::ModuleContext *context = us::GetModuleContext();
    std::vector&lt;us::ServiceReference&lt;mitk::Annotation&gt;&gt; annotations =</span>
      context-&gt;GetServiceReferences&lt;mitk::Annotation&gt;(ldapFilter);
<span style = "background-color:#fdd">    Annotation *annotation = nullptr;
    if (!annotations.empty())</span>
    {
<span style = "background-color:#fdd">      annotation = us::GetModuleContext()-&gt;GetService&lt;mitk::Annotation&gt;(annotations.front());</span>
    }
<span style = "background-color:#fdd">    return annotation;
  }</span>

  std::vector&lt;AbstractAnnotationRenderer *&gt; AnnotationUtils::GetAnnotationRenderer(const std::string &amp;rendererID)
<span style = "background-color:#fdd">  {
    us::ModuleContext *context = us::GetModuleContext();</span>

    // specify a filter that defines the requested type
<span style = "background-color:#fdd">    std::string filter = "(&amp;(" + AbstractAnnotationRenderer::US_PROPKEY_ID + "=*)(" +</span>
                         AbstractAnnotationRenderer::US_PROPKEY_RENDERER_ID + "=" + rendererID + "))";
    // find the fitting service
<span style = "background-color:#fdd">    std::vector&lt;us::ServiceReferenceU&gt; serviceReferences =</span>
      context-&gt;GetServiceReferences(AbstractAnnotationRenderer::US_INTERFACE_NAME, filter);
<span style = "background-color:#fdd">    std::vector&lt;AbstractAnnotationRenderer *&gt; arList;
    for (const us::ServiceReferenceU &amp;service : serviceReferences)</span>
    {
<span style = "background-color:#fdd">      arList.push_back(context-&gt;GetService&lt;AbstractAnnotationRenderer&gt;(service));
    }
    return arList;
  }</span>
}</pre>
	</body>
</html>
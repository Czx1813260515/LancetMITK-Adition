<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkSurfaceVtkIO.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkSurfaceVtkIO.h"

#include "mitkSurface.h"
#include &lt;mitkUtf8Util.h&gt;

#include &lt;vtkLinearTransform.h&gt;
#include &lt;vtkPolyData.h&gt;
#include &lt;vtkSmartPointer.h&gt;
#include &lt;vtkTransformPolyDataFilter.h&gt;

#include &lt;itksys/SystemTools.hxx&gt;

namespace mitk
{
  SurfaceVtkIO::SurfaceVtkIO(const std::string &amp;baseDataType,
                             const CustomMimeType &amp;mimeType,
                             const std::string &amp;description)
<span style = "background-color:#dfd">    : AbstractFileIO(baseDataType, mimeType, description)
  {
  }</span>

  vtkSmartPointer&lt;vtkPolyData&gt; SurfaceVtkIO::GetPolyData(unsigned int t, std::string &amp;fileName)
<span style = "background-color:#fdd">  {
    const auto *input = dynamic_cast&lt;const Surface *&gt;(this-&gt;GetInput());</span>

<span style = "background-color:#fdd">    vtkSmartPointer&lt;vtkTransformPolyDataFilter&gt; transformPolyData = vtkSmartPointer&lt;vtkTransformPolyDataFilter&gt;::New();</span>

    // surfaces do not have to exist in all timesteps; therefor, only write valid surfaces
<span style = "background-color:#fdd">    if (input-&gt;GetVtkPolyData(t) == nullptr)
      return vtkSmartPointer&lt;vtkPolyData&gt;();</span>

<span style = "background-color:#fdd">    std::string baseName = this-&gt;GetOutputLocation();
    std::string extension = Utf8Util::Utf8ToLocal8Bit(itksys::SystemTools::GetFilenameExtension(Utf8Util::Local8BitToUtf8(baseName)));
    if (!extension.empty())</span>
    {
<span style = "background-color:#fdd">      baseName = baseName.substr(0, baseName.size() - extension.size());</span>
    }

<span style = "background-color:#fdd">    std::ostringstream ss;
    ss.imbue(::std::locale::classic());</span>

<span style = "background-color:#fdd">    BaseGeometry *geometry = input-&gt;GetGeometry(t);
    if (input-&gt;GetTimeGeometry()-&gt;IsValidTimeStep(t))</span>
    {
<span style = "background-color:#fdd">      if (input-&gt;GetTimeGeometry()-&gt;CountTimeSteps() &gt; 1)</span>
      {
<span style = "background-color:#fdd">        const TimeBounds &amp;timebounds = input-&gt;GetTimeGeometry()-&gt;GetTimeBounds(t);
        ss &lt;&lt; baseName &lt;&lt; "_S" &lt;&lt; std::setprecision(0) &lt;&lt; timebounds[0] &lt;&lt; "_E" &lt;&lt; std::setprecision(0) &lt;&lt; timebounds[1]</span>
           &lt;&lt; "_T" &lt;&lt; t &lt;&lt; extension;
<span style = "background-color:#fdd">      }</span>
      else
      {
        // use the original file name
<span style = "background-color:#fdd">        ss &lt;&lt; this-&gt;GetOutputLocation();</span>
      }
<span style = "background-color:#fdd">    }</span>
    else
    {
<span style = "background-color:#fdd">      MITK_WARN &lt;&lt; "Error on write: TimeGeometry invalid of surface " &lt;&lt; fileName &lt;&lt; ".";
      return vtkSmartPointer&lt;vtkPolyData&gt;();</span>
    }

<span style = "background-color:#fdd">    fileName = ss.str();</span>

<span style = "background-color:#fdd">    transformPolyData-&gt;SetInputData(input-&gt;GetVtkPolyData(t));
    transformPolyData-&gt;SetTransform(geometry-&gt;GetVtkTransform());
    transformPolyData-&gt;UpdateWholeExtent();</span>

<span style = "background-color:#fdd">    vtkSmartPointer&lt;vtkPolyData&gt; polyData = transformPolyData-&gt;GetOutput();
    return polyData;
  }</span>

  IFileIO::ConfidenceLevel SurfaceVtkIO::GetWriterConfidenceLevel() const
<span style = "background-color:#fdd">  {
    if (AbstractFileIO::GetWriterConfidenceLevel() == Unsupported)
      return Unsupported;
    if (this-&gt;GetInput()-&gt;GetTimeGeometry()-&gt;CountTimeSteps() &gt; 1)</span>
    {
      // The VTK formats don't support multiple time points.
      // During writing, we write each time step into a separate file.
      // For output streams, we only write the first time-step and print a warning.
<span style = "background-color:#fdd">      return PartiallySupported;</span>
    }
<span style = "background-color:#fdd">    return Supported;
  }</span>
}</pre>
	</body>
</html>
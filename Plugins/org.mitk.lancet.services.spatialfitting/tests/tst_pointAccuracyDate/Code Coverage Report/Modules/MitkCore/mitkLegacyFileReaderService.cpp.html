<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkLegacyFileReaderService.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkLegacyFileReaderService.h"

#include &lt;mitkCustomMimeType.h&gt;
#include &lt;mitkIOAdapter.h&gt;
#include &lt;mitkIOMimeTypes.h&gt;
#include &lt;mitkProgressBar.h&gt;

mitk::LegacyFileReaderService::LegacyFileReaderService(const mitk::LegacyFileReaderService &amp;other)
<span style = "background-color:#fdd">  : mitk::AbstractFileReader(other)
{
}</span>

mitk::LegacyFileReaderService::LegacyFileReaderService(const std::vector&lt;std::string&gt; &amp;extensions,
                                                       const std::string &amp;category)
<span style = "background-color:#dfd">  : AbstractFileReader()
{
  this-&gt;SetMimeTypePrefix(IOMimeTypes::DEFAULT_BASE_NAME() + ".legacy.");</span>

<span style = "background-color:#dfd">  CustomMimeType customMimeType;
  customMimeType.SetCategory(category);</span>

<span style = "background-color:#dfd">  for (auto extension : extensions)</span>
  {
<span style = "background-color:#dfd">    if (!extension.empty() &amp;&amp; extension[0] == '.')</span>
    {
<span style = "background-color:#fdd">      extension.assign(extension.begin() + 1, extension.end());</span>
    }
<span style = "background-color:#dfd">    customMimeType.AddExtension(extension);
  }
  this-&gt;SetDescription(category);
  this-&gt;SetMimeType(customMimeType);</span>

<span style = "background-color:#dfd">  m_ServiceReg = this-&gt;RegisterService();
}</span>

mitk::LegacyFileReaderService::~LegacyFileReaderService()
<span style = "background-color:#dfd">{
}</span>

////////////////////// Reading /////////////////////////

std::vector&lt;itk::SmartPointer&lt;mitk::BaseData&gt;&gt; mitk::LegacyFileReaderService::DoRead()
<span style = "background-color:#fdd">{
  std::vector&lt;BaseData::Pointer&gt; result;</span>

<span style = "background-color:#fdd">  std::list&lt;IOAdapterBase::Pointer&gt; possibleIOAdapter;
  std::list&lt;itk::LightObject::Pointer&gt; allobjects = itk::ObjectFactoryBase::CreateAllInstance("mitkIOAdapter");</span>

<span style = "background-color:#fdd">  for (auto i = allobjects.begin(); i != allobjects.end(); ++i)</span>
  {
<span style = "background-color:#fdd">    auto *io = dynamic_cast&lt;IOAdapterBase *&gt;(i-&gt;GetPointer());
    if (io)</span>
    {
<span style = "background-color:#fdd">      possibleIOAdapter.push_back(io);
    }</span>
    else
    {
<span style = "background-color:#fdd">      MITK_ERROR &lt;&lt; "Error BaseDataIO factory did not return an IOAdapterBase: " &lt;&lt; (*i)-&gt;GetNameOfClass() &lt;&lt; std::endl;
    }
  }</span>

<span style = "background-color:#fdd">  const std::string path = this-&gt;GetLocalFileName();
  for (auto k = possibleIOAdapter.begin(); k != possibleIOAdapter.end(); ++k)</span>
  {
<span style = "background-color:#fdd">    bool canReadFile = (*k)-&gt;CanReadFile(path, "", ""); // they could read the file</span>

<span style = "background-color:#fdd">    if (canReadFile)</span>
    {
<span style = "background-color:#fdd">      BaseDataSource::Pointer ioObject = (*k)-&gt;CreateIOProcessObject(path, "", "");
      ioObject-&gt;Update();
      auto numberOfContents = static_cast&lt;int&gt;(ioObject-&gt;GetNumberOfOutputs());</span>

<span style = "background-color:#fdd">      if (numberOfContents &gt; 0)</span>
      {
<span style = "background-color:#fdd">        BaseData::Pointer baseData;
        for (int i = 0; i &lt; numberOfContents; ++i)</span>
        {
<span style = "background-color:#fdd">          baseData = dynamic_cast&lt;BaseData *&gt;(ioObject-&gt;GetOutputs()[i].GetPointer());
          if (baseData) // this is what's wanted, right?</span>
          {
<span style = "background-color:#fdd">            result.push_back(baseData);</span>
          }
<span style = "background-color:#fdd">        }
      }</span>

<span style = "background-color:#fdd">      break;
    }
  }</span>

<span style = "background-color:#fdd">  if (result.empty())</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Could not read file '" &lt;&lt; path &lt;&lt; "'";</span>
  }

<span style = "background-color:#fdd">  return result;
}</span>

mitk::LegacyFileReaderService *mitk::LegacyFileReaderService::Clone() const
<span style = "background-color:#fdd">{
  return new LegacyFileReaderService(*this);
}</span></pre>
	</body>
</html>
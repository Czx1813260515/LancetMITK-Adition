<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkAnnotation.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkAnnotation.h"
#include "usGetModuleContext.h"

<span style = "background-color:#dfd">const std::string mitk::Annotation::US_INTERFACE_NAME = "org.mitk.services.Annotation";
const std::string mitk::Annotation::US_PROPKEY_AnnotationNAME = US_INTERFACE_NAME + ".name";
const std::string mitk::Annotation::US_PROPKEY_ID = US_INTERFACE_NAME + ".id";
const std::string mitk::Annotation::US_PROPKEY_MODIFIED = US_INTERFACE_NAME + ".modified";
const std::string mitk::Annotation::US_PROPKEY_RENDERER_ID = US_INTERFACE_NAME + ".rendererId";
const std::string mitk::Annotation::US_PROPKEY_AR_ID = US_INTERFACE_NAME + ".arId";</span>

<span style = "background-color:#fdd">mitk::Annotation::Annotation() : m_PropertyListModifiedObserverTag(0)
{
  m_PropertyList = mitk::PropertyList::New();
  itk::MemberCommand&lt;mitk::Annotation&gt;::Pointer _PropertyListModifiedCommand =</span>
    itk::MemberCommand&lt;mitk::Annotation&gt;::New();
<span style = "background-color:#fdd">  _PropertyListModifiedCommand-&gt;SetCallbackFunction(this, &amp;mitk::Annotation::PropertyListModified);
  m_PropertyListModifiedObserverTag = m_PropertyList-&gt;AddObserver(itk::ModifiedEvent(), _PropertyListModifiedCommand);
  this-&gt;SetName(this-&gt;GetNameOfClass());
  this-&gt;SetVisibility(true);
  this-&gt;SetOpacity(1.0);
}</span>

void mitk::Annotation::PropertyListModified(const itk::Object * /*caller*/, const itk::EventObject &amp;)
<span style = "background-color:#fdd">{
  AnnotationModified();
}</span>

mitk::Annotation::~Annotation()
<span style = "background-color:#fdd">{
  this-&gt;UnRegisterMicroservice();
}</span>

void mitk::Annotation::SetUSProperty(const std::string &amp;propertyKey, us::Any value)
<span style = "background-color:#fdd">{
  if (this-&gt;m_ServiceRegistration)</span>
  {
<span style = "background-color:#fdd">    us::ServiceProperties props;
    std::vector&lt;std::string&gt; propertyKeys;
    m_ServiceRegistration.GetReference().GetPropertyKeys(propertyKeys);
    for (const std::string &amp;key : propertyKeys)</span>
    {
<span style = "background-color:#fdd">      props[key] = m_ServiceRegistration.GetReference().GetProperty(key);
    }
    props[propertyKey] = value;
    m_ServiceRegistration.SetProperties(props);
  }
}</span>

void mitk::Annotation::SetProperty(const std::string &amp;propertyKey, const BaseProperty::Pointer &amp;propertyValue)
<span style = "background-color:#fdd">{
  this-&gt;m_PropertyList-&gt;SetProperty(propertyKey, propertyValue);
}</span>

void mitk::Annotation::ReplaceProperty(const std::string &amp;propertyKey, const BaseProperty::Pointer &amp;propertyValue)
<span style = "background-color:#fdd">{
  this-&gt;m_PropertyList-&gt;ReplaceProperty(propertyKey, propertyValue);
}</span>

void mitk::Annotation::AddProperty(const std::string &amp;propertyKey,
                                   const BaseProperty::Pointer &amp;propertyValue,
                                   bool overwrite)
<span style = "background-color:#fdd">{
  if ((overwrite) || (GetProperty(propertyKey) == nullptr))</span>
  {
<span style = "background-color:#fdd">    SetProperty(propertyKey, propertyValue);</span>
  }
<span style = "background-color:#fdd">}</span>

void mitk::Annotation::ConcatenatePropertyList(PropertyList *pList, bool replace)
<span style = "background-color:#fdd">{
  m_PropertyList-&gt;ConcatenatePropertyList(pList, replace);
}</span>

mitk::BaseProperty *mitk::Annotation::GetProperty(const std::string &amp;propertyKey) const
<span style = "background-color:#fdd">{
  mitk::BaseProperty::Pointer property = m_PropertyList-&gt;GetProperty(propertyKey);
  if (property.IsNotNull())
    return property;</span>

  // only to satisfy compiler!
<span style = "background-color:#fdd">  return nullptr;
}</span>

bool mitk::Annotation::GetBoolProperty(const std::string &amp;propertyKey, bool &amp;boolValue) const
<span style = "background-color:#fdd">{
  mitk::BoolProperty::Pointer boolprop = dynamic_cast&lt;mitk::BoolProperty *&gt;(GetProperty(propertyKey));
  if (boolprop.IsNull())
    return false;</span>

<span style = "background-color:#fdd">  boolValue = boolprop-&gt;GetValue();
  return true;
}</span>

bool mitk::Annotation::GetIntProperty(const std::string &amp;propertyKey, int &amp;intValue) const
<span style = "background-color:#fdd">{
  mitk::IntProperty::Pointer intprop = dynamic_cast&lt;mitk::IntProperty *&gt;(GetProperty(propertyKey));
  if (intprop.IsNull())
    return false;</span>

<span style = "background-color:#fdd">  intValue = intprop-&gt;GetValue();
  return true;
}</span>

bool mitk::Annotation::GetFloatProperty(const std::string &amp;propertyKey, float &amp;floatValue) const
<span style = "background-color:#fdd">{
  mitk::FloatProperty::Pointer floatprop = dynamic_cast&lt;mitk::FloatProperty *&gt;(GetProperty(propertyKey));
  if (floatprop.IsNull())
    return false;</span>

<span style = "background-color:#fdd">  floatValue = floatprop-&gt;GetValue();
  return true;
}</span>

bool mitk::Annotation::GetStringProperty(const std::string &amp;propertyKey, std::string &amp;string) const
<span style = "background-color:#fdd">{
  mitk::StringProperty::Pointer stringProp = dynamic_cast&lt;mitk::StringProperty *&gt;(GetProperty(propertyKey));
  if (stringProp.IsNull())</span>
  {
<span style = "background-color:#fdd">    return false;
  }</span>
  else
  {
    // memcpy((void*)string, stringProp-&gt;GetValue(), strlen(stringProp-&gt;GetValue()) + 1 ); // looks dangerous
<span style = "background-color:#fdd">    string = stringProp-&gt;GetValue();
    return true;</span>
  }
<span style = "background-color:#fdd">}</span>

void mitk::Annotation::SetIntProperty(const std::string &amp;propertyKey, int intValue)
<span style = "background-color:#fdd">{
  this-&gt;m_PropertyList-&gt;SetProperty(propertyKey, mitk::IntProperty::New(intValue));
  Modified();
}</span>
void mitk::Annotation::SetBoolProperty(const std::string &amp;propertyKey, bool boolValue)
<span style = "background-color:#fdd">{
  this-&gt;m_PropertyList-&gt;SetProperty(propertyKey, mitk::BoolProperty::New(boolValue));
  Modified();
}</span>

void mitk::Annotation::SetFloatProperty(const std::string &amp;propertyKey, float floatValue)
<span style = "background-color:#fdd">{
  this-&gt;m_PropertyList-&gt;SetProperty(propertyKey, mitk::FloatProperty::New(floatValue));
  Modified();
}</span>

void mitk::Annotation::SetDoubleProperty(const std::string &amp;propertyKey, double doubleValue)
<span style = "background-color:#fdd">{
  this-&gt;m_PropertyList-&gt;SetProperty(propertyKey, mitk::DoubleProperty::New(doubleValue));
  Modified();
}</span>

void mitk::Annotation::SetStringProperty(const std::string &amp;propertyKey, const std::string &amp;stringValue)
<span style = "background-color:#fdd">{
  this-&gt;m_PropertyList-&gt;SetProperty(propertyKey, mitk::StringProperty::New(stringValue));
  Modified();
}</span>

std::string mitk::Annotation::GetName() const
<span style = "background-color:#fdd">{
  mitk::StringProperty *sp = dynamic_cast&lt;mitk::StringProperty *&gt;(this-&gt;GetProperty("name"));
  if (sp == nullptr)
    return "";
  return sp-&gt;GetValue();
}</span>

void mitk::Annotation::SetName(const std::string &amp;name)
<span style = "background-color:#fdd">{
  this-&gt;SetStringProperty("name", name);
}</span>

bool mitk::Annotation::GetName(std::string &amp;nodeName, const std::string &amp;propertyKey) const
<span style = "background-color:#fdd">{
  return GetStringProperty(propertyKey, nodeName);
}</span>

void mitk::Annotation::SetText(std::string text)
<span style = "background-color:#fdd">{
  SetStringProperty("Text", text.c_str());
}</span>

std::string mitk::Annotation::GetText() const
<span style = "background-color:#fdd">{
  std::string text;
  GetStringProperty("Text", text);
  return text;
}</span>

void mitk::Annotation::SetFontSize(int fontSize)
<span style = "background-color:#fdd">{
  SetIntProperty("FontSize", fontSize);
}</span>

int mitk::Annotation::GetFontSize() const
<span style = "background-color:#fdd">{
  int fontSize = 1;
  GetIntProperty("FontSize", fontSize);
  return fontSize;
}</span>

bool mitk::Annotation::GetVisibility(bool &amp;visible, const std::string &amp;propertyKey) const
<span style = "background-color:#fdd">{
  return GetBoolProperty(propertyKey, visible);
}</span>

bool mitk::Annotation::IsVisible(const std::string &amp;propertyKey, bool defaultIsOn) const
<span style = "background-color:#fdd">{
  return IsOn(propertyKey, defaultIsOn);
}</span>

bool mitk::Annotation::GetColor(float rgb[], const std::string &amp;propertyKey) const
<span style = "background-color:#fdd">{
  mitk::ColorProperty::Pointer colorprop = dynamic_cast&lt;mitk::ColorProperty *&gt;(GetProperty(propertyKey));
  if (colorprop.IsNull())
    return false;</span>

<span style = "background-color:#fdd">  memcpy(rgb, colorprop-&gt;GetColor().GetDataPointer(), 3 * sizeof(float));
  return true;
}</span>

void mitk::Annotation::SetColor(const mitk::Color &amp;color, const std::string &amp;propertyKey)
<span style = "background-color:#fdd">{
  mitk::ColorProperty::Pointer prop;
  prop = mitk::ColorProperty::New(color);
  this-&gt;m_PropertyList-&gt;SetProperty(propertyKey, prop);
}</span>

void mitk::Annotation::SetColor(float red, float green, float blue, const std::string &amp;propertyKey)
<span style = "background-color:#fdd">{</span>
  float color[3];
<span style = "background-color:#fdd">  color[0] = red;
  color[1] = green;
  color[2] = blue;
  SetColor(color, propertyKey);
}</span>

void mitk::Annotation::SetColor(const float rgb[], const std::string &amp;propertyKey)
<span style = "background-color:#fdd">{
  mitk::ColorProperty::Pointer prop;
  prop = mitk::ColorProperty::New(rgb);
  this-&gt;m_PropertyList-&gt;SetProperty(propertyKey, prop);
}</span>

bool mitk::Annotation::GetOpacity(float &amp;opacity, const std::string &amp;propertyKey) const
<span style = "background-color:#fdd">{
  mitk::FloatProperty::Pointer opacityprop = dynamic_cast&lt;mitk::FloatProperty *&gt;(GetProperty(propertyKey));
  if (opacityprop.IsNull())
    return false;</span>

<span style = "background-color:#fdd">  opacity = opacityprop-&gt;GetValue();
  return true;
}</span>

void mitk::Annotation::SetOpacity(float opacity, const std::string &amp;propertyKey)
<span style = "background-color:#fdd">{
  mitk::FloatProperty::Pointer prop;
  prop = mitk::FloatProperty::New(opacity);
  this-&gt;m_PropertyList-&gt;SetProperty(propertyKey, prop);
}</span>

void mitk::Annotation::SetVisibility(bool visible, const std::string &amp;propertyKey)
<span style = "background-color:#fdd">{
  mitk::BoolProperty::Pointer prop;
  prop = mitk::BoolProperty::New(visible);
  this-&gt;m_PropertyList-&gt;SetProperty(propertyKey, prop);
  Modified();
}</span>

bool mitk::Annotation::BaseLocalStorage::IsGenerateDataRequired(mitk::BaseRenderer *renderer,
                                                                mitk::Annotation *Annotation)
<span style = "background-color:#fdd">{
  if (m_LastGenerateDataTime &lt; Annotation-&gt;GetMTime())
    return true;</span>

<span style = "background-color:#fdd">  if (m_LastGenerateDataTime &lt; Annotation-&gt;GetPropertyList()-&gt;GetMTime())
    return true;</span>

<span style = "background-color:#fdd">  if (renderer &amp;&amp; m_LastGenerateDataTime &lt; renderer-&gt;GetTimeStepUpdateTime())
    return true;</span>

<span style = "background-color:#fdd">  return false;
}</span>

mitk::Annotation::Bounds mitk::Annotation::GetBoundsOnDisplay(mitk::BaseRenderer *) const
<span style = "background-color:#fdd">{</span>
  mitk::Annotation::Bounds bounds;
<span style = "background-color:#fdd">  bounds.Position[0] = bounds.Position[1] = bounds.Size[0] = bounds.Size[1] = 0;
  return bounds;
}</span>

void mitk::Annotation::SetBoundsOnDisplay(mitk::BaseRenderer *, const mitk::Annotation::Bounds &amp;)
<span style = "background-color:#fdd">{
}</span>

void mitk::Annotation::SetForceInForeground(bool forceForeground)
<span style = "background-color:#fdd">{
  m_ForceInForeground = forceForeground;
}</span>

bool mitk::Annotation::IsForceInForeground() const
<span style = "background-color:#fdd">{
  return m_ForceInForeground;
}</span>

mitk::PropertyList *mitk::Annotation::GetPropertyList() const
<span style = "background-color:#fdd">{
  return m_PropertyList;
}</span>

std::string mitk::Annotation::GetMicroserviceID()
<span style = "background-color:#fdd">{
  return this-&gt;m_ServiceRegistration.GetReference().GetProperty(US_PROPKEY_ID).ToString();
}</span>

void mitk::Annotation::RegisterAsMicroservice(us::ServiceProperties props)
<span style = "background-color:#fdd">{
  if (m_ServiceRegistration != nullptr)
    m_ServiceRegistration.Unregister();
  us::ModuleContext *context = us::GetModuleContext();</span>
  // Define ServiceProps
<span style = "background-color:#fdd">  mitk::UIDGenerator uidGen = mitk::UIDGenerator("org.mitk.services.Annotation.id_");
  props[US_PROPKEY_ID] = uidGen.GetUID();
  m_ServiceRegistration = context-&gt;RegisterService(this, props);
}</span>

void mitk::Annotation::UnRegisterMicroservice()
<span style = "background-color:#fdd">{
  if (m_ServiceRegistration != nullptr)
    m_ServiceRegistration.Unregister();
  m_ServiceRegistration = 0;
}</span>

void mitk::Annotation::AnnotationModified()
<span style = "background-color:#fdd">{
  Modified();
  this-&gt;SetUSProperty(US_PROPKEY_MODIFIED, this-&gt;GetMTime());
}</span></pre>
	</body>
</html>
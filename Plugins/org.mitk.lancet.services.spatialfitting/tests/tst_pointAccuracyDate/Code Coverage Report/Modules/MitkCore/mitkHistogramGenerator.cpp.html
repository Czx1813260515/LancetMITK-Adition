<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkHistogramGenerator.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#if (_MSC_VER == 1200)
#include &lt;itkFixedCenterOfRotationAffineTransform.h&gt;
#endif

#include "mitkHistogramGenerator.h"
#include "mitkImageAccessByItk.h"
#include "mitkImageTimeSelector.h"

//
// The new ITK Statistics framework has
// a class with the same functionality as
// MITKScalarImageToHistogramGenerator.h, but
// no longer has the classis the MITK class depends on.
#if !defined(ITK_USE_REVIEW_STATISTICS)
#include "itkMITKScalarImageToHistogramGenerator.h"
#else
#include "itkScalarImageToHistogramGenerator.h"
#endif

<span style = "background-color:#fdd">mitk::HistogramGenerator::HistogramGenerator() : m_Image(nullptr), m_Size(256), m_Histogram(nullptr)
{
}</span>

mitk::HistogramGenerator::~HistogramGenerator()
<span style = "background-color:#fdd">{
}</span>

template &lt;typename TPixel, unsigned int VImageDimension&gt;
void InternalCompute(itk::Image&lt;TPixel, VImageDimension&gt; *itkImage,
                     const mitk::HistogramGenerator *mitkHistoGenerator,
                     mitk::HistogramGenerator::HistogramType::ConstPointer &amp;histogram)
<span style = "background-color:#fdd">{</span>
#if !defined(ITK_USE_REVIEW_STATISTICS)
  typedef itk::Statistics::MITKScalarImageToHistogramGenerator&lt;itk::Image&lt;TPixel, VImageDimension&gt;, double&gt;
    HistogramGeneratorType;
#else
  typedef itk::Statistics::ScalarImageToHistogramGenerator&lt;itk::Image&lt;TPixel, VImageDimension&gt;&gt; HistogramGeneratorType;

#endif
<span style = "background-color:#fdd">  typename HistogramGeneratorType::Pointer histogramGenerator = HistogramGeneratorType::New();</span>

<span style = "background-color:#fdd">  histogramGenerator-&gt;SetInput(itkImage);</span>

<span style = "background-color:#fdd">  histogramGenerator-&gt;SetNumberOfBins(mitkHistoGenerator-&gt;GetSize());</span>
  //  histogramGenerator-&gt;SetMarginalScale( 10.0 );
<span style = "background-color:#fdd">  histogramGenerator-&gt;Compute();</span>

<span style = "background-color:#fdd">  histogram = histogramGenerator-&gt;GetOutput();
}</span>

void mitk::HistogramGenerator::ComputeHistogram()
<span style = "background-color:#fdd">{
  if ((m_Histogram.IsNull()) || (m_Histogram-&gt;GetMTime() &lt; m_Image-&gt;GetMTime()))</span>
  {
<span style = "background-color:#fdd">    const_cast&lt;mitk::Image *&gt;(m_Image.GetPointer())-&gt;SetRequestedRegionToLargestPossibleRegion(); //@todo without this,</span>
                                                                                                  // Image::GetScalarMin
    // does not work for
    // dim==3 (including
    // sliceselector!)
<span style = "background-color:#fdd">    const_cast&lt;mitk::Image *&gt;(m_Image.GetPointer())-&gt;Update();
    mitk::ImageTimeSelector::Pointer timeSelector = mitk::ImageTimeSelector::New();
    timeSelector-&gt;SetInput(m_Image);
    timeSelector-&gt;SetTimeNr(0);
    timeSelector-&gt;UpdateLargestPossibleRegion();
    AccessByItk_n(timeSelector-&gt;GetOutput(), InternalCompute, (this, m_Histogram));
  }</span>

  // debug code
  /*
    MITK_INFO &lt;&lt; "Histogram modfied 1" &lt;&lt; m_Histogram-&gt;GetMTime() &lt;&lt; std::endl;
    m_Histogram-&gt;Modified();
    MITK_INFO &lt;&lt; "Histogram modfied 2" &lt;&lt; m_Histogram-&gt;GetMTime() &lt;&lt; std::endl;
    MITK_INFO &lt;&lt; "Image modfied" &lt;&lt; m_Image-&gt;GetMTime() &lt;&lt; std::endl;
  const unsigned int histogramSize = m_Histogram-&gt;Size();

  MITK_INFO &lt;&lt; "Histogram size " &lt;&lt; histogramSize &lt;&lt; std::endl;

  HistogramType::ConstIterator itr = GetHistogram()-&gt;Begin();
  HistogramType::ConstIterator end = GetHistogram()-&gt;End();

  int bin = 0;
  while( itr != end )
    {
    MITK_INFO &lt;&lt; "bin = " &lt;&lt; GetHistogram()-&gt;GetBinMin(0,bin) &lt;&lt; "--" &lt;&lt; GetHistogram()-&gt;GetBinMax(0,bin) &lt;&lt; " frequency
  = ";
    MITK_INFO &lt;&lt; itr.GetFrequency() &lt;&lt; std::endl;
    ++itr;
    ++bin;
    }
    */
<span style = "background-color:#fdd">}</span>

float mitk::HistogramGenerator::GetMaximumFrequency() const
<span style = "background-color:#fdd">{
  return CalculateMaximumFrequency(this-&gt;m_Histogram);
}</span>

float mitk::HistogramGenerator::CalculateMaximumFrequency(const HistogramType *histogram)
<span style = "background-color:#fdd">{
  HistogramType::ConstIterator itr = histogram-&gt;Begin();
  HistogramType::ConstIterator end = histogram-&gt;End();</span>

<span style = "background-color:#fdd">  float maxFreq = 0;
  while (itr != end)</span>
  {
<span style = "background-color:#fdd">    maxFreq = std::max(maxFreq, static_cast&lt;float&gt;(itr.GetFrequency()));
    ++itr;
  }
  return maxFreq;
}</span></pre>
	</body>
</html>
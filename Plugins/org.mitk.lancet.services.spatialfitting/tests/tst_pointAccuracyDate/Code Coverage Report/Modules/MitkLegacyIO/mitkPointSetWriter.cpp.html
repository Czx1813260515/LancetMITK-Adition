<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkPointSetWriter.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkPointSetWriter.h"
#include &lt;fstream&gt;
#include &lt;iostream&gt;
#include &lt;locale&gt;

//
// Initialization of the xml tags.
//

const char *mitk::PointSetWriter::XML_POINT_SET_FILE = "point_set_file";

const char *mitk::PointSetWriter::XML_FILE_VERSION = "file_version";

const char *mitk::PointSetWriter::XML_POINT_SET = "point_set";

const char *mitk::PointSetWriter::XML_TIME_SERIES = "time_series";

const char *mitk::PointSetWriter::XML_TIME_SERIES_ID = "time_series_id";

const char *mitk::PointSetWriter::XML_POINT = "point";

const char *mitk::PointSetWriter::XML_ID = "id";

const char *mitk::PointSetWriter::XML_SPEC = "specification";

const char *mitk::PointSetWriter::XML_X = "x";

const char *mitk::PointSetWriter::XML_Y = "y";

const char *mitk::PointSetWriter::XML_Z = "z";

const char *mitk::PointSetWriter::VERSION_STRING = "0.1";

<span style = "background-color:#fdd">mitk::PointSetWriter::PointSetWriter() : m_FileName(""), m_FilePrefix(""), m_FilePattern("")
{
  this-&gt;SetNumberOfRequiredInputs(1);
  this-&gt;SetNumberOfIndexedOutputs(1);
  this-&gt;SetNthOutput(0, mitk::PointSet::New().GetPointer());
  m_Indent = 2;
  m_IndentDepth = 0;
  m_Success = false;
}</span>

mitk::PointSetWriter::~PointSetWriter()
<span style = "background-color:#fdd">{
}</span>

void mitk::PointSetWriter::GenerateData()
<span style = "background-color:#fdd">{
  m_Success = false;
  m_IndentDepth = 0;</span>

  //
  // Opening the file to write to
  //
<span style = "background-color:#fdd">  if (m_FileName == "")</span>
  {
<span style = "background-color:#fdd">    itkWarningMacro(&lt;&lt; "Sorry, filename has not been set!");
    return;</span>
  }
<span style = "background-color:#fdd">  std::ofstream out(m_FileName.c_str());
  if (!out.good())</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro(&lt;&lt; "File " &lt;&lt; m_FileName &lt;&lt; " could not be opened!");
    itkWarningMacro(&lt;&lt; "Sorry, file " &lt;&lt; m_FileName &lt;&lt; " could not be opened!");
    out.close();
    return;</span>
  }

<span style = "background-color:#fdd">  std::locale previousLocale(out.getloc());
  std::locale I("C");
  out.imbue(I);</span>

  //
  // Here the actual xml writing begins
  //
<span style = "background-color:#fdd">  WriteXMLHeader(out);
  WriteStartElement(XML_POINT_SET_FILE, out);
  WriteStartElement(XML_FILE_VERSION, out);
  WriteCharacterData(VERSION_STRING, out);
  WriteEndElement(XML_FILE_VERSION, out, false);</span>

  //
  // for each input object write its xml representation to
  // the stream
  //
<span style = "background-color:#fdd">  for (unsigned int i = 0; i &lt; this-&gt;GetNumberOfInputs(); ++i)</span>
  {
<span style = "background-color:#fdd">    InputType::Pointer pointSet = this-&gt;GetInput(i);
    assert(pointSet.IsNotNull());
    WriteXML(pointSet.GetPointer(), out);
  }</span>

<span style = "background-color:#fdd">  WriteEndElement(XML_POINT_SET_FILE, out);
  out.imbue(previousLocale);
  if (!out.good()) // some error during output</span>
  {
<span style = "background-color:#fdd">    out.close();
    throw std::ios_base::failure("Some error during point set writing.");</span>
  }

<span style = "background-color:#fdd">  out.close();
  m_Success = true;
  m_MimeType = "application/MITK.PointSet";
}</span>

void mitk::PointSetWriter::WriteXML(mitk::PointSet *pointSet, std::ofstream &amp;out)
<span style = "background-color:#fdd">{
  WriteStartElement(XML_POINT_SET, out);
  unsigned int timecount = pointSet-&gt;GetTimeSteps();</span>

<span style = "background-color:#fdd">  for (unsigned int i = 0; i &lt; timecount; i++)</span>
  {
<span style = "background-color:#fdd">    WriteStartElement(XML_TIME_SERIES, out);</span>

<span style = "background-color:#fdd">    WriteStartElement(XML_TIME_SERIES_ID, out);
    WriteCharacterData(ConvertToString(i).c_str(), out);
    WriteEndElement(XML_TIME_SERIES_ID, out, false);</span>

<span style = "background-color:#fdd">    mitk::PointSet::PointsContainer *pointsContainer = pointSet-&gt;GetPointSet(i)-&gt;GetPoints();
    mitk::PointSet::PointsContainer::Iterator it;</span>

<span style = "background-color:#fdd">    for (it = pointsContainer-&gt;Begin(); it != pointsContainer-&gt;End(); ++it)</span>
    {
<span style = "background-color:#fdd">      WriteStartElement(XML_POINT, out);</span>

<span style = "background-color:#fdd">      WriteStartElement(XML_ID, out);
      WriteCharacterData(ConvertToString(it-&gt;Index()).c_str(), out);
      WriteEndElement(XML_ID, out, false);</span>

<span style = "background-color:#fdd">      mitk::PointSet::PointType point = it-&gt;Value();</span>

<span style = "background-color:#fdd">      WriteStartElement(XML_SPEC, out);
      WriteCharacterData(ConvertToString(pointSet-&gt;GetSpecificationTypeInfo(it-&gt;Index(), i)).c_str(), out);
      WriteEndElement(XML_SPEC, out, false);</span>

<span style = "background-color:#fdd">      WriteStartElement(XML_X, out);
      WriteCharacterData(ConvertToString(point[0]).c_str(), out);
      WriteEndElement(XML_X, out, false);</span>

<span style = "background-color:#fdd">      WriteStartElement(XML_Y, out);
      WriteCharacterData(ConvertToString(point[1]).c_str(), out);
      WriteEndElement(XML_Y, out, false);</span>

<span style = "background-color:#fdd">      WriteStartElement(XML_Z, out);
      WriteCharacterData(ConvertToString(point[2]).c_str(), out);
      WriteEndElement(XML_Z, out, false);</span>

<span style = "background-color:#fdd">      WriteEndElement(XML_POINT, out);
    }
    WriteEndElement(XML_TIME_SERIES, out);
  }</span>

<span style = "background-color:#fdd">  WriteEndElement(XML_POINT_SET, out);
}</span>

void mitk::PointSetWriter::ResizeInputs(const unsigned int &amp;num)
<span style = "background-color:#fdd">{
  unsigned int prevNum = this-&gt;GetNumberOfInputs();
  this-&gt;SetNumberOfIndexedInputs(num);
  for (unsigned int i = prevNum; i &lt; num; ++i)</span>
  {
<span style = "background-color:#fdd">    this-&gt;SetNthInput(i, mitk::PointSet::New().GetPointer());
  }
}</span>

void mitk::PointSetWriter::SetInput(InputType *pointSet)
<span style = "background-color:#fdd">{
  this-&gt;ProcessObject::SetNthInput(0, pointSet);
}</span>

void mitk::PointSetWriter::SetInput(const unsigned int &amp;id, InputType *pointSet)
<span style = "background-color:#fdd">{
  if (id &gt;= this-&gt;GetNumberOfInputs())
    this-&gt;ResizeInputs(id + 1);
  this-&gt;ProcessObject::SetNthInput(id, pointSet);
}</span>

mitk::PointSet *mitk::PointSetWriter::GetInput()
<span style = "background-color:#fdd">{
  if (this-&gt;GetNumberOfInputs() &lt; 1)</span>
  {
<span style = "background-color:#fdd">    return nullptr;
  }</span>
  else
  {
<span style = "background-color:#fdd">    return dynamic_cast&lt;InputType *&gt;(this-&gt;GetInput(0));</span>
  }
<span style = "background-color:#fdd">}</span>

mitk::PointSet *mitk::PointSetWriter::GetInput(const unsigned int &amp;num)
<span style = "background-color:#fdd">{
  return dynamic_cast&lt;InputType *&gt;(this-&gt;ProcessObject::GetInput(num));
}</span>

template &lt;typename T&gt;
std::string mitk::PointSetWriter::ConvertToString(T value)
<span style = "background-color:#fdd">{
  std::ostringstream o;
  std::locale I("C");
  o.imbue(I);</span>

<span style = "background-color:#fdd">  if (o &lt;&lt; value)</span>
  {
<span style = "background-color:#fdd">    return o.str();
  }</span>
  else
<span style = "background-color:#fdd">    return "conversion error";
}</span>

void mitk::PointSetWriter::WriteXMLHeader(std::ofstream &amp;file)
<span style = "background-color:#fdd">{
  file &lt;&lt; "&lt;?xml version=\"1.0\" encoding=\"ISO-8859-1\"?&gt;";
}</span>

void mitk::PointSetWriter::WriteStartElement(const char *const tag, std::ofstream &amp;file)
<span style = "background-color:#fdd">{
  file &lt;&lt; std::endl;
  WriteIndent(file);
  file &lt;&lt; '&lt;' &lt;&lt; tag &lt;&lt; '&gt;';
  m_IndentDepth++;
}</span>

void mitk::PointSetWriter::WriteEndElement(const char *const tag, std::ofstream &amp;file, const bool &amp;indent)
<span style = "background-color:#fdd">{
  m_IndentDepth--;
  if (indent)</span>
  {
<span style = "background-color:#fdd">    file &lt;&lt; std::endl;
    WriteIndent(file);</span>
  }
<span style = "background-color:#fdd">  file &lt;&lt; '&lt;' &lt;&lt; '/' &lt;&lt; tag &lt;&lt; '&gt;';
}</span>

void mitk::PointSetWriter::WriteCharacterData(const char *const data, std::ofstream &amp;file)
<span style = "background-color:#fdd">{
  file &lt;&lt; data;
}</span>

void mitk::PointSetWriter::WriteStartElement(std::string &amp;tag, std::ofstream &amp;file)
<span style = "background-color:#fdd">{
  WriteStartElement(tag.c_str(), file);
}</span>

void mitk::PointSetWriter::WriteEndElement(std::string &amp;tag, std::ofstream &amp;file, const bool &amp;indent)
<span style = "background-color:#fdd">{
  WriteEndElement(tag.c_str(), file, indent);
}</span>

void mitk::PointSetWriter::WriteCharacterData(std::string &amp;data, std::ofstream &amp;file)
<span style = "background-color:#fdd">{
  WriteCharacterData(data.c_str(), file);
}</span>

void mitk::PointSetWriter::WriteIndent(std::ofstream &amp;file)
<span style = "background-color:#fdd">{
  std::string spaces(m_IndentDepth * m_Indent, ' ');
  file &lt;&lt; spaces.c_str();
}</span>

bool mitk::PointSetWriter::GetSuccess() const
<span style = "background-color:#fdd">{
  return m_Success;
}</span>

bool mitk::PointSetWriter::CanWriteDataType(DataNode *input)
<span style = "background-color:#fdd">{
  if (input)</span>
  {
<span style = "background-color:#fdd">    mitk::BaseData *data = input-&gt;GetData();
    if (data)</span>
    {
<span style = "background-color:#fdd">      mitk::PointSet::Pointer pointSet = dynamic_cast&lt;mitk::PointSet *&gt;(data);
      if (pointSet.IsNotNull())</span>
      {
        // this writer has no "SetDefaultExtension()" - function
<span style = "background-color:#fdd">        m_Extension = ".mps";
        return true;</span>
      }
<span style = "background-color:#fdd">    }</span>
  }
<span style = "background-color:#fdd">  return false;
}</span>

void mitk::PointSetWriter::SetInput(DataNode *input)
<span style = "background-color:#fdd">{
  if (input &amp;&amp; CanWriteDataType(input))
    this-&gt;ProcessObject::SetNthInput(0, dynamic_cast&lt;mitk::PointSet *&gt;(input-&gt;GetData()));
}</span>

std::string mitk::PointSetWriter::GetWritenMIMEType()
<span style = "background-color:#fdd">{
  return m_MimeType;
}</span>

std::vector&lt;std::string&gt; mitk::PointSetWriter::GetPossibleFileExtensions()
<span style = "background-color:#fdd">{
  std::vector&lt;std::string&gt; possibleFileExtensions;
  possibleFileExtensions.push_back(".mps");
  return possibleFileExtensions;
}</span>

std::string mitk::PointSetWriter::GetSupportedBaseData() const
<span style = "background-color:#fdd">{
  return PointSet::GetStaticNameOfClass();
}</span>

std::string mitk::PointSetWriter::GetFileExtension()
<span style = "background-color:#fdd">{
  return m_Extension;
}</span></pre>
	</body>
</html>
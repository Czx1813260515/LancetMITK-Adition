<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkRawImageFileReader.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkRawImageFileReader.h"
#include "mitkImageCast.h"

#include &lt;itkImage.h&gt;
#include &lt;itkImageFileReader.h&gt;
#include &lt;itkRawImageIO.h&gt;

<span style = "background-color:#fdd">mitk::RawImageFileReader::RawImageFileReader() : m_FileName(""), m_FilePrefix(""), m_FilePattern("")
{
}</span>

mitk::RawImageFileReader::~RawImageFileReader()
<span style = "background-color:#fdd">{
}</span>

void mitk::RawImageFileReader::SetDimensions(unsigned int i, unsigned int dim)
<span style = "background-color:#fdd">{
  if (i &gt; 2)
    return;</span>

<span style = "background-color:#fdd">  this-&gt;Modified(); // TODO: this order (first modified, then set the variable) is intended??
  m_Dimensions[i] = dim;
}</span>

unsigned int mitk::RawImageFileReader::GetDimensions(unsigned int i) const
<span style = "background-color:#fdd">{
  if (i &gt; 2)
    return 0;</span>

<span style = "background-color:#fdd">  return m_Dimensions[i];
}</span>

bool mitk::RawImageFileReader::CanReadFile(const std::string filename,
                                           const std::string filePrefix,
                                           const std::string filePattern)
<span style = "background-color:#fdd">{</span>
  // First check the extension
<span style = "background-color:#fdd">  if (filename == "")
    return false;</span>

  // check if image is serie
<span style = "background-color:#fdd">  if (filePattern != "" &amp;&amp; filePrefix != "")
    return false;</span>

<span style = "background-color:#fdd">  return true;
}</span>

void mitk::RawImageFileReader::GenerateData()
<span style = "background-color:#fdd">{
  mitk::Image::Pointer output = this-&gt;GetOutput();</span>

<span style = "background-color:#fdd">  if (this-&gt;GetOutput() == nullptr)</span>
  {
<span style = "background-color:#fdd">    MITK_INFO &lt;&lt; "Error" &lt;&lt; std::endl;</span>
  }

  // Check to see if we can read the file given the name or prefix
<span style = "background-color:#fdd">  if (m_FileName == "")</span>
  {
<span style = "background-color:#fdd">    itkWarningMacro(&lt;&lt; "File Type not supported!");
    return;</span>
  }

  // check file dimensionality and pixel type and perform reading according to it
<span style = "background-color:#fdd">  if (m_Dimensionality == 2)</span>
  {
<span style = "background-color:#fdd">    if (m_PixelType == SCHAR)
      TypedGenerateData&lt;signed char, 2&gt;();
    else if (m_PixelType == UCHAR)
      TypedGenerateData&lt;unsigned char, 2&gt;();
    else if (m_PixelType == SSHORT)
      TypedGenerateData&lt;signed short int, 2&gt;();
    else if (m_PixelType == USHORT)
      TypedGenerateData&lt;unsigned short int, 2&gt;();
    else if (m_PixelType == UINT)
      TypedGenerateData&lt;unsigned int, 2&gt;();
    else if (m_PixelType == SINT)
      TypedGenerateData&lt;signed int, 2&gt;();
    else if (m_PixelType == FLOAT)
      TypedGenerateData&lt;float, 2&gt;();
    else if (m_PixelType == DOUBLE)
      TypedGenerateData&lt;double, 2&gt;();</span>
    else
    {
<span style = "background-color:#fdd">      MITK_INFO &lt;&lt; "Error while reading raw file: Dimensionality or pixel type not supported or not properly set"</span>
                &lt;&lt; std::endl;
<span style = "background-color:#fdd">      return;</span>
    }
<span style = "background-color:#fdd">  }
  else if (m_Dimensionality == 3)</span>
  {
<span style = "background-color:#fdd">    if (m_PixelType == SCHAR)
      TypedGenerateData&lt;signed char, 3&gt;();
    else if (m_PixelType == UCHAR)
      TypedGenerateData&lt;unsigned char, 3&gt;();
    else if (m_PixelType == SSHORT)
      TypedGenerateData&lt;signed short int, 3&gt;();
    else if (m_PixelType == USHORT)
      TypedGenerateData&lt;unsigned short int, 3&gt;();
    else if (m_PixelType == UINT)
      TypedGenerateData&lt;unsigned int, 3&gt;();
    else if (m_PixelType == SINT)
      TypedGenerateData&lt;signed int, 3&gt;();
    else if (m_PixelType == FLOAT)
      TypedGenerateData&lt;float, 3&gt;();
    else if (m_PixelType == DOUBLE)
      TypedGenerateData&lt;double, 3&gt;();</span>
    else
    {
<span style = "background-color:#fdd">      MITK_INFO &lt;&lt; "Error while reading raw file: Dimensionality or pixel type not supported or not properly set"</span>
                &lt;&lt; std::endl;
<span style = "background-color:#fdd">      return;</span>
    }
<span style = "background-color:#fdd">  }</span>
  else
  {
<span style = "background-color:#fdd">    MITK_INFO &lt;&lt; "Error while reading raw file: Dimensionality not supported" &lt;&lt; std::endl;
    return;</span>
  }

<span style = "background-color:#fdd">  MITK_INFO &lt;&lt; "...reading raw finished!" &lt;&lt; std::endl;
}</span>

template &lt;typename TPixel, unsigned int VImageDimensions&gt;
void mitk::RawImageFileReader::TypedGenerateData()
<span style = "background-color:#fdd">{
  mitk::Image::Pointer output = this-&gt;GetOutput();</span>

<span style = "background-color:#fdd">  if (this-&gt;GetOutput() == nullptr)</span>
  {
<span style = "background-color:#fdd">    MITK_INFO &lt;&lt; "Error" &lt;&lt; std::endl;</span>
  }

<span style = "background-color:#fdd">  MITK_INFO &lt;&lt; "loading " &lt;&lt; m_FileName &lt;&lt; " via itk::ImageIOFactory... " &lt;&lt; std::endl;</span>

  // Check to see if we can read the file given the name or prefix
<span style = "background-color:#fdd">  if (m_FileName == "")</span>
  {
<span style = "background-color:#fdd">    itkWarningMacro(&lt;&lt; "File Type not supported!");
    return;</span>
  }

  typedef itk::Image&lt;TPixel, VImageDimensions&gt; ImageType;
  typedef itk::ImageFileReader&lt;ImageType&gt; ReaderType;
  typedef itk::RawImageIO&lt;TPixel, VImageDimensions&gt; IOType;

<span style = "background-color:#fdd">  typename ReaderType::Pointer reader = ReaderType::New();
  typename IOType::Pointer io = IOType::New();</span>

<span style = "background-color:#fdd">  io-&gt;SetFileDimensionality(VImageDimensions);</span>

<span style = "background-color:#fdd">  for (unsigned short int dim = 0; dim &lt; VImageDimensions; ++dim)</span>
  {
<span style = "background-color:#fdd">    io-&gt;SetDimensions(dim, m_Dimensions[dim]);
  }</span>

<span style = "background-color:#fdd">  if (m_Endianity == LITTLE)</span>
  {
<span style = "background-color:#fdd">    io-&gt;SetByteOrderToLittleEndian();
  }
  else if (m_Endianity == BIG)</span>
  {
<span style = "background-color:#fdd">    io-&gt;SetByteOrderToBigEndian();
  }</span>
  else
  {
<span style = "background-color:#fdd">    MITK_INFO &lt;&lt; "Warning: endianity not properly set. Resulting image might be incorrect";</span>
  }

<span style = "background-color:#fdd">  reader-&gt;SetImageIO(io);
  reader-&gt;SetFileName(m_FileName.c_str());</span>

  try
  {
<span style = "background-color:#fdd">    reader-&gt;Update();</span>
  }
  catch (itk::ExceptionObject &amp;err)
<span style = "background-color:#fdd">  {
    MITK_ERROR &lt;&lt; "An error occurred during the raw image reading process: ";
    MITK_INFO &lt;&lt; err &lt;&lt; std::endl;
  }</span>

<span style = "background-color:#fdd">  mitk::Image::Pointer image = mitk::Image::New();
  mitk::CastToMitkImage(reader-&gt;GetOutput(), image);
  output-&gt;Initialize(image);
  output-&gt;SetVolume(reader-&gt;GetOutput()-&gt;GetBufferPointer());
}</span></pre>
	</body>
</html>
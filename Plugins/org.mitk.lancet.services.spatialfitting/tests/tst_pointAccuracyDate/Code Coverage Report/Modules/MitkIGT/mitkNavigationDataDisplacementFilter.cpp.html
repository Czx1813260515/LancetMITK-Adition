<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkNavigationDataDisplacementFilter.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkNavigationDataDisplacementFilter.h"
#include "mitkPropertyList.h"
#include "mitkProperties.h"

mitk::NavigationDataDisplacementFilter::NavigationDataDisplacementFilter()
<span style = "background-color:#fdd">: mitk::NavigationDataToNavigationDataFilter(), m_Transform6DOF(false)
{
  m_Offset[0] = 0.0;
  m_Offset[1] = 0.0;
  m_Offset[2] = 0.0;</span>

<span style = "background-color:#fdd">  m_Transformation = mitk::NavigationData::New();</span>

<span style = "background-color:#fdd">}</span>


mitk::NavigationDataDisplacementFilter::~NavigationDataDisplacementFilter()
<span style = "background-color:#fdd">{
}</span>


void mitk::NavigationDataDisplacementFilter::GenerateData()
<span style = "background-color:#fdd">{</span>
  /* update outputs with tracking data from tools */
<span style = "background-color:#fdd">  if( !m_Transform6DOF )</span>
  {
<span style = "background-color:#fdd">    for (unsigned int i = 0; i &lt; this-&gt;GetNumberOfOutputs() ; ++i)</span>
    {
<span style = "background-color:#fdd">      mitk::NavigationData* output = this-&gt;GetOutput(i);
      assert(output);
      const mitk::NavigationData* input = this-&gt;GetInput(i);
      assert(input);</span>

<span style = "background-color:#fdd">      if (input-&gt;IsDataValid() == false)</span>
      {
<span style = "background-color:#fdd">        output-&gt;SetDataValid(false);
        continue;</span>
      }
<span style = "background-color:#fdd">      output-&gt;Graft(input); // First, copy all information from input to output
      output-&gt;SetPosition(input-&gt;GetPosition() + m_Offset);  // Then change the member(s): add offset to position of navigation data
      output-&gt;SetDataValid(true); // operation was successful, therefore data of output is valid.</span>
      // don't change anything else here
<span style = "background-color:#fdd">    }
  }</span>
  else
  {
<span style = "background-color:#fdd">    if( this-&gt;GetNumberOfOutputs() &lt; 2 )</span>
    {
<span style = "background-color:#fdd">      MITK_WARN &lt;&lt; "TrackedUltrasound not possible. The number of tracked devices must be at least 2.";
      return;</span>
    }

    //important: First device = Needle | Second device = US-Tracker

<span style = "background-color:#fdd">    mitk::NavigationData::Pointer needleOut = this-&gt;GetOutput(0);
    const mitk::NavigationData* needleIn = this-&gt;GetInput(0);</span>

<span style = "background-color:#fdd">    mitk::NavigationData::Pointer usTrackerOut = this-&gt;GetOutput(1);
    const mitk::NavigationData* usTrackerIn = this-&gt;GetInput(1);</span>

<span style = "background-color:#fdd">    if(needleIn-&gt;IsDataValid() == false )</span>
    {
<span style = "background-color:#fdd">      needleOut-&gt;SetDataValid(false);
    }</span>
    else
<span style = "background-color:#fdd">      needleOut-&gt;Graft(needleIn);</span>

<span style = "background-color:#fdd">    if (usTrackerIn-&gt;IsDataValid() == false)</span>
    {
<span style = "background-color:#fdd">      usTrackerOut-&gt;SetDataValid(false);
    }</span>
    else
<span style = "background-color:#fdd">      usTrackerOut-&gt;Graft(usTrackerIn);</span>

<span style = "background-color:#fdd">    needleOut-&gt;Compose( usTrackerOut-&gt;GetInverse(), false );
    needleOut-&gt;Compose( m_Transformation-&gt;GetInverse() );</span>

<span style = "background-color:#fdd">    usTrackerOut-&gt;SetDataValid(true);
    needleOut-&gt;SetDataValid(true);</span>

<span style = "background-color:#fdd">    if( this-&gt;GetNumberOfOutputs() &gt; 2 )</span>
    {
<span style = "background-color:#fdd">      for( unsigned int i = 2; i &lt; this-&gt;GetNumberOfOutputs(); ++i )</span>
      {
<span style = "background-color:#fdd">        mitk::NavigationData* output = this-&gt;GetOutput(i);
        const mitk::NavigationData* input = this-&gt;GetInput(i);</span>

<span style = "background-color:#fdd">        if (input-&gt;IsDataValid() == false)</span>
        {
<span style = "background-color:#fdd">          output-&gt;SetDataValid(false);
          continue;</span>
        }
<span style = "background-color:#fdd">        output-&gt;Graft(input);
        output-&gt;SetDataValid(true);
      }</span>
    }
<span style = "background-color:#fdd">  }
}</span>


void mitk::NavigationDataDisplacementFilter::SetTransformation(mitk::AffineTransform3D::Pointer transform)
<span style = "background-color:#fdd">{
  mitk::NavigationData::Pointer transformation = mitk::NavigationData::New(transform);
  m_Transformation = transformation;
}</span>

void mitk::NavigationDataDisplacementFilter::SetParameters( const mitk::PropertyList* p )
<span style = "background-color:#fdd">{
  if (p == nullptr)
    return;
  mitk::Vector3D v;
  if (p-&gt;GetPropertyValue&lt;mitk::Vector3D&gt;("NavigationDataDisplacementFilter_Offset", v) == true)  // search for Offset parameter
    this-&gt;SetOffset(v);   // apply if found;
}</span>


mitk::PropertyList::ConstPointer mitk::NavigationDataDisplacementFilter::GetParameters() const
<span style = "background-color:#fdd">{
  mitk::PropertyList::Pointer p = mitk::PropertyList::New();
  p-&gt;SetProperty("NavigationDataDisplacementFilter_Offset", mitk::Vector3DProperty::New(this-&gt;GetOffset()));  // store Offset parameter
  return mitk::PropertyList::ConstPointer(p);
}</span></pre>
	</body>
</html>
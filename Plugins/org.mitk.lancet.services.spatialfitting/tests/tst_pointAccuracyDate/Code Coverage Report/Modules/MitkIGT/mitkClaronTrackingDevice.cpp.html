<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkClaronTrackingDevice.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkClaronTrackingDevice.h"
#include "mitkClaronTool.h"
#include "mitkIGTConfig.h"
#include "mitkIGTTimeStamp.h"
#include "mitkIGTHardwareException.h"
#include &lt;itksys/SystemTools.hxx&gt;
#include &lt;iostream&gt;
#include &lt;mitkIOUtil.h&gt;
#include &lt;mitkMicronTrackerTypeInformation.h&gt;


<span style = "background-color:#fdd">mitk::ClaronTrackingDevice::ClaronTrackingDevice(): mitk::TrackingDevice()
{</span>
  //set the type of this tracking device
<span style = "background-color:#fdd">  this-&gt;m_Data = mitk::MicronTrackerTypeInformation::GetDeviceDataMicronTrackerH40();</span>

<span style = "background-color:#fdd">  m_Device = mitk::ClaronInterface::New();</span>
  //############################# standard directories ##################################
<span style = "background-color:#fdd">  if (m_Device-&gt;IsMicronTrackerInstalled())</span>
  {
<span style = "background-color:#fdd">    m_ToolfilesDir = mitk::IOUtil::CreateTemporaryDirectory();</span>
#ifdef MITK_MICRON_TRACKER_CALIBRATION_DIR
    m_CalibrationDir = std::string(MITK_MICRON_TRACKER_CALIBRATION_DIR);
#endif
<span style = "background-color:#fdd">  }</span>
  else
  {
<span style = "background-color:#fdd">    m_ToolfilesDir = "Error - No Microntracker installed";
    m_CalibrationDir = "Error - No Microntracker installed";</span>
  }
  //##################################################################################################
<span style = "background-color:#fdd">  m_Device-&gt;Initialize(m_CalibrationDir, m_ToolfilesDir);
}</span>

bool mitk::ClaronTrackingDevice::IsDeviceInstalled()
<span style = "background-color:#fdd">{
  mitk::ClaronInterface::Pointer tempInterface = mitk::ClaronInterface::New();
  return tempInterface-&gt;IsMicronTrackerInstalled();
}</span>


mitk::ClaronTrackingDevice::~ClaronTrackingDevice()
<span style = "background-color:#fdd">{
}</span>


mitk::TrackingTool* mitk::ClaronTrackingDevice::AddTool( const char* toolName, const char* fileName )
<span style = "background-color:#fdd">{
  mitk::ClaronTool::Pointer t = mitk::ClaronTool::New();
  if (t-&gt;LoadFile(fileName) == false)</span>
  {
<span style = "background-color:#fdd">    return nullptr;</span>
  }
<span style = "background-color:#fdd">  t-&gt;SetToolName(toolName);
  if (this-&gt;InternalAddTool(t) == false)
    return nullptr;
  return t.GetPointer();
}</span>


bool mitk::ClaronTrackingDevice::InternalAddTool(ClaronTool::Pointer tool)
<span style = "background-color:#fdd">{
  m_AllTools.push_back(tool);
  return true;
}</span>


std::vector&lt;mitk::ClaronTool::Pointer&gt; mitk::ClaronTrackingDevice::DetectTools()
<span style = "background-color:#fdd">{
  std::vector&lt;mitk::ClaronTool::Pointer&gt; returnValue;
  std::vector&lt;claronToolHandle&gt; allHandles = m_Device-&gt;GetAllActiveTools();
  for (auto iter = allHandles.begin(); iter != allHandles.end(); ++iter)</span>
  {
<span style = "background-color:#fdd">    ClaronTool::Pointer newTool = ClaronTool::New();
    newTool-&gt;SetToolName(m_Device-&gt;GetName(*iter));
    newTool-&gt;SetCalibrationName(m_Device-&gt;GetName(*iter));
    newTool-&gt;SetToolHandle(*iter);
    returnValue.push_back(newTool);
  }
  return returnValue;
}</span>


bool mitk::ClaronTrackingDevice::StartTracking()
<span style = "background-color:#fdd">{</span>

  //By Alfred: next line because no temp directory is set if MicronTracker is not installed
<span style = "background-color:#fdd">  if (!m_Device-&gt;IsMicronTrackerInstalled())
    return false;</span>
  //##################################################################################

  //be sure that the temp-directory is empty at start: delete all files in the tool files directory
<span style = "background-color:#fdd">  itksys::SystemTools::RemoveADirectory(m_ToolfilesDir.c_str());
  itksys::SystemTools::MakeDirectory(m_ToolfilesDir.c_str());</span>

  //copy all toolfiles into the temp directory
<span style = "background-color:#fdd">  for (unsigned int i=0; i&lt;m_AllTools.size(); i++)</span>
  {
<span style = "background-color:#fdd">    itksys::SystemTools::CopyAFile(m_AllTools[i]-&gt;GetFile().c_str(), m_ToolfilesDir.c_str());
  }
  this-&gt;SetState(Tracking);            // go to mode Tracking
  this-&gt;m_StopTrackingMutex.lock();  // update the local copy of m_StopTracking
  this-&gt;m_StopTracking = false;
  this-&gt;m_StopTrackingMutex.unlock();</span>

  //restart the Microntracker, so it will load the new tool files
<span style = "background-color:#fdd">  m_Device-&gt;StopTracking();
  m_Device-&gt;Initialize(m_CalibrationDir,m_ToolfilesDir);</span>

<span style = "background-color:#fdd">  if (m_Device-&gt;StartTracking())</span>
  {
<span style = "background-color:#fdd">    mitk::IGTTimeStamp::GetInstance()-&gt;Start(this);
    m_Thread = std::thread(&amp;ClaronTrackingDevice::ThreadStartTracking, this);    // start a new thread that executes the TrackTools() method
    return true;
  }</span>
  else
<span style = "background-color:#fdd">    {mitkThrowException(mitk::IGTHardwareException) &lt;&lt; "Error while trying to start the device!";}
}</span>


bool mitk::ClaronTrackingDevice::StopTracking()
<span style = "background-color:#fdd">{
  Superclass::StopTracking();</span>
  //delete all files in the tool files directory
<span style = "background-color:#fdd">  itksys::SystemTools::RemoveADirectory(m_ToolfilesDir.c_str());
  return true;
}</span>


unsigned int mitk::ClaronTrackingDevice::GetToolCount() const
<span style = "background-color:#fdd">{
  return (unsigned int)this-&gt;m_AllTools.size();
}</span>


mitk::TrackingTool* mitk::ClaronTrackingDevice::GetTool(unsigned int toolNumber) const
<span style = "background-color:#fdd">{
  if ( toolNumber &gt;= this-&gt;GetToolCount())
    return nullptr;</span>
  else
<span style = "background-color:#fdd">    return this-&gt;m_AllTools[toolNumber];
}</span>


bool mitk::ClaronTrackingDevice::OpenConnection()
<span style = "background-color:#fdd">{</span>
  bool returnValue;
  //Create the temp directory
<span style = "background-color:#fdd">  itksys::SystemTools::MakeDirectory(m_ToolfilesDir.c_str());</span>

<span style = "background-color:#fdd">  m_Device-&gt;Initialize(m_CalibrationDir,m_ToolfilesDir);
  returnValue = m_Device-&gt;StartTracking();</span>

<span style = "background-color:#fdd">  if (returnValue)</span>
  {
<span style = "background-color:#fdd">    this-&gt;SetState(Ready);
  }</span>
  else
  {
    //reset everything
<span style = "background-color:#fdd">    if (m_Device.IsNull())</span>
    {
<span style = "background-color:#fdd">      m_Device = mitk::ClaronInterface::New();
      m_Device-&gt;Initialize(m_CalibrationDir, m_ToolfilesDir);</span>
    }
<span style = "background-color:#fdd">    m_Device-&gt;StopTracking();
    this-&gt;SetState(Setup);
    mitkThrowException(mitk::IGTHardwareException) &lt;&lt; "Error while trying to open connection to the MicronTracker.";</span>
  }
<span style = "background-color:#fdd">  return returnValue;
}</span>


bool mitk::ClaronTrackingDevice::CloseConnection()
<span style = "background-color:#fdd">{
  bool returnValue = true;
  if (this-&gt;GetState() == Setup)
    return true;</span>

<span style = "background-color:#fdd">  returnValue = m_Device-&gt;StopTracking();</span>

  //delete the temporary directory
<span style = "background-color:#fdd">  itksys::SystemTools::RemoveADirectory(m_ToolfilesDir.c_str());</span>

<span style = "background-color:#fdd">  this-&gt;SetState(Setup);
  return returnValue;
}</span>


mitk::ClaronInterface* mitk::ClaronTrackingDevice::GetDevice()
<span style = "background-color:#fdd">{
  return m_Device;
}</span>


std::vector&lt;mitk::ClaronTool::Pointer&gt; mitk::ClaronTrackingDevice::GetAllTools()
<span style = "background-color:#fdd">{
  return this-&gt;m_AllTools;
}</span>


void mitk::ClaronTrackingDevice::TrackTools()
<span style = "background-color:#fdd">{</span>
  try
  {
    /* lock the TrackingFinishedMutex to signal that the execution rights are now transfered to the tracking thread */
<span style = "background-color:#fdd">    std::lock_guard&lt;std::mutex&gt; trackingFinishedLockHolder(m_TrackingFinishedMutex); // keep lock until end of scope</span>

    bool localStopTracking;       // Because m_StopTracking is used by two threads, access has to be guarded by a mutex. To minimize thread locking, a local copy is used here
<span style = "background-color:#fdd">    this-&gt;m_StopTrackingMutex.lock();  // update the local copy of m_StopTracking
    localStopTracking = this-&gt;m_StopTracking;
    this-&gt;m_StopTrackingMutex.unlock();</span>

<span style = "background-color:#fdd">    while ((this-&gt;GetState() == Tracking) &amp;&amp; (localStopTracking == false))</span>
    {
<span style = "background-color:#fdd">      this-&gt;GetDevice()-&gt;GrabFrame();</span>

<span style = "background-color:#fdd">      std::vector&lt;mitk::ClaronTool::Pointer&gt; detectedTools = this-&gt;DetectTools();
      std::vector&lt;mitk::ClaronTool::Pointer&gt; allTools = this-&gt;GetAllTools();
      std::vector&lt;mitk::ClaronTool::Pointer&gt;::iterator itAllTools;
      for(itAllTools = allTools.begin(); itAllTools != allTools.end(); itAllTools++)</span>
      {
<span style = "background-color:#fdd">        mitk::ClaronTool::Pointer currentTool = *itAllTools;</span>
        //test if current tool was detected
<span style = "background-color:#fdd">        std::vector&lt;mitk::ClaronTool::Pointer&gt;::iterator itDetectedTools;
        bool foundTool = false;
        for(itDetectedTools = detectedTools.begin(); itDetectedTools != detectedTools.end(); itDetectedTools++)</span>
        {
<span style = "background-color:#fdd">          mitk::ClaronTool::Pointer aktuDet = *itDetectedTools;
          std::string tempString(currentTool-&gt;GetCalibrationName());
          if (tempString.compare(aktuDet-&gt;GetCalibrationName())==0)</span>
          {
<span style = "background-color:#fdd">            currentTool-&gt;SetToolHandle(aktuDet-&gt;GetToolHandle());
            foundTool = true;</span>
          }
<span style = "background-color:#fdd">        }
        if (!foundTool)</span>
        {
<span style = "background-color:#fdd">          currentTool-&gt;SetToolHandle(0);</span>
        }

<span style = "background-color:#fdd">        if (currentTool-&gt;GetToolHandle() != 0)</span>
        {
<span style = "background-color:#fdd">          currentTool-&gt;SetDataValid(true);</span>
          //get tip position of tool:
<span style = "background-color:#fdd">          std::vector&lt;double&gt; pos_vector = this-&gt;GetDevice()-&gt;GetTipPosition(currentTool-&gt;GetToolHandle());</span>
          //write tip position into tool:
<span style = "background-color:#fdd">          mitk::Point3D pos;
          pos[0] = pos_vector[0];
          pos[1] = pos_vector[1];
          pos[2] = pos_vector[2];
          currentTool-&gt;SetPosition(pos);</span>
          //get tip quaternion of tool
<span style = "background-color:#fdd">          std::vector&lt;double&gt; quat = this-&gt;GetDevice()-&gt;GetTipQuaternions(currentTool-&gt;GetToolHandle());</span>
          //write tip quaternion into tool
<span style = "background-color:#fdd">          mitk::Quaternion orientation(quat[1], quat[2], quat[3], quat[0]);
          currentTool-&gt;SetOrientation(orientation);</span>

          //TODO: read the timestamp data from the tracking device interface
<span style = "background-color:#fdd">          currentTool-&gt;SetIGTTimeStamp(mitk::IGTTimeStamp::GetInstance()-&gt;GetElapsed());
        }</span>
        else
        {
<span style = "background-color:#fdd">          mitk::Point3D origin;
          origin.Fill(0);
          currentTool-&gt;SetPosition(origin);
          currentTool-&gt;SetOrientation(mitk::Quaternion(0,0,0,0));
          currentTool-&gt;SetDataValid(false);</span>
        }
<span style = "background-color:#fdd">      }</span>
      /* Update the local copy of m_StopTracking */
<span style = "background-color:#fdd">      this-&gt;m_StopTrackingMutex.lock();
      localStopTracking = m_StopTracking;
      this-&gt;m_StopTrackingMutex.unlock();
    }
  }</span>
  catch(...)
<span style = "background-color:#fdd">  {
    this-&gt;StopTracking();
    mitkThrowException(mitk::IGTHardwareException) &lt;&lt; "Error while trying to track tools. Thread stopped.";
  }
}</span>


bool mitk::ClaronTrackingDevice::IsMicronTrackerInstalled()
<span style = "background-color:#fdd">{
  return this-&gt;m_Device-&gt;IsMicronTrackerInstalled();
}</span>


void mitk::ClaronTrackingDevice::ThreadStartTracking()
<span style = "background-color:#fdd">{
  this-&gt;TrackTools();
}</span></pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkImageGenerationHelper.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkImageGenerationHelper.h"
#include "mitkArbitraryTimeGeometry.h"
#include "mitkImageCast.h"


  typedef itk::Image&lt;double,3&gt; FrameITKImageType;
  typedef itk::Image&lt;double,4&gt; DynamicITKImageType;


  mitk::Image::Pointer mitk::ImageGenerationHelper::GenerateTestFrame(unsigned int timePointIndex)
<span style = "background-color:#fdd">  {
    FrameITKImageType::Pointer image = FrameITKImageType::New();</span>

    FrameITKImageType::IndexType start;
<span style = "background-color:#fdd">    start[0] =   0;  // first index on X
    start[1] =   0;  // first index on Y
    start[2] =   0;  // first index on Z</span>

    FrameITKImageType::SizeType  size;
<span style = "background-color:#fdd">    size[0]  = this-&gt;m_DimX;  // size along X
    size[1]  = this-&gt;m_DimY;  // size along Y
    size[2]  = this-&gt;m_DimZ;  // size along Z</span>

<span style = "background-color:#fdd">    FrameITKImageType::RegionType region;
    region.SetSize( size );
    region.SetIndex( start );</span>

<span style = "background-color:#fdd">    image-&gt;SetRegions( region );
    image-&gt;Allocate();</span>

<span style = "background-color:#fdd">    itk::ImageRegionIterator&lt;FrameITKImageType&gt; it = itk::ImageRegionIterator&lt;FrameITKImageType&gt;(image,image-&gt;GetLargestPossibleRegion());</span>

<span style = "background-color:#fdd">    while (!it.IsAtEnd())</span>
    {
<span style = "background-color:#fdd">      it.Set(this-&gt;m_Curve[timePointIndex]);
      ++it;
    }</span>

<span style = "background-color:#fdd">    mitk::Image::Pointer mitkImage = mitk::Image::New();
    mitkImage-&gt;InitializeByItk( image.GetPointer() );
    mitkImage-&gt;SetVolume( image-&gt;GetBufferPointer() );</span>

<span style = "background-color:#fdd">    return mitkImage;
  }</span>




  mitk::Image::Pointer mitk::ImageGenerationHelper::GenerateDynamicImageMITK()
<span style = "background-color:#fdd">  {</span>

<span style = "background-color:#fdd">    unsigned int timeSteps = this-&gt;m_Grid.GetSize();</span>

<span style = "background-color:#fdd">    if(this-&gt;m_Curve.GetSize() != this-&gt;m_Grid.GetSize())</span>
    {
<span style = "background-color:#fdd">        itkExceptionMacro("Error. TimeGrid and ConcentrationCurve do not have same size. No Image Generation possible!");</span>

    }
<span style = "background-color:#fdd">    if(this-&gt;m_DimX == 0 &amp;&amp; this-&gt;m_DimY == 0 &amp;&amp; this-&gt;m_DimZ == 0)</span>
    {
<span style = "background-color:#fdd">        itkExceptionMacro("Error. No Dimensions for Image Set!");</span>

    }
<span style = "background-color:#fdd">    if(this-&gt;m_Curve.GetSize() == 0 || this-&gt;m_Grid.GetSize() == 0)</span>
    {
<span style = "background-color:#fdd">        itkExceptionMacro("Error. No Curve/Grid set!");</span>

    }

<span style = "background-color:#fdd">    mitk::Image::Pointer tempImage = GenerateTestFrame(0);
    mitk::Image::Pointer dynamicImage = mitk::Image::New();</span>

<span style = "background-color:#fdd">    DynamicITKImageType::Pointer dynamicITKImage = DynamicITKImageType::New();
    DynamicITKImageType::RegionType dynamicITKRegion;</span>
    DynamicITKImageType::PointType dynamicITKOrigin;
    DynamicITKImageType::IndexType dynamicITKIndex;
    DynamicITKImageType::SpacingType dynamicITKSpacing;

<span style = "background-color:#fdd">    dynamicITKSpacing[0] = tempImage-&gt;GetGeometry()-&gt;GetSpacing()[0];
    dynamicITKSpacing[1] = tempImage-&gt;GetGeometry()-&gt;GetSpacing()[1];
    dynamicITKSpacing[2] = tempImage-&gt;GetGeometry()-&gt;GetSpacing()[2];
    dynamicITKSpacing[3] = 1.0;</span>

<span style = "background-color:#fdd">    dynamicITKIndex[0] = 0;  // The first pixel of the REGION
    dynamicITKIndex[1] = 0;
    dynamicITKIndex[2] = 0;
    dynamicITKIndex[3] = 0;</span>

<span style = "background-color:#fdd">    dynamicITKRegion.SetSize( 0,tempImage-&gt;GetDimension(0));
    dynamicITKRegion.SetSize( 1,tempImage-&gt;GetDimension(1));
    dynamicITKRegion.SetSize( 2,tempImage-&gt;GetDimension(2));
    dynamicITKRegion.SetSize( 3,timeSteps);</span>

<span style = "background-color:#fdd">    dynamicITKRegion.SetIndex( dynamicITKIndex );</span>

<span style = "background-color:#fdd">    dynamicITKOrigin[0]=tempImage-&gt;GetGeometry()-&gt;GetOrigin()[0];
    dynamicITKOrigin[1]=tempImage-&gt;GetGeometry()-&gt;GetOrigin()[1];
    dynamicITKOrigin[2]=tempImage-&gt;GetGeometry()-&gt;GetOrigin()[2];</span>

<span style = "background-color:#fdd">    dynamicITKImage-&gt;SetOrigin(dynamicITKOrigin);
    dynamicITKImage-&gt;SetSpacing(dynamicITKSpacing);
    dynamicITKImage-&gt;SetRegions( dynamicITKRegion);
    dynamicITKImage-&gt;Allocate();
    dynamicITKImage-&gt;FillBuffer(0); //not sure if this is necessary</span>

    // Convert
<span style = "background-color:#fdd">    mitk::CastToMitkImage(dynamicITKImage, dynamicImage);</span>

<span style = "background-color:#fdd">    ArbitraryTimeGeometry::Pointer timeGeometry = ArbitraryTimeGeometry::New();
    timeGeometry-&gt;ClearAllGeometries();</span>


<span style = "background-color:#fdd">    for (unsigned int i = 0; i&lt;timeSteps; ++i)</span>
    {
<span style = "background-color:#fdd">      mitk::Image::Pointer frameImage = GenerateTestFrame(i);
      mitk::ImageReadAccessor readAccess(frameImage, frameImage-&gt;GetVolumeData(0));
      dynamicImage-&gt;SetVolume(readAccess.GetData(),i);</span>

<span style = "background-color:#fdd">      timeGeometry-&gt;AppendNewTimeStepClone(frameImage-&gt;GetGeometry(),this-&gt;m_Grid(i),this-&gt;m_Grid(i+1));
    }</span>

<span style = "background-color:#fdd">    dynamicImage-&gt;SetTimeGeometry(timeGeometry);</span>

<span style = "background-color:#fdd">    return dynamicImage;
  }</span>

</pre>
	</body>
</html>
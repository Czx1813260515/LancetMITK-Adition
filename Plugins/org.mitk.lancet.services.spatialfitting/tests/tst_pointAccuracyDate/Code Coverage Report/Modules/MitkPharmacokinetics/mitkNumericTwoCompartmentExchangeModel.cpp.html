<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkNumericTwoCompartmentExchangeModel.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkNumericTwoCompartmentExchangeModel.h"
#include "mitkAIFParametrizerHelper.h"
#include "mitkTimeGridHelper.h"
#include "mitkTwoCompartmentExchangeModelDifferentialEquations.h"
#include &lt;vnl/algo/vnl_fft_1d.h&gt;
#include &lt;boost/numeric/odeint.hpp&gt;
#include &lt;fstream&gt;

<span style = "background-color:#dfd">const std::string mitk::NumericTwoCompartmentExchangeModel::MODEL_DISPLAY_NAME =
  "Numeric Two Compartment Exchange Model";</span>

<span style = "background-color:#dfd">const std::string mitk::NumericTwoCompartmentExchangeModel::NAME_PARAMETER_F = "F";
const std::string mitk::NumericTwoCompartmentExchangeModel::NAME_PARAMETER_PS = "PS";
const std::string mitk::NumericTwoCompartmentExchangeModel::NAME_PARAMETER_ve = "ve";
const std::string mitk::NumericTwoCompartmentExchangeModel::NAME_PARAMETER_vp = "vp";</span>

<span style = "background-color:#dfd">const std::string mitk::NumericTwoCompartmentExchangeModel::UNIT_PARAMETER_F = "ml/min/100ml";
const std::string mitk::NumericTwoCompartmentExchangeModel::UNIT_PARAMETER_PS = "ml/min/100ml";
const std::string mitk::NumericTwoCompartmentExchangeModel::UNIT_PARAMETER_ve = "ml/ml";
const std::string mitk::NumericTwoCompartmentExchangeModel::UNIT_PARAMETER_vp = "ml/ml";</span>

const unsigned int mitk::NumericTwoCompartmentExchangeModel::POSITION_PARAMETER_F = 0;
const unsigned int mitk::NumericTwoCompartmentExchangeModel::POSITION_PARAMETER_PS = 1;
const unsigned int mitk::NumericTwoCompartmentExchangeModel::POSITION_PARAMETER_ve = 2;
const unsigned int mitk::NumericTwoCompartmentExchangeModel::POSITION_PARAMETER_vp = 3;

const unsigned int mitk::NumericTwoCompartmentExchangeModel::NUMBER_OF_PARAMETERS = 4;

<span style = "background-color:#dfd">const std::string mitk::NumericTwoCompartmentExchangeModel::NAME_STATIC_PARAMETER_ODEINTStepSize = "ODEIntStepSize";</span>


std::string mitk::NumericTwoCompartmentExchangeModel::GetModelDisplayName() const
<span style = "background-color:#fdd">{
  return MODEL_DISPLAY_NAME;
};</span>

std::string mitk::NumericTwoCompartmentExchangeModel::GetModelType() const
<span style = "background-color:#dfd">{
  return "Perfusion.MR";
};</span>


mitk::NumericTwoCompartmentExchangeModel::NumericTwoCompartmentExchangeModel()
<span style = "background-color:#dfd">{</span>

<span style = "background-color:#dfd">}</span>

mitk::NumericTwoCompartmentExchangeModel::~NumericTwoCompartmentExchangeModel()
<span style = "background-color:#dfd">{</span>

<span style = "background-color:#dfd">}</span>

mitk::NumericTwoCompartmentExchangeModel::ParameterNamesType mitk::NumericTwoCompartmentExchangeModel::GetStaticParameterNames() const
<span style = "background-color:#fdd">{
  ParameterNamesType result;</span>

<span style = "background-color:#fdd">  result.push_back(NAME_STATIC_PARAMETER_AIF);
  result.push_back(NAME_STATIC_PARAMETER_AIFTimeGrid);
  result.push_back(NAME_STATIC_PARAMETER_ODEINTStepSize);</span>

<span style = "background-color:#fdd">  return result;
}</span>

mitk::NumericTwoCompartmentExchangeModel::ParametersSizeType  mitk::NumericTwoCompartmentExchangeModel::GetNumberOfStaticParameters()
const
<span style = "background-color:#fdd">{
  return 3;
}</span>


void mitk::NumericTwoCompartmentExchangeModel::SetStaticParameter(const ParameterNameType&amp; name,
    const StaticParameterValuesType&amp; values)
<span style = "background-color:#fdd">{
  if (name == NAME_STATIC_PARAMETER_AIF)</span>
  {
<span style = "background-color:#fdd">    AterialInputFunctionType aif = mitk::convertParameterToArray(values);</span>

<span style = "background-color:#fdd">    SetAterialInputFunctionValues(aif);
  }</span>

<span style = "background-color:#fdd">  if (name == NAME_STATIC_PARAMETER_AIFTimeGrid)</span>
  {
<span style = "background-color:#fdd">    TimeGridType timegrid = mitk::convertParameterToArray(values);</span>

<span style = "background-color:#fdd">    SetAterialInputFunctionTimeGrid(timegrid);
  }</span>

<span style = "background-color:#fdd">  if (name == NAME_STATIC_PARAMETER_ODEINTStepSize)</span>
  {
<span style = "background-color:#fdd">      SetODEINTStepSize(values[0]);</span>
  }
<span style = "background-color:#fdd">};</span>

mitk::NumericTwoCompartmentExchangeModel::StaticParameterValuesType mitk::NumericTwoCompartmentExchangeModel::GetStaticParameterValue(
  const ParameterNameType&amp; name) const
<span style = "background-color:#fdd">{
  StaticParameterValuesType result;</span>

<span style = "background-color:#fdd">  if (name == NAME_STATIC_PARAMETER_AIF)</span>
  {
<span style = "background-color:#fdd">    result = mitk::convertArrayToParameter(this-&gt;m_AterialInputFunctionValues);</span>
  }

<span style = "background-color:#fdd">  if (name == NAME_STATIC_PARAMETER_AIFTimeGrid)</span>
  {
<span style = "background-color:#fdd">    result = mitk::convertArrayToParameter(this-&gt;m_AterialInputFunctionTimeGrid);</span>
  }
<span style = "background-color:#fdd">  if (name == NAME_STATIC_PARAMETER_ODEINTStepSize)</span>
  {
<span style = "background-color:#fdd">    result.push_back(GetODEINTStepSize());</span>
  }

<span style = "background-color:#fdd">  return result;
};</span>


mitk::NumericTwoCompartmentExchangeModel::ParameterNamesType
mitk::NumericTwoCompartmentExchangeModel::GetParameterNames() const
<span style = "background-color:#fdd">{
  ParameterNamesType result;</span>

<span style = "background-color:#fdd">  result.push_back(NAME_PARAMETER_F);
  result.push_back(NAME_PARAMETER_PS);
  result.push_back(NAME_PARAMETER_ve);
  result.push_back(NAME_PARAMETER_vp);</span>

<span style = "background-color:#fdd">  return result;
}</span>

mitk::NumericTwoCompartmentExchangeModel::ParametersSizeType
mitk::NumericTwoCompartmentExchangeModel::GetNumberOfParameters() const
<span style = "background-color:#fdd">{
  return NUMBER_OF_PARAMETERS;
}</span>


mitk::NumericTwoCompartmentExchangeModel::ParamterUnitMapType
mitk::NumericTwoCompartmentExchangeModel::GetParameterUnits() const
<span style = "background-color:#fdd">{
  ParamterUnitMapType result;</span>

<span style = "background-color:#fdd">  result.insert(std::make_pair(NAME_PARAMETER_F, UNIT_PARAMETER_F));
  result.insert(std::make_pair(NAME_PARAMETER_PS, UNIT_PARAMETER_PS));
  result.insert(std::make_pair(NAME_PARAMETER_vp, UNIT_PARAMETER_vp));
  result.insert(std::make_pair(NAME_PARAMETER_ve, UNIT_PARAMETER_ve));</span>

<span style = "background-color:#fdd">  return result;
};</span>

mitk::NumericTwoCompartmentExchangeModel::ModelResultType
mitk::NumericTwoCompartmentExchangeModel::ComputeModelfunction(const ParametersType&amp; parameters)
const
<span style = "background-color:#fdd">{</span>
  typedef itk::Array&lt;double&gt; ConcentrationCurveType;
  typedef std::vector&lt;double&gt; ConcentrationVectorType;

<span style = "background-color:#fdd">  if (this-&gt;m_TimeGrid.GetSize() == 0)</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro("No Time Grid Set! Cannot Calculate Signal");</span>
  }

<span style = "background-color:#fdd">  AterialInputFunctionType aterialInputFunction;
  aterialInputFunction = GetAterialInputFunction(this-&gt;m_TimeGrid);</span>

<span style = "background-color:#fdd">  unsigned int timeSteps = this-&gt;m_TimeGrid.GetSize();</span>

  /** @brief Boost::numeric::odeint works with type std::vector&lt;double&gt; thus, aif and grid are converted to ModelParameters( of type std::vector)
   */
<span style = "background-color:#fdd">  mitk::TwoCompartmentExchangeModelDifferentialEquations::AIFType aif = mitk::convertArrayToParameter(</span>
        aterialInputFunction);
<span style = "background-color:#fdd">  mitk::TwoCompartmentExchangeModelDifferentialEquations::AIFType grid =</span>
    mitk::convertArrayToParameter(m_TimeGrid);

<span style = "background-color:#fdd">  mitk::TwoCompartmentExchangeModelDifferentialEquations::AIFType aifODE = aif;
  aifODE.push_back(aif[timeSteps - 1]);
  mitk::TwoCompartmentExchangeModelDifferentialEquations::AIFType gridODE = grid;
  gridODE.push_back(grid[timeSteps - 1] + (grid[timeSteps - 1] - grid[timeSteps - 2]));</span>



  //Model Parameters
<span style = "background-color:#fdd">  double F = (double) parameters[POSITION_PARAMETER_F] / 6000.0;
  double PS  = (double) parameters[POSITION_PARAMETER_PS] / 6000.0;
  double ve = (double) parameters[POSITION_PARAMETER_ve];
  double vp = (double) parameters[POSITION_PARAMETER_vp];</span>


  /** @brief Initialize class TwoCompartmentExchangeModelDifferentialEquations defining the differential equations. AIF and Grid must be set so that at step t the aterial Concentration Ca(t) can be interpolated from AIF*/
<span style = "background-color:#fdd">  mitk::TwoCompartmentExchangeModelDifferentialEquations ode;
  ode.initialize(F, PS, ve, vp);
  ode.setAIF(aifODE);
  ode.setAIFTimeGrid(gridODE);</span>

<span style = "background-color:#fdd">  state_type x(2);
  x[0] = 0.0;
  x[1] = 0.0;</span>
  typedef boost::numeric::odeint::runge_kutta_cash_karp54&lt;state_type&gt; error_stepper_type;
  //typedef boost::numeric::odeint::runge_kutta4&lt; state_type &gt; stepper_type;

  /** @brief Results of odeeint x[0] and x[1]*/
<span style = "background-color:#fdd">  ConcentrationVectorType Cp;
  ConcentrationVectorType Ce;
  ConcentrationVectorType odeTimeGrid;</span>

<span style = "background-color:#fdd">  error_stepper_type stepper;</span>


  /** @brief Stepsize. Should be adapted by stepper (runge_kutta_cash_karp54) */
//  const double dt = 0.05;
<span style = "background-color:#fdd">   const double dt = this-&gt;m_ODEINTStepSize;</span>


  /** @brief perform Step t -&gt; t+dt to calculate approximate value x(t+dt)*/
<span style = "background-color:#fdd">  for (double t = 0.0; t &lt; this-&gt;m_TimeGrid(this-&gt;m_TimeGrid.GetSize() - 1) - 2*dt; t += dt)</span>
  {
<span style = "background-color:#fdd">    stepper.do_step(ode, x, t, dt);
    Cp.push_back(x[0]);
    Ce.push_back(x[1]);
    odeTimeGrid.push_back(t);
  }</span>

  /** @brief transfom result of Differential equations back to itk::Array and interpolate to m_TimeGrid (they are calculated on a different grid defined by stepsize of odeint)*/
<span style = "background-color:#fdd">  ConcentrationCurveType plasmaConcentration = mitk::convertParameterToArray(Cp);
  ConcentrationCurveType EESConcentration = mitk::convertParameterToArray(Ce);
  ConcentrationCurveType rungeKuttaTimeGrid = mitk::convertParameterToArray(odeTimeGrid);</span>

<span style = "background-color:#fdd">  mitk::ModelBase::ModelResultType C_Plasma = mitk::InterpolateSignalToNewTimeGrid(plasmaConcentration, rungeKuttaTimeGrid, m_TimeGrid);
  mitk::ModelBase::ModelResultType C_EES = mitk::InterpolateSignalToNewTimeGrid(EESConcentration, rungeKuttaTimeGrid, m_TimeGrid);</span>


  //Signal that will be returned by ComputeModelFunction
<span style = "background-color:#fdd">  mitk::ModelBase::ModelResultType signal(timeSteps);
  signal.fill(0.0);</span>

<span style = "background-color:#fdd">  mitk::ModelBase::ModelResultType::iterator signalPos = signal.begin();
  mitk::ModelBase::ModelResultType::const_iterator CePos = C_EES.begin();</span>

<span style = "background-color:#fdd">  mitk::ModelBase::ModelResultType::const_iterator t = this-&gt;m_TimeGrid.begin();
  mitk::ModelBase::ModelResultType::const_iterator Cin = aterialInputFunction.begin();</span>



<span style = "background-color:#fdd">  for (mitk::ModelBase::ModelResultType::const_iterator CpPos = C_Plasma.begin();
       CpPos != C_Plasma.end(); ++CpPos, ++CePos, ++signalPos, ++t, ++Cin)</span>
  {
<span style = "background-color:#fdd">    *signalPos = vp * (*CpPos) + ve * (*CePos);</span>

<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  return signal;</span>

<span style = "background-color:#fdd">}</span>




itk::LightObject::Pointer mitk::NumericTwoCompartmentExchangeModel::InternalClone() const
<span style = "background-color:#fdd">{
  NumericTwoCompartmentExchangeModel::Pointer newClone = NumericTwoCompartmentExchangeModel::New();</span>

<span style = "background-color:#fdd">  newClone-&gt;SetTimeGrid(this-&gt;m_TimeGrid);</span>

<span style = "background-color:#fdd">  return newClone.GetPointer();
}</span>

void mitk::NumericTwoCompartmentExchangeModel::PrintSelf(std::ostream&amp; os,
    ::itk::Indent indent) const
<span style = "background-color:#fdd">{
  Superclass::PrintSelf(os, indent);</span>


<span style = "background-color:#fdd">}</span>

</pre>
	</body>
</html>
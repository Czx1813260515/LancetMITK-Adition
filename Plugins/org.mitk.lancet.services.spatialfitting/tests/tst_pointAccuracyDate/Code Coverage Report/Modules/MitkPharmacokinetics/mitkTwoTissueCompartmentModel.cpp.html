<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkTwoTissueCompartmentModel.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkTwoTissueCompartmentModel.h"
#include "mitkConvolutionHelper.h"
#include &lt;fstream&gt;
<span style = "background-color:#dfd">const std::string mitk::TwoTissueCompartmentModel::MODEL_DISPLAY_NAME = "Two Tissue Compartment Model";</span>

<span style = "background-color:#dfd">const std::string mitk::TwoTissueCompartmentModel::NAME_PARAMETER_K1 = "K1";
const std::string mitk::TwoTissueCompartmentModel::NAME_PARAMETER_k2 = "k2";
const std::string mitk::TwoTissueCompartmentModel::NAME_PARAMETER_k3 = "k3";
const std::string mitk::TwoTissueCompartmentModel::NAME_PARAMETER_k4 = "k4";
const std::string mitk::TwoTissueCompartmentModel::NAME_PARAMETER_VB = "V_B";</span>

<span style = "background-color:#dfd">const std::string mitk::TwoTissueCompartmentModel::UNIT_PARAMETER_K1 = "1/min";
const std::string mitk::TwoTissueCompartmentModel::UNIT_PARAMETER_k2 = "1/min";
const std::string mitk::TwoTissueCompartmentModel::UNIT_PARAMETER_k3 = "1/min";
const std::string mitk::TwoTissueCompartmentModel::UNIT_PARAMETER_k4 = "1/min";
const std::string mitk::TwoTissueCompartmentModel::UNIT_PARAMETER_VB = "ml/ml";</span>

const unsigned int mitk::TwoTissueCompartmentModel::POSITION_PARAMETER_K1 = 0;
const unsigned int mitk::TwoTissueCompartmentModel::POSITION_PARAMETER_k2 = 1;
const unsigned int mitk::TwoTissueCompartmentModel::POSITION_PARAMETER_k3 = 2;
const unsigned int mitk::TwoTissueCompartmentModel::POSITION_PARAMETER_k4 = 3;
const unsigned int mitk::TwoTissueCompartmentModel::POSITION_PARAMETER_VB = 4;

const unsigned int mitk::TwoTissueCompartmentModel::NUMBER_OF_PARAMETERS = 5;


inline double square(double a)
<span style = "background-color:#fdd">{
  return a * a;
}</span>

std::string mitk::TwoTissueCompartmentModel::GetModelDisplayName() const
<span style = "background-color:#fdd">{
  return MODEL_DISPLAY_NAME;
};</span>

std::string mitk::TwoTissueCompartmentModel::GetModelType() const
<span style = "background-color:#dfd">{
  return "Dynamic.PET";
};</span>

mitk::TwoTissueCompartmentModel::TwoTissueCompartmentModel()
<span style = "background-color:#dfd">{</span>

<span style = "background-color:#dfd">}</span>

mitk::TwoTissueCompartmentModel::~TwoTissueCompartmentModel()
<span style = "background-color:#dfd">{</span>

<span style = "background-color:#dfd">}</span>

mitk::TwoTissueCompartmentModel::ParameterNamesType
mitk::TwoTissueCompartmentModel::GetParameterNames() const
<span style = "background-color:#fdd">{
  ParameterNamesType result;</span>

<span style = "background-color:#fdd">  result.push_back(NAME_PARAMETER_K1);
  result.push_back(NAME_PARAMETER_k2);
  result.push_back(NAME_PARAMETER_k3);
  result.push_back(NAME_PARAMETER_k4);
  result.push_back(NAME_PARAMETER_VB);</span>

<span style = "background-color:#fdd">  return result;
}</span>

mitk::TwoTissueCompartmentModel::ParametersSizeType
mitk::TwoTissueCompartmentModel::GetNumberOfParameters() const
<span style = "background-color:#fdd">{
  return NUMBER_OF_PARAMETERS;
}</span>

mitk::TwoTissueCompartmentModel::ParamterUnitMapType
mitk::TwoTissueCompartmentModel::GetParameterUnits() const
<span style = "background-color:#fdd">{
  ParamterUnitMapType result;</span>

<span style = "background-color:#fdd">  result.insert(std::make_pair(NAME_PARAMETER_K1, UNIT_PARAMETER_K1));
  result.insert(std::make_pair(NAME_PARAMETER_k2, UNIT_PARAMETER_k2));
  result.insert(std::make_pair(NAME_PARAMETER_k3, UNIT_PARAMETER_k3));
  result.insert(std::make_pair(NAME_PARAMETER_k4, UNIT_PARAMETER_k4));
  result.insert(std::make_pair(NAME_PARAMETER_VB, UNIT_PARAMETER_VB));</span>

<span style = "background-color:#fdd">  return result;
};</span>

mitk::TwoTissueCompartmentModel::ModelResultType
mitk::TwoTissueCompartmentModel::ComputeModelfunction(const ParametersType&amp; parameters) const
<span style = "background-color:#fdd">{
  if (this-&gt;m_TimeGrid.GetSize() == 0)</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro("No Time Grid Set! Cannot Calculate Signal");</span>
  }

<span style = "background-color:#fdd">  AterialInputFunctionType aterialInputFunction;
  aterialInputFunction = GetAterialInputFunction(this-&gt;m_TimeGrid);</span>


<span style = "background-color:#fdd">  unsigned int timeSteps = this-&gt;m_TimeGrid.GetSize();</span>

  //Model Parameters
<span style = "background-color:#fdd">  double k1 = (double)parameters[POSITION_PARAMETER_K1] / 60.0;
  double k2 = (double)parameters[POSITION_PARAMETER_k2] / 60.0;
  double k3 = (double)parameters[POSITION_PARAMETER_k3] / 60.0;
  double k4 = (double)parameters[POSITION_PARAMETER_k4] / 60.0;
  double VB = parameters[POSITION_PARAMETER_VB];</span>



<span style = "background-color:#fdd">  double alpha1 = 0.5 * ((k2 + k3 + k4) - sqrt(square(k2 + k3 + k4) - 4 * k2 * k4));
  double alpha2 = 0.5 * ((k2 + k3 + k4) + sqrt(square(k2 + k3 + k4) - 4 * k2 * k4));</span>

  //double lambda1 = -alpha1;
  //double lambda2 = -alpha2;
<span style = "background-color:#fdd">  mitk::ModelBase::ModelResultType exp1 = mitk::convoluteAIFWithExponential(this-&gt;m_TimeGrid,</span>
                                          aterialInputFunction, alpha1);
<span style = "background-color:#fdd">  mitk::ModelBase::ModelResultType exp2 = mitk::convoluteAIFWithExponential(this-&gt;m_TimeGrid,</span>
                                          aterialInputFunction, alpha2);


  //Signal that will be returned by ComputeModelFunction
<span style = "background-color:#fdd">  mitk::ModelBase::ModelResultType signal(timeSteps);
  signal.fill(0.0);</span>

<span style = "background-color:#fdd">  mitk::ModelBase::ModelResultType::const_iterator exp1Pos = exp1.begin();
  mitk::ModelBase::ModelResultType::const_iterator exp2Pos = exp2.begin();
  AterialInputFunctionType::const_iterator aifPos = aterialInputFunction.begin();</span>

<span style = "background-color:#fdd">  for (mitk::ModelBase::ModelResultType::iterator signalPos = signal.begin();
       signalPos != signal.end(); ++exp1Pos, ++exp2Pos, ++signalPos, ++aifPos)</span>
  {
<span style = "background-color:#fdd">    double Ci = k1 / (alpha2 - alpha1) * ((k4 - alpha1 + k3) * (*exp1Pos) + (alpha2 - k4 - k3) *</span>
                                          (*exp2Pos));
<span style = "background-color:#fdd">    *signalPos = VB * (*aifPos) + (1 - VB) * Ci;
  }</span>

<span style = "background-color:#fdd">  return signal;</span>

<span style = "background-color:#fdd">}</span>




itk::LightObject::Pointer mitk::TwoTissueCompartmentModel::InternalClone() const
<span style = "background-color:#fdd">{
  TwoTissueCompartmentModel::Pointer newClone = TwoTissueCompartmentModel::New();</span>

<span style = "background-color:#fdd">  newClone-&gt;SetTimeGrid(this-&gt;m_TimeGrid);</span>

<span style = "background-color:#fdd">  return newClone.GetPointer();
}</span>

void mitk::TwoTissueCompartmentModel::PrintSelf(std::ostream&amp; os, ::itk::Indent indent) const
<span style = "background-color:#fdd">{
  Superclass::PrintSelf(os, indent);</span>


<span style = "background-color:#fdd">}</span>


</pre>
	</body>
</html>
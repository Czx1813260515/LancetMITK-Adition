<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkIGTLMessageFactory.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkIGTLMessageFactory.h"

// IGT message types
#include "igtlImageMessage.h"
#include "igtlTransformMessage.h"
#include "igtlPositionMessage.h"
#include "igtlStatusMessage.h"
#include "igtlImageMetaMessage.h"
#include "igtlPointMessage.h"
#include "igtlTrajectoryMessage.h"
#include "igtlStringMessage.h"
#include "igtlSensorMessage.h"
#include "igtlBindMessage.h"
#include "igtlPolyDataMessage.h"
#include "igtlQuaternionTrackingDataMessage.h"
#include "igtlCapabilityMessage.h"
#include "igtlNDArrayMessage.h"
#include "igtlTrackingDataMessage.h"
#include "igtlColorTableMessage.h"
#include "igtlLabelMetaMessage.h"

//own types
#include "mitkIGTLDummyMessage.h"

#include "mitkIGTLMessageCommon.h"

#include "itksys/SystemTools.hxx"

//------------------------------------------------------------
// Define message clone classes
// igtlMessageHandlerClassMacro() defines a child class of
// igtl::MessageHandler to handle OpenIGTLink messages for
// the message type specified as the first argument. The
// second argument will be used for the name of this
// message handler class, while the third argument specifies
// a type of data that will be shared with the message functions
// of this handler class.

mitkIGTMessageCloneClassMacro(igtl::TransformMessage, TransformMsgCloneHandler)

/**
 * \brief Clones the original message interpreted as transform message
 * \param original_ The original message that will be interpreted as transform
 * message
 * \return The clone of the input message
 */
igtl::MessageBase::Pointer TransformMsgCloneHandler::Clone(igtl::MessageBase* original_)
<span style = "background-color:#fdd">{
  bool copySuccess = false;
  igtl::TransformMessage::Pointer clone_ = igtl::TransformMessage::New();</span>

  //initialize the clone
  //  clone = igtl::MessageBase::New();

<span style = "background-color:#fdd">  igtl::TransformMessage* original = (igtl::TransformMessage*)original_;</span>

  //copy all meta data
<span style = "background-color:#fdd">  copySuccess = clone_-&gt;Copy(original);</span>

<span style = "background-color:#fdd">  if (!copySuccess)
    return nullptr;</span>

  //copy all data that is important for this class
  //copy the matrix
  igtl::Matrix4x4 mat;
<span style = "background-color:#fdd">  original-&gt;GetMatrix(mat);
  clone_-&gt;SetMatrix(mat);</span>

  //copy the normals
  float normals[3][3];
<span style = "background-color:#fdd">  original-&gt;GetNormals(normals);
  clone_-&gt;SetNormals(normals);</span>

  //copy the position
  float position[3];
<span style = "background-color:#fdd">  original-&gt;GetPosition(position);
  clone_-&gt;SetPosition(position);</span>

<span style = "background-color:#fdd">  return igtl::MessageBase::Pointer(clone_.GetPointer());
}</span>

mitk::IGTLMessageFactory::IGTLMessageFactory()
<span style = "background-color:#fdd">{</span>
  //create clone handlers
  //  mitk::IGTLMessageCloneHandler::Pointer tmch = ;

<span style = "background-color:#fdd">  this-&gt;AddMessageNewMethod("NONE", nullptr);</span>

  // OpenIGTLink Types V1
<span style = "background-color:#fdd">  this-&gt;AddMessageNewMethod("IMAGE", (PointerToMessageBaseNew)&amp;igtl::ImageMessage::New);
  this-&gt;AddMessageNewMethod("TRANSFORM", (PointerToMessageBaseNew)&amp;igtl::TransformMessage::New);
  this-&gt;AddMessageNewMethod("POSITION", (PointerToMessageBaseNew)&amp;igtl::PositionMessage::New);
  this-&gt;AddMessageNewMethod("STATUS", (PointerToMessageBaseNew)&amp;igtl::StatusMessage::New);
  this-&gt;AddMessageNewMethod("CAPABILITY", (PointerToMessageBaseNew)&amp;igtl::CapabilityMessage::New);</span>

<span style = "background-color:#fdd">  this-&gt;AddMessageNewMethod("GET_IMAGE", (PointerToMessageBaseNew)&amp;igtl::GetImageMessage::New);
  this-&gt;AddMessageNewMethod("GET_TRANS", (PointerToMessageBaseNew)&amp;igtl::GetTransformMessage::New);</span>
  //this-&gt;AddMessageNewMethod("GET_POS", (PointerToMessageBaseNew)&amp;igtl::GetPositionMessage::New); //not available???
<span style = "background-color:#fdd">  this-&gt;AddMessageNewMethod("GET_STATUS", (PointerToMessageBaseNew)&amp;igtl::GetStatusMessage::New);</span>

  // OpenIGTLink Types V2
<span style = "background-color:#fdd">  this-&gt;AddMessageNewMethod("IMGMETA", (PointerToMessageBaseNew)&amp;igtl::ImageMetaMessage::New);
  this-&gt;AddMessageNewMethod("LBMETA", (PointerToMessageBaseNew)&amp;igtl::LabelMetaMessage::New);
  this-&gt;AddMessageNewMethod("COLORT", (PointerToMessageBaseNew)&amp;igtl::ColorTableMessage::New);
  this-&gt;AddMessageNewMethod("POINT", (PointerToMessageBaseNew)&amp;igtl::PointMessage::New);
  this-&gt;AddMessageNewMethod("TRAJ", (PointerToMessageBaseNew)&amp;igtl::TrajectoryMessage::New);
  this-&gt;AddMessageNewMethod("TDATA", (PointerToMessageBaseNew)&amp;igtl::TrackingDataMessage::New);
  this-&gt;AddMessageNewMethod("QTDATA", (PointerToMessageBaseNew)&amp;igtl::QuaternionTrackingDataMessage::New);
  this-&gt;AddMessageNewMethod("SENSOR", (PointerToMessageBaseNew)&amp;igtl::SensorMessage::New);
  this-&gt;AddMessageNewMethod("STRING", (PointerToMessageBaseNew)&amp;igtl::StringMessage::New);
  this-&gt;AddMessageNewMethod("NDARRAY", (PointerToMessageBaseNew)&amp;igtl::NDArrayMessage::New);
  this-&gt;AddMessageNewMethod("BIND", (PointerToMessageBaseNew)&amp;igtl::BindMessage::New);
  this-&gt;AddMessageNewMethod("POLYDATA", (PointerToMessageBaseNew)&amp;igtl::PolyDataMessage::New);</span>

<span style = "background-color:#fdd">  this-&gt;AddMessageNewMethod("GET_IMGMETA", (PointerToMessageBaseNew)&amp;igtl::GetImageMetaMessage::New);
  this-&gt;AddMessageNewMethod("GET_LBMETA", (PointerToMessageBaseNew)&amp;igtl::GetLabelMetaMessage::New);
  this-&gt;AddMessageNewMethod("GET_COLORT", (PointerToMessageBaseNew)&amp;igtl::GetColorTableMessage::New);
  this-&gt;AddMessageNewMethod("GET_POINT", (PointerToMessageBaseNew)&amp;igtl::GetPointMessage::New);
  this-&gt;AddMessageNewMethod("GET_TRAJ", (PointerToMessageBaseNew)&amp;igtl::GetTrajectoryMessage::New);</span>
  //  this-&gt;AddMessageNewMethod("GET_TDATA",      (PointerToMessageBaseNew)&amp;igtl::GetTrackingDataMessage::New); //not available???
  //  this-&gt;AddMessageNewMethod("GET_QTDATA",     (PointerToMessageBaseNew)&amp;igtl::GetQuaternionTrackingDataMessage::New); //not available???
  //  this-&gt;AddMessageNewMethod("GET_SENSOR",     (PointerToMessageBaseNew)&amp;igtl::GetSensorMessage::New); //not available???
  //  this-&gt;AddMessageNewMethod("GET_STRING",     (PointerToMessageBaseNew)&amp;igtl::GetStringMessage::New); //not available???
  //  this-&gt;AddMessageNewMethod("GET_NDARRAY",    (PointerToMessageBaseNew)&amp;igtl::GetNDArrayMessage::New); //not available???
<span style = "background-color:#fdd">  this-&gt;AddMessageNewMethod("GET_BIND", (PointerToMessageBaseNew)&amp;igtl::GetBindMessage::New);
  this-&gt;AddMessageNewMethod("GET_POLYDATA", (PointerToMessageBaseNew)&amp;igtl::GetPolyDataMessage::New);</span>

<span style = "background-color:#fdd">  this-&gt;AddMessageNewMethod("RTS_BIND", (PointerToMessageBaseNew)&amp;igtl::RTSBindMessage::New);
  this-&gt;AddMessageNewMethod("RTS_QTDATA", (PointerToMessageBaseNew)&amp;igtl::RTSQuaternionTrackingDataMessage::New);
  this-&gt;AddMessageNewMethod("RTS_TDATA", (PointerToMessageBaseNew)&amp;igtl::RTSTrackingDataMessage::New);</span>
  //todo: check if there are more RTS messages

<span style = "background-color:#fdd">  this-&gt;AddMessageNewMethod("STT_BIND", (PointerToMessageBaseNew)&amp;igtl::StartBindMessage::New);
  this-&gt;AddMessageNewMethod("STT_TDATA", (PointerToMessageBaseNew)&amp;igtl::StartTrackingDataMessage::New);
  this-&gt;AddMessageNewMethod("STT_QTDATA", (PointerToMessageBaseNew)&amp;igtl::StartQuaternionTrackingDataMessage::New);</span>
  //todo: check if there are more STT messages

<span style = "background-color:#fdd">  this-&gt;AddMessageNewMethod("STP_BIND", (PointerToMessageBaseNew)&amp;igtl::StopBindMessage::New);
  this-&gt;AddMessageNewMethod("STP_TDATA", (PointerToMessageBaseNew)&amp;igtl::StopTrackingDataMessage::New);
  this-&gt;AddMessageNewMethod("STP_QTDATA", (PointerToMessageBaseNew)&amp;igtl::StopQuaternionTrackingDataMessage::New);</span>
  //todo: check if there are more STP messages

  //Own Types
<span style = "background-color:#fdd">  this-&gt;AddMessageNewMethod("DUMMY", (PointerToMessageBaseNew)&amp;mitk::IGTLDummyMessage::New);
}</span>

mitk::IGTLMessageFactory::~IGTLMessageFactory()
<span style = "background-color:#fdd">{
}</span>

void mitk::IGTLMessageFactory::AddMessageType(std::string messageTypeName,
  IGTLMessageFactory::PointerToMessageBaseNew messageTypeNewPointer,
  mitk::IGTLMessageCloneHandler::Pointer cloneHandler)
<span style = "background-color:#fdd">{
  this-&gt;AddMessageNewMethod(messageTypeName, messageTypeNewPointer);
  this-&gt;AddMessageCloneHandler(messageTypeName, cloneHandler);
}</span>

void mitk::IGTLMessageFactory::AddMessageNewMethod(std::string messageTypeName,
  IGTLMessageFactory::PointerToMessageBaseNew messageTypeNewPointer)
<span style = "background-color:#fdd">{
  this-&gt;m_NewMethods[messageTypeName] = messageTypeNewPointer;
}</span>

void mitk::IGTLMessageFactory::AddMessageCloneHandler(std::string msgTypeName,
  mitk::IGTLMessageCloneHandler::Pointer cloneHandler)
<span style = "background-color:#fdd">{
  this-&gt;m_CloneHandlers[msgTypeName] = cloneHandler;
}</span>

mitk::IGTLMessageCloneHandler::Pointer
mitk::IGTLMessageFactory::GetCloneHandler(std::string messageTypeName)
<span style = "background-color:#fdd">{
  if (this-&gt;m_CloneHandlers.find(messageTypeName) !=</span>
    this-&gt;m_CloneHandlers.end())
  {
<span style = "background-color:#fdd">    return m_CloneHandlers[messageTypeName];</span>
  }

<span style = "background-color:#fdd">  MITK_ERROR("IGTLMessageFactory") &lt;&lt; messageTypeName &lt;&lt;</span>
    " message type is not registered to factory!";

<span style = "background-color:#fdd">  mitkThrow() &lt;&lt; messageTypeName &lt;&lt; " message type is not registered to factory!";</span>

<span style = "background-color:#fdd">  return nullptr;
}</span>

igtl::MessageBase::Pointer
mitk::IGTLMessageFactory::Clone(igtl::MessageBase::Pointer msg)
<span style = "background-color:#fdd">{
  return this-&gt;GetCloneHandler(msg-&gt;GetDeviceType())-&gt;Clone(msg);
}</span>

mitk::IGTLMessageFactory::PointerToMessageBaseNew
mitk::IGTLMessageFactory::GetMessageTypeNewPointer(std::string messageTypeName)
<span style = "background-color:#fdd">{
  if (this-&gt;m_NewMethods.find(messageTypeName) != this-&gt;m_NewMethods.end())</span>
  {
<span style = "background-color:#fdd">    return m_NewMethods[messageTypeName];</span>
  }

<span style = "background-color:#fdd">  MITK_ERROR("IGTLMessageFactory") &lt;&lt; messageTypeName &lt;&lt;</span>
    " message type is not registered to factory!";
<span style = "background-color:#fdd">  return nullptr;
}</span>

igtl::MessageBase::Pointer
mitk::IGTLMessageFactory::CreateInstance(std::string messageTypeName)
<span style = "background-color:#fdd">{
  mitk::IGTLMessageFactory::PointerToMessageBaseNew newPointer =</span>
    this-&gt;GetMessageTypeNewPointer(messageTypeName);
<span style = "background-color:#fdd">  if (newPointer != nullptr)</span>
  {
<span style = "background-color:#fdd">    return newPointer();
  }</span>
  else
  {
<span style = "background-color:#fdd">    return nullptr;</span>
  }
<span style = "background-color:#fdd">}</span>

std::list&lt;std::string&gt;
mitk::IGTLMessageFactory::GetAvailableMessageRequestTypes()
<span style = "background-color:#fdd">{
  std::list&lt;std::string&gt; allGetMessages;
  for (std::map&lt;std::string, PointerToMessageBaseNew&gt;::const_iterator it =</span>
    this-&gt;m_NewMethods.begin();
<span style = "background-color:#fdd">    it != this-&gt;m_NewMethods.end(); ++it)</span>
  {
    if (it-&gt;first.find("GET_") != std::string::npos ||
      it-&gt;first.find("STT_") != std::string::npos ||
<span style = "background-color:#fdd">      it-&gt;first.find("STP_") != std::string::npos ||</span>
      it-&gt;first.find("RTS_") != std::string::npos)
    {
<span style = "background-color:#fdd">      allGetMessages.push_back(it-&gt;first);
    }
  }</span>

<span style = "background-color:#fdd">  return allGetMessages;
}</span>

igtl::MessageBase::Pointer
mitk::IGTLMessageFactory::CreateInstance(igtl::MessageHeader::Pointer msgHeader)
<span style = "background-color:#fdd">{
  std::string messageType;</span>

  //check the header
<span style = "background-color:#fdd">  if (msgHeader.IsNull())</span>
  {
<span style = "background-color:#fdd">    messageType = "NONE";
  }</span>
  else
  {
<span style = "background-color:#fdd">    messageType = msgHeader-&gt;GetDeviceType();</span>
  }

  //make message type uppercase
<span style = "background-color:#fdd">  messageType = itksys::SystemTools::UpperCase(messageType);</span>

  //find the according new method
  if (this-&gt;m_NewMethods.find(messageType)
<span style = "background-color:#fdd">    != this-&gt;m_NewMethods.end())</span>
  {
<span style = "background-color:#fdd">    if (this-&gt;m_NewMethods[messageType] != nullptr)</span>
    {
      // Call tracker New() function if tracker not nullptr
<span style = "background-color:#fdd">      return (*this-&gt;m_NewMethods[messageType])();
    }</span>
    else
<span style = "background-color:#fdd">      return nullptr;
  }</span>
  else
  {
<span style = "background-color:#fdd">    MITK_ERROR("IGTLMessageFactory") &lt;&lt; "Unknown IGT message type: "</span>
      &lt;&lt; messageType;
<span style = "background-color:#fdd">    return nullptr;</span>
  }
<span style = "background-color:#fdd">}</span></pre>
	</body>
</html>
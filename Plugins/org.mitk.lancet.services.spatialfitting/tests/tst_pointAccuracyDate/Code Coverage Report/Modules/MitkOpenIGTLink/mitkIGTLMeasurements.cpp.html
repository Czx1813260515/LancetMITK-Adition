<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkIGTLMeasurements.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkIGTLMeasurements.h"
#include &lt;chrono&gt;

//Microservices
#include "usServiceReference.h"
#include "usModuleContext.h"
#include "usServiceEvent.h"
#include "mitkServiceInterface.h"
#include "usGetModuleContext.h"
#include &lt;iostream&gt;
#include &lt;fstream&gt;

mitk::IGTLMeasurements::IGTLMeasurements()
<span style = "background-color:#dfd">{
}</span>

mitk::IGTLMeasurements* mitk::IGTLMeasurements::GetInstance()
<span style = "background-color:#fdd">{
  static us::ServiceReference&lt;mitk::IGTLMeasurements&gt; serviceRef;
  static us::ModuleContext* context = us::GetModuleContext();
  if (!serviceRef)</span>
  {
    // This is either the first time GetInstance() was called,
    // or a mitk::IGTLMeasurements instance has not yet been registered.
<span style = "background-color:#fdd">    serviceRef = context-&gt;GetServiceReference&lt;mitk::IGTLMeasurements&gt;();</span>
  }
<span style = "background-color:#fdd">  if (serviceRef)</span>
  {
    // We have a valid service reference. It always points to the service
    // with the lowest id (usually the one which was registered first).
    // This still might return a null pointer, if all mitk::IGTLMeasurements
    // instances have been unregistered (during unloading of the library,
    // for example).
<span style = "background-color:#fdd">    return context-&gt;GetService(serviceRef);
  }</span>
  else
  {
    // No mitk::IGTLMeasurements instance was registered yet.
<span style = "background-color:#fdd">    return nullptr;</span>
  }
<span style = "background-color:#fdd">}</span>

mitk::IGTLMeasurements::~IGTLMeasurements()
<span style = "background-color:#dfd">{
}</span>

void mitk::IGTLMeasurements::AddMeasurement(unsigned int measurementPoint, unsigned int index, long long timestamp)
<span style = "background-color:#fdd">{
  if (timestamp == 0) { timestamp = std::chrono::high_resolution_clock::now().time_since_epoch().count(); }
  if (m_IsStarted)</span>
  {
<span style = "background-color:#fdd">    m_MeasurementPoints[measurementPoint].push_back(TimeStampIndexPair(timestamp, index));</span>
  }
<span style = "background-color:#fdd">}</span>

bool mitk::IGTLMeasurements::ExportData(std::string filename)
<span style = "background-color:#fdd">{</span>
  //open file
<span style = "background-color:#fdd">  std::ostream* out = new std::ofstream(filename.c_str());</span>

  //save old locale
  char * oldLocale;
<span style = "background-color:#fdd">  oldLocale = setlocale(LC_ALL, nullptr);</span>

  //define own locale
<span style = "background-color:#fdd">  std::locale C("C");
  setlocale(LC_ALL, "C");</span>

  //write header
<span style = "background-color:#fdd">  unsigned int numberOfMeasurementPoints = (unsigned int)m_MeasurementPoints.size();
  *out &lt;&lt; numberOfMeasurementPoints &lt;&lt; "\n";</span>

<span style = "background-color:#fdd">  if (numberOfMeasurementPoints == 0)</span>
  {
<span style = "background-color:#fdd">    delete out;
    return false;</span>
  }

<span style = "background-color:#fdd">  out-&gt;precision(15); // rounding precision because we don't want to loose data.</span>

  //for each entry of the map
<span style = "background-color:#fdd">  for (auto entry : m_MeasurementPoints)</span>
  {
<span style = "background-color:#fdd">    *out &lt;&lt; entry.second.size() &lt;&lt; ";";
    *out &lt;&lt; entry.first &lt;&lt; ";";
    for (TimeStampIndexPair timestampIndexPair : entry.second)</span>
    {
<span style = "background-color:#fdd">      *out &lt;&lt; (timestampIndexPair.first) &lt;&lt; ";";
      *out &lt;&lt; (timestampIndexPair.second) &lt;&lt; ";";
    }
    *out &lt;&lt; "\n";
  }</span>

<span style = "background-color:#fdd">  out-&gt;flush();
  delete out;</span>
  //switch back to old locale
<span style = "background-color:#fdd">  setlocale(LC_ALL, oldLocale);</span>

<span style = "background-color:#fdd">  return true;
}</span>

void mitk::IGTLMeasurements::Reset()
<span style = "background-color:#fdd">{
  m_MeasurementPoints.clear();
}</span>

void mitk::IGTLMeasurements::SetStarted(bool started)
<span style = "background-color:#fdd">{
  m_IsStarted = started;
}</span></pre>
	</body>
</html>
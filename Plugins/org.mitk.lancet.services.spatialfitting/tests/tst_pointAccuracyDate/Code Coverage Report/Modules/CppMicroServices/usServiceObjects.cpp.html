<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>usServiceObjects.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

  Library: CppMicroServices

  Copyright (c) German Cancer Research Center (DKFZ)
  All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

============================================================================*/

#include "usServiceObjects.h"

#include "usServiceReferenceBasePrivate.h"

#include &lt;set&gt;

US_BEGIN_NAMESPACE

class ServiceObjectsBasePrivate
{
public:

  AtomicInt ref;

  ModuleContext* m_context;
  ServiceReferenceBase m_reference;

  // This is used by all ServiceObjects&lt;S&gt; instances with S != void
  std::map&lt;void*, InterfaceMap&gt; m_serviceInstances;
  // This is used by ServiceObjects&lt;void&gt;
  std::set&lt;InterfaceMap&gt; m_serviceInterfaceMaps;

  ServiceObjectsBasePrivate(ModuleContext* context, const ServiceReferenceBase&amp; reference)
<span style = "background-color:#fdd">    : m_context(context)
    , m_reference(reference)
  {}</span>

  InterfaceMap GetServiceInterfaceMap()
<span style = "background-color:#fdd">  {
    InterfaceMap result;</span>

<span style = "background-color:#fdd">    bool isPrototypeScope = m_reference.GetProperty(ServiceConstants::SERVICE_SCOPE()).ToString() ==</span>
                            ServiceConstants::SCOPE_PROTOTYPE();

<span style = "background-color:#fdd">    if (isPrototypeScope)</span>
    {
<span style = "background-color:#fdd">      result = m_reference.d-&gt;GetPrototypeService(m_context-&gt;GetModule());
    }</span>
    else
    {
<span style = "background-color:#fdd">      result = m_reference.d-&gt;GetServiceInterfaceMap(m_context-&gt;GetModule());</span>
    }

<span style = "background-color:#fdd">    return result;
  }</span>
};

ServiceObjectsBase::ServiceObjectsBase(ModuleContext* context, const ServiceReferenceBase&amp; reference)
<span style = "background-color:#fdd">  : d(new ServiceObjectsBasePrivate(context, reference))
{
  if (!reference)</span>
  {
<span style = "background-color:#fdd">    delete d;
    throw std::invalid_argument("The service reference is invalid");</span>
  }
<span style = "background-color:#fdd">  d-&gt;ref.Ref();
}</span>

void* ServiceObjectsBase::GetService() const
<span style = "background-color:#fdd">{
  if (!d-&gt;m_reference)</span>
  {
<span style = "background-color:#fdd">    return nullptr;</span>
  }

<span style = "background-color:#fdd">  InterfaceMap im = d-&gt;GetServiceInterfaceMap();
  void* result = im.find(d-&gt;m_reference.GetInterfaceId())-&gt;second;</span>

<span style = "background-color:#fdd">  if (result)</span>
  {
<span style = "background-color:#fdd">    d-&gt;m_serviceInstances.insert(std::make_pair(result, im));</span>
  }
<span style = "background-color:#fdd">  return result;
}</span>

InterfaceMap ServiceObjectsBase::GetServiceInterfaceMap() const
<span style = "background-color:#fdd">{
  InterfaceMap result;
  if (!d-&gt;m_reference)</span>
  {
<span style = "background-color:#fdd">    return result;</span>
  }

<span style = "background-color:#fdd">  result = d-&gt;GetServiceInterfaceMap();</span>

<span style = "background-color:#fdd">  if (!result.empty())</span>
  {
<span style = "background-color:#fdd">    d-&gt;m_serviceInterfaceMaps.insert(result);</span>
  }
<span style = "background-color:#fdd">  return result;
}</span>

void ServiceObjectsBase::UngetService(void* service)
<span style = "background-color:#fdd">{
  if (service == nullptr)</span>
  {
<span style = "background-color:#fdd">    return;</span>
  }

<span style = "background-color:#fdd">  std::map&lt;void*,InterfaceMap&gt;::iterator serviceIter = d-&gt;m_serviceInstances.find(service);
  if (serviceIter == d-&gt;m_serviceInstances.end())</span>
  {
<span style = "background-color:#fdd">    throw std::invalid_argument("The provided service has not been retrieved via this ServiceObjects instance");</span>
  }

<span style = "background-color:#fdd">  if (!d-&gt;m_reference.d-&gt;UngetPrototypeService(d-&gt;m_context-&gt;GetModule(), serviceIter-&gt;second))</span>
  {
<span style = "background-color:#fdd">    US_WARN &lt;&lt; "Ungetting service unsuccessful";
  }</span>
  else
  {
<span style = "background-color:#fdd">    d-&gt;m_serviceInstances.erase(serviceIter);</span>
  }
<span style = "background-color:#fdd">}</span>

void ServiceObjectsBase::UngetService(const InterfaceMap&amp; interfaceMap)
<span style = "background-color:#fdd">{
  if (interfaceMap.empty())</span>
  {
<span style = "background-color:#fdd">    return;</span>
  }

<span style = "background-color:#fdd">  std::set&lt;InterfaceMap&gt;::iterator serviceIter = d-&gt;m_serviceInterfaceMaps.find(interfaceMap);
  if (serviceIter == d-&gt;m_serviceInterfaceMaps.end())</span>
  {
<span style = "background-color:#fdd">    throw std::invalid_argument("The provided service has not been retrieved via this ServiceObjects instance");</span>
  }

<span style = "background-color:#fdd">  if (!d-&gt;m_reference.d-&gt;UngetPrototypeService(d-&gt;m_context-&gt;GetModule(), interfaceMap))</span>
  {
<span style = "background-color:#fdd">    US_WARN &lt;&lt; "Ungetting service unsuccessful";
  }</span>
  else
  {
<span style = "background-color:#fdd">    d-&gt;m_serviceInterfaceMaps.erase(serviceIter);</span>
  }
<span style = "background-color:#fdd">}</span>

ServiceReferenceBase ServiceObjectsBase::GetReference() const
<span style = "background-color:#fdd">{
  return d-&gt;m_reference;
}</span>

ServiceObjectsBase::ServiceObjectsBase(const ServiceObjectsBase&amp; other)
<span style = "background-color:#fdd">  : d(other.d)
{
  d-&gt;ref.Ref();
}</span>

ServiceObjectsBase::~ServiceObjectsBase()
<span style = "background-color:#fdd">{
  if (!d-&gt;ref.Deref())</span>
  {
<span style = "background-color:#fdd">    delete d;</span>
  }
<span style = "background-color:#fdd">}</span>

ServiceObjectsBase&amp; ServiceObjectsBase::operator =(const ServiceObjectsBase&amp; other)
<span style = "background-color:#fdd">{
  ServiceObjectsBasePrivate* curr_d = d;
  d = other.d;
  d-&gt;ref.Ref();</span>

<span style = "background-color:#fdd">  if (!curr_d-&gt;ref.Deref())
    delete curr_d;</span>

<span style = "background-color:#fdd">  return *this;
}</span>

InterfaceMap ServiceObjects&lt;void&gt;::GetService() const
<span style = "background-color:#fdd">{
  return this-&gt;ServiceObjectsBase::GetServiceInterfaceMap();
}</span>

void ServiceObjects&lt;void&gt;::UngetService(const InterfaceMap&amp; service)
<span style = "background-color:#fdd">{
  this-&gt;ServiceObjectsBase::UngetService(service);
}</span>

ServiceReferenceU ServiceObjects&lt;void&gt;::GetServiceReference() const
<span style = "background-color:#fdd">{
  return this-&gt;ServiceObjectsBase::GetReference();
}</span>

ServiceObjects&lt;void&gt;::ServiceObjects(ModuleContext* context, const ServiceReferenceU&amp; reference)
<span style = "background-color:#fdd">  : ServiceObjectsBase(context, reference)
{}</span>

US_END_NAMESPACE</pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>usServiceRegistry.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

  Library: CppMicroServices

  Copyright (c) German Cancer Research Center (DKFZ)
  All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

============================================================================*/

#include &lt;iterator&gt;
#include &lt;stdexcept&gt;
#include &lt;cassert&gt;

#include "usServiceRegistry_p.h"
#include "usServiceFactory.h"
#include "usPrototypeServiceFactory.h"
#include "usServiceRegistry_p.h"
#include "usServiceRegistrationBasePrivate.h"
#include "usModulePrivate.h"
#include "usCoreModuleContext_p.h"


US_BEGIN_NAMESPACE

ServicePropertiesImpl ServiceRegistry::CreateServiceProperties(const ServiceProperties&amp; in,
                                                               const std::vector&lt;std::string&gt;&amp; classes,
                                                               bool isFactory, bool isPrototypeFactory,
                                                               long sid)
<span style = "background-color:#dfd">{</span>
  static long nextServiceID = 1;
<span style = "background-color:#dfd">  ServiceProperties props(in);</span>

<span style = "background-color:#dfd">  if (!classes.empty())</span>
  {
<span style = "background-color:#dfd">    props.insert(std::make_pair(ServiceConstants::OBJECTCLASS(), classes));</span>
  }

<span style = "background-color:#dfd">  props.insert(std::make_pair(ServiceConstants::SERVICE_ID(), sid != -1 ? sid : nextServiceID++));</span>

<span style = "background-color:#dfd">  if (isPrototypeFactory)</span>
  {
<span style = "background-color:#dfd">    props.insert(std::make_pair(ServiceConstants::SERVICE_SCOPE(), ServiceConstants::SCOPE_PROTOTYPE()));
  }
  else if (isFactory)</span>
  {
<span style = "background-color:#fdd">    props.insert(std::make_pair(ServiceConstants::SERVICE_SCOPE(), ServiceConstants::SCOPE_MODULE()));
  }</span>
  else
  {
<span style = "background-color:#dfd">    props.insert(std::make_pair(ServiceConstants::SERVICE_SCOPE(), ServiceConstants::SCOPE_SINGLETON()));</span>
  }

<span style = "background-color:#dfd">  return ServicePropertiesImpl(props);
}</span>

ServiceRegistry::ServiceRegistry(CoreModuleContext* coreCtx)
<span style = "background-color:#dfd">  : core(coreCtx)
{</span>

<span style = "background-color:#dfd">}</span>

ServiceRegistry::~ServiceRegistry()
<span style = "background-color:#dfd">{
  Clear();
}</span>

void ServiceRegistry::Clear()
<span style = "background-color:#dfd">{
  services.clear();
  serviceRegistrations.clear();
  classServices.clear();
  core = nullptr;
}</span>

ServiceRegistrationBase ServiceRegistry::RegisterService(ModulePrivate* module,
                                                     const InterfaceMap&amp; service,
                                                     const ServiceProperties&amp; properties)
<span style = "background-color:#dfd">{
  if (service.empty())</span>
  {
<span style = "background-color:#fdd">    throw std::invalid_argument("Can't register empty InterfaceMap as a service");</span>
  }

  // Check if we got a service factory
<span style = "background-color:#dfd">  bool isFactory = service.count("org.cppmicroservices.factory") &gt; 0;
  bool isPrototypeFactory = (isFactory ? dynamic_cast&lt;PrototypeServiceFactory*&gt;(reinterpret_cast&lt;ServiceFactory*&gt;(service.find("org.cppmicroservices.factory")-&gt;second)) != nullptr : false);</span>

<span style = "background-color:#dfd">  std::vector&lt;std::string&gt; classes;</span>
  // Check if service implements claimed classes and that they exist.
<span style = "background-color:#dfd">  for (InterfaceMap::const_iterator i = service.begin();
       i != service.end(); ++i)</span>
  {
<span style = "background-color:#dfd">    if (i-&gt;first.empty() || (!isFactory &amp;&amp; i-&gt;second == nullptr))</span>
    {
<span style = "background-color:#fdd">      throw std::invalid_argument("Can't register as null class");</span>
    }
<span style = "background-color:#dfd">    classes.push_back(i-&gt;first);
  }</span>

<span style = "background-color:#dfd">  ServiceRegistrationBase res(module, service,</span>
                              CreateServiceProperties(properties, classes, isFactory, isPrototypeFactory));
  {
<span style = "background-color:#dfd">    MutexLock lock(mutex);
    services.insert(std::make_pair(res, classes));
    serviceRegistrations.push_back(res);
    for (std::vector&lt;std::string&gt;::const_iterator i = classes.begin();
         i != classes.end(); ++i)</span>
    {
<span style = "background-color:#dfd">      std::vector&lt;ServiceRegistrationBase&gt;&amp; s = classServices[*i];
      std::vector&lt;ServiceRegistrationBase&gt;::iterator ip =</span>
          std::lower_bound(s.begin(), s.end(), res);
<span style = "background-color:#dfd">      s.insert(ip, res);
    }
  }</span>

<span style = "background-color:#dfd">  ServiceReferenceBase r = res.GetReference(std::string());
  ServiceListeners::ServiceListenerEntries listeners;
  ServiceEvent registeredEvent(ServiceEvent::REGISTERED, r);
  module-&gt;coreCtx-&gt;listeners.GetMatchingServiceListeners(registeredEvent, listeners);
  module-&gt;coreCtx-&gt;listeners.ServiceChanged(listeners,</span>
                                            registeredEvent);
<span style = "background-color:#dfd">  return res;
}</span>

void ServiceRegistry::UpdateServiceRegistrationOrder(const ServiceRegistrationBase&amp; sr,
                                                     const std::vector&lt;std::string&gt;&amp; classes)
<span style = "background-color:#fdd">{
  MutexLock lock(mutex);
  for (std::vector&lt;std::string&gt;::const_iterator i = classes.begin();
       i != classes.end(); ++i)</span>
  {
<span style = "background-color:#fdd">    std::vector&lt;ServiceRegistrationBase&gt;&amp; s = classServices[*i];
    s.erase(std::remove(s.begin(), s.end(), sr), s.end());
    s.insert(std::lower_bound(s.begin(), s.end(), sr), sr);
  }
}</span>

void ServiceRegistry::Get(const std::string&amp; clazz,
                          std::vector&lt;ServiceRegistrationBase&gt;&amp; serviceRegs) const
<span style = "background-color:#dfd">{
  MutexLock lock(mutex);
  Get_unlocked(clazz, serviceRegs);
}</span>

void ServiceRegistry::Get_unlocked(const std::string&amp; clazz,
                                   std::vector&lt;ServiceRegistrationBase&gt;&amp; serviceRegs) const
<span style = "background-color:#dfd">{
  MapClassServices::const_iterator i = classServices.find(clazz);
  if (i != classServices.end())</span>
  {
<span style = "background-color:#fdd">    serviceRegs = i-&gt;second;</span>
  }
<span style = "background-color:#dfd">}</span>

ServiceReferenceBase ServiceRegistry::Get(ModulePrivate* module, const std::string&amp; clazz) const
<span style = "background-color:#dfd">{
  MutexLock lock(mutex);</span>
  try
  {
<span style = "background-color:#dfd">    std::vector&lt;ServiceReferenceBase&gt; srs;
    Get_unlocked(clazz, "", module, srs);
    US_DEBUG &lt;&lt; "get service ref " &lt;&lt; clazz &lt;&lt; " for module "</span>
             &lt;&lt; module-&gt;info.name &lt;&lt; " = " &lt;&lt; srs.size() &lt;&lt; " refs";

<span style = "background-color:#dfd">    if (!srs.empty())</span>
    {
<span style = "background-color:#dfd">      return srs.back();</span>
    }
<span style = "background-color:#fdd">  }</span>
  catch (const std::invalid_argument&amp; )
<span style = "background-color:#fdd">  { }</span>

<span style = "background-color:#fdd">  return ServiceReferenceBase();</span>
<span style = "background-color:#dfd">}</span>

void ServiceRegistry::Get(const std::string&amp; clazz, const std::string&amp; filter,
                          ModulePrivate* module, std::vector&lt;ServiceReferenceBase&gt;&amp; res) const
<span style = "background-color:#dfd">{
  MutexLock lock(mutex);
  Get_unlocked(clazz, filter, module, res);
}</span>

void ServiceRegistry::Get_unlocked(const std::string&amp; clazz, const std::string&amp; filter,
                          ModulePrivate* module, std::vector&lt;ServiceReferenceBase&gt;&amp; res) const
<span style = "background-color:#dfd">{
  std::vector&lt;ServiceRegistrationBase&gt;::const_iterator s;
  std::vector&lt;ServiceRegistrationBase&gt;::const_iterator send;
  std::vector&lt;ServiceRegistrationBase&gt; v;
  LDAPExpr ldap;
  if (clazz.empty())</span>
  {
<span style = "background-color:#fdd">    if (!filter.empty())</span>
    {
<span style = "background-color:#fdd">      ldap = LDAPExpr(filter);
      LDAPExpr::ObjectClassSet matched;
      if (ldap.GetMatchedObjectClasses(matched))</span>
      {
<span style = "background-color:#fdd">        v.clear();
        for(LDAPExpr::ObjectClassSet::const_iterator className = matched.begin();
            className != matched.end(); ++className)</span>
        {
<span style = "background-color:#fdd">          MapClassServices::const_iterator i = classServices.find(*className);
          if (i != classServices.end())</span>
          {
<span style = "background-color:#fdd">            std::copy(i-&gt;second.begin(), i-&gt;second.end(), std::back_inserter(v));</span>
          }
<span style = "background-color:#fdd">        }
        if (!v.empty())</span>
        {
<span style = "background-color:#fdd">          s = v.begin();
          send = v.end();
        }</span>
        else
        {
<span style = "background-color:#fdd">          return;</span>
        }
<span style = "background-color:#fdd">      }</span>
      else
      {
<span style = "background-color:#fdd">        s = serviceRegistrations.begin();
        send = serviceRegistrations.end();</span>
      }
<span style = "background-color:#fdd">    }</span>
    else
    {
<span style = "background-color:#fdd">      s = serviceRegistrations.begin();
      send = serviceRegistrations.end();</span>
    }
<span style = "background-color:#fdd">  }</span>
  else
  {
<span style = "background-color:#dfd">    MapClassServices::const_iterator it = classServices.find(clazz);
    if (it != classServices.end())</span>
    {
<span style = "background-color:#dfd">      s = it-&gt;second.begin();
      send = it-&gt;second.end();
    }</span>
    else
    {
<span style = "background-color:#dfd">      return;</span>
    }
<span style = "background-color:#dfd">    if (!filter.empty())</span>
    {
<span style = "background-color:#fdd">      ldap = LDAPExpr(filter);</span>
    }
<span style = "background-color:#dfd">  }</span>

<span style = "background-color:#dfd">  for (; s != send; ++s)</span>
  {
<span style = "background-color:#dfd">    ServiceReferenceBase sri = s-&gt;GetReference(clazz);</span>

<span style = "background-color:#dfd">    if (filter.empty() || ldap.Evaluate(s-&gt;d-&gt;properties, false))</span>
    {
<span style = "background-color:#dfd">      res.push_back(sri);</span>
    }
<span style = "background-color:#dfd">  }</span>

<span style = "background-color:#dfd">  if (!res.empty())</span>
  {
<span style = "background-color:#dfd">    if (module != nullptr)</span>
    {
<span style = "background-color:#dfd">      core-&gt;serviceHooks.FilterServiceReferences(module-&gt;moduleContext, clazz, filter, res);
    }</span>
    else
    {
<span style = "background-color:#fdd">      core-&gt;serviceHooks.FilterServiceReferences(nullptr, clazz, filter, res);</span>
    }
  }
<span style = "background-color:#dfd">}</span>

void ServiceRegistry::RemoveServiceRegistration(const ServiceRegistrationBase&amp; sr)
<span style = "background-color:#dfd">{
  MutexLock lock(mutex);</span>

<span style = "background-color:#dfd">  assert(sr.d-&gt;properties.Value(ServiceConstants::OBJECTCLASS()).Type() == typeid(std::vector&lt;std::string&gt;));
  const std::vector&lt;std::string&gt;&amp; classes = ref_any_cast&lt;std::vector&lt;std::string&gt; &gt;(</span>
        sr.d-&gt;properties.Value(ServiceConstants::OBJECTCLASS()));
<span style = "background-color:#dfd">  services.erase(sr);
  serviceRegistrations.erase(std::remove(serviceRegistrations.begin(), serviceRegistrations.end(), sr),</span>
                             serviceRegistrations.end());
<span style = "background-color:#dfd">  for (std::vector&lt;std::string&gt;::const_iterator i = classes.begin();
       i != classes.end(); ++i)</span>
  {
<span style = "background-color:#dfd">    std::vector&lt;ServiceRegistrationBase&gt;&amp; s = classServices[*i];
    if (s.size() &gt; 1)</span>
    {
<span style = "background-color:#dfd">      s.erase(std::remove(s.begin(), s.end(), sr), s.end());
    }</span>
    else
    {
<span style = "background-color:#dfd">      classServices.erase(*i);
    }
  }
}</span>

void ServiceRegistry::GetRegisteredByModule(ModulePrivate* p,
                                            std::vector&lt;ServiceRegistrationBase&gt;&amp; res) const
<span style = "background-color:#dfd">{
  MutexLock lock(mutex);</span>

<span style = "background-color:#dfd">  for (std::vector&lt;ServiceRegistrationBase&gt;::const_iterator i = serviceRegistrations.begin();
       i != serviceRegistrations.end(); ++i)</span>
  {
<span style = "background-color:#dfd">    if (i-&gt;d-&gt;module == p)</span>
    {
<span style = "background-color:#dfd">      res.push_back(*i);
    }
  }
}</span>

void ServiceRegistry::GetUsedByModule(Module* p,
                                      std::vector&lt;ServiceRegistrationBase&gt;&amp; res) const
<span style = "background-color:#dfd">{
  MutexLock lock(mutex);</span>

<span style = "background-color:#dfd">  for (std::vector&lt;ServiceRegistrationBase&gt;::const_iterator i = serviceRegistrations.begin();
       i != serviceRegistrations.end(); ++i)</span>
  {
<span style = "background-color:#dfd">    if (i-&gt;d-&gt;IsUsedByModule(p))</span>
    {
<span style = "background-color:#dfd">      res.push_back(*i);
    }
  }
}</span>

US_END_NAMESPACE</pre>
	</body>
</html>
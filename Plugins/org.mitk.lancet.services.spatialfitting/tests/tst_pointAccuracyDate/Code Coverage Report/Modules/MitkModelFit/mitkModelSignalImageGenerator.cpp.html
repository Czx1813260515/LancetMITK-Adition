<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkModelSignalImageGenerator.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkModelSignalImageGenerator.h"
#include "itkMultiOutputNaryFunctorImageFilter.h"
#include "mitkArbitraryTimeGeometry.h"
#include "mitkImageCast.h"
#include "mitkImageAccessByItk.h"
#include "mitkITKImageImport.h"
#include "mitkModelDataGenerationFunctor.h"
#include "mitkSimpleFunctorPolicy.h"


void mitk::ModelSignalImageGenerator::SetParameterInputImage(const ParametersIndexType parameterIndex, ParameterImageType parameterImage)
<span style = "background-color:#fdd">{
    m_ParameterInputMap.insert(std::make_pair(parameterIndex,parameterImage));</span>

<span style = "background-color:#fdd">}</span>

mitk::ModelSignalImageGenerator::ResultImageType mitk::ModelSignalImageGenerator::GetGeneratedImage()
<span style = "background-color:#fdd">{
    Generate();
    return m_ResultImage;
}</span>

template &lt;typename TPixel, unsigned int VDim&gt;
void
  mitk::ModelSignalImageGenerator::DoPrepareMask(itk::Image&lt;TPixel, VDim&gt;* image)
<span style = "background-color:#fdd">{
  m_InternalMask = dynamic_cast&lt;InternalMaskType*&gt;(image);</span>

<span style = "background-color:#fdd">  if (m_InternalMask.IsNull())</span>
  {
<span style = "background-color:#fdd">    MITK_INFO &lt;&lt; "Parameter Fit Generator. Need to cast mask for parameter fit.";</span>
    typedef itk::Image&lt;TPixel, VDim&gt; InputImageType;
    typedef itk::CastImageFilter&lt; InputImageType, InternalMaskType &gt; CastFilterType;
<span style = "background-color:#fdd">    typename CastFilterType::Pointer  spImageCaster =  CastFilterType::New();</span>

<span style = "background-color:#fdd">    spImageCaster-&gt;SetInput(image);</span>

<span style = "background-color:#fdd">    m_InternalMask = spImageCaster-&gt;GetOutput();
    spImageCaster-&gt;Update();
  }
}</span>

void mitk::ModelSignalImageGenerator::SortParameterImages()
<span style = "background-color:#fdd">{
    ParameterVectorType inputImages(this-&gt;m_ParameterInputMap.size());</span>

<span style = "background-color:#fdd">    unsigned int i = 0;
    for (ParameterMapType::const_iterator pos = m_ParameterInputMap.begin(); pos != m_ParameterInputMap.end(); ++pos)</span>
    {

<span style = "background-color:#fdd">      i = pos-&gt;first;
      inputImages[i] = pos-&gt;second;
    }</span>

<span style = "background-color:#fdd">    this-&gt;m_InputParameterImages = inputImages;</span>


<span style = "background-color:#fdd">}</span>

void mitk::ModelSignalImageGenerator::Generate()
<span style = "background-color:#fdd">{
     SortParameterImages();</span>

<span style = "background-color:#fdd">    if(this-&gt;m_Mask.IsNotNull())</span>
    {
<span style = "background-color:#fdd">      AccessFixedDimensionByItk(m_Mask, mitk::ModelSignalImageGenerator::DoPrepareMask, 3);
    }</span>
    else
    {
<span style = "background-color:#fdd">      this-&gt;m_InternalMask = nullptr;</span>
    }

    /** @todo #1 This did not work! The Access-Routine would be a much nicer solution, but for some reasons, the handling did not work.
     * Thats why the code for Generation the Data was pasted below
     */
//    mitk::Image::Pointer firstParameterImage = this-&gt;m_InputParameterImages[0];
//    AccessFixedDimensionByItk(firstParameterImage, mitk::ModelSignalImageGenerator::DoGenerateData, 3);


    typedef itk::Image&lt;double, 3&gt; InputFrameImageType;
    typedef itk::Image&lt;double, 3&gt; OutputImageType;

    typedef itk::MultiOutputNaryFunctorImageFilter&lt;InputFrameImageType, OutputImageType, SimpleFunctorPolicy, InternalMaskType&gt; FilterType;
<span style = "background-color:#fdd">     FilterType::Pointer filter = FilterType::New();</span>

<span style = "background-color:#fdd">    for(unsigned int i=0; i&lt;this-&gt;m_ParameterInputMap.size(); ++i)</span>
    {
<span style = "background-color:#fdd">        InputFrameImageType::Pointer frameImage = InputFrameImageType::New();
        Image::Pointer parameterImage = m_InputParameterImages.at(i);</span>

<span style = "background-color:#fdd">        mitk::CastToItkImage(parameterImage, frameImage);
        filter-&gt;SetInput(i,frameImage);
    }</span>

<span style = "background-color:#fdd">    ModelDataGenerationFunctor::Pointer generationFunctor = ModelDataGenerationFunctor::New();
    generationFunctor-&gt;SetModelParameterizer(m_Parameterizer);</span>

<span style = "background-color:#fdd">    SimpleFunctorPolicy functor;
    functor.SetFunctor(generationFunctor);
    filter-&gt;SetFunctor(functor);
    if (this-&gt;m_InternalMask.IsNotNull())</span>
    {
<span style = "background-color:#fdd">     filter-&gt;SetMask(this-&gt;m_InternalMask);</span>
    }
<span style = "background-color:#fdd">    filter-&gt;Update();</span>

<span style = "background-color:#fdd">    if (filter-&gt;GetNumberOfOutputs() != generationFunctor-&gt;GetGrid().GetSize())</span>
    {
<span style = "background-color:#fdd">      itkExceptionMacro("Error. Number of computed output Images does not match Grid size!");</span>
    }

    /** @todo #1 Better solution than all this code!
     * This was copied from TestingHelper/TestArtifactGenerator. Just instantiating a mitk::Image and setting its Volumes
     * in the for-loop did not work somehow.
     * This was a work around
     */

    typedef itk::Image&lt;double,4&gt; DynamicITKImageType;

<span style = "background-color:#fdd">    Image::Pointer dynamicImage= Image::New();
    mitk::Image::Pointer tempImage = mitk::ImportItkImage(filter-&gt;GetOutput(0))-&gt;Clone();</span>

<span style = "background-color:#fdd">    DynamicITKImageType::Pointer dynamicITKImage = DynamicITKImageType::New();
    DynamicITKImageType::RegionType dynamicITKRegion;</span>
    DynamicITKImageType::PointType dynamicITKOrigin;
    DynamicITKImageType::IndexType dynamicITKIndex;
    DynamicITKImageType::SpacingType dynamicITKSpacing;

<span style = "background-color:#fdd">    dynamicITKSpacing[0] = tempImage-&gt;GetGeometry()-&gt;GetSpacing()[0];
    dynamicITKSpacing[1] = tempImage-&gt;GetGeometry()-&gt;GetSpacing()[1];
    dynamicITKSpacing[2] = tempImage-&gt;GetGeometry()-&gt;GetSpacing()[2];
    dynamicITKSpacing[3] = 3.0;</span>

<span style = "background-color:#fdd">    dynamicITKIndex[0] = 0;  // The first pixel of the REGION
    dynamicITKIndex[1] = 0;
    dynamicITKIndex[2] = 0;
    dynamicITKIndex[3] = 0;</span>

<span style = "background-color:#fdd">    dynamicITKRegion.SetSize( 0,tempImage-&gt;GetDimension(0));
    dynamicITKRegion.SetSize( 1,tempImage-&gt;GetDimension(1));
    dynamicITKRegion.SetSize( 2,tempImage-&gt;GetDimension(2));
    dynamicITKRegion.SetSize(3, filter-&gt;GetNumberOfOutputs());</span>

<span style = "background-color:#fdd">    dynamicITKRegion.SetIndex( dynamicITKIndex );</span>

<span style = "background-color:#fdd">    dynamicITKOrigin[0]=tempImage-&gt;GetGeometry()-&gt;GetOrigin()[0];
    dynamicITKOrigin[1]=tempImage-&gt;GetGeometry()-&gt;GetOrigin()[1];
    dynamicITKOrigin[2]=tempImage-&gt;GetGeometry()-&gt;GetOrigin()[2];</span>

<span style = "background-color:#fdd">    dynamicITKImage-&gt;SetOrigin(dynamicITKOrigin);
    dynamicITKImage-&gt;SetSpacing(dynamicITKSpacing);
    dynamicITKImage-&gt;SetRegions( dynamicITKRegion);
    dynamicITKImage-&gt;Allocate();
    dynamicITKImage-&gt;FillBuffer(0); //not sure if this is necessary</span>

    // Convert
<span style = "background-color:#fdd">    mitk::CastToMitkImage(dynamicITKImage, dynamicImage);</span>



<span style = "background-color:#fdd">    ArbitraryTimeGeometry::Pointer timeGeometry = ArbitraryTimeGeometry::New();
    timeGeometry-&gt;ClearAllGeometries();</span>

<span style = "background-color:#fdd">    auto nrOfOutputs = filter-&gt;GetNumberOfOutputs();
    auto grid = generationFunctor-&gt;GetGrid();
    for (unsigned int i = 0; i&lt;nrOfOutputs; ++i)</span>
    {
<span style = "background-color:#fdd">      mitk::Image::Pointer frame = mitk::ImportItkImage(filter-&gt;GetOutput(i))-&gt;Clone();
      mitk::ImageReadAccessor accessor(frame);
      dynamicImage-&gt;SetVolume(accessor.GetData(), i);</span>

<span style = "background-color:#fdd">      double tmax = 0;
      if (i&lt;(nrOfOutputs - 1))</span>
      {
<span style = "background-color:#fdd">        tmax = grid[i + 1] * 1000;
      }</span>
      else
      {
<span style = "background-color:#fdd">        tmax = grid[i] * 1000;</span>
      }
<span style = "background-color:#fdd">      timeGeometry-&gt;AppendNewTimeStepClone(frame-&gt;GetGeometry(), grid[i] * 1000, tmax);
     }</span>

<span style = "background-color:#fdd">    dynamicImage-&gt;SetTimeGeometry(timeGeometry);</span>

<span style = "background-color:#fdd">    this-&gt;m_ResultImage = dynamicImage-&gt;Clone();</span>

<span style = "background-color:#fdd">}</span></pre>
	</body>
</html>
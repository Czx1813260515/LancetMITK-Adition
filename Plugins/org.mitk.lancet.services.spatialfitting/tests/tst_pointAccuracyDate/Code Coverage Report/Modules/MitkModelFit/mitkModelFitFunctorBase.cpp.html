<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkModelFitFunctorBase.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkModelFitFunctorBase.h"

mitk::ModelFitFunctorBase::OutputPixelArrayType
mitk::ModelFitFunctorBase::
Compute(const InputPixelArrayType&amp; value, const ModelBase* model,
        const ModelBase::ParametersType&amp; initialParameters) const
<span style = "background-color:#fdd">{
  if (!model)</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro("Cannot compute fit. Passed model is not defined.");</span>
  }

<span style = "background-color:#fdd">  if (model-&gt;GetNumberOfParameters() != initialParameters.Size())</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro("Cannot compute fit. Parameter count of passed model and passed initial parameters differ. Model parameter count: "</span>
                      &lt;&lt; model-&gt;GetNumberOfParameters() &lt;&lt; "; Initial parameters: " &lt;&lt; initialParameters);
  }

<span style = "background-color:#fdd">  SignalType sample(value.size());</span>

<span style = "background-color:#fdd">  for (SignalType::SizeValueType i = 0; i &lt; sample.Size(); ++i)</span>
  {
<span style = "background-color:#fdd">    sample[i] = value [i];
  }</span>

<span style = "background-color:#fdd">  DebugParameterMapType debugParams;
  ParameterNamesType debugNames;
  if (this-&gt;m_DebugParameterMaps)</span>
  {
<span style = "background-color:#fdd">    debugNames = this-&gt;GetDebugParameterNames();</span>
  }

<span style = "background-color:#fdd">  ParametersType fittedParameters = DoModelFit(sample, model, initialParameters, debugParams);</span>

<span style = "background-color:#fdd">  OutputPixelArrayType derivedParameters = this-&gt;GetDerivedParameters(model, fittedParameters);</span>

<span style = "background-color:#fdd">  OutputPixelArrayType criteria = this-&gt;GetCriteria(model, fittedParameters, sample);</span>

<span style = "background-color:#fdd">  OutputPixelArrayType evaluationParameters = this-&gt;GetEvaluationParameters(model, fittedParameters,</span>
      sample);

<span style = "background-color:#fdd">  if (criteria.size() != this-&gt;GetCriterionNames().size())</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro("ModelFitInfo implementation seems to be inconsitent. Number of criterion values is not equal to number of criterion names.");</span>
  }

<span style = "background-color:#fdd">  OutputPixelArrayType result(fittedParameters.Size() + derivedParameters.size() + criteria.size() +</span>
                              evaluationParameters.size() + debugNames.size());

<span style = "background-color:#fdd">  for (ParametersType::SizeValueType i = 0; i &lt; fittedParameters.Size(); ++i)</span>
  {
<span style = "background-color:#fdd">    result[i] = fittedParameters[i];
  }</span>

<span style = "background-color:#fdd">  OutputPixelArrayType::size_type offset = fittedParameters.Size();</span>

<span style = "background-color:#fdd">  for (OutputPixelArrayType::size_type j = 0; j &lt; derivedParameters.size(); ++j)</span>
  {
<span style = "background-color:#fdd">    result[offset + j] = derivedParameters[j];
  }</span>

<span style = "background-color:#fdd">  offset += derivedParameters.size();
  for (OutputPixelArrayType::size_type j = 0; j &lt; criteria.size(); ++j)</span>
  {
<span style = "background-color:#fdd">    result[offset + j] = criteria[j];
  }</span>

<span style = "background-color:#fdd">  offset += criteria.size();
  for (OutputPixelArrayType::size_type j = 0; j &lt; evaluationParameters.size(); ++j)</span>
  {
<span style = "background-color:#fdd">    result[offset + j] = evaluationParameters[j];
  }</span>

<span style = "background-color:#fdd">  offset += evaluationParameters.size();
  for (OutputPixelArrayType::size_type j = 0; j &lt; debugNames.size(); ++j)</span>
  {
<span style = "background-color:#fdd">    DebugParameterMapType::const_iterator pos = debugParams.find(debugNames[j]);
    if (pos == debugParams.end())</span>
    {
<span style = "background-color:#fdd">      itkExceptionMacro("ModelFitInfo implementation seems to be inconsitent. Debug parameter defined by functor is not in its returned debug map. Invalid debug parameter name: "&lt;&lt;debugNames[j]);
    }</span>
    else
    {
<span style = "background-color:#fdd">      result[offset + j] = pos-&gt;second;</span>
    }
<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  return result;
};</span>

unsigned int
mitk::ModelFitFunctorBase::GetNumberOfOutputs(const ModelBase* model) const
<span style = "background-color:#fdd">{
  if (!model)</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro("Cannot get number of outputs. Model is not defined.");</span>
  }

<span style = "background-color:#fdd">  return model-&gt;GetNumberOfParameters() + model-&gt;GetNumberOfDerivedParameters() +</span>
         this-&gt;GetCriterionNames().size() + m_CostFunctionMap.size()+ this-&gt;GetDebugParameterNames().size();
<span style = "background-color:#fdd">};</span>

void
mitk::ModelFitFunctorBase::ResetEvaluationParameters()
<span style = "background-color:#fdd">{
  m_Mutex.lock();</span>

<span style = "background-color:#fdd">  m_CostFunctionMap.clear();</span>

<span style = "background-color:#fdd">  m_Mutex.unlock();
};</span>

void
mitk::ModelFitFunctorBase::RegisterEvaluationParameter(const std::string&amp; parameterName,
    SVModelFitCostFunction* evaluationCostFunction)
<span style = "background-color:#fdd">{
  m_Mutex.lock();</span>

<span style = "background-color:#fdd">  SVModelFitCostFunction::Pointer costFunctPtr = evaluationCostFunction;</span>

<span style = "background-color:#fdd">  m_CostFunctionMap.insert(std::make_pair(parameterName, costFunctPtr));</span>

<span style = "background-color:#fdd">  m_Mutex.unlock();
};</span>

mitk::ModelFitFunctorBase::ParameterNamesType
mitk::ModelFitFunctorBase::GetEvaluationParameterNames() const
<span style = "background-color:#fdd">{
  m_Mutex.lock();</span>

<span style = "background-color:#fdd">  ParameterNamesType result;</span>

<span style = "background-color:#fdd">  for (CostFunctionMapType::const_iterator pos = m_CostFunctionMap.begin();
       pos != m_CostFunctionMap.end(); ++pos)</span>
  {
<span style = "background-color:#fdd">    result.push_back(pos-&gt;first);
  }</span>

<span style = "background-color:#fdd">  m_Mutex.unlock();</span>

<span style = "background-color:#fdd">  return result;
};</span>

const mitk::SVModelFitCostFunction*
mitk::ModelFitFunctorBase::GetEvaluationParameterCostFunction(const std::string&amp; parameterName)
const
<span style = "background-color:#fdd">{
  const SVModelFitCostFunction* result = nullptr;</span>

<span style = "background-color:#fdd">  m_Mutex.lock();</span>

<span style = "background-color:#fdd">  CostFunctionMapType::const_iterator pos = m_CostFunctionMap.find(parameterName);</span>

<span style = "background-color:#fdd">  if (pos != m_CostFunctionMap.end())</span>
  {
<span style = "background-color:#fdd">    result = (pos-&gt;second).GetPointer();</span>
  }

<span style = "background-color:#fdd">  m_Mutex.unlock();</span>

<span style = "background-color:#fdd">  return result;
};</span>

mitk::ModelFitFunctorBase::ParameterNamesType
mitk::ModelFitFunctorBase::GetDebugParameterNames() const
<span style = "background-color:#fdd">{
  ParameterNamesType result;</span>

<span style = "background-color:#fdd">  if (this-&gt;m_DebugParameterMaps)</span>
  {
<span style = "background-color:#fdd">    result = this-&gt;DefineDebugParameterNames();</span>
  }

<span style = "background-color:#fdd">  return result;
};</span>

mitk::ModelFitFunctorBase::
<span style = "background-color:#fdd">ModelFitFunctorBase() : m_DebugParameterMaps(false)
{};</span>

mitk::ModelFitFunctorBase::
<span style = "background-color:#fdd">~ModelFitFunctorBase() {};</span>

mitk::ModelFitFunctorBase::OutputPixelArrayType
mitk::ModelFitFunctorBase::GetDerivedParameters(const ModelBase* model,
    const ParametersType&amp; parameters) const
<span style = "background-color:#fdd">{
  ModelBase::DerivedParameterMapType derivedParameterMap = model-&gt;GetDerivedParameters(parameters);
  OutputPixelArrayType result(derivedParameterMap.size());</span>

<span style = "background-color:#fdd">  unsigned int i = 0;</span>

<span style = "background-color:#fdd">  for (ModelBase::DerivedParameterMapType::const_iterator pos = derivedParameterMap.begin();
       pos != derivedParameterMap.end(); ++pos, ++i)</span>
  {
<span style = "background-color:#fdd">    result[i] = pos-&gt;second;
  }</span>

<span style = "background-color:#fdd">  return result;
};</span>

mitk::ModelFitFunctorBase::OutputPixelArrayType
mitk::ModelFitFunctorBase::GetEvaluationParameters(const ModelBase* model,
    const ParametersType&amp; parameters, const SignalType&amp; sample) const
<span style = "background-color:#fdd">{
  m_Mutex.lock();</span>

<span style = "background-color:#fdd">  OutputPixelArrayType result(m_CostFunctionMap.size());</span>

<span style = "background-color:#fdd">  unsigned int i = 0;</span>

<span style = "background-color:#fdd">  for (CostFunctionMapType::const_iterator pos = m_CostFunctionMap.begin();
       pos != m_CostFunctionMap.end(); ++pos, ++i)</span>
  {
    //break constness to configure evaluation cost functions. This operatoin is guarded be the mutex
    //after costFct-&gt;GetValue() the cost function may change its state again and is irrelevant for the
    //current call of GetEvaluationParameters
<span style = "background-color:#fdd">    SVModelFitCostFunction* costFct = const_cast&lt;SVModelFitCostFunction*&gt;(pos-&gt;second.GetPointer());</span>

<span style = "background-color:#fdd">    costFct-&gt;SetModel(model);
    costFct-&gt;SetSample(sample);</span>

<span style = "background-color:#fdd">    result[i] = costFct-&gt;GetValue(parameters);
  }</span>

<span style = "background-color:#fdd">  m_Mutex.unlock();</span>

<span style = "background-color:#fdd">  return result;
};</span></pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkModelFitResultHelper.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkModelFitResultHelper.h"

#include &lt;mitkDataStorage.h&gt;
#include &lt;mitkUIDGenerator.h&gt;

#include "mitkModelTraitsInterface.h"
#include "mitkModelFitConstants.h"
#include "mitkModelFitInfo.h"
#include &lt;mitkModelFitResultRelationRule.h&gt;

#include &lt;mitkDICOMPMPropertyHelper.h&gt;
#include &lt;mitkDICOMQIPropertyHelper.h&gt;

namespace mitk
{
  namespace modelFit
  {
    void AdaptDataPropertyToParameter(mitk::BaseData* data, const ModelBase::ParameterNameType&amp; name, modelFit::Parameter::Type dataType, const modelFit::ModelFitInfo* fitInfo)
<span style = "background-color:#fdd">    {
      assert(data);</span>

<span style = "background-color:#fdd">      if (!data)</span>
      {
<span style = "background-color:#fdd">        mitkThrow() &lt;&lt; "Cannot add model or fit properties to data instance. Passed data instance is null. parameter name:" &lt;&lt; name;</span>
      }

<span style = "background-color:#fdd">      if (!fitInfo)</span>
      {
<span style = "background-color:#fdd">        mitkThrow() &lt;&lt; "Cannot add model or fit properties to data. Passed fit info instance is null. parameter name:" &lt;&lt; name;</span>
      }

<span style = "background-color:#fdd">      data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::PARAMETER_NAME_PROPERTY_NAME().c_str(),name.c_str());</span>

<span style = "background-color:#fdd">      if (dataType == modelFit::Parameter::ParameterType)</span>
      {
<span style = "background-color:#fdd">        data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::PARAMETER_TYPE_PROPERTY_NAME().c_str(), ModelFitConstants::PARAMETER_TYPE_VALUE_PARAMETER().c_str());
      }
      else if (dataType == modelFit::Parameter::DerivedType)</span>
      {
<span style = "background-color:#fdd">        data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::PARAMETER_TYPE_PROPERTY_NAME().c_str(), ModelFitConstants::PARAMETER_TYPE_VALUE_DERIVED_PARAMETER().c_str());
      }
      else if (dataType == modelFit::Parameter::CriterionType)</span>
      {
<span style = "background-color:#fdd">        data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::PARAMETER_TYPE_PROPERTY_NAME().c_str(), ModelFitConstants::PARAMETER_TYPE_VALUE_CRITERION().c_str());
      }
      else if (dataType == modelFit::Parameter::EvaluationType)</span>
      {
<span style = "background-color:#fdd">        data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::PARAMETER_TYPE_PROPERTY_NAME().c_str(), ModelFitConstants::PARAMETER_TYPE_VALUE_EVALUATION_PARAMETER().c_str());</span>
      }


<span style = "background-color:#fdd">      if (dataType == modelFit::Parameter::ParameterType || dataType == modelFit::Parameter::DerivedType)</span>
      {
<span style = "background-color:#fdd">        modelFit::Parameter::ConstPointer param = fitInfo-&gt;GetParameter(name,dataType);</span>

<span style = "background-color:#fdd">        if (param.IsNull())</span>
        {
<span style = "background-color:#fdd">          mitkThrow() &lt;&lt; "Cannot generate model fit result data. Parameter name is not part of the model fit info. Parameter name: "&lt;&lt;name;</span>
        }

<span style = "background-color:#fdd">        if (!param-&gt;unit.empty())</span>
        {
<span style = "background-color:#fdd">          data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::PARAMETER_UNIT_PROPERTY_NAME().c_str(), param-&gt;unit.c_str());</span>
        }

<span style = "background-color:#fdd">        if (param-&gt;scale != 1.0)</span>
        {
<span style = "background-color:#fdd">          data-&gt;GetPropertyList()-&gt;SetFloatProperty(ModelFitConstants::PARAMETER_SCALE_PROPERTY_NAME().c_str(), param-&gt;scale);</span>
        }
<span style = "background-color:#fdd">      }</span>

<span style = "background-color:#fdd">    }</span>

    void AdaptDataPropertyToModelFit(mitk::BaseData* data, const modelFit::ModelFitInfo* fitInfo)
<span style = "background-color:#fdd">    {
      assert(data);</span>

<span style = "background-color:#fdd">      if (!data)</span>
      {
<span style = "background-color:#fdd">        mitkThrow() &lt;&lt; "Cannot add model or fit properties to data. Passed data instance is null.";</span>
      }

<span style = "background-color:#fdd">      if (!fitInfo)</span>
      {
<span style = "background-color:#fdd">        mitkThrow() &lt;&lt; "Cannot add model or fit properties to data. Passed model traits instance is null.";</span>
      }

      //model section
<span style = "background-color:#fdd">      data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::MODEL_TYPE_PROPERTY_NAME().c_str(), fitInfo-&gt;modelType.c_str());
      data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::MODEL_NAME_PROPERTY_NAME().c_str(), fitInfo-&gt;modelName.c_str());</span>

<span style = "background-color:#fdd">      data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::MODEL_FUNCTION_CLASS_PROPERTY_NAME().c_str(), fitInfo-&gt;functionClassID.c_str());
      if(!(fitInfo-&gt;function.empty()))</span>
      {
<span style = "background-color:#fdd">        data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::MODEL_FUNCTION_PROPERTY_NAME().c_str(), fitInfo-&gt;function.c_str());
        data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::MODEL_X_PROPERTY_NAME().c_str(), fitInfo-&gt;x.c_str());</span>
      }

      //axis section
<span style = "background-color:#fdd">      if (!fitInfo-&gt;xAxisName.empty())</span>
      {
<span style = "background-color:#fdd">        data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::XAXIS_NAME_PROPERTY_NAME().c_str(), fitInfo-&gt;xAxisName.c_str());</span>
      }

<span style = "background-color:#fdd">      if (!fitInfo-&gt;xAxisUnit.empty())</span>
      {
<span style = "background-color:#fdd">        data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::XAXIS_UNIT_PROPERTY_NAME().c_str(), fitInfo-&gt;xAxisUnit.c_str());</span>
      }

<span style = "background-color:#fdd">      if (!fitInfo-&gt;yAxisName.empty())</span>
      {
<span style = "background-color:#fdd">        data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::YAXIS_NAME_PROPERTY_NAME().c_str(), fitInfo-&gt;yAxisName.c_str());</span>
      }

<span style = "background-color:#fdd">      if (!fitInfo-&gt;yAxisUnit.empty())</span>
      {
<span style = "background-color:#fdd">        data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::YAXIS_UNIT_PROPERTY_NAME().c_str(), fitInfo-&gt;yAxisUnit.c_str());</span>
      }

      //fit section
<span style = "background-color:#fdd">      data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::FIT_UID_PROPERTY_NAME().c_str(), fitInfo-&gt;uid.c_str());
      data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::FIT_NAME_PROPERTY_NAME().c_str(), fitInfo-&gt;fitName.c_str());
      data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::FIT_TYPE_PROPERTY_NAME().c_str(), fitInfo-&gt;fitType.c_str());</span>

<span style = "background-color:#fdd">      const auto rule = ModelFitResultRelationRule::New();
      rule-&gt;Connect(dynamic_cast&lt;Image*&gt;(data), fitInfo-&gt;inputImage);</span>

<span style = "background-color:#fdd">      if (fitInfo-&gt;inputData.GetLookupTable().size() &gt; 0)</span>
      {
<span style = "background-color:#fdd">        mitk::ScalarListLookupTableProperty::Pointer inputDataProp = mitk::ScalarListLookupTableProperty::New();
        inputDataProp-&gt;SetValue(fitInfo-&gt;inputData);</span>

<span style = "background-color:#fdd">        data-&gt;SetProperty(ModelFitConstants::FIT_INPUT_DATA_PROPERTY_NAME().c_str(), inputDataProp);
      }</span>

<span style = "background-color:#fdd">      if (!fitInfo-&gt;roiUID.empty())</span>
      {
<span style = "background-color:#fdd">        data-&gt;GetPropertyList()-&gt;SetStringProperty(ModelFitConstants::FIT_INPUT_ROIUID_PROPERTY_NAME().c_str(), fitInfo-&gt;roiUID.c_str());</span>
      }

<span style = "background-color:#fdd">      data-&gt;SetProperty(ModelFitConstants::FIT_STATIC_PARAMETERS_PROPERTY_NAME().c_str(), ConvertStaticParametersToProperty(fitInfo-&gt;staticParamMap));
    }</span>

    mitk::DataNode::Pointer CreateNode(const ModelBase::ParameterNameType&amp; name, Image* parameterImage, const ModelFitInfo* fitInfo)
<span style = "background-color:#fdd">    {
      if (!parameterImage)</span>
      {
<span style = "background-color:#fdd">        mitkThrow() &lt;&lt; "Cannot generate model fit result node. Passed parameterImage is null. parameter name: "&lt;&lt;name;</span>
      }

<span style = "background-color:#fdd">      if (!fitInfo)</span>
      {
<span style = "background-color:#fdd">        mitkThrow() &lt;&lt; "Cannot generate model fit result node. Passed model traits instance is null. parameter name: "&lt;&lt;name;</span>
      }

<span style = "background-color:#fdd">      DataNode::Pointer result = DataNode::New();</span>

<span style = "background-color:#fdd">      result-&gt;SetData(parameterImage);</span>

<span style = "background-color:#fdd">      std::string nodeName = name;</span>

<span style = "background-color:#fdd">      if (!fitInfo-&gt;fitName.empty())</span>
      {
<span style = "background-color:#fdd">        nodeName = fitInfo-&gt;fitName + "_" + nodeName;</span>
      }

<span style = "background-color:#fdd">      result-&gt;SetName(nodeName);</span>

<span style = "background-color:#fdd">      result-&gt;SetVisibility(false);</span>

<span style = "background-color:#fdd">      return result;
    }</span>
  }
}

mitk::ScalarListLookupTableProperty::Pointer mitk::modelFit::ConvertStaticParametersToProperty(const mitk::modelFit::StaticParameterMap&amp; params)
<span style = "background-color:#fdd">{
  mitk::ScalarListLookupTableProperty::Pointer result = mitk::ScalarListLookupTableProperty::New();</span>

<span style = "background-color:#fdd">  ScalarListLookupTable table;</span>

<span style = "background-color:#fdd">  for(mitk::modelFit::StaticParameterMap::const_iterator pos = params.begin(); pos != params.end(); ++pos)</span>
  {
<span style = "background-color:#fdd">    table.SetTableValue(pos-&gt;first,pos-&gt;second);
  }</span>

<span style = "background-color:#fdd">  result-&gt;SetValue(table);</span>

<span style = "background-color:#fdd">  return result;
}</span>

MITKMODELFIT_EXPORT void mitk::modelFit::SetModelFitDataProperties(mitk::BaseData* data, const ModelBase::ParameterNameType&amp; name, modelFit::Parameter::Type dataType, const modelFit::ModelFitInfo* fitInfo)
<span style = "background-color:#fdd">{
  AdaptDataPropertyToModelFit(data, fitInfo);
  AdaptDataPropertyToParameter(data, name, dataType, fitInfo);
}</span>

MITKMODELFIT_EXPORT mitk::DataNode::Pointer mitk::modelFit::CreateResultNode( const ModelBase::ParameterNameType&amp; name, modelFit::Parameter::Type nodeType, Image* parameterImage, const ModelFitInfo* modelFitInfo)
<span style = "background-color:#fdd">{
  if (!parameterImage)</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cannot generate model fit result node. Passed parameterImage is null. parameter name: "&lt;&lt;name;</span>
  }

<span style = "background-color:#fdd">  if (!modelFitInfo)</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cannot generate model fit result node. Passed model fit info instance is null. parameter name: "&lt;&lt;name;</span>
  }

<span style = "background-color:#fdd">  DataNode::Pointer result = CreateNode(name, parameterImage, modelFitInfo);
  SetModelFitDataProperties(parameterImage, name, nodeType, modelFitInfo);</span>

  // Set DICOM properties, paramap-secific (DICOMPM) and general properties from source data (DICOMQI)
<span style = "background-color:#fdd">  mitk::DICOMQIPropertyHelper::DeriveDICOMSourceProperties(modelFitInfo-&gt;inputImage, parameterImage);
  mitk::DICOMPMPropertyHelper::DeriveDICOMPMProperties(parameterImage);</span>

<span style = "background-color:#fdd">  return result;
}</span>

MITKMODELFIT_EXPORT mitk::modelFit::ModelFitResultNodeVectorType mitk::modelFit::CreateResultNodeMap( const ModelFitResultImageMapType&amp; results, const ModelFitResultImageMapType&amp; derivedResults, const ModelFitResultImageMapType&amp; criterionResults, const ModelFitResultImageMapType&amp; evaluationResults, const ModelFitInfo* fitInfo)
<span style = "background-color:#fdd">{
  if (!fitInfo)</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cannot store model fit results in data storage. Passed model traits instance is null.";</span>
  }

<span style = "background-color:#fdd">  ModelFitResultNodeVectorType nodes;</span>

<span style = "background-color:#fdd">  for (ModelFitResultImageMapType::const_iterator pos = results.begin(); pos!=results.end(); ++pos)</span>
  {
<span style = "background-color:#fdd">    DataNode::Pointer newNode = CreateResultNode(pos-&gt;first, modelFit::Parameter::ParameterType, pos-&gt;second, fitInfo);
    nodes.push_back(newNode);
  }</span>

<span style = "background-color:#fdd">  for (ModelFitResultImageMapType::const_iterator pos = derivedResults.begin(); pos!=derivedResults.end(); ++pos)</span>
  {
<span style = "background-color:#fdd">    DataNode::Pointer newNode = CreateResultNode(pos-&gt;first, modelFit::Parameter::DerivedType, pos-&gt;second, fitInfo);
    nodes.push_back(newNode);
  }</span>

<span style = "background-color:#fdd">  for (ModelFitResultImageMapType::const_iterator pos = criterionResults.begin(); pos!=criterionResults.end(); ++pos)</span>
  {
<span style = "background-color:#fdd">    DataNode::Pointer newNode = CreateResultNode(pos-&gt;first, modelFit::Parameter::CriterionType, pos-&gt;second, fitInfo);
    nodes.push_back(newNode);
  }</span>

<span style = "background-color:#fdd">  for (ModelFitResultImageMapType::const_iterator pos = evaluationResults.begin(); pos!=evaluationResults.end(); ++pos)</span>
  {
<span style = "background-color:#fdd">    DataNode::Pointer newNode = CreateResultNode(pos-&gt;first, modelFit::Parameter::EvaluationType, pos-&gt;second, fitInfo);
    nodes.push_back(newNode);
  }</span>

<span style = "background-color:#fdd">  return nodes;
}</span>

MITKMODELFIT_EXPORT void mitk::modelFit::StoreResultsInDataStorage(DataStorage* storage, const ModelFitResultNodeVectorType&amp; resultNodes, DataNode* parentNode)
<span style = "background-color:#fdd">{
  if (!storage)</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cannot store model fit results in data storage. Passed storage is null.";</span>
  }

<span style = "background-color:#fdd">  for (ModelFitResultNodeVectorType::const_iterator pos = resultNodes.begin(); pos!=resultNodes.end(); ++pos)</span>
  {
<span style = "background-color:#fdd">    storage-&gt;Add(*pos,parentNode);
  }
}</span>
</pre>
	</body>
</html>
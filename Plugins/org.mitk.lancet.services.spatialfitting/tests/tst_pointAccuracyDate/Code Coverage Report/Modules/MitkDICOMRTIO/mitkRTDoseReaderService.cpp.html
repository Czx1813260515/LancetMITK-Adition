<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkRTDoseReaderService.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/


#include &lt;mitkRTDoseReaderService.h&gt;

#include &lt;mitkLexicalCast.h&gt;

#include &lt;mitkImageAccessByItk.h&gt;
#include &lt;mitkImageCast.h&gt;
#include &lt;mitkDICOMFileReaderSelector.h&gt;
#include &lt;mitkDICOMFileReader.h&gt;
#include &lt;mitkRTConstants.h&gt;
#include &lt;mitkImageStatisticsHolder.h&gt;
#include &lt;mitkDICOMTagPath.h&gt;
#include &lt;mitkDICOMDCMTKTagScanner.h&gt;
#include &lt;mitkDICOMRTMimeTypes.h&gt;
#include &lt;mitkDICOMIOHelper.h&gt;
#include &lt;mitkProperties.h&gt;
#include &lt;mitkDICOMProperty.h&gt;

#include &lt;dcmtk/dcmrt/drtdose.h&gt;

#include &lt;itkShiftScaleImageFilter.h&gt;
#include &lt;itkCastImageFilter.h&gt;

namespace mitk
{

<span style = "background-color:#dfd">  RTDoseReaderService::RTDoseReaderService() : AbstractFileReader(CustomMimeType(mitk::DICOMRTMimeTypes::DICOMRT_DOSE_MIMETYPE_NAME()), mitk::DICOMRTMimeTypes::DICOMRT_DOSE_MIMETYPE_DESCRIPTION()) {
    m_FileReaderServiceReg = RegisterService();
  }</span>

<span style = "background-color:#fdd">  RTDoseReaderService::RTDoseReaderService(const RTDoseReaderService&amp; other) : mitk::AbstractFileReader(other)
  {</span>

<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#dfd">  RTDoseReaderService::~RTDoseReaderService() {}</span>

  template&lt;typename TPixel, unsigned int VImageDimension&gt;
  void RTDoseReaderService::MultiplyGridScaling(itk::Image&lt;TPixel, VImageDimension&gt;* image, float gridscale)
<span style = "background-color:#fdd">  {</span>
    typedef itk::Image&lt;Float32, VImageDimension&gt; OutputImageType;
    typedef itk::Image&lt;TPixel, VImageDimension&gt; InputImageType;

    typedef itk::CastImageFilter&lt;InputImageType, OutputImageType&gt; CastFilterType;
    typedef itk::ShiftScaleImageFilter&lt;OutputImageType, OutputImageType&gt; ScaleFilterType;
<span style = "background-color:#fdd">    typename CastFilterType::Pointer castFilter = CastFilterType::New();
    typename ScaleFilterType::Pointer scaleFilter = ScaleFilterType::New();</span>

<span style = "background-color:#fdd">    castFilter-&gt;SetInput(image);
    scaleFilter-&gt;SetInput(castFilter-&gt;GetOutput());
    scaleFilter-&gt;SetScale(gridscale);
    scaleFilter-&gt;Update();
    typename OutputImageType::Pointer scaledOutput = scaleFilter-&gt;GetOutput();
    this-&gt;scaledDoseImage = mitk::Image::New();</span>

<span style = "background-color:#fdd">    mitk::CastToMitkImage(scaledOutput, this-&gt;scaledDoseImage);
  }</span>

  std::vector&lt;itk::SmartPointer&lt;BaseData&gt; &gt; RTDoseReaderService::DoRead()
<span style = "background-color:#fdd">  {
    std::vector&lt;itk::SmartPointer&lt;mitk::BaseData&gt; &gt; result;</span>


<span style = "background-color:#fdd">    mitk::IDICOMTagsOfInterest* toiSrv = GetDicomTagsOfInterestService();</span>

<span style = "background-color:#fdd">    auto tagsOfInterest = toiSrv-&gt;GetTagsOfInterest();</span>

<span style = "background-color:#fdd">    DICOMTagPathList tagsOfInterestList;
    for (const auto&amp; tag : tagsOfInterest) {
      tagsOfInterestList.push_back(tag.first);
    }</span>

<span style = "background-color:#fdd">    std::string location = GetInputLocation();
    mitk::DICOMFileReaderSelector::Pointer selector = mitk::DICOMFileReaderSelector::New();
    selector-&gt;LoadBuiltIn3DConfigs();
    selector-&gt;SetInputFiles({ location });</span>

<span style = "background-color:#fdd">    mitk::DICOMFileReader::Pointer reader = selector-&gt;GetFirstReaderWithMinimumNumberOfOutputImages();
    reader-&gt;SetAdditionalTagsOfInterest(toiSrv-&gt;GetTagsOfInterest());
    reader-&gt;SetTagLookupTableToPropertyFunctor(mitk::GetDICOMPropertyForDICOMValuesFunctor);</span>

<span style = "background-color:#fdd">    reader-&gt;SetInputFiles({ location });
    reader-&gt;AnalyzeInputFiles();
    reader-&gt;LoadImages();</span>

<span style = "background-color:#fdd">    if (reader-&gt;GetNumberOfOutputs() == 0) {
      MITK_ERROR &lt;&lt; "Could not determine a DICOM reader for this file" &lt;&lt; std::endl;
      return result;</span>
    }

<span style = "background-color:#fdd">    mitk::DICOMDCMTKTagScanner::Pointer scanner = mitk::DICOMDCMTKTagScanner::New();
    scanner-&gt;SetInputFiles({ location });
    scanner-&gt;AddTagPaths(tagsOfInterestList);
    scanner-&gt;Scan();</span>

<span style = "background-color:#fdd">    mitk::DICOMDatasetAccessingImageFrameList frames = scanner-&gt;GetFrameInfoList();
    if (frames.empty()) {
      MITK_ERROR &lt;&lt; "Error reading the RTDOSE file" &lt;&lt; std::endl;
      return result;</span>
    }

<span style = "background-color:#fdd">    const mitk::DICOMImageBlockDescriptor&amp; desc = reader-&gt;GetOutput(0);</span>

<span style = "background-color:#fdd">    mitk::Image::Pointer originalImage = desc.GetMitkImage();</span>

<span style = "background-color:#fdd">    if (originalImage.IsNull())</span>
    {
<span style = "background-color:#fdd">      MITK_ERROR &lt;&lt; "Error reading the RTDOSE file in mitk::DicomFileReader" &lt;&lt; std::endl;
      return result;</span>
    }

<span style = "background-color:#fdd">    DcmFileFormat fileformat;
    OFCondition outp = fileformat.loadFile(location.c_str(), EXS_Unknown);
    if (outp.bad())</span>
    {
<span style = "background-color:#fdd">      MITK_ERROR &lt;&lt; "Error reading the RTDOSE file in DCMTK" &lt;&lt; std::endl;
      return result;</span>
    }
<span style = "background-color:#fdd">    DcmDataset *dataset = fileformat.getDataset();</span>

<span style = "background-color:#fdd">    DRTDoseIOD doseObject;
    OFCondition DCMTKresult = doseObject.read(*dataset);</span>

<span style = "background-color:#fdd">    if (DCMTKresult.bad())</span>
    {
<span style = "background-color:#fdd">      MITK_ERROR &lt;&lt; "Error reading the RTDOSE file in DCMTK" &lt;&lt; std::endl;
      return result;</span>
    }

<span style = "background-color:#fdd">    auto findingsGridScaling = frames.front()-&gt;GetTagValueAsString(DICOMTagPath(0x3004, 0x000e)); //(0x3004, 0x000e) is grid scaling</span>

    double gridScaling;
<span style = "background-color:#fdd">    if (findingsGridScaling.empty()) {
      MITK_ERROR &lt;&lt; "Could not find DoseGridScaling tag" &lt;&lt; std::endl;
      return result;
    }</span>
    else {
<span style = "background-color:#fdd">      gridScaling = boost::lexical_cast&lt;double&gt;(findingsGridScaling.front().value);</span>
    }

<span style = "background-color:#fdd">    AccessByItk_1(originalImage, MultiplyGridScaling, gridScaling);</span>

<span style = "background-color:#fdd">    auto statistics = this-&gt;scaledDoseImage-&gt;GetStatistics();
    double maxDose = statistics-&gt;GetScalarValueMax();</span>

<span style = "background-color:#fdd">    this-&gt;scaledDoseImage-&gt;SetPropertyList(originalImage-&gt;GetPropertyList());
    this-&gt;scaledDoseImage-&gt;SetProperty(mitk::RTConstants::PRESCRIBED_DOSE_PROPERTY_NAME.c_str(), mitk::DoubleProperty::New(0.8*maxDose));
    auto findings = ExtractPathsOfInterest(tagsOfInterestList, frames);
    SetProperties(this-&gt;scaledDoseImage, findings);</span>

<span style = "background-color:#fdd">    result.push_back(this-&gt;scaledDoseImage.GetPointer());
    return result;
  }</span>

  RTDoseReaderService* RTDoseReaderService::Clone() const
<span style = "background-color:#fdd">  {
    return new RTDoseReaderService(*this);
  }</span>
}</pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkMovieGenerator.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkMovieGenerator.h"
#include "mitkConfig.h"
#include &lt;mitkRenderingManager.h&gt;
#include "vtk_glew.h"

#if WIN32
#ifndef __GNUC__
//#if ! (_MSC_VER &gt;= 1400)
#include "mitkMovieGeneratorWin32.h"
//#endif
#else
#include "GL/glext.h"
#endif
#endif
#ifndef GL_BGR
#define GL_BGR GL_BGR_EXT
#endif

mitk::MovieGenerator::MovieGenerator()
<span style = "background-color:#fdd">  : m_stepper(nullptr), m_renderer(nullptr), m_width(0), m_height(0), m_initialized(false), m_FrameRate(20)
{
  m_fileName[0] = 0;
}</span>

mitk::MovieGenerator::Pointer mitk::MovieGenerator::New()
<span style = "background-color:#fdd">{
  Pointer smartPtr;
  MovieGenerator *rawPtr = ::itk::ObjectFactory&lt;MovieGenerator&gt;::Create();
  if (rawPtr == nullptr)</span>
  {
#ifdef WIN32
#ifndef __GNUC__
    //#if ! (_MSC_VER &gt;= 1400)
<span style = "background-color:#fdd">    mitk::MovieGenerator::Pointer wp = static_cast&lt;mitk::MovieGenerator *&gt;(mitk::MovieGeneratorWin32::New());
    return wp;</span>
//#endif
#endif
#endif
  }
<span style = "background-color:#fdd">  smartPtr = rawPtr;
  if (rawPtr != nullptr)
    rawPtr-&gt;UnRegister();
  return smartPtr;
}</span>

bool mitk::MovieGenerator::WriteMovie()
<span style = "background-color:#fdd">{
  bool ok = false;
  if (m_stepper)</span>
  {
<span style = "background-color:#fdd">    if (m_renderer)
      m_renderer-&gt;GetRenderWindow()-&gt;MakeCurrent();</span>
    // m_stepper-&gt;First();
<span style = "background-color:#fdd">    RenderingManager::GetInstance()-&gt;ForceImmediateUpdate(m_renderer-&gt;GetRenderWindow());</span>

<span style = "background-color:#fdd">    ok = InitGenerator();
    if (!ok)</span>
    {
<span style = "background-color:#fdd">      TerminateGenerator();
      return false;</span>
    }
<span style = "background-color:#fdd">    int imgSize = 3 * m_width * m_height;
    printf("Video size = %i x %i\n", m_width, m_height);
    auto *data = new GLbyte[imgSize];</span>

    // duplicate steps if pingPong option is switched to on.
<span style = "background-color:#fdd">    unsigned int numOfSteps = m_stepper-&gt;GetSteps();
    if (m_stepper-&gt;GetPingPong())
      numOfSteps *= 2;</span>

<span style = "background-color:#fdd">    for (unsigned int i = 0; i &lt; numOfSteps; i++)</span>
    {
<span style = "background-color:#fdd">      if (m_renderer)
        m_renderer-&gt;GetRenderWindow()-&gt;MakeCurrent();
      RenderingManager::GetInstance()-&gt;ForceImmediateUpdate(m_renderer-&gt;GetRenderWindow());
      glReadPixels(5, 5, m_width, m_height, GL_BGR, GL_UNSIGNED_BYTE, (void *)data);
      AddFrame(data);
      m_stepper-&gt;Next();
    }
    ok = TerminateGenerator();
    delete[] data;</span>
  }
<span style = "background-color:#fdd">  return ok;
}</span>

bool mitk::MovieGenerator::WriteCurrentFrameToMovie()
<span style = "background-color:#fdd">{
  if (m_renderer)</span>
  {
<span style = "background-color:#fdd">    m_renderer-&gt;GetRenderWindow()-&gt;MakeCurrent();</span>

<span style = "background-color:#fdd">    if (!m_initialized)</span>
    {
<span style = "background-color:#fdd">      RenderingManager::GetInstance()-&gt;ForceImmediateUpdate(m_renderer-&gt;GetRenderWindow());
      m_initialized = InitGenerator();</span>
    }
<span style = "background-color:#fdd">    if (!m_initialized)</span>
    {
<span style = "background-color:#fdd">      TerminateGenerator();
      return false;</span>
    }
<span style = "background-color:#fdd">    int imgSize = 3 * m_width * m_height;
    auto *data = new GLbyte[imgSize];</span>

<span style = "background-color:#fdd">    RenderingManager::GetInstance()-&gt;ForceImmediateUpdate(m_renderer-&gt;GetRenderWindow());
    glReadPixels(5, 5, m_width, m_height, GL_BGR, GL_UNSIGNED_BYTE, (void *)data);
    AddFrame(data);
    delete[] data;</span>
  }
<span style = "background-color:#fdd">  return true;
}</span>

void mitk::MovieGenerator::ReleaseMovieWriter()
<span style = "background-color:#fdd">{
  TerminateGenerator();
  m_initialized = false;
}</span>

void mitk::MovieGenerator::SetFrameRate(unsigned int rate)
<span style = "background-color:#fdd">{
  m_FrameRate = rate;
}</span>

unsigned int mitk::MovieGenerator::GetFrameRate()
<span style = "background-color:#fdd">{
  return m_FrameRate;
}</span></pre>
	</body>
</html>
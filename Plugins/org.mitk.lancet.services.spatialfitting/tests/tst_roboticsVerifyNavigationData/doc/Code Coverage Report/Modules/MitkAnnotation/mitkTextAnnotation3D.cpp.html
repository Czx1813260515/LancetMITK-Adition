<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkTextAnnotation3D.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkTextAnnotation3D.h"
#include &lt;vtkCamera.h&gt;
#include &lt;vtkFollower.h&gt;
#include &lt;vtkMath.h&gt;
#include &lt;vtkPolyDataMapper.h&gt;
#include &lt;vtkProperty.h&gt;
#include &lt;vtkTextActor3D.h&gt;
#include &lt;vtkTextProperty.h&gt;
#include &lt;vtkVectorText.h&gt;

mitk::TextAnnotation3D::TextAnnotation3D()
<span style = "background-color:#fdd">{
  mitk::Point3D position;
  position.Fill(0);
  this-&gt;SetPosition3D(position);
  this-&gt;SetOffsetVector(position);
  this-&gt;SetText("");
  this-&gt;SetFontSize(20);
  this-&gt;SetColor(1.0, 1.0, 1.0);
}</span>

mitk::TextAnnotation3D::~TextAnnotation3D()
<span style = "background-color:#fdd">{
  for (BaseRenderer *renderer : m_LSH.GetRegisteredBaseRenderer())</span>
  {
<span style = "background-color:#fdd">    if (renderer)</span>
    {
<span style = "background-color:#fdd">      this-&gt;RemoveFromBaseRenderer(renderer);
    }
  }
}</span>

mitk::TextAnnotation3D::LocalStorage::~LocalStorage()
<span style = "background-color:#fdd">{
}</span>

mitk::TextAnnotation3D::LocalStorage::LocalStorage()
<span style = "background-color:#fdd">{</span>
  // Create some text
<span style = "background-color:#fdd">  m_textSource = vtkSmartPointer&lt;vtkVectorText&gt;::New();</span>

  // Create a mapper
<span style = "background-color:#fdd">  vtkSmartPointer&lt;vtkPolyDataMapper&gt; mapper = vtkSmartPointer&lt;vtkPolyDataMapper&gt;::New();
  mapper-&gt;SetInputConnection(m_textSource-&gt;GetOutputPort());</span>

  // Create a subclass of vtkActor: a vtkFollower that remains facing the camera
<span style = "background-color:#fdd">  m_follower = vtkSmartPointer&lt;vtkFollower&gt;::New();
  m_follower-&gt;SetMapper(mapper);
  m_follower-&gt;GetProperty()-&gt;SetColor(1, 0, 0); // red
  m_follower-&gt;SetScale(1);
}</span>

void mitk::TextAnnotation3D::UpdateVtkAnnotation(mitk::BaseRenderer *renderer)
<span style = "background-color:#fdd">{
  LocalStorage *ls = this-&gt;m_LSH.GetLocalStorage(renderer);
  if (ls-&gt;IsGenerateDataRequired(renderer, this))</span>
  {
<span style = "background-color:#fdd">    Point3D pos3d = GetPosition3D();
    vtkRenderer *vtkRender = renderer-&gt;GetVtkRenderer();
    if (vtkRender)</span>
    {
<span style = "background-color:#fdd">      vtkCamera *camera = vtkRender-&gt;GetActiveCamera();
      ls-&gt;m_follower-&gt;SetCamera(camera);
      if (camera != nullptr)</span>
      {
        // calculate the offset relative to the camera's view direction
<span style = "background-color:#fdd">        Point3D offset = GetOffsetVector();</span>

<span style = "background-color:#fdd">        Vector3D viewUp;
        camera-&gt;GetViewUp(viewUp.GetDataPointer());
        Vector3D cameraDirection;
        camera-&gt;GetDirectionOfProjection(cameraDirection.GetDataPointer());
        Vector3D viewRight;
        vtkMath::Cross(cameraDirection.GetDataPointer(), viewUp.GetDataPointer(), viewRight.GetDataPointer());</span>

<span style = "background-color:#fdd">        pos3d = pos3d + viewRight * offset[0] + viewUp * offset[1] + cameraDirection * offset[2];</span>
      }
    }
<span style = "background-color:#fdd">    ls-&gt;m_follower-&gt;SetPosition(pos3d.GetDataPointer());
    ls-&gt;m_textSource-&gt;SetText(GetText().c_str());
    float color[3] = {1, 1, 1};
    float opacity = 1.0;
    GetColor(color);
    GetOpacity(opacity);
    ls-&gt;m_follower-&gt;GetProperty()-&gt;SetColor(color[0], color[1], color[2]);
    ls-&gt;m_follower-&gt;GetProperty()-&gt;SetOpacity(opacity);
    ls-&gt;m_follower-&gt;SetScale(this-&gt;GetFontSize());
    ls-&gt;UpdateGenerateDataTime();</span>
  }
<span style = "background-color:#fdd">}</span>

vtkProp *mitk::TextAnnotation3D::GetVtkProp(BaseRenderer *renderer) const
<span style = "background-color:#fdd">{
  LocalStorage *ls = this-&gt;m_LSH.GetLocalStorage(renderer);
  return ls-&gt;m_follower;
}</span></pre>
	</body>
</html>
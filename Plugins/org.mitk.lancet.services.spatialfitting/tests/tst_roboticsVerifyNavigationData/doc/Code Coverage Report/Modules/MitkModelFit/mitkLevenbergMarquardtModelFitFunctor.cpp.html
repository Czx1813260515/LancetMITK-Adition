<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkLevenbergMarquardtModelFitFunctor.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkLevenbergMarquardtModelFitFunctor.h"

#include "mitkSquaredDifferencesFitCostFunction.h"
#include "mitkSumOfSquaredDifferencesFitCostFunction.h"
#include &lt;chrono&gt;
#include &lt;mitkExceptionMacro.h&gt;

mitk::LevenbergMarquardtModelFitFunctor::
<span style = "background-color:#fdd">LevenbergMarquardtModelFitFunctor(): m_Epsilon(1e-5), m_GradientTolerance(1e-3),
  m_ValueTolerance(1e-5), m_Iterations(1000), m_DerivativeStepLength(1e-5),
  m_ActivateFailureThreshold(true)
{};</span>

mitk::LevenbergMarquardtModelFitFunctor::
~LevenbergMarquardtModelFitFunctor()
<span style = "background-color:#fdd">{};</span>

mitk::LevenbergMarquardtModelFitFunctor::ParameterNamesType
mitk::LevenbergMarquardtModelFitFunctor::
GetCriterionNames() const
<span style = "background-color:#fdd">{
  ParameterNamesType names;
  names.push_back("sum_diff^2");
  return names;
};</span>

mitk::LevenbergMarquardtModelFitFunctor::OutputPixelArrayType
mitk::LevenbergMarquardtModelFitFunctor::
GetCriteria(const ModelBase* model, const ParametersType&amp; parameters,
              const SignalType&amp; sample) const
<span style = "background-color:#fdd">{</span>
  ::mitk::SumOfSquaredDifferencesFitCostFunction::Pointer metric
<span style = "background-color:#fdd">    = ::mitk::SumOfSquaredDifferencesFitCostFunction::New();
  metric-&gt;SetModel(model);
  metric-&gt;SetSample(sample);</span>

<span style = "background-color:#fdd">  mitk::LevenbergMarquardtModelFitFunctor::OutputPixelArrayType result(1);
  result[0] = metric-&gt;GetValue(parameters);</span>

<span style = "background-color:#fdd">  return result;
};</span>

mitk::MVModelFitCostFunction::Pointer mitk::LevenbergMarquardtModelFitFunctor::GenerateCostFunction(
  const SignalType&amp; value, const ModelBase* model) const
<span style = "background-color:#fdd">{</span>
  ::mitk::SquaredDifferencesFitCostFunction::Pointer metric
<span style = "background-color:#fdd">    = ::mitk::SquaredDifferencesFitCostFunction::New();
  metric-&gt;SetModel(model);
  metric-&gt;SetSample(value);
  metric-&gt;SetDerivativeStepLength(m_DerivativeStepLength);</span>

<span style = "background-color:#fdd">  mitk::MVModelFitCostFunction::Pointer result = metric.GetPointer();</span>

<span style = "background-color:#fdd">  if (m_ConstraintChecker.IsNotNull())</span>
  {
    ::mitk::MVConstrainedCostFunctionDecorator::Pointer decorator
<span style = "background-color:#fdd">      = ::mitk::MVConstrainedCostFunctionDecorator::New();
    decorator-&gt;SetConstraintChecker(m_ConstraintChecker);
    decorator-&gt;SetWrappedCostFunction(metric);
    decorator-&gt;SetFailureThreshold(m_ConstraintChecker-&gt;GetFailedConstraintValue());</span>

<span style = "background-color:#fdd">    decorator-&gt;SetModel(model);
    decorator-&gt;SetSample(value);
    decorator-&gt;SetActivateFailureThreshold(m_ActivateFailureThreshold);
    result = decorator;
  }</span>

<span style = "background-color:#fdd">  return result;
};</span>

mitk::LevenbergMarquardtModelFitFunctor::ParameterNamesType
mitk::LevenbergMarquardtModelFitFunctor::DefineDebugParameterNames() const
<span style = "background-color:#fdd">{
  ParameterNamesType result;
  result.push_back("optimization_time");
  result.push_back("nr_of_iterations");
  result.push_back("stop_condition");
  if (m_ConstraintChecker.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    result.push_back("constraint_penalty_ratio");
    result.push_back("constraint_failure_ratio");
    result.push_back("constraint_last_failed_parameter");</span>
  }
<span style = "background-color:#fdd">  return result;
};</span>

mitk::LevenbergMarquardtModelFitFunctor::ParametersType
mitk::LevenbergMarquardtModelFitFunctor::
DoModelFit(const SignalType&amp; value, const ModelBase* model,
           const ModelBase::ParametersType&amp; initialParameters,
           DebugParameterMapType&amp; debugParameters) const
<span style = "background-color:#fdd">{
    std::chrono::time_point&lt;std::chrono::system_clock&gt; startTime;
    startTime = std::chrono::system_clock::now();
  ::itk::LevenbergMarquardtOptimizer::ParametersType internalInitParam = initialParameters;
  ::itk::LevenbergMarquardtOptimizer::ScalesType scales = m_Scales;</span>

<span style = "background-color:#fdd">  if (initialParameters.GetNumberOfElements() != model-&gt;GetNumberOfParameters())</span>
  {
<span style = "background-color:#fdd">    MITK_DEBUG &lt;&lt;</span>
               "Size of initial parameters of fit functor optimizer do not match number of model parameters. Renitialize parameters with 0.0.";
<span style = "background-color:#fdd">    internalInitParam.SetSize(model-&gt;GetNumberOfParameters());
    internalInitParam.Fill(0.0);</span>
  }

<span style = "background-color:#fdd">  if (m_Scales.GetNumberOfElements() != model-&gt;GetNumberOfParameters())</span>
  {
<span style = "background-color:#fdd">    MITK_DEBUG &lt;&lt;</span>
               "Size of scales of fit functor optimizer do not match number of model parameters. Reinitialize scales with 1.0.";
<span style = "background-color:#fdd">    scales.SetSize(model-&gt;GetNumberOfParameters());
    scales.Fill(1.0);</span>
  }

<span style = "background-color:#fdd">  mitk::MVModelFitCostFunction::Pointer metric = this-&gt;GenerateCostFunction(value, model);</span>

<span style = "background-color:#fdd">  ::itk::LevenbergMarquardtOptimizer::Pointer optimizer = ::itk::LevenbergMarquardtOptimizer::New();</span>

<span style = "background-color:#fdd">  optimizer-&gt;SetCostFunction(metric);
  optimizer-&gt;SetEpsilonFunction(m_Epsilon);
  optimizer-&gt;SetGradientTolerance(m_GradientTolerance);
  optimizer-&gt;SetNumberOfIterations(m_Iterations);
  optimizer-&gt;SetScales(scales);
  optimizer-&gt;SetInitialPosition(internalInitParam);</span>

<span style = "background-color:#fdd">  optimizer-&gt;StartOptimization();</span>

<span style = "background-color:#fdd">  itk::Optimizer::ParametersType position = optimizer-&gt;GetCurrentPosition();</span>

<span style = "background-color:#fdd">  std::chrono::time_point&lt;std::chrono::system_clock&gt; stopTime;
  stopTime = std::chrono::system_clock::now();
  debugParameters.clear();
  if (this-&gt;GetDebugParameterMaps())</span>
  {
<span style = "background-color:#fdd">    const auto timeDiff = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(stopTime - startTime).count();
    debugParameters.insert(std::make_pair("optimization_time", timeDiff));</span>

<span style = "background-color:#fdd">    ParameterImagePixelType value = optimizer-&gt;GetOptimizer()-&gt;get_num_iterations();
    debugParameters.insert(std::make_pair("nr_of_iterations", value));
    value = optimizer-&gt;GetOptimizer()-&gt;get_failure_code();
    debugParameters.insert(std::make_pair("stop_condition", value));</span>


<span style = "background-color:#fdd">    const ::mitk::MVConstrainedCostFunctionDecorator* decorator = dynamic_cast&lt;const ::mitk::MVConstrainedCostFunctionDecorator*&gt;(metric.GetPointer());
    if (decorator)</span>
    {
<span style = "background-color:#fdd">      value = decorator-&gt;GetPenaltyRatio();
      debugParameters.insert(std::make_pair("constraint_penalty_ratio", value));
      value = decorator-&gt;GetFailureRatio();
      debugParameters.insert(std::make_pair("constraint_failure_ratio", value));
      value = decorator-&gt;GetFailedParameter();
      debugParameters.insert(std::make_pair("constraint_last_failed_parameter", value));
    }</span>
    else
    {
<span style = "background-color:#fdd">      if (m_ConstraintChecker.IsNotNull())</span>
      {
<span style = "background-color:#fdd">        mitkThrow() &lt;&lt; "Fit functor has invalid state/wrong implementation. Constraint checker is set, but used metric seems to be no MVContstrainedCostFunctionDecorator.";</span>
      }
    }
  }

<span style = "background-color:#fdd">  return position;
};</span></pre>
	</body>
</html>
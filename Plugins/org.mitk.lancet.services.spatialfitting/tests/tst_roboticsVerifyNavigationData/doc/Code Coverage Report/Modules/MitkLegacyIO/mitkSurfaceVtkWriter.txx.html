<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkSurfaceVtkWriter.txx</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkSurfaceVtkWriter.h"
#include &lt;vtkErrorCode.h&gt;
#include &lt;vtkLinearTransform.h&gt;
#include &lt;vtkPolyData.h&gt;
#include &lt;vtkTransformPolyDataFilter.h&gt;

#include &lt;sstream&gt;
#include &lt;cstdio&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/types.h&gt;

template &lt;class VTKWRITER&gt;
<span style = "background-color:#fdd">mitk::SurfaceVtkWriter&lt;VTKWRITER&gt;::SurfaceVtkWriter() : m_WriterWriteHasReturnValue(false)
{
  this-&gt;SetNumberOfRequiredInputs(1);</span>

<span style = "background-color:#fdd">  m_VtkWriter = vtkSmartPointer&lt;VtkWriterType&gt;::New();</span>

  // enable to write ascii-formatted-file
  // m_VtkWriter-&gt;SetFileTypeToASCII();

<span style = "background-color:#fdd">  SetDefaultExtension(); // and information about the Writer's Write() method
}</span>

template &lt;class VTKWRITER&gt;
mitk::SurfaceVtkWriter&lt;VTKWRITER&gt;::~SurfaceVtkWriter()
<span style = "background-color:#fdd">{
}</span>

template &lt;class VTKWRITER&gt;
void mitk::SurfaceVtkWriter&lt;VTKWRITER&gt;::SetDefaultExtension()
{
  m_Extension = ".vtk";
}

template &lt;class VTKWRITER&gt;
void mitk::SurfaceVtkWriter&lt;VTKWRITER&gt;::ExecuteWrite(VtkWriterType *vtkWriter)
<span style = "background-color:#fdd">{
  if (vtkWriter-&gt;Write() == 0 || vtkWriter-&gt;GetErrorCode() != 0)</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro(&lt;&lt; "Error during surface writing: "</span>
                      &lt;&lt; vtkErrorCode::GetStringFromErrorCode(vtkWriter-&gt;GetErrorCode()));
  }
<span style = "background-color:#fdd">}</span>

template &lt;class VTKWRITER&gt;
void mitk::SurfaceVtkWriter&lt;VTKWRITER&gt;::GenerateData()
<span style = "background-color:#fdd">{
  if (m_FileName == "")</span>
  {
<span style = "background-color:#fdd">    itkWarningMacro(&lt;&lt; "Sorry, filename has not been set!");
    return;</span>
  }

<span style = "background-color:#fdd">  mitk::Surface::Pointer input = const_cast&lt;mitk::Surface *&gt;(this-&gt;GetInput());</span>

<span style = "background-color:#fdd">  vtkSmartPointer&lt;vtkTransformPolyDataFilter&gt; transformPolyData = vtkSmartPointer&lt;vtkTransformPolyDataFilter&gt;::New();</span>
  vtkPolyData *polyData;
  BaseGeometry *geometry;

<span style = "background-color:#fdd">  unsigned int t, timesteps = input-&gt;GetTimeGeometry()-&gt;CountTimeSteps();</span>

<span style = "background-color:#fdd">  for (t = 0; t &lt; timesteps; ++t)</span>
  {
    // surfaces do not have to exist in all timeteps; therefor, only write valid surfaces
<span style = "background-color:#fdd">    if (input-&gt;GetVtkPolyData(t) == nullptr)
      continue;</span>

<span style = "background-color:#fdd">    std::ostringstream filename;
    filename.imbue(::std::locale::classic());
    geometry = input-&gt;GetGeometry(t);
    if (timesteps &gt; 1)</span>
    {
<span style = "background-color:#fdd">      if (input-&gt;GetTimeGeometry()-&gt;IsValidTimeStep(t))</span>
      {
<span style = "background-color:#fdd">        const TimeBounds timebounds = input-&gt;GetTimeGeometry()-&gt;GetTimeBounds(t);
        filename &lt;&lt; m_FileName.c_str() &lt;&lt; "_S" &lt;&lt; std::setprecision(0) &lt;&lt; timebounds[0] &lt;&lt; "_E" &lt;&lt; std::setprecision(0)</span>
                 &lt;&lt; timebounds[1] &lt;&lt; "_T" &lt;&lt; t &lt;&lt; m_Extension;
<span style = "background-color:#fdd">      }</span>
      else
      {
<span style = "background-color:#fdd">        itkWarningMacro(&lt;&lt; "Error on write: TimeGeometry invalid of surface " &lt;&lt; filename.str() &lt;&lt; ".");
        filename &lt;&lt; m_FileName.c_str() &lt;&lt; "_T" &lt;&lt; t &lt;&lt; m_Extension;</span>
      }
<span style = "background-color:#fdd">      m_VtkWriter-&gt;SetFileName(filename.str().c_str());
    }</span>
    else
<span style = "background-color:#fdd">      m_VtkWriter-&gt;SetFileName(m_FileName.c_str());</span>

<span style = "background-color:#fdd">    transformPolyData-&gt;SetInputData(input-&gt;GetVtkPolyData(t));
    transformPolyData-&gt;SetTransform(geometry-&gt;GetVtkTransform());
    transformPolyData-&gt;UpdateWholeExtent();
    polyData = transformPolyData-&gt;GetOutput();</span>

<span style = "background-color:#fdd">    m_VtkWriter-&gt;SetInputData(polyData);</span>

<span style = "background-color:#fdd">    ExecuteWrite(m_VtkWriter);
  }</span>

<span style = "background-color:#fdd">  m_MimeType = "application/MITK.Surface";
}</span>

template &lt;class VTKWRITER&gt;
void mitk::SurfaceVtkWriter&lt;VTKWRITER&gt;::SetInput(mitk::Surface *surface)
<span style = "background-color:#fdd">{
  this-&gt;ProcessObject::SetNthInput(0, surface);
}</span>

template &lt;class VTKWRITER&gt;
const mitk::Surface *mitk::SurfaceVtkWriter&lt;VTKWRITER&gt;::GetInput()
<span style = "background-color:#fdd">{
  if (this-&gt;GetNumberOfInputs() &lt; 1)</span>
  {
<span style = "background-color:#fdd">    return nullptr;
  }</span>
  else
  {
<span style = "background-color:#fdd">    return static_cast&lt;const Surface *&gt;(this-&gt;ProcessObject::GetInput(0));</span>
  }
<span style = "background-color:#fdd">}</span>

template &lt;class VTKWRITER&gt;
bool mitk::SurfaceVtkWriter&lt;VTKWRITER&gt;::CanWriteDataType(DataNode *input)
<span style = "background-color:#fdd">{
  if (input)</span>
  {
<span style = "background-color:#fdd">    BaseData *data = input-&gt;GetData();
    if (data)</span>
    {
<span style = "background-color:#fdd">      Surface::Pointer surface = dynamic_cast&lt;Surface *&gt;(data);
      if (surface.IsNotNull())</span>
      {
<span style = "background-color:#fdd">        SetDefaultExtension();
        return true;</span>
      }
<span style = "background-color:#fdd">    }</span>
  }
<span style = "background-color:#fdd">  return false;
}</span>

template &lt;class VTKWRITER&gt;
void mitk::SurfaceVtkWriter&lt;VTKWRITER&gt;::SetInput(DataNode *input)
<span style = "background-color:#fdd">{
  if (input &amp;&amp; CanWriteDataType(input))
    SetInput(dynamic_cast&lt;Surface *&gt;(input-&gt;GetData()));
}</span>

template &lt;class VTKWRITER&gt;
std::string mitk::SurfaceVtkWriter&lt;VTKWRITER&gt;::GetWritenMIMEType()
<span style = "background-color:#fdd">{
  return m_MimeType;
}</span>

template &lt;class VTKWRITER&gt;
std::string mitk::SurfaceVtkWriter&lt;VTKWRITER&gt;::GetFileExtension()
<span style = "background-color:#fdd">{
  return m_Extension;
}</span></pre>
	</body>
</html>
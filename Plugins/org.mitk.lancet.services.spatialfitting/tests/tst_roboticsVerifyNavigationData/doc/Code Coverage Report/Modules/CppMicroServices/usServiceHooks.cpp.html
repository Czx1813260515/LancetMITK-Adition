<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>usServiceHooks.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

  Library: CppMicroServices

  Copyright (c) German Cancer Research Center (DKFZ)
  All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

============================================================================*/

#include "usServiceHooks_p.h"

#include "usGetModuleContext.h"
#include "usCoreModuleContext_p.h"
#include "usServiceEventListenerHook.h"
#include "usServiceFindHook.h"
#include "usServiceListenerHook.h"
#include "usServiceReferenceBasePrivate.h"

US_BEGIN_NAMESPACE

ServiceHooks::ServiceHooks(CoreModuleContext* coreCtx)
<span style = "background-color:#dfd">  : coreCtx(coreCtx)
  , listenerHookTracker(nullptr)
  , bOpen(false)
{
}</span>

ServiceHooks::~ServiceHooks()
<span style = "background-color:#dfd">{
  this-&gt;Close();
}</span>

ServiceHooks::TrackedType ServiceHooks::AddingService(const ServiceReferenceType&amp; reference)
<span style = "background-color:#fdd">{
  ServiceListenerHook* lh = GetModuleContext()-&gt;GetService(reference);</span>
  try
  {
<span style = "background-color:#fdd">    lh-&gt;Added(coreCtx-&gt;listeners.GetListenerInfoCollection());</span>
  }
  catch (const std::exception&amp; e)
<span style = "background-color:#fdd">  {
    US_WARN &lt;&lt; "Failed to call listener hook  #" &lt;&lt; reference.GetProperty(ServiceConstants::SERVICE_ID()).ToString()</span>
               &lt;&lt; ": " &lt;&lt; e.what();
<span style = "background-color:#fdd">  }</span>
  catch (...)
<span style = "background-color:#fdd">  {
    US_WARN &lt;&lt; "Failed to call listener hook  #" &lt;&lt; reference.GetProperty(ServiceConstants::SERVICE_ID()).ToString()</span>
               &lt;&lt; ": unknown exception type";
<span style = "background-color:#fdd">  }
  return lh;
}</span>

void ServiceHooks::ModifiedService(const ServiceReferenceType&amp; /*reference*/, TrackedType /*service*/)
<span style = "background-color:#fdd">{</span>
  // noop
<span style = "background-color:#fdd">}</span>

void ServiceHooks::RemovedService(const ServiceReferenceType&amp; reference, TrackedType /*service*/)
<span style = "background-color:#fdd">{
  GetModuleContext()-&gt;UngetService(reference);
}</span>

void ServiceHooks::Open()
<span style = "background-color:#dfd">{
  US_UNUSED(Lock(this));</span>

<span style = "background-color:#dfd">  listenerHookTracker = new ServiceTracker&lt;ServiceListenerHook&gt;(GetModuleContext(), this);
  listenerHookTracker-&gt;Open();</span>

<span style = "background-color:#dfd">  bOpen = true;
}</span>

void ServiceHooks::Close()
<span style = "background-color:#dfd">{
  US_UNUSED(Lock(this));
  if (listenerHookTracker)</span>
  {
<span style = "background-color:#dfd">    listenerHookTracker-&gt;Close();
    delete listenerHookTracker;
    listenerHookTracker = nullptr;</span>
  }

<span style = "background-color:#dfd">  bOpen = false;
}</span>

bool ServiceHooks::IsOpen() const
<span style = "background-color:#dfd">{
  US_UNUSED(Lock(this));
  return bOpen;
}</span>

void ServiceHooks::FilterServiceReferences(ModuleContext* mc, const std::string&amp; service,
                                           const std::string&amp; filter, std::vector&lt;ServiceReferenceBase&gt;&amp; refs)
<span style = "background-color:#dfd">{
  std::vector&lt;ServiceRegistrationBase&gt; srl;
  coreCtx-&gt;services.Get_unlocked(us_service_interface_iid&lt;ServiceFindHook&gt;(), srl);
  if (!srl.empty())</span>
  {
<span style = "background-color:#fdd">    ShrinkableVector&lt;ServiceReferenceBase&gt; filtered(refs);</span>

<span style = "background-color:#fdd">    std::sort(srl.begin(), srl.end());
    for (std::vector&lt;ServiceRegistrationBase&gt;::reverse_iterator fhrIter = srl.rbegin(), fhrEnd = srl.rend();
         fhrIter != fhrEnd; ++fhrIter)</span>
    {
<span style = "background-color:#fdd">      ServiceReference&lt;ServiceFindHook&gt; sr = fhrIter-&gt;GetReference();
      ServiceFindHook* const fh = reinterpret_cast&lt;ServiceFindHook*&gt;(sr.d-&gt;GetService(GetModuleContext()-&gt;GetModule()));
      if (fh != nullptr)</span>
      {
        try
        {
<span style = "background-color:#fdd">          fh-&gt;Find(mc, service, filter, filtered);</span>
        }
        catch (const std::exception&amp; e)
<span style = "background-color:#fdd">        {
          US_WARN &lt;&lt; "Failed to call find hook  #" &lt;&lt; sr.GetProperty(ServiceConstants::SERVICE_ID()).ToString()</span>
                  &lt;&lt; ": " &lt;&lt; e.what();
<span style = "background-color:#fdd">        }</span>
        catch (...)
<span style = "background-color:#fdd">        {
          US_WARN &lt;&lt; "Failed to call find hook  #" &lt;&lt; sr.GetProperty(ServiceConstants::SERVICE_ID()).ToString()</span>
                  &lt;&lt; ": unknown exception type";
<span style = "background-color:#fdd">        }</span>
      }
<span style = "background-color:#fdd">    }</span>
  }
<span style = "background-color:#dfd">}</span>

void ServiceHooks::FilterServiceEventReceivers(const ServiceEvent&amp; evt,
                                               ServiceListeners::ServiceListenerEntries&amp; receivers)
<span style = "background-color:#dfd">{
  std::vector&lt;ServiceRegistrationBase&gt; eventListenerHooks;
  coreCtx-&gt;services.Get_unlocked(us_service_interface_iid&lt;ServiceEventListenerHook&gt;(), eventListenerHooks);
  if (!eventListenerHooks.empty())</span>
  {
<span style = "background-color:#fdd">    std::sort(eventListenerHooks.begin(), eventListenerHooks.end());
    std::map&lt;ModuleContext*, std::vector&lt;ServiceListenerHook::ListenerInfo&gt; &gt; listeners;
    for (ServiceListeners::ServiceListenerEntries::iterator sleIter = receivers.begin(),
         sleEnd = receivers.end(); sleIter != sleEnd; ++sleIter)</span>
    {
<span style = "background-color:#fdd">      listeners[sleIter-&gt;GetModuleContext()].push_back(*sleIter);
    }</span>

<span style = "background-color:#fdd">    std::map&lt;ModuleContext*, ShrinkableVector&lt;ServiceListenerHook::ListenerInfo&gt; &gt; shrinkableListeners;
    for (std::map&lt;ModuleContext*, std::vector&lt;ServiceListenerHook::ListenerInfo&gt; &gt;::iterator iter = listeners.begin(),
         iterEnd = listeners.end(); iter != iterEnd; ++iter)</span>
    {
<span style = "background-color:#fdd">      shrinkableListeners.insert(std::make_pair(iter-&gt;first, ShrinkableVector&lt;ServiceListenerHook::ListenerInfo&gt;(iter-&gt;second)));
    }</span>

<span style = "background-color:#fdd">    ShrinkableMap&lt;ModuleContext*, ShrinkableVector&lt;ServiceListenerHook::ListenerInfo&gt; &gt; filtered(shrinkableListeners);</span>

<span style = "background-color:#fdd">    for(std::vector&lt;ServiceRegistrationBase&gt;::reverse_iterator sriIter = eventListenerHooks.rbegin(),
        sriEnd = eventListenerHooks.rend(); sriIter != sriEnd; ++sriIter)</span>
    {
<span style = "background-color:#fdd">      ServiceReference&lt;ServiceEventListenerHook&gt; sr = sriIter-&gt;GetReference();
      ServiceEventListenerHook* elh = reinterpret_cast&lt;ServiceEventListenerHook*&gt;(sr.d-&gt;GetService(GetModuleContext()-&gt;GetModule()));
      if(elh != nullptr)</span>
      {
        try
        {
<span style = "background-color:#fdd">          elh-&gt;Event(evt, filtered);</span>
        }
        catch(const std::exception&amp; e)
<span style = "background-color:#fdd">        {
          US_WARN &lt;&lt; "Failed to call event hook  #" &lt;&lt; sr.GetProperty(ServiceConstants::SERVICE_ID()).ToString()</span>
                  &lt;&lt; ": " &lt;&lt; e.what();
<span style = "background-color:#fdd">        }</span>
        catch(...)
<span style = "background-color:#fdd">        {
          US_WARN &lt;&lt; "Failed to call event hook  #" &lt;&lt; sr.GetProperty(ServiceConstants::SERVICE_ID()).ToString()</span>
                  &lt;&lt; ": unknown exception type";
<span style = "background-color:#fdd">        }</span>
      }
<span style = "background-color:#fdd">    }
    receivers.clear();
    for(std::map&lt;ModuleContext*, std::vector&lt;ServiceListenerHook::ListenerInfo&gt; &gt;::iterator iter = listeners.begin(),
        iterEnd = listeners.end(); iter != iterEnd; ++iter)</span>
    {
<span style = "background-color:#fdd">      receivers.insert(iter-&gt;second.begin(), iter-&gt;second.end());
    }
  }</span>
<span style = "background-color:#dfd">}</span>

void ServiceHooks::HandleServiceListenerReg(const ServiceListenerEntry&amp; sle)
<span style = "background-color:#dfd">{
  if(!IsOpen() || listenerHookTracker-&gt;Size() == 0)</span>
  {
<span style = "background-color:#dfd">    return;</span>
  }

  std::vector&lt;ServiceReference&lt;ServiceListenerHook&gt; &gt; srl
<span style = "background-color:#fdd">      = listenerHookTracker-&gt;GetServiceReferences();</span>

<span style = "background-color:#fdd">  if (!srl.empty())</span>
  {
<span style = "background-color:#fdd">    std::sort(srl.begin(), srl.end());</span>

<span style = "background-color:#fdd">    std::vector&lt;ServiceListenerHook::ListenerInfo&gt; set;
    set.push_back(sle);
    for (std::vector&lt;ServiceReference&lt;ServiceListenerHook&gt; &gt;::reverse_iterator srIter = srl.rbegin(),
         srEnd = srl.rend(); srIter != srEnd; ++srIter)</span>
    {
<span style = "background-color:#fdd">      ServiceListenerHook* lh = listenerHookTracker-&gt;GetService(*srIter);</span>
      try
      {
<span style = "background-color:#fdd">        lh-&gt;Added(set);</span>
      }
      catch (const std::exception&amp; e)
<span style = "background-color:#fdd">      {
        US_WARN &lt;&lt; "Failed to call listener hook #" &lt;&lt; srIter-&gt;GetProperty(ServiceConstants::SERVICE_ID()).ToString()</span>
                &lt;&lt; ": " &lt;&lt; e.what();
<span style = "background-color:#fdd">      }</span>
      catch (...)
<span style = "background-color:#fdd">      {
        US_WARN &lt;&lt; "Failed to call listener hook #" &lt;&lt; srIter-&gt;GetProperty(ServiceConstants::SERVICE_ID()).ToString()</span>
                &lt;&lt; ": unknown exception";
<span style = "background-color:#fdd">      }
    }
  }
}</span>

void ServiceHooks::HandleServiceListenerUnreg(const ServiceListenerEntry&amp; sle)
<span style = "background-color:#dfd">{
  if(IsOpen())</span>
  {
<span style = "background-color:#dfd">    std::vector&lt;ServiceListenerEntry&gt; set;
    set.push_back(sle);
    HandleServiceListenerUnreg(set);
  }
}</span>

void ServiceHooks::HandleServiceListenerUnreg(const std::vector&lt;ServiceListenerEntry&gt;&amp; set)
<span style = "background-color:#dfd">{
  if(!IsOpen() || listenerHookTracker-&gt;Size() == 0)</span>
  {
<span style = "background-color:#dfd">    return;</span>
  }

  std::vector&lt;ServiceReference&lt;ServiceListenerHook&gt; &gt; srl
<span style = "background-color:#fdd">      = listenerHookTracker-&gt;GetServiceReferences();</span>

<span style = "background-color:#fdd">  if (!srl.empty())</span>
  {
<span style = "background-color:#fdd">    std::vector&lt;ServiceListenerHook::ListenerInfo&gt; lis;
    for (std::vector&lt;ServiceListenerEntry&gt;::const_iterator sleIter = set.begin(),
         sleEnd = set.end(); sleIter != sleEnd; ++sleIter)</span>
    {
<span style = "background-color:#fdd">      lis.push_back(*sleIter);
    }</span>

<span style = "background-color:#fdd">    std::sort(srl.begin(), srl.end());
    for (std::vector&lt;ServiceReference&lt;ServiceListenerHook&gt; &gt;::reverse_iterator srIter = srl.rbegin(),
         srEnd = srl.rend(); srIter != srEnd; ++srIter)</span>
    {
<span style = "background-color:#fdd">      ServiceListenerHook* const lh = listenerHookTracker-&gt;GetService(*srIter);</span>
      try
      {
<span style = "background-color:#fdd">        lh-&gt;Removed(lis);</span>
      }
      catch (const std::exception&amp; e)
<span style = "background-color:#fdd">      {
        US_WARN &lt;&lt; "Failed to call listener hook #" &lt;&lt; srIter-&gt;GetProperty(ServiceConstants::SERVICE_ID()).ToString()</span>
                &lt;&lt; ": " &lt;&lt; e.what();
<span style = "background-color:#fdd">      }</span>
      catch (...)
<span style = "background-color:#fdd">      {
        US_WARN &lt;&lt; "Failed to call listener hook #" &lt;&lt; srIter-&gt;GetProperty(ServiceConstants::SERVICE_ID()).ToString()</span>
                &lt;&lt; ": unknown exception type";
<span style = "background-color:#fdd">      }
    }
  }
}</span>

US_END_NAMESPACE</pre>
	</body>
</html>
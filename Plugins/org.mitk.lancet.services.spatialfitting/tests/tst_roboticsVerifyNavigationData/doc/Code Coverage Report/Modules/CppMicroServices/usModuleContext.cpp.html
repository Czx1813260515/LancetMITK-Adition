<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>usModuleContext.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

  Library: CppMicroServices

  Copyright (c) German Cancer Research Center (DKFZ)
  All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

============================================================================*/

#include "usModuleContext.h"

#include "usModuleRegistry.h"
#include "usModulePrivate.h"
#include "usModuleSettings.h"
#include "usCoreModuleContext_p.h"
#include "usServiceRegistry_p.h"
#include "usServiceReferenceBasePrivate.h"

#include &lt;cstdio&gt;

US_BEGIN_NAMESPACE

class ModuleContextPrivate {

public:

  ModuleContextPrivate(ModulePrivate* module)
<span style = "background-color:#dfd">  : module(module)
  {}</span>

  ModulePrivate* module;
};


ModuleContext::ModuleContext(ModulePrivate* module)
<span style = "background-color:#dfd">  : d(new ModuleContextPrivate(module))
{}</span>

ModuleContext::~ModuleContext()
<span style = "background-color:#dfd">{
  delete d;
}</span>

Module* ModuleContext::GetModule() const
<span style = "background-color:#dfd">{
  return d-&gt;module-&gt;q;
}</span>

Module* ModuleContext::GetModule(long id) const
<span style = "background-color:#fdd">{
  return d-&gt;module-&gt;coreCtx-&gt;moduleHooks.FilterModule(this, ModuleRegistry::GetModule(id));
}</span>

Module* ModuleContext::GetModule(const std::string&amp; name)
<span style = "background-color:#fdd">{
  return ModuleRegistry::GetModule(name);
}</span>

std::vector&lt;Module*&gt; ModuleContext::GetModules() const
<span style = "background-color:#fdd">{
  std::vector&lt;Module*&gt; modules = ModuleRegistry::GetModules();
  d-&gt;module-&gt;coreCtx-&gt;moduleHooks.FilterModules(this, modules);
  return modules;
}</span>

ServiceRegistrationU ModuleContext::RegisterService(const InterfaceMap&amp; service,
                                                    const ServiceProperties&amp; properties)
<span style = "background-color:#dfd">{
  return d-&gt;module-&gt;coreCtx-&gt;services.RegisterService(d-&gt;module, service, properties);
}</span>

std::vector&lt;ServiceReferenceU &gt; ModuleContext::GetServiceReferences(const std::string&amp; clazz,
                                                                    const std::string&amp; filter)
<span style = "background-color:#dfd">{
  std::vector&lt;ServiceReferenceU&gt; result;
  std::vector&lt;ServiceReferenceBase&gt; refs;
  d-&gt;module-&gt;coreCtx-&gt;services.Get(clazz, filter, d-&gt;module, refs);
  for (std::vector&lt;ServiceReferenceBase&gt;::const_iterator iter = refs.begin();
       iter != refs.end(); ++iter)</span>
  {
<span style = "background-color:#dfd">    result.push_back(ServiceReferenceU(*iter));
  }
  return result;
}</span>

ServiceReferenceU ModuleContext::GetServiceReference(const std::string&amp; clazz)
<span style = "background-color:#dfd">{
  return d-&gt;module-&gt;coreCtx-&gt;services.Get(d-&gt;module, clazz);
}</span>

void* ModuleContext::GetService(const ServiceReferenceBase&amp; reference)
<span style = "background-color:#dfd">{
  if (!reference)</span>
  {
<span style = "background-color:#fdd">    throw std::invalid_argument("Default constructed ServiceReference is not a valid input to GetService()");</span>
  }
<span style = "background-color:#dfd">  return reference.d-&gt;GetService(d-&gt;module-&gt;q);
}</span>

InterfaceMap ModuleContext::GetService(const ServiceReferenceU&amp; reference)
<span style = "background-color:#fdd">{
  if (!reference)</span>
  {
<span style = "background-color:#fdd">    throw std::invalid_argument("Default constructed ServiceReference is not a valid input to GetService()");</span>
  }
<span style = "background-color:#fdd">  return reference.d-&gt;GetServiceInterfaceMap(d-&gt;module-&gt;q);
}</span>

bool ModuleContext::UngetService(const ServiceReferenceBase&amp; reference)
<span style = "background-color:#dfd">{
  ServiceReferenceBase ref = reference;
  return ref.d-&gt;UngetService(d-&gt;module-&gt;q, true);
}</span>

void ModuleContext::AddServiceListener(const ServiceListener&amp; delegate,
                                       const std::string&amp; filter)
<span style = "background-color:#fdd">{
  d-&gt;module-&gt;coreCtx-&gt;listeners.AddServiceListener(this, delegate, nullptr, filter);
}</span>

void ModuleContext::RemoveServiceListener(const ServiceListener&amp; delegate)
<span style = "background-color:#fdd">{
  d-&gt;module-&gt;coreCtx-&gt;listeners.RemoveServiceListener(this, delegate, nullptr);
}</span>

void ModuleContext::AddModuleListener(const ModuleListener&amp; delegate)
<span style = "background-color:#fdd">{
  d-&gt;module-&gt;coreCtx-&gt;listeners.AddModuleListener(this, delegate, nullptr);
}</span>

void ModuleContext::RemoveModuleListener(const ModuleListener&amp; delegate)
<span style = "background-color:#fdd">{
  d-&gt;module-&gt;coreCtx-&gt;listeners.RemoveModuleListener(this, delegate, nullptr);
}</span>

void ModuleContext::AddServiceListener(const ServiceListener&amp; delegate, void* data,
                                       const std::string &amp;filter)
<span style = "background-color:#dfd">{
  d-&gt;module-&gt;coreCtx-&gt;listeners.AddServiceListener(this, delegate, data, filter);
}</span>

void ModuleContext::RemoveServiceListener(const ServiceListener&amp; delegate, void* data)
<span style = "background-color:#dfd">{
  d-&gt;module-&gt;coreCtx-&gt;listeners.RemoveServiceListener(this, delegate, data);
}</span>

void ModuleContext::AddModuleListener(const ModuleListener&amp; delegate, void* data)
<span style = "background-color:#fdd">{
  d-&gt;module-&gt;coreCtx-&gt;listeners.AddModuleListener(this, delegate, data);
}</span>

void ModuleContext::RemoveModuleListener(const ModuleListener&amp; delegate, void* data)
<span style = "background-color:#fdd">{
  d-&gt;module-&gt;coreCtx-&gt;listeners.RemoveModuleListener(this, delegate, data);
}</span>

std::string ModuleContext::GetDataFile(const std::string &amp;filename) const
<span style = "background-color:#fdd">{</span>
  // compute the module storage path
#ifdef US_PLATFORM_WINDOWS
    static const char separator = '\\';
#else
    static const char separator = '/';
#endif

<span style = "background-color:#fdd">  std::string baseStoragePath = ModuleSettings::GetStoragePath();
  if (baseStoragePath.empty()) return std::string();
  if (baseStoragePath != d-&gt;module-&gt;baseStoragePath)</span>
  {
<span style = "background-color:#fdd">    d-&gt;module-&gt;baseStoragePath = baseStoragePath;
    d-&gt;module-&gt;storagePath.clear();</span>
  }

<span style = "background-color:#fdd">  if (d-&gt;module-&gt;storagePath.empty())</span>
  {
    char buf[50];
<span style = "background-color:#fdd">    sprintf(buf, "%ld", d-&gt;module-&gt;info.id);
    d-&gt;module-&gt;storagePath = baseStoragePath + separator + buf + "_" + d-&gt;module-&gt;info.name + separator;</span>
  }
<span style = "background-color:#fdd">  return d-&gt;module-&gt;storagePath + filename;
}</span>


US_END_NAMESPACE</pre>
	</body>
</html>
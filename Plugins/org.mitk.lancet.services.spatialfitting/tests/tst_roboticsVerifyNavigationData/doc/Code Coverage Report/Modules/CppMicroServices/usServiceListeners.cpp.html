<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>usServiceListeners.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

  Library: CppMicroServices

  Copyright (c) German Cancer Research Center (DKFZ)
  All rights reserved.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.

============================================================================*/

#include "usUtils_p.h"

#include "usServiceListeners_p.h"
#include "usServiceReferenceBasePrivate.h"

#include "usCoreModuleContext_p.h"
#include "usModule.h"
#include "usModuleContext.h"


US_BEGIN_NAMESPACE

const int ServiceListeners::OBJECTCLASS_IX = 0;
const int ServiceListeners::SERVICE_ID_IX = 1;

ServiceListeners::ServiceListeners(CoreModuleContext* coreCtx)
<span style = "background-color:#dfd">  : coreCtx(coreCtx)
{
  hashedServiceKeys.push_back(ServiceConstants::OBJECTCLASS());
  hashedServiceKeys.push_back(ServiceConstants::SERVICE_ID());
}</span>

void ServiceListeners::AddServiceListener(ModuleContext* mc, const ServiceListenerEntry::ServiceListener&amp; listener,
                                          void* data, const std::string&amp; filter)
<span style = "background-color:#dfd">{
  US_UNUSED(Lock(this));</span>

<span style = "background-color:#dfd">  ServiceListenerEntry sle(mc, listener, data, filter);
  RemoveServiceListener_unlocked(sle);</span>

<span style = "background-color:#dfd">  serviceSet.insert(sle);
  coreCtx-&gt;serviceHooks.HandleServiceListenerReg(sle);
  CheckSimple(sle);
}</span>

void ServiceListeners::RemoveServiceListener(ModuleContext* mc, const ServiceListenerEntry::ServiceListener&amp; listener,
                                             void* data)
<span style = "background-color:#dfd">{
  ServiceListenerEntry entryToRemove(mc, listener, data);</span>

<span style = "background-color:#dfd">  US_UNUSED(Lock(this));
  RemoveServiceListener_unlocked(entryToRemove);
}</span>

void ServiceListeners::RemoveServiceListener_unlocked(const ServiceListenerEntry&amp; entryToRemove)
<span style = "background-color:#dfd">{
  ServiceListenerEntries::const_iterator it = serviceSet.find(entryToRemove);
  if (it != serviceSet.end())</span>
  {
<span style = "background-color:#dfd">    it-&gt;SetRemoved(true);
    coreCtx-&gt;serviceHooks.HandleServiceListenerUnreg(*it);
    RemoveFromCache(*it);
    serviceSet.erase(it);</span>
  }
<span style = "background-color:#dfd">}</span>

void ServiceListeners::AddModuleListener(ModuleContext* mc, const ModuleListener&amp; listener, void* data)
<span style = "background-color:#fdd">{
  MutexLock lock(moduleListenerMapMutex);
  ModuleListenerMap::value_type::second_type&amp; listeners = moduleListenerMap[mc];
  if (std::find_if(listeners.begin(), listeners.end(), std::bind(ModuleListenerCompare(), std::make_pair(listener, data), std::placeholders::_1)) == listeners.end())</span>
  {
<span style = "background-color:#fdd">    listeners.push_back(std::make_pair(listener, data));</span>
  }
<span style = "background-color:#fdd">}</span>

void ServiceListeners::RemoveModuleListener(ModuleContext* mc, const ModuleListener&amp; listener, void* data)
<span style = "background-color:#fdd">{
  MutexLock lock(moduleListenerMapMutex);
  moduleListenerMap[mc].remove_if(std::bind(ModuleListenerCompare(), std::make_pair(listener, data), std::placeholders::_1));
}</span>

void ServiceListeners::ModuleChanged(const ModuleEvent&amp; evt)
<span style = "background-color:#dfd">{
  ModuleListenerMap filteredModuleListeners;
  coreCtx-&gt;moduleHooks.FilterModuleEventReceivers(evt, filteredModuleListeners);</span>

<span style = "background-color:#dfd">  for(ModuleListenerMap::iterator iter = filteredModuleListeners.begin(), end = filteredModuleListeners.end();</span>
<span style = "background-color:#fdd">      iter != end; ++iter)</span>
  {
<span style = "background-color:#fdd">    for (ModuleListenerMap::mapped_type::iterator iter2 = iter-&gt;second.begin(), end2 = iter-&gt;second.end();
         iter2 != end2; ++iter2)</span>
    {
      try
      {
<span style = "background-color:#fdd">        (iter2-&gt;first)(evt);</span>
      }
      catch (const std::exception&amp; e)
<span style = "background-color:#fdd">      {
        US_WARN &lt;&lt; "Module listener threw an exception: " &lt;&lt; e.what();
      }
    }</span>
<span style = "background-color:#dfd">  }
}</span>

void ServiceListeners::RemoveAllListeners(ModuleContext* mc)
<span style = "background-color:#dfd">{</span>
  {
<span style = "background-color:#dfd">    US_UNUSED(Lock(this));
    for (ServiceListenerEntries::iterator it = serviceSet.begin();
         it != serviceSet.end(); )</span>
    {

<span style = "background-color:#dfd">      if (it-&gt;GetModuleContext() == mc)</span>
      {
<span style = "background-color:#fdd">        RemoveFromCache(*it);
        serviceSet.erase(it++);
      }</span>
      else
      {
<span style = "background-color:#dfd">        ++it;
      }
    }</span>
  }

  {
<span style = "background-color:#dfd">    MutexLock lock(moduleListenerMapMutex);
    moduleListenerMap.erase(mc);
  }
}</span>

void ServiceListeners::HooksModuleStopped(ModuleContext* mc)
<span style = "background-color:#fdd">{
  US_UNUSED(Lock(this));
  std::vector&lt;ServiceListenerEntry&gt; entries;
  for (ServiceListenerEntries::iterator it = serviceSet.begin();
       it != serviceSet.end(); )</span>
  {
<span style = "background-color:#fdd">    if (it-&gt;GetModuleContext() == mc)</span>
    {
<span style = "background-color:#fdd">      entries.push_back(*it);
    }
  }
  coreCtx-&gt;serviceHooks.HandleServiceListenerUnreg(entries);
}</span>

void ServiceListeners::ServiceChanged(ServiceListenerEntries&amp; receivers,
                                      const ServiceEvent&amp; evt)
<span style = "background-color:#dfd">{
  ServiceListenerEntries matchBefore;
  ServiceChanged(receivers, evt, matchBefore);
}</span>

void ServiceListeners::ServiceChanged(ServiceListenerEntries&amp; receivers,
                                      const ServiceEvent&amp; evt,
                                      ServiceListenerEntries&amp; matchBefore)
<span style = "background-color:#dfd">{
  int n = 0;</span>

<span style = "background-color:#dfd">  if (!matchBefore.empty())</span>
  {
<span style = "background-color:#fdd">    for (ServiceListenerEntries::const_iterator l = receivers.begin();
         l != receivers.end(); ++l)</span>
    {
<span style = "background-color:#fdd">      matchBefore.erase(*l);
    }</span>
  }

<span style = "background-color:#dfd">  for (ServiceListenerEntries::const_iterator l = receivers.begin();
       l != receivers.end(); ++l)</span>
  {
<span style = "background-color:#dfd">    if (!l-&gt;IsRemoved())</span>
    {
      try
      {
<span style = "background-color:#dfd">        ++n;
        l-&gt;CallDelegate(evt);</span>
      }
      catch (...)
<span style = "background-color:#fdd">      {
        US_WARN &lt;&lt; "Service listener"</span>
                &lt;&lt; " in " &lt;&lt; l-&gt;GetModuleContext()-&gt;GetModule()-&gt;GetName()
                &lt;&lt; " threw an exception!";
<span style = "background-color:#fdd">      }</span>
<span style = "background-color:#dfd">    }
  }</span>

  //US_DEBUG &lt;&lt; "Notified " &lt;&lt; n &lt;&lt; " listeners";
<span style = "background-color:#dfd">}</span>

void ServiceListeners::GetMatchingServiceListeners(const ServiceEvent&amp; evt, ServiceListenerEntries&amp; set,
                                                   bool lockProps)
<span style = "background-color:#dfd">{
  US_UNUSED(Lock(this));</span>

  // Filter the original set of listeners
<span style = "background-color:#dfd">  ServiceListenerEntries receivers = serviceSet;
  coreCtx-&gt;serviceHooks.FilterServiceEventReceivers(evt, receivers);</span>

  // Check complicated or empty listener filters
<span style = "background-color:#dfd">  for (std::list&lt;ServiceListenerEntry&gt;::const_iterator sse = complicatedListeners.begin();
       sse != complicatedListeners.end(); ++sse)</span>
  {
<span style = "background-color:#dfd">    if (receivers.count(*sse) == 0) continue;
    const LDAPExpr&amp; ldapExpr = sse-&gt;GetLDAPExpr();
    if (ldapExpr.IsNull() ||</span>
        ldapExpr.Evaluate(evt.GetServiceReference().d-&gt;GetProperties(), false))
    {
<span style = "background-color:#dfd">      set.insert(*sse);
    }
  }</span>

  //US_DEBUG &lt;&lt; "Added " &lt;&lt; set.size() &lt;&lt; " out of " &lt;&lt; n
  //         &lt;&lt; " listeners with complicated filters";

  // Check the cache
<span style = "background-color:#dfd">  const std::vector&lt;std::string&gt; c(any_cast&lt;std::vector&lt;std::string&gt; &gt;</span>
                                 (evt.GetServiceReference().d-&gt;GetProperty(ServiceConstants::OBJECTCLASS(), lockProps)));
<span style = "background-color:#dfd">  for (std::vector&lt;std::string&gt;::const_iterator objClass = c.begin();
       objClass != c.end(); ++objClass)</span>
  {
<span style = "background-color:#dfd">    AddToSet(set, receivers, OBJECTCLASS_IX, *objClass);
  }</span>

<span style = "background-color:#dfd">  long service_id = any_cast&lt;long&gt;(evt.GetServiceReference().d-&gt;GetProperty(ServiceConstants::SERVICE_ID(), lockProps));
  std::stringstream ss;
  ss &lt;&lt; service_id;
  AddToSet(set, receivers, SERVICE_ID_IX, ss.str());
}</span>

std::vector&lt;ServiceListenerHook::ListenerInfo&gt; ServiceListeners::GetListenerInfoCollection() const
<span style = "background-color:#fdd">{
  US_UNUSED(Lock(this));
  std::vector&lt;ServiceListenerHook::ListenerInfo&gt; result;
  result.reserve(serviceSet.size());
  for (ServiceListenerEntries::const_iterator iter = serviceSet.begin(),
       iterEnd = serviceSet.end(); iter != iterEnd; ++iter)</span>
  {
<span style = "background-color:#fdd">    result.push_back(*iter);
  }
  return result;
}</span>

void ServiceListeners::RemoveFromCache(const ServiceListenerEntry&amp; sle)
<span style = "background-color:#dfd">{
  if (!sle.GetLocalCache().empty())</span>
  {
<span style = "background-color:#dfd">    for (std::size_t i = 0; i &lt; hashedServiceKeys.size(); ++i)</span>
    {
<span style = "background-color:#dfd">      CacheType&amp; keymap = cache[i];
      std::vector&lt;std::string&gt;&amp; l = sle.GetLocalCache()[i];
      for (std::vector&lt;std::string&gt;::const_iterator it = l.begin();
           it != l.end(); ++it)</span>
      {
<span style = "background-color:#dfd">        std::list&lt;ServiceListenerEntry&gt;&amp; sles = keymap[*it];
        sles.remove(sle);
        if (sles.empty())</span>
        {
<span style = "background-color:#dfd">          keymap.erase(*it);
        }
      }
    }
  }</span>
  else
  {
<span style = "background-color:#dfd">    complicatedListeners.remove(sle);</span>
  }
<span style = "background-color:#dfd">}</span>

<span style = "background-color:#dfd"> void ServiceListeners::CheckSimple(const ServiceListenerEntry&amp; sle) {
   if (sle.GetLDAPExpr().IsNull())</span>
   {
<span style = "background-color:#fdd">     complicatedListeners.push_back(sle);
   }</span>
   else
   {
<span style = "background-color:#dfd">     LDAPExpr::LocalCache local_cache;
     if (sle.GetLDAPExpr().IsSimple(hashedServiceKeys, local_cache, false))</span>
     {
<span style = "background-color:#dfd">       sle.GetLocalCache() = local_cache;
       for (std::size_t i = 0; i &lt; hashedServiceKeys.size(); ++i)</span>
       {
<span style = "background-color:#dfd">         for (std::vector&lt;std::string&gt;::const_iterator it = local_cache[i].begin();
              it != local_cache[i].end(); ++it)</span>
         {
<span style = "background-color:#dfd">           std::list&lt;ServiceListenerEntry&gt;&amp; sles = cache[i][*it];
           sles.push_back(sle);
         }
       }
     }</span>
     else
     {
       //US_DEBUG &lt;&lt; "Too complicated filter: " &lt;&lt; sle.GetFilter();
<span style = "background-color:#dfd">       complicatedListeners.push_back(sle);</span>
     }
<span style = "background-color:#dfd">   }
 }</span>

void ServiceListeners::AddToSet(ServiceListenerEntries&amp; set,
                                const ServiceListenerEntries&amp; receivers,
                                int cache_ix, const std::string&amp; val)
<span style = "background-color:#dfd">{
  std::list&lt;ServiceListenerEntry&gt;&amp; l = cache[cache_ix][val];
  if (!l.empty())</span>
  {
    //US_DEBUG &lt;&lt; hashedServiceKeys[cache_ix] &lt;&lt; " matches " &lt;&lt; l.size();

<span style = "background-color:#dfd">    for (std::list&lt;ServiceListenerEntry&gt;::const_iterator entry = l.begin();
         entry != l.end(); ++entry)</span>
    {
<span style = "background-color:#dfd">      if (receivers.count(*entry))</span>
      {
<span style = "background-color:#dfd">        set.insert(*entry);
      }
    }</span>
  }
  else
  {
    //US_DEBUG &lt;&lt; hashedServiceKeys[cache_ix] &lt;&lt; " matches none";
  }
<span style = "background-color:#dfd">}</span>

US_END_NAMESPACE</pre>
	</body>
</html>
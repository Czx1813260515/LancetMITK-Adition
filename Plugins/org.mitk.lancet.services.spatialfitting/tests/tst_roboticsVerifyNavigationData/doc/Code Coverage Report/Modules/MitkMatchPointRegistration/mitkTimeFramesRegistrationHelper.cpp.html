<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkTimeFramesRegistrationHelper.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "itkCommand.h"

#include "mitkTimeFramesRegistrationHelper.h"
#include &lt;mitkImageTimeSelector.h&gt;
#include &lt;mitkImageReadAccessor.h&gt;

#include &lt;mitkMaskedAlgorithmHelper.h&gt;
#include &lt;mitkMAPAlgorithmHelper.h&gt;

mitk::Image::Pointer
mitk::TimeFramesRegistrationHelper::GetFrameImage(const mitk::Image* image,
    mitk::TimePointType timePoint) const
<span style = "background-color:#fdd">{
  mitk::ImageTimeSelector::Pointer imageTimeSelector = mitk::ImageTimeSelector::New();
  imageTimeSelector-&gt;SetInput(image);
  imageTimeSelector-&gt;SetTimeNr(timePoint);
  imageTimeSelector-&gt;UpdateLargestPossibleRegion();</span>

<span style = "background-color:#fdd">  mitk::Image::Pointer frameImage = imageTimeSelector-&gt;GetOutput();
  return frameImage;
};</span>

void
mitk::TimeFramesRegistrationHelper::Generate()
<span style = "background-color:#fdd">{
  CheckValidInputs();</span>

  //prepare processing
<span style = "background-color:#fdd">  mitk::Image::Pointer targetFrame = GetFrameImage(this-&gt;m_4DImage, 0);</span>

<span style = "background-color:#fdd">  this-&gt;m_Registered4DImage = this-&gt;m_4DImage-&gt;Clone();</span>

<span style = "background-color:#fdd">  Image::ConstPointer mask;</span>

<span style = "background-color:#fdd">  if (m_TargetMask.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    if (m_TargetMask-&gt;GetTimeSteps() &gt; 1)</span>
    {
<span style = "background-color:#fdd">      mask = GetFrameImage(m_TargetMask, 0);
    }</span>
    else
    {
<span style = "background-color:#fdd">      mask = m_TargetMask;</span>
    }
  }

<span style = "background-color:#fdd">  double progressDelta = 1.0 / ((this-&gt;m_4DImage-&gt;GetTimeSteps() - 1) * 3.0);
  m_Progress = 0.0;</span>

  //process the frames
<span style = "background-color:#fdd">  for (unsigned int i = 1; i &lt; this-&gt;m_4DImage-&gt;GetTimeSteps(); ++i)</span>
  {
<span style = "background-color:#fdd">    Image::Pointer movingFrame = GetFrameImage(this-&gt;m_4DImage, i);
    Image::Pointer mappedFrame;</span>

<span style = "background-color:#fdd">    IgnoreListType::iterator finding = std::find(m_IgnoreList.begin(), m_IgnoreList.end(), i);</span>


<span style = "background-color:#fdd">    if (finding == m_IgnoreList.end())</span>
    {
      //frame should be processed
<span style = "background-color:#fdd">      RegistrationPointer reg = DoFrameRegistration(movingFrame, targetFrame, mask);</span>

<span style = "background-color:#fdd">      m_Progress += progressDelta;
      this-&gt;InvokeEvent(::mitk::FrameRegistrationEvent(nullptr,</span>
                        "Registred frame #" +::map::core::convert::toStr(i)));

<span style = "background-color:#fdd">      mappedFrame = DoFrameMapping(movingFrame, reg, targetFrame);</span>

<span style = "background-color:#fdd">      m_Progress += progressDelta;
      this-&gt;InvokeEvent(::mitk::FrameMappingEvent(nullptr,</span>
                        "Mapped frame #" + ::map::core::convert::toStr(i)));

<span style = "background-color:#fdd">      mitk::ImageReadAccessor accessor(mappedFrame, mappedFrame-&gt;GetVolumeData(0, 0, nullptr,</span>
                                       mitk::Image::ReferenceMemory));


<span style = "background-color:#fdd">      this-&gt;m_Registered4DImage-&gt;SetVolume(accessor.GetData(), i);
      this-&gt;m_Registered4DImage-&gt;GetTimeGeometry()-&gt;SetTimeStepGeometry(mappedFrame-&gt;GetGeometry(), i);</span>

<span style = "background-color:#fdd">      m_Progress += progressDelta;
    }</span>
    else
    {
<span style = "background-color:#fdd">      m_Progress += 3 * progressDelta;</span>
    }

<span style = "background-color:#fdd">    this-&gt;InvokeEvent(::itk::ProgressEvent());</span>

<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">};</span>

mitk::Image::Pointer
mitk::TimeFramesRegistrationHelper::GetRegisteredImage()
<span style = "background-color:#fdd">{
  if (this-&gt;HasOutdatedResult())</span>
  {
<span style = "background-color:#fdd">    Generate();</span>
  }

<span style = "background-color:#fdd">  return m_Registered4DImage;
};</span>

void
mitk::TimeFramesRegistrationHelper::
SetIgnoreList(const IgnoreListType&amp; il)
<span style = "background-color:#fdd">{
  m_IgnoreList = il;
  this-&gt;Modified();
}</span>

void
mitk::TimeFramesRegistrationHelper::ClearIgnoreList()
<span style = "background-color:#fdd">{
  m_IgnoreList.clear();
  this-&gt;Modified();
};</span>


mitk::TimeFramesRegistrationHelper::RegistrationPointer
mitk::TimeFramesRegistrationHelper::DoFrameRegistration(const mitk::Image* movingFrame,
    const mitk::Image* targetFrame, const mitk::Image* targetMask) const
<span style = "background-color:#fdd">{
  mitk::MAPAlgorithmHelper algHelper(m_Algorithm);
  algHelper.SetAllowImageCasting(true);
  algHelper.SetData(movingFrame, targetFrame);</span>

<span style = "background-color:#fdd">  if (targetMask)</span>
  {
<span style = "background-color:#fdd">    mitk::MaskedAlgorithmHelper maskHelper(m_Algorithm);
    maskHelper.SetMasks(nullptr, targetMask);
  }</span>

<span style = "background-color:#fdd">  return algHelper.GetRegistration();
};</span>

mitk::Image::Pointer mitk::TimeFramesRegistrationHelper::DoFrameMapping(
  const mitk::Image* movingFrame, const RegistrationType* reg, const mitk::Image* targetFrame) const
<span style = "background-color:#fdd">{
  return mitk::ImageMappingHelper::map(movingFrame, reg, !m_AllowUndefPixels, m_PaddingValue,</span>
                                      targetFrame-&gt;GetGeometry(), !m_AllowUnregPixels, m_ErrorValue, m_InterpolatorType);
<span style = "background-color:#fdd">};</span>

bool
mitk::TimeFramesRegistrationHelper::HasOutdatedResult() const
<span style = "background-color:#fdd">{
  if (m_Registered4DImage.IsNull())</span>
  {
<span style = "background-color:#fdd">    return true;</span>
  }

<span style = "background-color:#fdd">  bool result = false;</span>

<span style = "background-color:#fdd">  if (m_Registered4DImage-&gt;GetMTime() &gt; this-&gt;GetMTime())</span>
  {
<span style = "background-color:#fdd">    result = true;</span>
  }


<span style = "background-color:#fdd">  if (m_Algorithm.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    if (m_Algorithm-&gt;GetMTime() &gt; this-&gt;GetMTime())</span>
    {
<span style = "background-color:#fdd">      result = true;</span>
    }
  }

<span style = "background-color:#fdd">  if (m_4DImage.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    if (m_4DImage-&gt;GetMTime() &gt; this-&gt;GetMTime())</span>
    {
<span style = "background-color:#fdd">      result = true;</span>
    }
  }

<span style = "background-color:#fdd">  if (m_TargetMask.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    if (m_TargetMask-&gt;GetMTime() &gt; this-&gt;GetMTime())</span>
    {
<span style = "background-color:#fdd">      result = true;</span>
    }
  }

<span style = "background-color:#fdd">  return result;
};</span>

void
mitk::TimeFramesRegistrationHelper::CheckValidInputs() const
<span style = "background-color:#fdd">{
  if (m_4DImage.IsNull())</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cannot register image. Input 4D image is not set.";</span>
  }

<span style = "background-color:#fdd">  if (m_Algorithm.IsNull())</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cannot register image. Algorithm is not set.";</span>
  }

<span style = "background-color:#fdd">  if (m_4DImage-&gt;GetTimeSteps() &lt;= 1)</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Cannot register image. Input 4D image must have 2 or more time steps.";</span>
  }

<span style = "background-color:#fdd">  for (IgnoreListType::const_iterator pos = this-&gt;m_IgnoreList.begin();
       pos != this-&gt;m_IgnoreList.end(); ++pos)</span>
  {
<span style = "background-color:#fdd">    if (*pos &gt;= m_4DImage-&gt;GetTimeSteps())</span>
    {
<span style = "background-color:#fdd">      mitkThrow() &lt;&lt;</span>
                  "Cannot register image. Ignore list containes at least one inexistant frame. Invalid frame index: "
                  &lt;&lt; *pos;
<span style = "background-color:#fdd">    }
  }
};</span>

double
mitk::TimeFramesRegistrationHelper::GetProgress() const
<span style = "background-color:#fdd">{
  return m_Progress;
};</span></pre>
	</body>
</html>
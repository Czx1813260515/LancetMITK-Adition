<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkNavigationToolStorageDeserializer.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

//Poco headers
#include "Poco/Zip/Decompress.h"
#include "Poco/Path.h"
#include "Poco/File.h"

#include "mitkNavigationToolStorageDeserializer.h"
#include &lt;mitkSceneIO.h&gt;
#include &lt;mitkIOUtil.h&gt;
#include "mitkNavigationToolReader.h"

//POCO
#include &lt;Poco/Exception.h&gt;


#include "mitkIGTException.h"
#include "mitkIGTIOException.h"


mitk::NavigationToolStorageDeserializer::NavigationToolStorageDeserializer(mitk::DataStorage::Pointer dataStorage)
<span style = "background-color:#fdd">  {
  m_DataStorage = dataStorage;</span>
  //create temp directory for this reader
<span style = "background-color:#fdd">  m_tempDirectory = mitk::IOUtil::CreateTemporaryDirectory("NavigationToolStorageDeserializerTmp_XXXXXX",mitk::IOUtil::GetTempPath());
  }</span>

mitk::NavigationToolStorageDeserializer::~NavigationToolStorageDeserializer()
<span style = "background-color:#fdd">  {</span>
  //remove temp directory
<span style = "background-color:#fdd">  Poco::File myFile(m_tempDirectory);</span>
  try
    {
<span style = "background-color:#fdd">    if (myFile.exists()) myFile.remove();</span>
    }
  catch(...)
<span style = "background-color:#fdd">    {
    MITK_ERROR &lt;&lt; "Can't remove temp directory " &lt;&lt; m_tempDirectory &lt;&lt; "!";
    }
  }</span>

mitk::NavigationToolStorage::Pointer mitk::NavigationToolStorageDeserializer::Deserialize(std::string filename)
<span style = "background-color:#fdd">  {</span>
  //decompress zip file into temporary directory
<span style = "background-color:#fdd">  decompressFiles(filename,m_tempDirectory);</span>

  //now read all files and convert them to navigation tools
<span style = "background-color:#fdd">  mitk::NavigationToolStorage::Pointer returnValue = mitk::NavigationToolStorage::New(m_DataStorage);
  bool cont = true;</span>
  int i;
<span style = "background-color:#fdd">  for (i=0; cont==true; i++)</span>
    {
<span style = "background-color:#fdd">    std::string fileName = m_tempDirectory + Poco::Path::separator() + "NavigationTool" + convertIntToString(i) + ".tool";
    mitk::NavigationToolReader::Pointer myReader = mitk::NavigationToolReader::New();
    mitk::NavigationTool::Pointer readTool = myReader-&gt;DoRead(fileName);
    if (readTool.IsNull()) cont = false;
    else returnValue-&gt;AddTool(readTool);</span>
    //delete file
<span style = "background-color:#fdd">    std::remove(fileName.c_str());
    }
  if(i==1)</span>
    {
    //throw an exception here in case of not finding any tool
<span style = "background-color:#fdd">    m_ErrorMessage = "Error: did not find any tool. \n Is this a tool storage file?";
    mitkThrowException(mitk::IGTException)&lt;&lt;"Error: did not find any tool. \n Is this a tool storage file?";</span>
    }
<span style = "background-color:#fdd">  return returnValue;
  }</span>

std::string mitk::NavigationToolStorageDeserializer::convertIntToString(int i)
<span style = "background-color:#fdd">{
std::string s;
std::stringstream out;
out &lt;&lt; i;
s = out.str();
return s;
}</span>

void mitk::NavigationToolStorageDeserializer::decompressFiles(std::string filename,std::string path)
<span style = "background-color:#fdd">{
  std::ifstream file( filename.c_str(), std::ios::binary );
  if (!file.good())</span>
    {
<span style = "background-color:#fdd">    m_ErrorMessage = "Cannot open '" + filename + "' for reading";
    mitkThrowException(mitk::IGTException)&lt;&lt;"Cannot open"+filename+" for reading";</span>
    }

  try
    {
<span style = "background-color:#fdd">    Poco::Zip::Decompress unzipper( file, Poco::Path( path ) );
    unzipper.decompressAllFiles();
    file.close();
    }</span>

  catch(const Poco::IllegalStateException&amp;) //temporary solution: replace this by defined exception handling later!
<span style = "background-color:#fdd">    {
    m_ErrorMessage = "Error: wrong file format! \n (please only load tool storage files)";
    mitkThrowException(mitk::IGTException) &lt;&lt; m_ErrorMessage;
    }</span>

<span style = "background-color:#fdd">  }</span></pre>
	</body>
</html>
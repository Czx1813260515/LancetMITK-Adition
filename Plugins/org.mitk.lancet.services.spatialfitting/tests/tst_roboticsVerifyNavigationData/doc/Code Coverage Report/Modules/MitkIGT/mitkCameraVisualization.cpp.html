<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkCameraVisualization.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkCameraVisualization.h"

#include "vtkCamera.h"

#include "mitkPropertyList.h"
#include "mitkProperties.h"




<span style = "background-color:#fdd">mitk::CameraVisualization::CameraVisualization(): NavigationDataToNavigationDataFilter(),
m_Renderer(nullptr), m_FocalLength(10.0)
{</span>
  // initialize members
<span style = "background-color:#fdd">  m_DirectionOfProjectionInToolCoordinates[0] = 0;
  m_DirectionOfProjectionInToolCoordinates[1] = 0;
  m_DirectionOfProjectionInToolCoordinates[2] = -1;
  m_ViewUpInToolCoordinates[0] = 1;
  m_ViewUpInToolCoordinates[1] = 0;
  m_ViewUpInToolCoordinates[2] = 0;
}</span>


mitk::CameraVisualization::~CameraVisualization()
<span style = "background-color:#fdd">{</span>

<span style = "background-color:#fdd">}</span>


void mitk::CameraVisualization::GenerateData()
<span style = "background-color:#fdd">{</span>
  // check if renderer was set
<span style = "background-color:#fdd">  if (m_Renderer.IsNull())
    itkExceptionMacro(&lt;&lt; "Renderer was not properly set");</span>

  /* update outputs with tracking data from tools */
<span style = "background-color:#fdd">  unsigned int numberOfInputs = this-&gt;GetNumberOfInputs();
  for (unsigned int i = 0; i &lt; numberOfInputs ; ++i)</span>
  {
<span style = "background-color:#fdd">    mitk::NavigationData* output = this-&gt;GetOutput(i);
    assert(output);
    const mitk::NavigationData* input = this-&gt;GetInput(i);
    assert(input);</span>

<span style = "background-color:#fdd">    if (input-&gt;IsDataValid() == false)</span>
    {
<span style = "background-color:#fdd">      continue;</span>
    }
<span style = "background-color:#fdd">    output-&gt;Graft(input); // First, copy all information from input to output
  }</span>

<span style = "background-color:#fdd">  const NavigationData* navigationData = this-&gt;GetInput();</span>
  // get position from NavigationData to move the camera to this position
<span style = "background-color:#fdd">  Point3D cameraPosition = navigationData-&gt;GetPosition();</span>

  //calculate the transform from the quaternions
<span style = "background-color:#fdd">  static itk::QuaternionRigidTransform&lt;double&gt;::Pointer quatTransform = itk::QuaternionRigidTransform&lt;double&gt;::New();</span>

<span style = "background-color:#fdd">  mitk::NavigationData::OrientationType orientation = navigationData-&gt;GetOrientation();</span>
  // convert mitk::Scalartype quaternion to double quaternion because of itk bug
<span style = "background-color:#fdd">  vnl_quaternion&lt;double&gt; doubleQuaternion(orientation.x(), orientation.y(), orientation.z(), orientation.r());
  quatTransform-&gt;SetIdentity();
  quatTransform-&gt;SetRotation(doubleQuaternion);
  quatTransform-&gt;Modified();</span>

  /* because of an itk bug, the transform can not be calculated with float datatype.
  To use it in the mitk geometry classes, it has to be transfered to mitk::ScalarType which is float */
  static AffineTransform3D::MatrixType m;
  //mitk::TransferMatrix(quatTransform-&gt;GetMatrix(), m);
<span style = "background-color:#fdd">  m = navigationData-&gt;GetOrientation().rotation_matrix_transpose();</span>


<span style = "background-color:#fdd">  Vector3D directionOfProjection = m*m_DirectionOfProjectionInToolCoordinates;
  directionOfProjection.Normalize();
  Point3D focalPoint = cameraPosition + m_FocalLength*directionOfProjection;</span>
  // compute current view up vector
<span style = "background-color:#fdd">  Vector3D viewUp = m*m_ViewUpInToolCoordinates;</span>

<span style = "background-color:#fdd">  m_Renderer-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;SetPosition(cameraPosition[0],cameraPosition[1],cameraPosition[2]);
  m_Renderer-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;SetFocalPoint(focalPoint[0],focalPoint[1],focalPoint[2]);
  m_Renderer-&gt;GetVtkRenderer()-&gt;GetActiveCamera()-&gt;SetViewUp(viewUp[0],viewUp[1],viewUp[2]);
  m_Renderer-&gt;GetVtkRenderer()-&gt;ResetCameraClippingRange();</span>

<span style = "background-color:#fdd">  m_Renderer-&gt;RequestUpdate();
}</span>


void mitk::CameraVisualization::SetRenderer(mitk::BaseRenderer*  renderer)
<span style = "background-color:#fdd">{
  m_Renderer = renderer;
}</span>


const mitk::BaseRenderer* mitk::CameraVisualization::GetRenderer()
<span style = "background-color:#fdd">{
  return m_Renderer;
}</span>


void mitk::CameraVisualization::SetParameters( const mitk::PropertyList* p )
<span style = "background-color:#fdd">{
  if (p == nullptr)
    return;
  mitk::Vector3D doP;
  if (p-&gt;GetPropertyValue&lt;mitk::Vector3D&gt;("CameraVisualization_DirectionOfProjectionInToolCoordinates", doP) == true)  // search for DirectionOfProjectionInToolCoordinates parameter
    this-&gt;SetDirectionOfProjectionInToolCoordinates(doP);   // apply if found;
  mitk::Vector3D vUp;
  if (p-&gt;GetPropertyValue&lt;mitk::Vector3D&gt;("CameraVisualization_ViewUpInToolCoordinates", vUp) == true)  // search for ViewUpInToolCoordinates parameter
    this-&gt;SetViewUpInToolCoordinates(vUp);   // apply if found;</span>
  float fL;
<span style = "background-color:#fdd">  if (p-&gt;GetPropertyValue&lt;float&gt;("CameraVisualization_FocalLength", fL) == true)  // search for FocalLength parameter
    this-&gt;SetFocalLength(fL);   // apply if found;</span>
  float vA;
<span style = "background-color:#fdd">  if (p-&gt;GetPropertyValue&lt;float&gt;("CameraVisualization_ViewAngle", vA) == true)  // search for ViewAngle parameter
    this-&gt;SetFocalLength(vA);   // apply if found;
}</span>


mitk::PropertyList::ConstPointer mitk::CameraVisualization::GetParameters() const
<span style = "background-color:#fdd">{
  mitk::PropertyList::Pointer p = mitk::PropertyList::New();
  p-&gt;SetProperty("CameraVisualization_DirectionOfProjectionInToolCoordinates", mitk::Vector3DProperty::New(this-&gt;GetDirectionOfProjectionInToolCoordinates()));  // store DirectionOfProjectionInToolCoordinates parameter
  p-&gt;SetProperty("CameraVisualization_ViewUpInToolCoordinates", mitk::Vector3DProperty::New(this-&gt;GetViewUpInToolCoordinates()));  // store ViewUpInToolCoordinates parameter
  p-&gt;SetProperty("CameraVisualization_FocalLength", mitk::Vector3DProperty::New(this-&gt;GetFocalLength()));  // store FocalLength parameter
  return mitk::PropertyList::ConstPointer(p);
}</span></pre>
	</body>
</html>
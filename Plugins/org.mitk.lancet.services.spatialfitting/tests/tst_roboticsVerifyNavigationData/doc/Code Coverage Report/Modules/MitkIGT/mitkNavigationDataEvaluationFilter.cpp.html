<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkNavigationDataEvaluationFilter.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkNavigationDataEvaluationFilter.h"
#include &lt;mitkPointSetStatisticsCalculator.h&gt;

mitk::NavigationDataEvaluationFilter::NavigationDataEvaluationFilter()
<span style = "background-color:#fdd">  : mitk::NavigationDataToNavigationDataFilter()
{
}</span>

mitk::NavigationDataEvaluationFilter::~NavigationDataEvaluationFilter()
<span style = "background-color:#fdd">{
}</span>

void mitk::NavigationDataEvaluationFilter::GenerateData()
<span style = "background-color:#fdd">{
  this-&gt;CreateOutputsForAllInputs(); // make sure that we have the same number of outputs as inputs
  this-&gt;CreateMembersForAllInputs();</span>

  /* update outputs with tracking data from tools */
<span style = "background-color:#fdd">  for (unsigned int i = 0; i &lt; this-&gt;GetNumberOfOutputs(); ++i)</span>
  {
    //first copy outputs to inputs
<span style = "background-color:#fdd">    mitk::NavigationData* output = this-&gt;GetOutput(i);
    assert(output);
    const mitk::NavigationData* input = this-&gt;GetInput(i);
    assert(input);
    if (input-&gt;IsDataValid() == false) { output-&gt;SetDataValid(false); }
    else { output-&gt;Graft(input); }</span>

    //then save statistics
<span style = "background-color:#fdd">    if (input-&gt;IsDataValid())</span>
    {
<span style = "background-color:#fdd">      m_LoggedPositions[i].push_back(input-&gt;GetPosition());
      m_LoggedQuaternions[i].push_back(input-&gt;GetOrientation());
    }</span>
    else
    {
<span style = "background-color:#fdd">      m_InvalidSamples[i]++;</span>
    }
<span style = "background-color:#fdd">  }
}</span>
void mitk::NavigationDataEvaluationFilter::CreateMembersForAllInputs()
<span style = "background-color:#fdd">{
  while (this-&gt;m_LoggedPositions.size() &lt; this-&gt;GetNumberOfInputs())</span>
  {
<span style = "background-color:#fdd">    std::pair&lt;std::size_t, std::vector&lt;mitk::Point3D&gt; &gt; newElement(m_LoggedPositions.size(), std::vector&lt;mitk::Point3D&gt;());
    m_LoggedPositions.insert(newElement);
  }
  while (this-&gt;m_LoggedQuaternions.size() &lt; this-&gt;GetNumberOfInputs())</span>
  {
<span style = "background-color:#fdd">    std::pair&lt;std::size_t, std::vector&lt;mitk::Quaternion&gt; &gt; newElement(m_LoggedQuaternions.size(), std::vector&lt;mitk::Quaternion&gt;());
    m_LoggedQuaternions.insert(newElement);
  }
  while (this-&gt;m_InvalidSamples.size() &lt; this-&gt;GetNumberOfInputs())</span>
  {
<span style = "background-color:#fdd">    std::pair&lt;std::size_t, int&gt; newElement(m_InvalidSamples.size(), 0);
    m_InvalidSamples.insert(newElement);
  }
}</span>

void mitk::NavigationDataEvaluationFilter::ResetStatistic()
<span style = "background-color:#fdd">{
  for (unsigned int i = 0; i &lt; m_LoggedPositions.size(); i++) m_LoggedPositions[i] = std::vector&lt;mitk::Point3D&gt;();
  for (unsigned int i = 0; i &lt; m_LoggedQuaternions.size(); i++) m_LoggedQuaternions[i] = std::vector&lt;mitk::Quaternion&gt;();
  for (unsigned int i = 0; i &lt; m_InvalidSamples.size(); i++) m_InvalidSamples[i] = 0;
}</span>

int mitk::NavigationDataEvaluationFilter::GetNumberOfAnalysedNavigationData(int input)
<span style = "background-color:#fdd">{
  return this-&gt;m_LoggedPositions[input].size();
}</span>

mitk::Point3D mitk::NavigationDataEvaluationFilter::GetPositionMean(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(m_LoggedPositions[input]));
  return myCalculator-&gt;GetPositionMean();
}</span>

mitk::Vector3D mitk::NavigationDataEvaluationFilter::GetPositionStandardDeviation(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(m_LoggedPositions[input]));
  return myCalculator-&gt;GetPositionStandardDeviation();
}</span>

mitk::Vector3D mitk::NavigationDataEvaluationFilter::GetPositionSampleStandardDeviation(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(m_LoggedPositions[input]));
  return myCalculator-&gt;GetPositionSampleStandardDeviation();
}</span>

mitk::Quaternion mitk::NavigationDataEvaluationFilter::GetQuaternionMean(int input)
<span style = "background-color:#fdd">{
  return GetMean(m_LoggedQuaternions[input]);
}</span>

mitk::Quaternion mitk::NavigationDataEvaluationFilter::GetQuaternionStandardDeviation(int input)
<span style = "background-color:#fdd">{</span>
  mitk::Quaternion returnValue;
<span style = "background-color:#fdd">  std::vector&lt;double&gt; list1 = std::vector&lt;double&gt;();
  std::vector&lt;double&gt; list2 = std::vector&lt;double&gt;();
  std::vector&lt;double&gt; list3 = std::vector&lt;double&gt;();
  std::vector&lt;double&gt; list4 = std::vector&lt;double&gt;();
  for (unsigned int i = 0; i &lt; m_LoggedQuaternions[input].size(); i++)</span>
  {
<span style = "background-color:#fdd">    list1.push_back(m_LoggedQuaternions[input].at(i)[0]);
    list2.push_back(m_LoggedQuaternions[input].at(i)[1]);
    list3.push_back(m_LoggedQuaternions[input].at(i)[2]);
    list4.push_back(m_LoggedQuaternions[input].at(i)[3]);
  }
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New();
  returnValue[0] = myCalculator-&gt;GetStabw(list1);
  returnValue[1] = myCalculator-&gt;GetStabw(list2);
  returnValue[2] = myCalculator-&gt;GetStabw(list3);
  returnValue[3] = myCalculator-&gt;GetStabw(list4);
  return returnValue;
}</span>

mitk::Vector3D mitk::NavigationDataEvaluationFilter::GetEulerAnglesMean(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(QuaternionsToEulerAngles(m_LoggedQuaternions[input])));
  mitk::Vector3D returnValue;
  returnValue[0] = myCalculator-&gt;GetPositionMean()[0];
  returnValue[1] = myCalculator-&gt;GetPositionMean()[1];
  returnValue[2] = myCalculator-&gt;GetPositionMean()[2];
  return returnValue;
}</span>

double mitk::NavigationDataEvaluationFilter::GetEulerAnglesRMS(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(QuaternionsToEulerAngles(m_LoggedQuaternions[input])));
  return myCalculator-&gt;GetPositionErrorRMS();
}</span>

double mitk::NavigationDataEvaluationFilter::GetEulerAnglesRMSDegree(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(QuaternionsToEulerAnglesGrad(m_LoggedQuaternions[input])));
  return myCalculator-&gt;GetPositionErrorRMS();
}</span>

double mitk::NavigationDataEvaluationFilter::GetPositionErrorMean(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(m_LoggedPositions[input]));
  return myCalculator-&gt;GetPositionErrorMean();
}</span>

double mitk::NavigationDataEvaluationFilter::GetPositionErrorStandardDeviation(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(m_LoggedPositions[input]));
  return myCalculator-&gt;GetPositionErrorStandardDeviation();
}</span>

double mitk::NavigationDataEvaluationFilter::GetPositionErrorSampleStandardDeviation(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(m_LoggedPositions[input]));
  return myCalculator-&gt;GetPositionErrorSampleStandardDeviation();
}</span>

double mitk::NavigationDataEvaluationFilter::GetPositionErrorRMS(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(m_LoggedPositions[input]));
  return myCalculator-&gt;GetPositionErrorRMS();
}</span>

double mitk::NavigationDataEvaluationFilter::GetPositionErrorMedian(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(m_LoggedPositions[input]));
  return myCalculator-&gt;GetPositionErrorMedian();
}</span>

double mitk::NavigationDataEvaluationFilter::GetPositionErrorMax(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(m_LoggedPositions[input]));
  return myCalculator-&gt;GetPositionErrorMax();
}</span>

double mitk::NavigationDataEvaluationFilter::GetPositionErrorMin(int input)
<span style = "background-color:#fdd">{
  mitk::PointSetStatisticsCalculator::Pointer myCalculator = mitk::PointSetStatisticsCalculator::New(VectorToPointSet(m_LoggedPositions[input]));
  return myCalculator-&gt;GetPositionErrorMin();
}</span>

int mitk::NavigationDataEvaluationFilter::GetNumberOfInvalidSamples(int input)
<span style = "background-color:#fdd">{
  return m_InvalidSamples[input];
}</span>

double mitk::NavigationDataEvaluationFilter::GetPercentageOfInvalidSamples(int input)
<span style = "background-color:#fdd">{
  return (m_InvalidSamples[input] / (m_InvalidSamples[input] + ((double)m_LoggedPositions[input].size())))*100.0;
}</span>

mitk::Quaternion mitk::NavigationDataEvaluationFilter::GetMean(std::vector&lt;mitk::Quaternion&gt; list)
<span style = "background-color:#fdd">{</span>
  //calculate mean
  mitk::Quaternion mean;
<span style = "background-color:#fdd">  mean[0] = 0;
  mean[1] = 0;
  mean[2] = 0;
  mean[3] = 0;</span>

<span style = "background-color:#fdd">  for (unsigned int i = 0; i &lt; list.size(); i++)</span>
  {
<span style = "background-color:#fdd">    mean[0] += list.at(i)[0];
    mean[1] += list.at(i)[1];
    mean[2] += list.at(i)[2];
    mean[3] += list.at(i)[3];
  }</span>

<span style = "background-color:#fdd">  mean[0] /= list.size();
  mean[1] /= list.size();
  mean[2] /= list.size();
  mean[3] /= list.size();</span>

<span style = "background-color:#fdd">  return mean;
}</span>

mitk::PointSet::Pointer mitk::NavigationDataEvaluationFilter::VectorToPointSet(std::vector&lt;mitk::Point3D&gt; pSet)
<span style = "background-color:#fdd">{
  mitk::PointSet::Pointer returnValue = mitk::PointSet::New();
  for (unsigned int i = 0; i &lt; pSet.size(); i++) returnValue-&gt;InsertPoint(i, pSet.at(i));
  return returnValue;
}</span>

mitk::PointSet::Pointer mitk::NavigationDataEvaluationFilter::VectorToPointSet(std::vector&lt;mitk::Vector3D&gt; pSet)
<span style = "background-color:#fdd">{
  mitk::PointSet::Pointer returnValue = mitk::PointSet::New();
  for (unsigned int i = 0; i &lt; pSet.size(); i++)</span>
  {
<span style = "background-color:#fdd">    mitk::Point3D thisPoint;
    thisPoint[0] = pSet.at(i)[0];
    thisPoint[1] = pSet.at(i)[1];
    thisPoint[2] = pSet.at(i)[2];
    returnValue-&gt;InsertPoint(i, thisPoint);
  }
  return returnValue;
}</span>

std::vector&lt;mitk::Vector3D&gt; mitk::NavigationDataEvaluationFilter::QuaternionsToEulerAngles(std::vector&lt;mitk::Quaternion&gt; quaterions)
<span style = "background-color:#fdd">{
  std::vector&lt;mitk::Vector3D&gt; returnValue = std::vector&lt;mitk::Vector3D&gt;();
  for (unsigned int i = 0; i &lt; quaterions.size(); i++)</span>
  {
<span style = "background-color:#fdd">    mitk::Vector3D eulerAngles;
    mitk::Quaternion currentQuaternion = quaterions.at(i);
    currentQuaternion.normalize(); //must be normalized due to the documentation of the vnl method rotation_euler_angles()
    eulerAngles[0] = currentQuaternion.rotation_euler_angles()[0];
    eulerAngles[1] = currentQuaternion.rotation_euler_angles()[1];
    eulerAngles[2] = currentQuaternion.rotation_euler_angles()[2];
    returnValue.push_back(eulerAngles);
  }
  return returnValue;
}</span>

std::vector&lt;mitk::Vector3D&gt; mitk::NavigationDataEvaluationFilter::QuaternionsToEulerAnglesGrad(std::vector&lt;mitk::Quaternion&gt; quaterions)
<span style = "background-color:#fdd">{
  std::vector&lt;mitk::Vector3D&gt; returnValue = std::vector&lt;mitk::Vector3D&gt;();
  std::vector&lt;mitk::Vector3D&gt; eulerAnglesRadians = QuaternionsToEulerAngles(quaterions);
  for (unsigned int i = 0; i &lt; eulerAnglesRadians.size(); i++)</span>
  {
<span style = "background-color:#fdd">    mitk::Vector3D currentAngles;
    currentAngles[0] = (eulerAnglesRadians.at(i)[0] / itk::Math::pi) * 180;
    currentAngles[1] = (eulerAnglesRadians.at(i)[1] / itk::Math::pi) * 180;
    currentAngles[2] = (eulerAnglesRadians.at(i)[2] / itk::Math::pi) * 180;
    returnValue.push_back(currentAngles);
  }
  return returnValue;
}</span>

mitk::Point3D  mitk::NavigationDataEvaluationFilter::GetLoggedPosition(unsigned int i, int input)
<span style = "background-color:#fdd">{
  mitk::Point3D returnValue;
  if (m_LoggedPositions[input].size() &lt;= i) returnValue.Fill(0);
  else returnValue = m_LoggedPositions[input].at(i);
  return returnValue;
}</span>

mitk::Quaternion  mitk::NavigationDataEvaluationFilter::GetLoggedOrientation(unsigned int i, int input)
<span style = "background-color:#fdd">{</span>
  mitk::Quaternion returnValue;
<span style = "background-color:#fdd">  if (m_LoggedQuaternions[input].size() &lt;= i) returnValue.fill(0);
  else returnValue = m_LoggedQuaternions[input].at(i);
  return returnValue;
}</span></pre>
	</body>
</html>
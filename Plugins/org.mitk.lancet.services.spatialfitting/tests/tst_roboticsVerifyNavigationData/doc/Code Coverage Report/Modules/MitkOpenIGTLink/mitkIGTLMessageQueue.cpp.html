<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkIGTLMessageQueue.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkIGTLMessageQueue.h"
#include &lt;string&gt;
#include "igtlMessageBase.h"

void mitk::IGTLMessageQueue::PushSendMessage(mitk::IGTLMessage::Pointer message)
<span style = "background-color:#fdd">{
  this-&gt;m_Mutex.lock();
  if (this-&gt;m_BufferingType == IGTLMessageQueue::NoBuffering)
    m_SendQueue.clear();</span>

<span style = "background-color:#fdd">  m_SendQueue.push_back(message);
  this-&gt;m_Mutex.unlock();
}</span>

void mitk::IGTLMessageQueue::PushCommandMessage(igtl::MessageBase::Pointer message)
<span style = "background-color:#fdd">{
  this-&gt;m_Mutex.lock();
  if (this-&gt;m_BufferingType == IGTLMessageQueue::NoBuffering)
    m_CommandQueue.clear();</span>

<span style = "background-color:#fdd">  m_CommandQueue.push_back(message);
  this-&gt;m_Mutex.unlock();
}</span>

void mitk::IGTLMessageQueue::PushMessage(igtl::MessageBase::Pointer msg)
<span style = "background-color:#fdd">{
  this-&gt;m_Mutex.lock();</span>

<span style = "background-color:#fdd">  std::stringstream infolog;</span>

<span style = "background-color:#fdd">  infolog &lt;&lt; "Received message of type ";</span>

<span style = "background-color:#fdd">  if (dynamic_cast&lt;igtl::TrackingDataMessage*&gt;(msg.GetPointer()) != nullptr)</span>
  {
<span style = "background-color:#fdd">    if (this-&gt;m_BufferingType == IGTLMessageQueue::NoBuffering)
      m_TrackingDataQueue.clear();</span>

<span style = "background-color:#fdd">    this-&gt;m_TrackingDataQueue.push_back(dynamic_cast&lt;igtl::TrackingDataMessage*&gt;(msg.GetPointer()));</span>

<span style = "background-color:#fdd">    infolog &lt;&lt; "TDATA";
  }
  else if (dynamic_cast&lt;igtl::TransformMessage*&gt;(msg.GetPointer()) != nullptr)</span>
  {
<span style = "background-color:#fdd">    if (this-&gt;m_BufferingType == IGTLMessageQueue::NoBuffering)
      m_TransformQueue.clear();</span>

<span style = "background-color:#fdd">    this-&gt;m_TransformQueue.push_back(dynamic_cast&lt;igtl::TransformMessage*&gt;(msg.GetPointer()));</span>

<span style = "background-color:#fdd">    infolog &lt;&lt; "TRANSFORM";
  }
  else if (dynamic_cast&lt;igtl::StringMessage*&gt;(msg.GetPointer()) != nullptr)</span>
  {
<span style = "background-color:#fdd">    if (this-&gt;m_BufferingType == IGTLMessageQueue::NoBuffering)
      m_StringQueue.clear();</span>

<span style = "background-color:#fdd">    this-&gt;m_StringQueue.push_back(dynamic_cast&lt;igtl::StringMessage*&gt;(msg.GetPointer()));</span>

<span style = "background-color:#fdd">    infolog &lt;&lt; "STRING";
  }
  else if (dynamic_cast&lt;igtl::ImageMessage*&gt;(msg.GetPointer()) != nullptr)</span>
  {
<span style = "background-color:#fdd">    igtl::ImageMessage::Pointer imageMsg = dynamic_cast&lt;igtl::ImageMessage*&gt;(msg.GetPointer());
    int* dim = new int[3];
    imageMsg-&gt;GetDimensions(dim);
    if (dim[2] &gt; 1)</span>
    {
<span style = "background-color:#fdd">      if (this-&gt;m_BufferingType == IGTLMessageQueue::NoBuffering)
        m_Image3dQueue.clear();</span>

<span style = "background-color:#fdd">      this-&gt;m_Image3dQueue.push_back(dynamic_cast&lt;igtl::ImageMessage*&gt;(msg.GetPointer()));</span>

<span style = "background-color:#fdd">      infolog &lt;&lt; "IMAGE3D";
    }</span>
    else
    {
<span style = "background-color:#fdd">      if (this-&gt;m_BufferingType == IGTLMessageQueue::NoBuffering)
        m_Image2dQueue.clear();</span>

<span style = "background-color:#fdd">      this-&gt;m_Image2dQueue.push_back(dynamic_cast&lt;igtl::ImageMessage*&gt;(msg.GetPointer()));</span>

<span style = "background-color:#fdd">      infolog &lt;&lt; "IMAGE2D";</span>
    }
<span style = "background-color:#fdd">  }</span>
  else
  {
<span style = "background-color:#fdd">    if (this-&gt;m_BufferingType == IGTLMessageQueue::NoBuffering)
      m_MiscQueue.clear();</span>

<span style = "background-color:#fdd">    this-&gt;m_MiscQueue.push_back(msg);</span>

<span style = "background-color:#fdd">    infolog &lt;&lt; "OTHER";</span>
  }

<span style = "background-color:#fdd">  m_Latest_Message = msg;</span>

  //MITK_INFO &lt;&lt; infolog.str();

<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
}</span>

mitk::IGTLMessage::Pointer mitk::IGTLMessageQueue::PullSendMessage()
<span style = "background-color:#fdd">{
  mitk::IGTLMessage::Pointer ret = nullptr;
  this-&gt;m_Mutex.lock();
  if (this-&gt;m_SendQueue.size() &gt; 0)</span>
  {
<span style = "background-color:#fdd">    ret = this-&gt;m_SendQueue.front();
    this-&gt;m_SendQueue.pop_front();</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return ret;
}</span>

igtl::MessageBase::Pointer mitk::IGTLMessageQueue::PullMiscMessage()
<span style = "background-color:#fdd">{
  igtl::MessageBase::Pointer ret = nullptr;
  this-&gt;m_Mutex.lock();
  if (this-&gt;m_MiscQueue.size() &gt; 0)</span>
  {
<span style = "background-color:#fdd">    ret = this-&gt;m_MiscQueue.front();
    this-&gt;m_MiscQueue.pop_front();</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return ret;
}</span>

igtl::ImageMessage::Pointer mitk::IGTLMessageQueue::PullImage2dMessage()
<span style = "background-color:#fdd">{
  igtl::ImageMessage::Pointer ret = nullptr;
  this-&gt;m_Mutex.lock();
  if (this-&gt;m_Image2dQueue.size() &gt; 0)</span>
  {
<span style = "background-color:#fdd">    ret = this-&gt;m_Image2dQueue.front();
    this-&gt;m_Image2dQueue.pop_front();</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return ret;
}</span>

igtl::ImageMessage::Pointer mitk::IGTLMessageQueue::PullImage3dMessage()
<span style = "background-color:#fdd">{
  igtl::ImageMessage::Pointer ret = nullptr;
  this-&gt;m_Mutex.lock();
  if (this-&gt;m_Image3dQueue.size() &gt; 0)</span>
  {
<span style = "background-color:#fdd">    ret = this-&gt;m_Image3dQueue.front();
    this-&gt;m_Image3dQueue.pop_front();</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return ret;
}</span>

igtl::TrackingDataMessage::Pointer mitk::IGTLMessageQueue::PullTrackingMessage()
<span style = "background-color:#fdd">{
  igtl::TrackingDataMessage::Pointer ret = nullptr;
  this-&gt;m_Mutex.lock();
  if (this-&gt;m_TrackingDataQueue.size() &gt; 0)</span>
  {
<span style = "background-color:#fdd">    ret = this-&gt;m_TrackingDataQueue.front();
    this-&gt;m_TrackingDataQueue.pop_front();</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return ret;
}</span>

igtl::MessageBase::Pointer mitk::IGTLMessageQueue::PullCommandMessage()
<span style = "background-color:#fdd">{
  igtl::MessageBase::Pointer ret = nullptr;
  this-&gt;m_Mutex.lock();
  if (this-&gt;m_CommandQueue.size() &gt; 0)</span>
  {
<span style = "background-color:#fdd">    ret = this-&gt;m_CommandQueue.front();
    this-&gt;m_CommandQueue.pop_front();</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return ret;
}</span>

igtl::StringMessage::Pointer mitk::IGTLMessageQueue::PullStringMessage()
<span style = "background-color:#fdd">{
  igtl::StringMessage::Pointer ret = nullptr;
  this-&gt;m_Mutex.lock();
  if (this-&gt;m_StringQueue.size() &gt; 0)</span>
  {
<span style = "background-color:#fdd">    ret = this-&gt;m_StringQueue.front();
    this-&gt;m_StringQueue.pop_front();</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return ret;
}</span>

igtl::TransformMessage::Pointer mitk::IGTLMessageQueue::PullTransformMessage()
<span style = "background-color:#fdd">{
  igtl::TransformMessage::Pointer ret = nullptr;
  this-&gt;m_Mutex.lock();
  if (this-&gt;m_TransformQueue.size() &gt; 0)</span>
  {
<span style = "background-color:#fdd">    ret = this-&gt;m_TransformQueue.front();
    this-&gt;m_TransformQueue.pop_front();</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return ret;
}</span>

std::string mitk::IGTLMessageQueue::GetNextMsgInformationString()
<span style = "background-color:#fdd">{
  this-&gt;m_Mutex.lock();
  std::stringstream s;
  if (this-&gt;m_Latest_Message != nullptr)</span>
  {
<span style = "background-color:#fdd">    s &lt;&lt; "Device Type: " &lt;&lt; this-&gt;m_Latest_Message-&gt;GetDeviceType() &lt;&lt; std::endl;
    s &lt;&lt; "Device Name: " &lt;&lt; this-&gt;m_Latest_Message-&gt;GetDeviceName() &lt;&lt; std::endl;
  }</span>
  else
  {
<span style = "background-color:#fdd">    s &lt;&lt; "No Msg";</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return s.str();
}</span>

std::string mitk::IGTLMessageQueue::GetNextMsgDeviceType()
<span style = "background-color:#fdd">{
  this-&gt;m_Mutex.lock();
  std::stringstream s;
  if (m_Latest_Message != nullptr)</span>
  {
<span style = "background-color:#fdd">    s &lt;&lt; this-&gt;m_Latest_Message-&gt;GetDeviceType();
  }</span>
  else
  {
<span style = "background-color:#fdd">    s &lt;&lt; "";</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return s.str();
}</span>

std::string mitk::IGTLMessageQueue::GetLatestMsgInformationString()
<span style = "background-color:#fdd">{
  this-&gt;m_Mutex.lock();
  std::stringstream s;
  if (m_Latest_Message != nullptr)</span>
  {
<span style = "background-color:#fdd">    s &lt;&lt; "Device Type: " &lt;&lt; this-&gt;m_Latest_Message-&gt;GetDeviceType() &lt;&lt; std::endl;
    s &lt;&lt; "Device Name: " &lt;&lt; this-&gt;m_Latest_Message-&gt;GetDeviceName() &lt;&lt; std::endl;
  }</span>
  else
  {
<span style = "background-color:#fdd">    s &lt;&lt; "No Msg";</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return s.str();
}</span>

std::string mitk::IGTLMessageQueue::GetLatestMsgDeviceType()
<span style = "background-color:#fdd">{
  this-&gt;m_Mutex.lock();
  std::stringstream s;
  if (m_Latest_Message != nullptr)</span>
  {
<span style = "background-color:#fdd">    s &lt;&lt; this-&gt;m_Latest_Message-&gt;GetDeviceType();
  }</span>
  else
  {
<span style = "background-color:#fdd">    s &lt;&lt; "";</span>
  }
<span style = "background-color:#fdd">  this-&gt;m_Mutex.unlock();
  return s.str();
}</span>

int mitk::IGTLMessageQueue::GetSize()
<span style = "background-color:#fdd">{
  return (this-&gt;m_CommandQueue.size() + this-&gt;m_Image2dQueue.size() + this-&gt;m_Image3dQueue.size() + this-&gt;m_MiscQueue.size()</span>
    + this-&gt;m_StringQueue.size() + this-&gt;m_TrackingDataQueue.size() + this-&gt;m_TransformQueue.size());
<span style = "background-color:#fdd">}</span>

void mitk::IGTLMessageQueue::EnableNoBufferingMode(bool enable)
<span style = "background-color:#fdd">{
  this-&gt;m_Mutex.lock();
  if (enable)
    this-&gt;m_BufferingType = IGTLMessageQueue::BufferingType::NoBuffering;</span>
  else
<span style = "background-color:#fdd">    this-&gt;m_BufferingType = IGTLMessageQueue::BufferingType::Infinit;
  this-&gt;m_Mutex.unlock();
}</span>

mitk::IGTLMessageQueue::IGTLMessageQueue()
<span style = "background-color:#fdd">{
  this-&gt;m_BufferingType = IGTLMessageQueue::NoBuffering;
}</span>

mitk::IGTLMessageQueue::~IGTLMessageQueue()
<span style = "background-color:#fdd">{
  this-&gt;m_Mutex.unlock();
}</span></pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkNumericTwoTissueCompartmentModel.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkNumericTwoTissueCompartmentModel.h"
#include "mitkAIFParametrizerHelper.h"
#include "mitkTimeGridHelper.h"
#include "mitkTwoTissueCompartmentModelDifferentialEquations.h"
#include &lt;vnl/algo/vnl_fft_1d.h&gt;
#include &lt;boost/numeric/odeint.hpp&gt;
#include &lt;fstream&gt;

<span style = "background-color:#dfd">const std::string mitk::NumericTwoTissueCompartmentModel::MODEL_DISPLAY_NAME =
  "Numeric Two Tissue Compartment Model";</span>

<span style = "background-color:#dfd">const std::string mitk::NumericTwoTissueCompartmentModel::NAME_PARAMETER_K1 = "K1";
const std::string mitk::NumericTwoTissueCompartmentModel::NAME_PARAMETER_k2 = "k2";
const std::string mitk::NumericTwoTissueCompartmentModel::NAME_PARAMETER_k3 = "k3";
const std::string mitk::NumericTwoTissueCompartmentModel::NAME_PARAMETER_k4 = "k4";
const std::string mitk::NumericTwoTissueCompartmentModel::NAME_PARAMETER_VB = "V_B";</span>

<span style = "background-color:#dfd">const std::string mitk::NumericTwoTissueCompartmentModel::UNIT_PARAMETER_K1 = "1/min";
const std::string mitk::NumericTwoTissueCompartmentModel::UNIT_PARAMETER_k2 = "1/min";
const std::string mitk::NumericTwoTissueCompartmentModel::UNIT_PARAMETER_k3 = "1/min";
const std::string mitk::NumericTwoTissueCompartmentModel::UNIT_PARAMETER_k4 = "1/min";
const std::string mitk::NumericTwoTissueCompartmentModel::UNIT_PARAMETER_VB = "ml/ml";</span>

const unsigned int mitk::NumericTwoTissueCompartmentModel::POSITION_PARAMETER_K1 = 0;
const unsigned int mitk::NumericTwoTissueCompartmentModel::POSITION_PARAMETER_k2 = 1;
const unsigned int mitk::NumericTwoTissueCompartmentModel::POSITION_PARAMETER_k3 = 2;
const unsigned int mitk::NumericTwoTissueCompartmentModel::POSITION_PARAMETER_k4 = 3;
const unsigned int mitk::NumericTwoTissueCompartmentModel::POSITION_PARAMETER_VB = 4;

const unsigned int mitk::NumericTwoTissueCompartmentModel::NUMBER_OF_PARAMETERS = 5;


std::string mitk::NumericTwoTissueCompartmentModel::GetModelDisplayName() const
<span style = "background-color:#fdd">{
  return MODEL_DISPLAY_NAME;
};</span>

std::string mitk::NumericTwoTissueCompartmentModel::GetModelType() const
<span style = "background-color:#dfd">{
  return "Dynamic.PET";
};</span>

mitk::NumericTwoTissueCompartmentModel::NumericTwoTissueCompartmentModel()
<span style = "background-color:#dfd">{</span>

<span style = "background-color:#dfd">}</span>

mitk::NumericTwoTissueCompartmentModel::~NumericTwoTissueCompartmentModel()
<span style = "background-color:#dfd">{</span>

<span style = "background-color:#dfd">}</span>

mitk::NumericTwoTissueCompartmentModel::ParameterNamesType
mitk::NumericTwoTissueCompartmentModel::GetParameterNames() const
<span style = "background-color:#fdd">{
  ParameterNamesType result;</span>

<span style = "background-color:#fdd">  result.push_back(NAME_PARAMETER_K1);
  result.push_back(NAME_PARAMETER_k2);
  result.push_back(NAME_PARAMETER_k3);
  result.push_back(NAME_PARAMETER_k4);
  result.push_back(NAME_PARAMETER_VB);</span>

<span style = "background-color:#fdd">  return result;
}</span>

mitk::NumericTwoTissueCompartmentModel::ParametersSizeType
mitk::NumericTwoTissueCompartmentModel::GetNumberOfParameters() const
<span style = "background-color:#fdd">{
  return NUMBER_OF_PARAMETERS;
}</span>

mitk::NumericTwoTissueCompartmentModel::ParamterUnitMapType
mitk::NumericTwoTissueCompartmentModel::GetParameterUnits() const
<span style = "background-color:#fdd">{
  ParamterUnitMapType result;</span>

<span style = "background-color:#fdd">  result.insert(std::make_pair(NAME_PARAMETER_K1, UNIT_PARAMETER_K1));
  result.insert(std::make_pair(NAME_PARAMETER_k2, UNIT_PARAMETER_k2));
  result.insert(std::make_pair(NAME_PARAMETER_k3, UNIT_PARAMETER_k3));
  result.insert(std::make_pair(NAME_PARAMETER_k4, UNIT_PARAMETER_k4));
  result.insert(std::make_pair(NAME_PARAMETER_VB, UNIT_PARAMETER_VB));</span>

<span style = "background-color:#fdd">  return result;
};</span>


mitk::NumericTwoTissueCompartmentModel::ModelResultType
mitk::NumericTwoTissueCompartmentModel::ComputeModelfunction(const ParametersType&amp; parameters) const
<span style = "background-color:#fdd">{</span>
  typedef itk::Array&lt;double&gt; ConcentrationCurveType;
  typedef std::vector&lt;double&gt; ConcentrationVectorType;

<span style = "background-color:#fdd">  if (this-&gt;m_TimeGrid.GetSize() == 0)</span>
  {
<span style = "background-color:#fdd">    itkExceptionMacro("No Time Grid Set! Cannot Calculate Signal");</span>
  }

<span style = "background-color:#fdd">  AterialInputFunctionType aterialInputFunction;
  aterialInputFunction = GetAterialInputFunction(this-&gt;m_TimeGrid);</span>

<span style = "background-color:#fdd">  unsigned int timeSteps = this-&gt;m_TimeGrid.GetSize();</span>

  /** @brief Boost::numeric::odeint works with type std::vector&lt;double&gt; thus, aif and grid are converted to ModelParameters( of type std::vector)
   */
<span style = "background-color:#fdd">  mitk::TwoTissueCompartmentModelDifferentialEquations::AIFType aif = mitk::convertArrayToParameter(</span>
        aterialInputFunction);
<span style = "background-color:#fdd">  mitk::TwoTissueCompartmentModelDifferentialEquations::AIFType grid = mitk::convertArrayToParameter(</span>
        m_TimeGrid);

<span style = "background-color:#fdd">  mitk::TwoTissueCompartmentModelDifferentialEquations::AIFType aifODE = aif;
  aifODE.push_back(aif[timeSteps - 1]);
  mitk::TwoTissueCompartmentModelDifferentialEquations::AIFType gridODE = grid;
  gridODE.push_back(grid[timeSteps - 1] + (grid[timeSteps - 1] - grid[timeSteps - 2]));</span>

  //Model Parameters
<span style = "background-color:#fdd">  double K1 = (double)parameters[POSITION_PARAMETER_K1] / 60.0;
  double k2 = (double)parameters[POSITION_PARAMETER_k2] / 60.0;
  double k3 = (double)parameters[POSITION_PARAMETER_k3] / 60.0;
  double k4 = (double)parameters[POSITION_PARAMETER_k4] / 60.0;
  double VB = parameters[POSITION_PARAMETER_VB];</span>


  /** @brief Initialize class TwpTissueCompartmentModelDifferentialEquations defining the differential equations. AIF and Grid must be set so that at step t the aterial Concentration Ca(t) can be interpolated from AIF*/
<span style = "background-color:#fdd">  mitk::TwoTissueCompartmentModelDifferentialEquations ode;
  ode.initialize(K1, k2, k3, k4);
  ode.setAIF(aifODE);
  ode.setAIFTimeGrid(gridODE);</span>

<span style = "background-color:#fdd">  state_type x(2);
  x[0] = 0.0;
  x[1] = 0.0;</span>
  typedef boost::numeric::odeint::runge_kutta_cash_karp54&lt;state_type&gt; error_stepper_type;
  //typedef boost::numeric::odeint::runge_kutta4&lt; state_type &gt; stepper_type;

  /** @brief Results of odeeint x[0] and x[1]*/
<span style = "background-color:#fdd">  ConcentrationVectorType C1;
  ConcentrationVectorType C2;
  ConcentrationVectorType odeTimeGrid;</span>

<span style = "background-color:#fdd">  error_stepper_type stepper;</span>
  /** @brief Stepsize. Should be adapted by stepper (runge_kutta_cash_karp54) */
<span style = "background-color:#fdd">  const double dt = 0.1;</span>
  /** @brief perform Step t -&gt; t+dt to calculate approximate value x(t+dt)*/

<span style = "background-color:#fdd">  double T = this-&gt;m_TimeGrid(timeSteps - 1) + (grid[timeSteps - 1] - grid[timeSteps - 2]);</span>

<span style = "background-color:#fdd">  for (double t = 0.0; t &lt; T; t += dt)</span>
  {
<span style = "background-color:#fdd">    stepper.do_step(ode, x, t, dt);
    C1.push_back(x[0]);
    C2.push_back(x[1]);
    odeTimeGrid.push_back(t);</span>

<span style = "background-color:#fdd">  }</span>

  /** @brief transfom result of Differential equations back to itk::Array and interpolate to m_TimeGrid (they are calculated on a different grid defined by stepsize of odeint)*/
<span style = "background-color:#fdd">  ConcentrationCurveType ConcentrationCompartment1 = mitk::convertParameterToArray(C1);
  ConcentrationCurveType ConcentrationCompartment2 = mitk::convertParameterToArray(C2);
  ConcentrationCurveType rungeKuttaTimeGrid = mitk::convertParameterToArray(odeTimeGrid);</span>

<span style = "background-color:#fdd">  mitk::ModelBase::ModelResultType C_1 = mitk::InterpolateSignalToNewTimeGrid(</span>
      ConcentrationCompartment1, rungeKuttaTimeGrid, m_TimeGrid);
<span style = "background-color:#fdd">  mitk::ModelBase::ModelResultType C_2 = mitk::InterpolateSignalToNewTimeGrid(</span>
      ConcentrationCompartment2, rungeKuttaTimeGrid, m_TimeGrid);


  //Signal that will be returned by ComputeModelFunction
<span style = "background-color:#fdd">  mitk::ModelBase::ModelResultType signal(timeSteps);
  signal.fill(0.0);
  mitk::ModelBase::ModelResultType::iterator signalPos = signal.begin();
  mitk::ModelBase::ModelResultType::const_iterator C1Pos = C_1.begin();
  mitk::ModelBase::ModelResultType::const_iterator C2Pos = C_2.begin();</span>


<span style = "background-color:#fdd">  for (AterialInputFunctionType::const_iterator aifpos = aterialInputFunction.begin();
       aifpos != aterialInputFunction.end(); ++aifpos, ++C1Pos, ++C2Pos, ++signalPos)</span>
  {
<span style = "background-color:#fdd">    *signalPos = VB * (*aifpos) + (1 - VB) * (*C1Pos + *C2Pos);
  }</span>

<span style = "background-color:#fdd">  return signal;</span>

<span style = "background-color:#fdd">}</span>

itk::LightObject::Pointer mitk::NumericTwoTissueCompartmentModel::InternalClone() const
<span style = "background-color:#fdd">{
  NumericTwoTissueCompartmentModel::Pointer newClone = NumericTwoTissueCompartmentModel::New();</span>

<span style = "background-color:#fdd">  newClone-&gt;SetTimeGrid(this-&gt;m_TimeGrid);</span>

<span style = "background-color:#fdd">  return newClone.GetPointer();
}</span>

void mitk::NumericTwoTissueCompartmentModel::PrintSelf(std::ostream&amp; os, ::itk::Indent indent) const
<span style = "background-color:#fdd">{
  Superclass::PrintSelf(os, indent);</span>


<span style = "background-color:#fdd">}</span>



</pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkConcentrationCurveGenerator.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkConcentrationCurveGenerator.h"
#include "mitkConvertToConcentrationTurboFlashFunctor.h"
#include "mitkConvertT2ConcentrationFunctor.h"
#include "mitkConvertToConcentrationViaT1Functor.h"
#include "mitkImageTimeSelector.h"
#include "mitkImageCast.h"
#include "mitkITKImageImport.h"
#include "mitkModelBase.h"
#include "mitkExtractTimeGrid.h"
#include "mitkArbitraryTimeGeometry.h"
#include "itkNaryAddImageFilter.h"
#include "mitkImageAccessByItk.h"
#include "itkImageIOBase.h"
#include "itkBinaryFunctorImageFilter.h"
#include "itkTernaryFunctorImageFilter.h"
#include &lt;itkExtractImageFilter.h&gt;
#include "itkMeanProjectionImageFilter.h"

<span style = "background-color:#fdd">mitk::ConcentrationCurveGenerator::ConcentrationCurveGenerator() : m_isT2weightedImage(false), m_isTurboFlashSequence(false),
    m_AbsoluteSignalEnhancement(false), m_RelativeSignalEnhancement(0.0), m_UsingT1Map(false), m_Factor(0.0), m_RecoveryTime(0.0), m_RelaxationTime(0.0),
    m_Relaxivity(0.0), m_FlipAngle(0.0), m_T2Factor(0.0), m_T2EchoTime(0.0)
{
}</span>

mitk::ConcentrationCurveGenerator::~ConcentrationCurveGenerator()
<span style = "background-color:#fdd">{</span>

<span style = "background-color:#fdd">}</span>

mitk::Image::Pointer mitk::ConcentrationCurveGenerator::GetConvertedImage()
<span style = "background-color:#fdd">{
    if(this-&gt;m_DynamicImage.IsNull())</span>
    {
<span style = "background-color:#fdd">        itkExceptionMacro( &lt;&lt; "Dynamic Image not set!");
    }</span>
    else {
<span style = "background-color:#fdd">    Convert();</span>
    }
<span style = "background-color:#fdd">    return m_ConvertedImage;</span>

<span style = "background-color:#fdd">}</span>

void mitk::ConcentrationCurveGenerator::Convert()
<span style = "background-color:#fdd">{</span>

<span style = "background-color:#fdd">    mitk::Image::Pointer tempImage = mitk::Image::New();
    mitk::PixelType pixeltype = mitk::MakeScalarPixelType&lt;double&gt;();</span>

<span style = "background-color:#fdd">    tempImage-&gt;Initialize(pixeltype,*this-&gt;m_DynamicImage-&gt;GetTimeGeometry());</span>

<span style = "background-color:#fdd">    mitk::TimeGeometry::Pointer timeGeometry = (this-&gt;m_DynamicImage-&gt;GetTimeGeometry())-&gt;Clone();
    tempImage-&gt;SetTimeGeometry(timeGeometry);</span>

<span style = "background-color:#fdd">    PrepareBaselineImage();
    mitk::ImageTimeSelector::Pointer imageTimeSelector = mitk::ImageTimeSelector::New();
    imageTimeSelector-&gt;SetInput(this-&gt;m_DynamicImage);</span>

<span style = "background-color:#fdd">    for(unsigned int i = 0; i&lt; this-&gt;m_DynamicImage-&gt;GetTimeSteps(); ++i)</span>
    {
<span style = "background-color:#fdd">        imageTimeSelector-&gt;SetTimeNr(i);
        imageTimeSelector-&gt;UpdateLargestPossibleRegion();</span>

<span style = "background-color:#fdd">        mitk::Image::Pointer mitkInputImage = imageTimeSelector-&gt;GetOutput();
        mitk::Image::Pointer outputImage = mitk::Image::New();</span>

<span style = "background-color:#fdd">        outputImage = ConvertSignalToConcentrationCurve(mitkInputImage,this-&gt;m_BaselineImage);</span>

<span style = "background-color:#fdd">        mitk::ImageReadAccessor accessor(outputImage);
        tempImage-&gt;SetVolume(accessor.GetData(), i);
    }</span>

<span style = "background-color:#fdd">    this-&gt;m_ConvertedImage = tempImage;</span>

<span style = "background-color:#fdd">}</span>

void mitk::ConcentrationCurveGenerator::PrepareBaselineImage()
<span style = "background-color:#fdd">{</span>

<span style = "background-color:#fdd">  mitk::ImageTimeSelector::Pointer imageTimeSelector = mitk::ImageTimeSelector::New();
  imageTimeSelector-&gt;SetInput(this-&gt;m_DynamicImage);
  imageTimeSelector-&gt;SetTimeNr(0);
  imageTimeSelector-&gt;UpdateLargestPossibleRegion();
  mitk::Image::Pointer baselineImage;
  baselineImage = imageTimeSelector-&gt;GetOutput();</span>
  
<span style = "background-color:#fdd">  if (m_BaselineStartTimeStep == m_BaselineEndTimeStep)</span>
  {
<span style = "background-color:#fdd">    this-&gt;m_BaselineImage = imageTimeSelector-&gt;GetOutput();
  }</span>
  else
  {
    try
    {
<span style = "background-color:#fdd">      AccessFixedDimensionByItk(this-&gt;m_DynamicImage, mitk::ConcentrationCurveGenerator::CalculateAverageBaselineImage, 4);</span>
    }
    catch (itk::ExceptionObject &amp; err)
<span style = "background-color:#fdd">    {
      std::cerr &lt;&lt; "ExceptionObject in ConcentrationCurveGenerator::CalculateAverageBaselineImage caught!" &lt;&lt; std::endl;
      std::cerr &lt;&lt; err &lt;&lt; std::endl;
    }</span>
  }
<span style = "background-color:#fdd">}</span>

template&lt;class TPixel&gt;
void mitk::ConcentrationCurveGenerator::CalculateAverageBaselineImage(const itk::Image&lt;TPixel, 4&gt; *itkBaselineImage)
<span style = "background-color:#fdd">{
  if (itkBaselineImage == NULL)</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Error in ConcentrationCurveGenerator::CalculateAverageBaselineImage. Input image is NULL.";</span>
  }
<span style = "background-color:#fdd">  if (m_BaselineStartTimeStep &gt; m_BaselineEndTimeStep)</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Error in ConcentrationCurveGenerator::CalculateAverageBaselineImage. End time point is before start time point.";</span>
  }
  
  typedef itk::Image&lt;TPixel, 4&gt; TPixel4DImageType;
  typedef itk::Image&lt;double, 3&gt; Double3DImageType;
  typedef itk::Image&lt;double, 4&gt; Double4DImageType;
  typedef itk::ExtractImageFilter&lt;TPixel4DImageType, TPixel4DImageType&gt; ExtractImageFilterType;
  typedef itk::ExtractImageFilter&lt;Double4DImageType, Double3DImageType&gt; Extract3DImageFilterType;
  typedef itk::MeanProjectionImageFilter&lt;TPixel4DImageType,Double4DImageType&gt; MeanProjectionImageFilterType;

<span style = "background-color:#fdd">  typename MeanProjectionImageFilterType::Pointer MeanProjectionImageFilter = MeanProjectionImageFilterType::New();
  typename Extract3DImageFilterType::Pointer Extract3DImageFilter = Extract3DImageFilterType::New();
  typename TPixel4DImageType::RegionType region_input = itkBaselineImage-&gt;GetLargestPossibleRegion();</span>

<span style = "background-color:#fdd">  if (m_BaselineEndTimeStep &gt; region_input.GetSize()[3])</span>
  {
<span style = "background-color:#fdd">    mitkThrow() &lt;&lt; "Error in ConcentrationCurveGenerator::CalculateAverageBaselineImage. End time point is larger than total number of time points.";</span>
  }

<span style = "background-color:#fdd">  typename ExtractImageFilterType::Pointer ExtractFilter = ExtractImageFilterType::New();
  typename TPixel4DImageType::Pointer baselineTimeFrameImage = TPixel4DImageType::New();
  typename TPixel4DImageType::RegionType extractionRegion;
  typename TPixel4DImageType::SizeType size_input_aux = region_input.GetSize();
  size_input_aux[3] = m_BaselineEndTimeStep - m_BaselineStartTimeStep + 1;
  typename TPixel4DImageType::IndexType start_input_aux = region_input.GetIndex();
  start_input_aux[3] = m_BaselineStartTimeStep;
  extractionRegion.SetSize(size_input_aux);
  extractionRegion.SetIndex(start_input_aux);
  ExtractFilter-&gt;SetExtractionRegion(extractionRegion);
  ExtractFilter-&gt;SetInput(itkBaselineImage);
  ExtractFilter-&gt;SetDirectionCollapseToSubmatrix();</span>
  try
  {
<span style = "background-color:#fdd">    ExtractFilter-&gt;Update();</span>
  }
  catch (itk::ExceptionObject &amp; err)
<span style = "background-color:#fdd">  {
    std::cerr &lt;&lt; "ExceptionObject caught!" &lt;&lt; std::endl;
    std::cerr &lt;&lt; err &lt;&lt; std::endl;
  }
  baselineTimeFrameImage = ExtractFilter-&gt;GetOutput();
  MeanProjectionImageFilter-&gt;SetProjectionDimension(3);
  MeanProjectionImageFilter-&gt;SetInput(baselineTimeFrameImage);</span>
  try
  {
<span style = "background-color:#fdd">    MeanProjectionImageFilter-&gt;Update();</span>
  }
  catch (itk::ExceptionObject &amp; err)
<span style = "background-color:#fdd">  {
    std::cerr &lt;&lt; "ExceptionObject caught!" &lt;&lt; std::endl;
    std::cerr &lt;&lt; err &lt;&lt; std::endl;
  }
  Extract3DImageFilter-&gt;SetInput(MeanProjectionImageFilter-&gt;GetOutput());
  size_input_aux[3] = 0;
  start_input_aux[3] = 0;
  extractionRegion.SetSize(size_input_aux);
  extractionRegion.SetIndex(start_input_aux);
  Extract3DImageFilter-&gt;SetExtractionRegion(extractionRegion);
  Extract3DImageFilter-&gt;SetDirectionCollapseToSubmatrix();</span>
  try
  {
<span style = "background-color:#fdd">    Extract3DImageFilter-&gt;Update();</span>
  }
  catch (itk::ExceptionObject &amp; err)
<span style = "background-color:#fdd">  {
    std::cerr &lt;&lt; "ExceptionObject caught!" &lt;&lt; std::endl;
    std::cerr &lt;&lt; err &lt;&lt; std::endl;
  }</span>

<span style = "background-color:#fdd">  Image::Pointer mitkBaselineImage = Image::New();
  CastToMitkImage(Extract3DImageFilter-&gt;GetOutput(), mitkBaselineImage);
  this-&gt;m_BaselineImage = mitkBaselineImage;
}</span>


mitk::Image::Pointer mitk::ConcentrationCurveGenerator::ConvertSignalToConcentrationCurve(const mitk::Image* inputImage,const mitk::Image* baselineImage)
<span style = "background-color:#fdd">{
  mitk::PixelType m_PixelType = inputImage-&gt;GetPixelType();
  AccessTwoImagesFixedDimensionByItk(inputImage, baselineImage, mitk::ConcentrationCurveGenerator::convertToConcentration, 3);
  return m_ConvertSignalToConcentrationCurve_OutputImage;</span>

<span style = "background-color:#fdd">}</span>


template&lt;class TPixel_input, class TPixel_baseline&gt;
mitk::Image::Pointer mitk::ConcentrationCurveGenerator::convertToConcentration(const itk::Image&lt;TPixel_input, 3&gt; *itkInputImage, const itk::Image&lt;TPixel_baseline, 3&gt; *itkBaselineImage)
<span style = "background-color:#fdd">{</span>
    typedef itk::Image&lt;TPixel_input, 3&gt; InputImageType;
    typedef itk::Image&lt;TPixel_baseline, 3&gt; BaselineImageType;


<span style = "background-color:#fdd">    if (this-&gt;m_isT2weightedImage)</span>
    {
        typedef mitk::ConvertT2ConcentrationFunctor &lt;TPixel_input, TPixel_baseline, double&gt; ConversionFunctorT2Type;
        typedef itk::BinaryFunctorImageFilter&lt;InputImageType, BaselineImageType, ConvertedImageType, ConversionFunctorT2Type&gt; FilterT2Type;


<span style = "background-color:#fdd">        ConversionFunctorT2Type ConversionT2Functor;
        ConversionT2Functor.initialize(this-&gt;m_T2Factor, this-&gt;m_T2EchoTime);</span>

<span style = "background-color:#fdd">        typename FilterT2Type::Pointer ConversionT2Filter = FilterT2Type::New();</span>

<span style = "background-color:#fdd">        ConversionT2Filter-&gt;SetFunctor(ConversionT2Functor);
        ConversionT2Filter-&gt;SetInput1(itkInputImage);
        ConversionT2Filter-&gt;SetInput2(itkBaselineImage);</span>

<span style = "background-color:#fdd">        ConversionT2Filter-&gt;Update();</span>

<span style = "background-color:#fdd">        m_ConvertSignalToConcentrationCurve_OutputImage = mitk::ImportItkImage(ConversionT2Filter-&gt;GetOutput())-&gt;Clone();
      }</span>

    else
    {
<span style = "background-color:#fdd">        if(this-&gt;m_isTurboFlashSequence)</span>
        {
            typedef mitk::ConvertToConcentrationTurboFlashFunctor &lt;TPixel_input, TPixel_baseline, double&gt; ConversionFunctorTurboFlashType;
            typedef itk::BinaryFunctorImageFilter&lt;InputImageType, BaselineImageType, ConvertedImageType, ConversionFunctorTurboFlashType&gt; FilterTurboFlashType;

<span style = "background-color:#fdd">            ConversionFunctorTurboFlashType ConversionTurboFlashFunctor;
            ConversionTurboFlashFunctor.initialize(this-&gt;m_RelaxationTime, this-&gt;m_Relaxivity, this-&gt;m_RecoveryTime);</span>

<span style = "background-color:#fdd">            typename FilterTurboFlashType::Pointer ConversionTurboFlashFilter = FilterTurboFlashType::New();</span>

<span style = "background-color:#fdd">            ConversionTurboFlashFilter-&gt;SetFunctor(ConversionTurboFlashFunctor);
            ConversionTurboFlashFilter-&gt;SetInput1(itkInputImage);
            ConversionTurboFlashFilter-&gt;SetInput2(itkBaselineImage);</span>

<span style = "background-color:#fdd">            ConversionTurboFlashFilter-&gt;Update();
            m_ConvertSignalToConcentrationCurve_OutputImage = mitk::ImportItkImage(ConversionTurboFlashFilter-&gt;GetOutput())-&gt;Clone();</span>


<span style = "background-color:#fdd">        }
        else if(this-&gt;m_UsingT1Map)</span>
        {
<span style = "background-color:#fdd">            typename ConvertedImageType::Pointer itkT10Image = ConvertedImageType::New();
            mitk::CastToItkImage(m_T10Image, itkT10Image);</span>

            typedef mitk::ConvertToConcentrationViaT1CalcFunctor &lt;TPixel_input, TPixel_baseline, double, double&gt; ConvertToConcentrationViaT1CalcFunctorType;
            typedef itk::TernaryFunctorImageFilter&lt;InputImageType, BaselineImageType, ConvertedImageType, ConvertedImageType, ConvertToConcentrationViaT1CalcFunctorType&gt; FilterT1MapType;

<span style = "background-color:#fdd">            ConvertToConcentrationViaT1CalcFunctorType ConversionT1MapFunctor;
            ConversionT1MapFunctor.initialize(this-&gt;m_Relaxivity, this-&gt;m_RecoveryTime, this-&gt;m_FlipAngle);</span>

<span style = "background-color:#fdd">            typename FilterT1MapType::Pointer ConversionT1MapFilter = FilterT1MapType::New();</span>

<span style = "background-color:#fdd">            ConversionT1MapFilter-&gt;SetFunctor(ConversionT1MapFunctor);
            ConversionT1MapFilter-&gt;SetInput1(itkInputImage);
            ConversionT1MapFilter-&gt;SetInput2(itkBaselineImage);
            ConversionT1MapFilter-&gt;SetInput3(itkT10Image);</span>

<span style = "background-color:#fdd">            ConversionT1MapFilter-&gt;Update();
            m_ConvertSignalToConcentrationCurve_OutputImage = mitk::ImportItkImage(ConversionT1MapFilter-&gt;GetOutput())-&gt;Clone();</span>


<span style = "background-color:#fdd">        }</span>

<span style = "background-color:#fdd">        else if(this-&gt;m_AbsoluteSignalEnhancement)</span>
        {
            typedef mitk::ConvertToConcentrationAbsoluteFunctor &lt;TPixel_input, TPixel_baseline, double&gt; ConversionFunctorAbsoluteType;
            typedef itk::BinaryFunctorImageFilter&lt;InputImageType, BaselineImageType, ConvertedImageType, ConversionFunctorAbsoluteType&gt; FilterAbsoluteType;

<span style = "background-color:#fdd">            ConversionFunctorAbsoluteType ConversionAbsoluteFunctor;
            ConversionAbsoluteFunctor.initialize(this-&gt;m_Factor);</span>

<span style = "background-color:#fdd">            typename FilterAbsoluteType::Pointer ConversionAbsoluteFilter = FilterAbsoluteType::New();</span>

<span style = "background-color:#fdd">            ConversionAbsoluteFilter-&gt;SetFunctor(ConversionAbsoluteFunctor);
            ConversionAbsoluteFilter-&gt;SetInput1(itkInputImage);
            ConversionAbsoluteFilter-&gt;SetInput2(itkBaselineImage);</span>

<span style = "background-color:#fdd">            ConversionAbsoluteFilter-&gt;Update();</span>

<span style = "background-color:#fdd">            m_ConvertSignalToConcentrationCurve_OutputImage = mitk::ImportItkImage(ConversionAbsoluteFilter-&gt;GetOutput())-&gt;Clone();
        }</span>

<span style = "background-color:#fdd">        else if(this-&gt;m_RelativeSignalEnhancement)</span>
        {
            typedef mitk::ConvertToConcentrationRelativeFunctor &lt;TPixel_input, TPixel_baseline, double&gt; ConversionFunctorRelativeType;
            typedef itk::BinaryFunctorImageFilter&lt;InputImageType, BaselineImageType, ConvertedImageType, ConversionFunctorRelativeType&gt; FilterRelativeType;

<span style = "background-color:#fdd">            ConversionFunctorRelativeType ConversionRelativeFunctor;
            ConversionRelativeFunctor.initialize(this-&gt;m_Factor);</span>

<span style = "background-color:#fdd">            typename FilterRelativeType::Pointer ConversionRelativeFilter = FilterRelativeType::New();</span>

<span style = "background-color:#fdd">            ConversionRelativeFilter-&gt;SetFunctor(ConversionRelativeFunctor);
            ConversionRelativeFilter-&gt;SetInput1(itkInputImage);
            ConversionRelativeFilter-&gt;SetInput2(itkBaselineImage);</span>

<span style = "background-color:#fdd">            ConversionRelativeFilter-&gt;Update();</span>

<span style = "background-color:#fdd">            m_ConvertSignalToConcentrationCurve_OutputImage = mitk::ImportItkImage(ConversionRelativeFilter-&gt;GetOutput())-&gt;Clone();
        }</span>

    }
<span style = "background-color:#fdd">    return m_ConvertSignalToConcentrationCurve_OutputImage;</span>

<span style = "background-color:#fdd">}</span>

</pre>
	</body>
</html>
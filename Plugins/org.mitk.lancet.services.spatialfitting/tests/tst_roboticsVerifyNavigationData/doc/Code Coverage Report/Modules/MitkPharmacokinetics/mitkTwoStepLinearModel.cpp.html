<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkTwoStepLinearModel.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkTwoStepLinearModel.h"
#include &lt;mitkIOUtil.h&gt;

<span style = "background-color:#dfd">const std::string mitk::TwoStepLinearModel::MODELL_NAME = "Two Step Linear Model";</span>

<span style = "background-color:#dfd">const std::string mitk::TwoStepLinearModel::NAME_PARAMETER_y1 = "BaseValue";
const std::string mitk::TwoStepLinearModel::NAME_PARAMETER_a1 = "Slope_1";
const std::string mitk::TwoStepLinearModel::NAME_PARAMETER_t = "Change_Point";
const std::string mitk::TwoStepLinearModel::NAME_PARAMETER_a2 = "Slope_2";</span>

const unsigned int mitk::TwoStepLinearModel::POSITION_PARAMETER_y1 = 0;
const unsigned int mitk::TwoStepLinearModel::POSITION_PARAMETER_t  = 1;
const unsigned int mitk::TwoStepLinearModel::POSITION_PARAMETER_a1 = 2;
const unsigned int mitk::TwoStepLinearModel::POSITION_PARAMETER_a2 = 3;

const unsigned int mitk::TwoStepLinearModel::NUMBER_OF_PARAMETERS = 4;

std::string mitk::TwoStepLinearModel::GetModelDisplayName() const
<span style = "background-color:#fdd">{
  return MODELL_NAME;
};</span>

std::string mitk::TwoStepLinearModel::GetModelType() const
<span style = "background-color:#dfd">{
  return "Generic";
};</span>

mitk::TwoStepLinearModel::FunctionStringType mitk::TwoStepLinearModel::GetFunctionString() const
<span style = "background-color:#fdd">{
  return "Slope_1*t+Y_intercept_1 if t&lt;Change_Point; Slope_2*t+Y_intercept_2 if ChangePoint&lt;=t";
};</span>

std::string mitk::TwoStepLinearModel::GetXName() const
<span style = "background-color:#fdd">{
  return "x";
};</span>

mitk::TwoStepLinearModel::ParameterNamesType
mitk::TwoStepLinearModel::GetParameterNames() const
<span style = "background-color:#fdd">{
  ParameterNamesType result;
  result.push_back(NAME_PARAMETER_y1);
  result.push_back(NAME_PARAMETER_t);
  result.push_back(NAME_PARAMETER_a1);
  result.push_back(NAME_PARAMETER_a2);</span>


<span style = "background-color:#fdd">  return result;
};</span>

mitk::TwoStepLinearModel::ParametersSizeType
mitk::TwoStepLinearModel::GetNumberOfParameters() const
<span style = "background-color:#fdd">{
  return NUMBER_OF_PARAMETERS;
};</span>

mitk::TwoStepLinearModel::ParameterNamesType
mitk::TwoStepLinearModel::GetDerivedParameterNames() const
<span style = "background-color:#fdd">{
  ParameterNamesType result;
  result.push_back("AUC");
  result.push_back("FinalUptake");
  result.push_back("Smax");
  result.push_back("y-intercept2");</span>

<span style = "background-color:#fdd">  return result;
};</span>

mitk::TwoStepLinearModel::ParametersSizeType
mitk::TwoStepLinearModel::GetNumberOfDerivedParameters() const
<span style = "background-color:#fdd">{
  return 4;
};</span>

mitk::TwoStepLinearModel::ModelResultType
mitk::TwoStepLinearModel::ComputeModelfunction(const ParametersType&amp; parameters) const
<span style = "background-color:#fdd">{</span>

  //Model Parameters
<span style = "background-color:#fdd">  const auto t = parameters[POSITION_PARAMETER_t] ;
  const auto a1 = parameters[POSITION_PARAMETER_a1] ;
  const auto a2 = parameters[POSITION_PARAMETER_a2] ;
  const auto b1 = parameters[POSITION_PARAMETER_y1] ;
  const auto b2 = (a1 - a2)*t + b1;</span>

<span style = "background-color:#fdd">  ModelResultType signal(m_TimeGrid.GetSize());</span>

<span style = "background-color:#fdd">  TimeGridType::const_iterator timeGridEnd = m_TimeGrid.end();
  ModelResultType::iterator signalPos = signal.begin();</span>

<span style = "background-color:#fdd">  for (TimeGridType::const_iterator gridPos = m_TimeGrid.begin(); gridPos != timeGridEnd; ++gridPos, ++signalPos)</span>
  {
<span style = "background-color:#fdd">      if((*gridPos) &lt; t)</span>
      {
<span style = "background-color:#fdd">          *signalPos = a1*(*gridPos)+b1;
      }</span>
      else
      {
<span style = "background-color:#fdd">          *signalPos = a2*(*gridPos)+b2;</span>
      }
<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  return signal;
};</span>

mitk::TwoStepLinearModel::ParameterNamesType mitk::TwoStepLinearModel::GetStaticParameterNames() const
<span style = "background-color:#fdd">{
  ParameterNamesType result;</span>

<span style = "background-color:#fdd">  return result;
}</span>

mitk::TwoStepLinearModel::ParametersSizeType  mitk::TwoStepLinearModel::GetNumberOfStaticParameters() const
<span style = "background-color:#fdd">{
  return 0;
}</span>

void mitk::TwoStepLinearModel::SetStaticParameter(const ParameterNameType&amp; /*name*/,
    const StaticParameterValuesType&amp; /*values*/)
<span style = "background-color:#fdd">{</span>
  //do nothing
<span style = "background-color:#fdd">};</span>

mitk::TwoStepLinearModel::StaticParameterValuesType mitk::TwoStepLinearModel::GetStaticParameterValue(
  const ParameterNameType&amp; /*name*/) const
<span style = "background-color:#fdd">{
  StaticParameterValuesType result;</span>

  //do nothing

<span style = "background-color:#fdd">  return result;
};</span>

mitk::ModelBase::DerivedParameterMapType mitk::TwoStepLinearModel::ComputeDerivedParameters(
  const mitk::ModelBase::ParametersType&amp; parameters) const
<span style = "background-color:#fdd">{
    const auto t = parameters[POSITION_PARAMETER_t] ;
    const auto a1 = parameters[POSITION_PARAMETER_a1] ;
    const auto a2 = parameters[POSITION_PARAMETER_a2] ;
    const auto b1 = parameters[POSITION_PARAMETER_y1] ;
    const auto b2 = (a1 - a2) * t + b1;</span>

<span style = "background-color:#fdd">    unsigned int timeSteps = m_TimeGrid.GetSize();</span>


<span style = "background-color:#fdd">    const double taq = (m_TimeGrid.empty() == false) ? (m_TimeGrid.GetElement(timeSteps - 1)) : (mitkThrow() &lt;&lt; "An exception occured because time grid is empty, method can't continue.");</span>

<span style = "background-color:#fdd">    const double sfin = a2 * taq + b2;</span>

<span style = "background-color:#fdd">    const double smax = (a2 &lt;= 0) ? (a1 * t + b1) : (sfin);</span>

<span style = "background-color:#fdd">    const double auc = a1/2*(t*t)+b1*t</span>
                 +a2/2*(taq*taq-t*t)+b2*(taq-t);

<span style = "background-color:#fdd">    DerivedParameterMapType result;</span>

<span style = "background-color:#fdd">    result.insert(std::make_pair("AUC", auc));
    result.insert(std::make_pair("FinalUptake", sfin));
    result.insert(std::make_pair("Smax", smax));
    result.insert(std::make_pair("y-intercept2", b2));</span>

<span style = "background-color:#fdd">    return result;
};</span>

itk::LightObject::Pointer mitk::TwoStepLinearModel::InternalClone() const
<span style = "background-color:#fdd">{
  TwoStepLinearModel::Pointer newClone = TwoStepLinearModel::New();</span>

<span style = "background-color:#fdd">  newClone-&gt;SetTimeGrid(this-&gt;m_TimeGrid);</span>

<span style = "background-color:#fdd">  return newClone.GetPointer();
};</span></pre>
	</body>
</html>
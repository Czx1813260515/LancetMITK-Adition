<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>TcpConnection.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
//----------------------------------------------------------------------------
//
//  Copyright (C) 2017, Northern Digital Inc. All rights reserved.
//
//  All Northern Digital Inc. ("NDI") Media and/or Sample Code and/or Sample Code
//  Documentation (collectively referred to as "Sample Code") is licensed and provided "as
//  is" without warranty of any kind. The licensee, by use of the Sample Code, warrants to
//  NDI that the Sample Code is fit for the use and purpose for which the licensee intends to
//  use the Sample Code. NDI makes no warranties, express or implied, that the functions
//  contained in the Sample Code will meet the licensee's requirements or that the operation
//  of the programs contained therein will be error free. This warranty as expressed herein is
//  exclusive and NDI expressly disclaims any and all express and/or implied, in fact or in
//  law, warranties, representations, and conditions of every kind pertaining in any way to
//  the Sample Code licensed and provided by NDI hereunder, including without limitation,
//  each warranty and/or condition of quality, merchantability, description, operation,
//  adequacy, suitability, fitness for particular purpose, title, interference with use or
//  enjoyment, and/or non infringement, whether express or implied by statute, common law,
//  usage of trade, course of dealing, custom, or otherwise. No NDI dealer, distributor, agent
//  or employee is authorized to make any modification or addition to this warranty.
//  In no event shall NDI nor any of its employees be liable for any direct, indirect,
//  incidental, special, exemplary, or consequential damages, sundry damages or any
//  damages whatsoever, including, but not limited to, procurement of substitute goods or
//  services, loss of use, data or profits, or business interruption, however caused. In no
//  event shall NDI's liability to the licensee exceed the amount paid by the licensee for the
//  Sample Code or any NDI products that accompany the Sample Code. The said limitations
//  and exclusions of liability shall apply whether or not any such damages are construed as
//  arising from a breach of a representation, warranty, guarantee, covenant, obligation,
//  condition or fundamental term or on any theory of liability, whether in contract, strict
//  liability, or tort (including negligence or otherwise) arising in any way out of the use of
//  the Sample Code even if advised of the possibility of such damage. In no event shall
//  NDI be liable for any claims, losses, damages, judgments, costs, awards, expenses or
//  liabilities of any kind whatsoever arising directly or indirectly from any injury to person
//  or property, arising from the Sample Code or any use thereof
//
//----------------------------------------------------------------------------

#include &lt;cstring&gt; // for std::cerr
#include &lt;errno.h&gt; // for errno on some linux machines
#include &lt;iostream&gt;
#include &lt;string.h&gt; // for memcpy

#include "TcpConnection.h"

int TcpConnection::write(const char* buffer, int length) const
<span style = "background-color:#fdd">{
	int result = send(ndiSocket_, buffer, length, 0);</span>
	//std::cout &lt;&lt; "------------socket write: " &lt;&lt; (result &gt; 0 ? "succeeded" : "failed") &lt;&lt; std::endl;
<span style = "background-color:#fdd">	return result;
}</span>

int TcpConnection::write(byte_t* buffer, int length) const
<span style = "background-color:#fdd">{
	return write((const char*)buffer, length);
}</span>

// The IP address of the connection
char *TcpConnection::connectionName()
<span style = "background-color:#fdd">{
	return ip4_;
}</span>

int TcpConnection::read(char* buffer, int length) const
<span style = "background-color:#fdd">{
	int result = recv(ndiSocket_, buffer, length, MSG_WAITALL);</span>
//	if (result != length )
//	{
//		std::cout &lt;&lt; "------------failed: asked for " &lt;&lt; length&lt;&lt;" read "&lt;&lt; result &lt;&lt; std::endl;
//	}
<span style = "background-color:#fdd">	return result;
}</span>

int TcpConnection::read(byte_t* buffer, int length) const
<span style = "background-color:#fdd">{
	return read((char*)buffer, length);
}</span>

bool TcpConnection::connect(const char* hostname)
<span style = "background-color:#fdd">{
	return connect(hostname, "8765");
}</span>

bool TcpConnection::connect(const char* hostname, const char* port)
<span style = "background-color:#fdd">{</span>
	// Define socket options in the 'addrinfo' block
	addrinfo addressInfo;
<span style = "background-color:#fdd">	memset(&amp;addressInfo, 0, sizeof(addressInfo));
	addressInfo.ai_family = AF_INET;
	addressInfo.ai_socktype = SOCK_STREAM;
	addressInfo.ai_protocol = IPPROTO_TCP;</span>

 	// Setup a TCP socket using the given hostname and port
<span style = "background-color:#fdd">	addrinfo* aiPointer = NULL, *pai;
	int addrinforesult = getaddrinfo(hostname, port, &amp;addressInfo, &amp;aiPointer);
	if (addrinforesult != 0)</span>
	{
<span style = "background-color:#fdd">		std::cerr &lt;&lt; "getaddrinfo Error code " &lt;&lt; addrinforesult &lt;&lt; " (" &lt;&lt; gai_strerror(addrinforesult) &lt;&lt; ")" &lt;&lt; std::endl;
		return false;</span>
	}

<span style = "background-color:#fdd">	for (pai = aiPointer; pai != NULL; pai = pai-&gt;ai_next) </span>
	{
		//Initialize socket
<span style = "background-color:#fdd">		ndiSocket_ = socket(pai-&gt;ai_family, pai-&gt;ai_socktype, pai-&gt;ai_protocol);
		if (!socketIsValid()) 
			continue;</span>
		//Initialize connection
<span style = "background-color:#fdd">		isConnected_ = ::connect(ndiSocket_, pai-&gt;ai_addr, (socklen_t) pai-&gt;ai_addrlen) &gt;= 0;
		if (isConnected_) </span>
		{
			// Convert the IP address to a character array
<span style = "background-color:#fdd">			inet_ntop(AF_INET, &amp;((const sockaddr_in *)aiPointer-&gt;ai_addr)-&gt;sin_addr, ip4_, INET_ADDRSTRLEN);
			break;</span>
		}
<span style = "background-color:#fdd">		disconnect();
		ndiSocket_ = -1;
	}
	if (!isConnected_)</span>
	{
#pragma warning( disable : 4996)
#pragma warning( push )
<span style = "background-color:#fdd">		std::cerr &lt;&lt; "::connect Error code " &lt;&lt; errno &lt;&lt; " (" &lt;&lt; std::strerror (errno) &lt;&lt; ")" &lt;&lt; std::endl;</span>
#pragma warning( pop )
	}
<span style = "background-color:#fdd">	freeaddrinfo(aiPointer);</span>
	
<span style = "background-color:#fdd">	return isConnected_;
}</span>

bool TcpConnection::socketIsValid() const
<span style = "background-color:#fdd">{</span>
	#ifdef _WIN32
	// On Windows, SOCKET type is unsigned, so a negative number cannot indicate invalid socket
	// so "all bits set" indicates invalid sockets:  #define INVALID_SOCKET (SOCKET)(~0)
<span style = "background-color:#fdd">	return ndiSocket_ != INVALID_SOCKET;</span>
	#else
	// On Mac/Linux, sockets are simple. If the file descriptor is negative, the socket is invalid
	return ndiSocket_ &gt;= 0;
	#endif
<span style = "background-color:#fdd">}</span>

void TcpConnection::disconnect()
<span style = "background-color:#fdd">{</span>
	#ifdef _WIN32
<span style = "background-color:#fdd">	closesocket(ndiSocket_);</span>
	#else
	close(ndiSocket_);
	#endif
<span style = "background-color:#fdd">}</span>

void TcpConnection::init()
<span style = "background-color:#fdd">{</span>
	#ifdef _WIN32
	// Initializes WinSock using the v2 implementation
	// See: https://msdn.microsoft.com/en-us/library/windows/desktop/ms738545%28v=vs.85%29.aspx
<span style = "background-color:#fdd">	WSAStartup(MAKEWORD(2,2), &amp;wsaData_);</span>
	#endif
<span style = "background-color:#fdd">	ndiSocket_ = 0;
	isConnected_ = false;
	ip4_[0] = 0;
}</span>

bool TcpConnection::isConnected() const
<span style = "background-color:#fdd">{
	return isConnected_;
}</span>

TcpConnection::TcpConnection(const char* hostname, const char* port)
<span style = "background-color:#fdd">{
	init();
	connect(hostname, port);
}</span>

TcpConnection::TcpConnection()
<span style = "background-color:#fdd">{
	init();
}</span>

TcpConnection::~TcpConnection()
<span style = "background-color:#fdd">{
	disconnect();</span>

	#ifdef _WIN32
	// An application must call the WSACleanup function for every successful time the WSAStartup function is called.
<span style = "background-color:#fdd">	WSACleanup();</span>
	#endif
<span style = "background-color:#fdd">}</span></pre>
	</body>
</html>
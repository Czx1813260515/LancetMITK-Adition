<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkPropertyListSerializer.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkPropertyListSerializer.h"
#include "mitkBasePropertySerializer.h"
#include "mitkStandardFileLocations.h"
#include &lt;itksys/SystemTools.hxx&gt;
#include &lt;tinyxml2.h&gt;

<span style = "background-color:#fdd">mitk::PropertyListSerializer::PropertyListSerializer() : m_FilenameHint("unnamed"), m_WorkingDirectory("")
{
}</span>

mitk::PropertyListSerializer::~PropertyListSerializer()
<span style = "background-color:#fdd">{
}</span>

std::string mitk::PropertyListSerializer::Serialize()
<span style = "background-color:#fdd">{
  m_FailedProperties = PropertyList::New();</span>

<span style = "background-color:#fdd">  if (m_PropertyList.IsNull() || m_PropertyList-&gt;IsEmpty())</span>
  {
<span style = "background-color:#fdd">    MITK_ERROR &lt;&lt; "Not serializing nullptr or empty PropertyList";
    return "";</span>
  }

  // tmpname
  static unsigned long count = 1;
<span style = "background-color:#fdd">  unsigned long n = count++;
  std::ostringstream name;
  for (int i = 0; i &lt; 6; ++i)</span>
  {
<span style = "background-color:#fdd">    name &lt;&lt; char('a' + (n % 26));
    n /= 26;
  }
  std::string filename;
  filename.append(name.str());</span>

<span style = "background-color:#fdd">  std::string fullname(m_WorkingDirectory);
  fullname += "/";
  fullname += filename;
  fullname = itksys::SystemTools::ConvertToOutputPath(fullname.c_str());</span>

  // Trim quotes
<span style = "background-color:#fdd">  std::string::size_type length = fullname.length();</span>

<span style = "background-color:#fdd">  if (length &gt;= 2 &amp;&amp; fullname[0] == '"' &amp;&amp; fullname[length - 1] == '"')
    fullname = fullname.substr(1, length - 2);</span>

<span style = "background-color:#fdd">  tinyxml2::XMLDocument document;
  document.InsertEndChild(document.NewDeclaration());</span>

<span style = "background-color:#fdd">  auto *version = document.NewElement("Version");
  version-&gt;SetAttribute("Writer", __FILE__);
  version-&gt;SetAttribute("Revision", "$Revision: 17055 $");
  version-&gt;SetAttribute("FileVersion", 1);
  document.InsertEndChild(version);</span>

  // add XML contents
<span style = "background-color:#fdd">  const PropertyList::PropertyMap *propmap = m_PropertyList-&gt;GetMap();
  for (auto iter = propmap-&gt;begin(); iter != propmap-&gt;end(); ++iter)</span>
  {
<span style = "background-color:#fdd">    std::string key = iter-&gt;first;
    const BaseProperty *property = iter-&gt;second;
    auto *element = SerializeOneProperty(document, key, property);
    if (element)</span>
    {
<span style = "background-color:#fdd">      document.InsertEndChild(element);</span>
      // TODO test serializer for error
<span style = "background-color:#fdd">    }</span>
    else
    {
<span style = "background-color:#fdd">      m_FailedProperties-&gt;ReplaceProperty(key, const_cast&lt;BaseProperty *&gt;(property));</span>
    }
<span style = "background-color:#fdd">  }</span>

  // save XML file
<span style = "background-color:#fdd">  if (tinyxml2::XML_SUCCESS != document.SaveFile(fullname.c_str()))</span>
  {
<span style = "background-color:#fdd">    MITK_ERROR &lt;&lt; "Could not write PropertyList to " &lt;&lt; fullname &lt;&lt; "\nTinyXML reports '" &lt;&lt; document.ErrorStr()</span>
               &lt;&lt; "'";
<span style = "background-color:#fdd">    return "";</span>
  }

<span style = "background-color:#fdd">  return filename;
}</span>

tinyxml2::XMLElement *mitk::PropertyListSerializer::SerializeOneProperty(tinyxml2::XMLDocument &amp;doc, const std::string &amp;key, const BaseProperty *property)
<span style = "background-color:#fdd">{
  auto *keyelement = doc.NewElement("property");
  keyelement-&gt;SetAttribute("key", key.c_str());
  keyelement-&gt;SetAttribute("type", property-&gt;GetNameOfClass());</span>

  // construct name of serializer class
<span style = "background-color:#fdd">  std::string serializername(property-&gt;GetNameOfClass());
  serializername += "Serializer";</span>

<span style = "background-color:#fdd">  std::list&lt;itk::LightObject::Pointer&gt; allSerializers =</span>
    itk::ObjectFactoryBase::CreateAllInstance(serializername.c_str());
<span style = "background-color:#fdd">  if (allSerializers.size() &lt; 1)</span>
  {
<span style = "background-color:#fdd">    MITK_ERROR &lt;&lt; "No serializer found for " &lt;&lt; property-&gt;GetNameOfClass() &lt;&lt; ". Skipping object";</span>
  }
<span style = "background-color:#fdd">  if (allSerializers.size() &gt; 1)</span>
  {
<span style = "background-color:#fdd">    MITK_WARN &lt;&lt; "Multiple serializers found for " &lt;&lt; property-&gt;GetNameOfClass() &lt;&lt; "Using arbitrarily the first one.";</span>
  }

<span style = "background-color:#fdd">  for (auto iter = allSerializers.begin(); iter != allSerializers.end(); ++iter)</span>
  {
<span style = "background-color:#fdd">    if (auto *serializer = dynamic_cast&lt;BasePropertySerializer *&gt;(iter-&gt;GetPointer()))</span>
    {
<span style = "background-color:#fdd">      serializer-&gt;SetProperty(property);</span>
      try
      {
<span style = "background-color:#fdd">        auto *valueelement = serializer-&gt;Serialize(doc);
        if (valueelement)</span>
        {
<span style = "background-color:#fdd">          keyelement-&gt;InsertEndChild(valueelement);</span>
        }
      }
      catch (std::exception &amp;e)
<span style = "background-color:#fdd">      {
        MITK_ERROR &lt;&lt; "Serializer " &lt;&lt; serializer-&gt;GetNameOfClass() &lt;&lt; " failed: " &lt;&lt; e.what();</span>
        // \TODO: log only if all potential serializers fail?
<span style = "background-color:#fdd">      }
      break;
    }</span>
    else
    {
<span style = "background-color:#fdd">      MITK_ERROR &lt;&lt; "Found a serializer called '" &lt;&lt; (*iter)-&gt;GetNameOfClass()</span>
                 &lt;&lt; "' that does not implement the BasePropertySerializer interface.";
<span style = "background-color:#fdd">      continue;
    }
  }</span>

<span style = "background-color:#fdd">  if (keyelement-&gt;NoChildren())</span>
  {
<span style = "background-color:#fdd">    m_FailedProperties-&gt;ReplaceProperty(key, const_cast&lt;BaseProperty *&gt;(property));
    return nullptr;
  }</span>
  else
  {
<span style = "background-color:#fdd">    return keyelement;</span>
  }
<span style = "background-color:#fdd">}</span>

mitk::PropertyList *mitk::PropertyListSerializer::GetFailedProperties()
<span style = "background-color:#fdd">{
  if (m_FailedProperties.IsNotNull() &amp;&amp; !m_FailedProperties-&gt;IsEmpty())</span>
  {
<span style = "background-color:#fdd">    return m_FailedProperties;
  }</span>
  else
  {
<span style = "background-color:#fdd">    return nullptr;</span>
  }
<span style = "background-color:#fdd">}</span></pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkDICOMQIPropertyHelper.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include &lt;mitkIDICOMTagsOfInterest.h&gt;
#include &lt;mitkPropertyNameHelper.h&gt;
#include &lt;mitkTemporoSpatialStringProperty.h&gt;
#include &lt;mitkPropertyList.h&gt;

#include "mitkDICOMQIPropertyHelper.h"

namespace mitk
{
  void DICOMQIPropertyHelper::DeriveDICOMSourceProperties(const BaseData *sourceDICOMImage, BaseData *derivedDICOMImage)
<span style = "background-color:#fdd">  {</span>
    // Check if original image is a DICOM image; if so, store relevant DICOM Tags into the PropertyList of new
    // segmentation/PM image

<span style = "background-color:#fdd">    PropertyList::Pointer sourcePropertyList = sourceDICOMImage-&gt;GetPropertyList();
    bool parentIsDICOM = false;</span>

<span style = "background-color:#fdd">    for (const auto &amp;element : *(sourcePropertyList-&gt;GetMap()))</span>
    {
<span style = "background-color:#fdd">      if (element.first.find("DICOM") == 0)</span>
      {
<span style = "background-color:#fdd">        parentIsDICOM = true;
        break;</span>
      }
<span style = "background-color:#fdd">    }</span>

<span style = "background-color:#fdd">    if (!parentIsDICOM)
      return;</span>


<span style = "background-color:#fdd">    PropertyList::Pointer propertyList = derivedDICOMImage-&gt;GetPropertyList();</span>

    //====== Patient information ======
    // Add DICOM Tag (0010,0010) patient's name; default "No Name"
<span style = "background-color:#fdd">    AdoptReferenceDICOMProperty(sourcePropertyList, propertyList, DICOMTag(0x0010, 0x0010), "NO NAME");</span>
    // Add DICOM Tag (0010,0020) patient id; default "No Name"
<span style = "background-color:#fdd">    AdoptReferenceDICOMProperty(sourcePropertyList, propertyList, DICOMTag(0x0010, 0x0020), "NO NAME");</span>
    // Add DICOM Tag (0010,0030) patient's birth date; no default
<span style = "background-color:#fdd">    AdoptReferenceDICOMProperty(sourcePropertyList, propertyList, DICOMTag(0x0010, 0x0030));</span>
    // Add DICOM Tag (0010,0040) patient's sex; default "U" (Unknown)
<span style = "background-color:#fdd">    AdoptReferenceDICOMProperty(sourcePropertyList, propertyList, DICOMTag(0x0010, 0x0040), "U");</span>

    //====== General study ======
    // Add DICOM Tag (0020,000D) Study Instance UID; no default --&gt; MANDATORY!
<span style = "background-color:#fdd">    AdoptReferenceDICOMProperty(sourcePropertyList, propertyList, DICOMTag(0x0020, 0x000D));</span>
    // Add DICOM Tag (0080,0020) Study Date; no default (think about "today")
<span style = "background-color:#fdd">    AdoptReferenceDICOMProperty(sourcePropertyList, propertyList, DICOMTag(0x0080, 0x0020));</span>
    // Add DICOM Tag (0008,0050) Accession Number; no default
<span style = "background-color:#fdd">    AdoptReferenceDICOMProperty(sourcePropertyList, propertyList, DICOMTag(0x0008, 0x0050));</span>
    // Add DICOM Tag (0008,1030) Study Description; no default
<span style = "background-color:#fdd">    AdoptReferenceDICOMProperty(sourcePropertyList, propertyList, DICOMTag(0x0008, 0x1030));</span>


    //====== Reference DICOM data ======
    // Add reference file paths to referenced DICOM data
<span style = "background-color:#fdd">    BaseProperty::Pointer dcmFilesProp = sourcePropertyList-&gt;GetProperty("files");
    if (dcmFilesProp.IsNotNull())
      propertyList-&gt;SetProperty("referenceFiles", dcmFilesProp);
  }</span>

  void DICOMQIPropertyHelper::AdoptReferenceDICOMProperty(PropertyList *referencedPropertyList,
    PropertyList *propertyList,
    const DICOMTag &amp;tag,
    const std::string &amp;defaultString)
<span style = "background-color:#fdd">  {
    std::string tagString = GeneratePropertyNameForDICOMTag(tag.GetGroup(), tag.GetElement());</span>

    // Get DICOM property from referenced image
<span style = "background-color:#fdd">    BaseProperty::Pointer originalProperty = referencedPropertyList-&gt;GetProperty(tagString.c_str());</span>

    // if property exists, copy the informtaion to the derived image
<span style = "background-color:#fdd">    if (originalProperty.IsNotNull())
      propertyList-&gt;SetProperty(tagString.c_str(), originalProperty);</span>
    else // use the default value, if there is one
    {
<span style = "background-color:#fdd">      if (!defaultString.empty())
        propertyList-&gt;SetProperty(tagString.c_str(), TemporoSpatialStringProperty::New(defaultString).GetPointer());</span>
    }
<span style = "background-color:#fdd">  }</span>
}</pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkVolumeCalculator.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkVolumeCalculator.h"
#include "mitkImageAccessByItk.h"
#include &lt;itkImageRegionConstIterator.h&gt;

#include "mitkImageStatisticsHolder.h"

template &lt;typename TPixel, unsigned int VImageDimension&gt;
void mitk::VolumeCalculator::InternalCompute(const itk::Image&lt;TPixel, VImageDimension&gt; *itkImage)
<span style = "background-color:#fdd">{
  itk::ImageRegionConstIterator&lt;itk::Image&lt;TPixel, VImageDimension&gt;&gt; imageIt(itkImage,</span>
                                                                             itkImage-&gt;GetLargestPossibleRegion());
<span style = "background-color:#fdd">  unsigned long int count = 0;</span>

<span style = "background-color:#fdd">  for (imageIt.GoToBegin(); !imageIt.IsAtEnd(); ++imageIt)</span>
  {
<span style = "background-color:#fdd">    if ((int)(imageIt.Get()) &gt;= m_Threshold)</span>
    {
<span style = "background-color:#fdd">      count++;</span>
    }
<span style = "background-color:#fdd">  }
  if (itkImage-&gt;GetLargestPossibleRegion().GetImageDimension() == 3)</span>
  {
<span style = "background-color:#fdd">    m_Volume = count / 1000.0 * itkImage-&gt;GetSpacing()[0] * itkImage-&gt;GetSpacing()[1] * itkImage-&gt;GetSpacing()[2];
  }
  else if (itkImage-&gt;GetLargestPossibleRegion().GetImageDimension() == 2)</span>
  {
<span style = "background-color:#fdd">    m_Volume = count / 100.0 * itkImage-&gt;GetSpacing()[0] * itkImage-&gt;GetSpacing()[1];</span>
  }
<span style = "background-color:#fdd">  m_VoxelCount = count;
}</span>

<span style = "background-color:#fdd">mitk::VolumeCalculator::VolumeCalculator() : m_Image(nullptr), m_Threshold(0), m_Volume(0)
{
  m_TimeSelector = ImageTimeSelector::New();
}</span>

mitk::VolumeCalculator::~VolumeCalculator()
<span style = "background-color:#fdd">{
}</span>

std::vector&lt;float&gt; mitk::VolumeCalculator::GetVolumes()
<span style = "background-color:#fdd">{
  return m_Volumes;
}</span>

void mitk::VolumeCalculator::ComputeVolume()
<span style = "background-color:#fdd">{
  const_cast&lt;Image *&gt;(m_Image.GetPointer())-&gt;SetRequestedRegionToLargestPossibleRegion();
  if (m_Image-&gt;GetDimension() == 4)</span>
  {
<span style = "background-color:#fdd">    m_TimeSelector-&gt;SetInput(m_Image);
    m_Volumes.resize(m_Image-&gt;GetDimension(3));
    for (unsigned int timeStep = 0; timeStep &lt; m_Image-&gt;GetDimension(3); ++timeStep)</span>
    {
<span style = "background-color:#fdd">      m_TimeSelector-&gt;SetTimeNr(timeStep);
      m_TimeSelector-&gt;Update();
      AccessFixedDimensionByItk(m_TimeSelector-&gt;GetOutput(), InternalCompute, 3);
      m_Volumes[timeStep] = m_Volume;
    }
  }
  else if (m_Image-&gt;GetDimension() == 3)</span>
  {
<span style = "background-color:#fdd">    const_cast&lt;Image *&gt;(m_Image.GetPointer())-&gt;Update();
    AccessFixedDimensionByItk(m_Image, InternalCompute, 3);
  }
  else if (m_Image-&gt;GetDimension() == 2)</span>
  {
<span style = "background-color:#fdd">    const_cast&lt;Image *&gt;(m_Image.GetPointer())-&gt;Update();
    AccessFixedDimensionByItk(m_Image, InternalCompute, 2);</span>
  }
<span style = "background-color:#fdd">}</span>

void mitk::VolumeCalculator::ComputeVolumeFromImageStatistics()
<span style = "background-color:#fdd">{
  unsigned int dim = m_Image-&gt;GetDimension();</span>

<span style = "background-color:#fdd">  if (dim == 4)</span>
  {
<span style = "background-color:#fdd">    m_Volumes.resize(m_Image-&gt;GetDimension(3), 0);
    Vector3D spacing = m_Image-&gt;GetSlicedGeometry()-&gt;GetSpacing();</span>

<span style = "background-color:#fdd">    for (unsigned int t = 0; t &lt; m_Image-&gt;GetDimension(3); ++t)</span>
    {
<span style = "background-color:#fdd">      m_Volumes[t] =</span>
        m_Image-&gt;GetStatistics()-&gt;GetCountOfMaxValuedVoxels(t) / 1000.0 * spacing[0] * spacing[1] * spacing[2];
<span style = "background-color:#fdd">    }
  }
  else if (dim == 3)</span>
  {
<span style = "background-color:#fdd">    Vector3D spacing = m_Image-&gt;GetSlicedGeometry()-&gt;GetSpacing();
    m_Volume = m_Image-&gt;GetStatistics()-&gt;GetCountOfMaxValuedVoxels() / 1000.0 * spacing[0] * spacing[1] * spacing[2];
  }
  else if (dim == 2)</span>
  {
<span style = "background-color:#fdd">    Vector3D spacing = m_Image-&gt;GetGeometry()-&gt;GetSpacing();
    m_Volume = m_Image-&gt;GetStatistics()-&gt;GetCountOfMaxValuedVoxels() / 100.0 * spacing[0] * spacing[1];
  }</span>
  else
<span style = "background-color:#fdd">    itkExceptionMacro(&lt;&lt; "Wrong image dimension...");
}</span>

float mitk::VolumeCalculator::ComputeVolume(Vector3D spacing, unsigned int voxelCount)
<span style = "background-color:#fdd">{
  return (voxelCount / 1000.0 * spacing[0] * spacing[1] * spacing[2]);
}</span></pre>
	</body>
</html>
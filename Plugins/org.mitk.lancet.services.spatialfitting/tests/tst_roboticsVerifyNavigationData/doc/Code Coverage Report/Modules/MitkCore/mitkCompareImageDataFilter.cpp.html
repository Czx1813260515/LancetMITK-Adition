<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkCompareImageDataFilter.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

// mitk includes
#include "mitkCompareImageDataFilter.h"
#include "mitkITKImageImport.h"
#include "mitkImageAccessByItk.h"
#include "mitkImageCaster.h"
#include "mitkMultiComponentImageDataComparisonFilter.h"

// itk includes
#include &lt;itkTestingComparisonImageFilter.h&gt;

<span style = "background-color:#fdd">mitk::CompareImageDataFilter::CompareImageDataFilter() : m_Tolerance(0.0)
{
  this-&gt;SetNumberOfRequiredInputs(2);</span>

<span style = "background-color:#fdd">  this-&gt;ResetCompareResultsToInitial();
}</span>

void mitk::CompareImageDataFilter::ResetCompareResultsToInitial()
<span style = "background-color:#fdd">{
  m_CompareDetails.m_MaximumDifference = 0.0f;
  m_CompareDetails.m_MinimumDifference = itk::NumericTraits&lt;double&gt;::max();
  m_CompareDetails.m_MeanDifference = 0.0f;
  m_CompareDetails.m_TotalDifference = 0.0f;
  m_CompareDetails.m_PixelsWithDifference = 0;
  m_CompareDetails.m_FilterCompleted = false;
  m_CompareDetails.m_ExceptionMessage = "";
}</span>

void mitk::CompareImageDataFilter::GenerateData()
<span style = "background-color:#fdd">{</span>
  // check inputs

<span style = "background-color:#fdd">  const mitk::Image *input1 = this-&gt;GetInput(0);
  const mitk::Image *input2 = this-&gt;GetInput(1);</span>

  //   Generally this filter is part of the mitk::Image::Equal() method and only checks the equality of the image data
  //   so no further image type comparison is performed!
  //   CAVE: If the images differ in a parameter other then the image data, the filter may fail!!

  // check what number of components the inputs have
<span style = "background-color:#fdd">  if (input1-&gt;GetPixelType().GetNumberOfComponents() == 1 &amp;&amp; input2-&gt;GetPixelType().GetNumberOfComponents() == 1)</span>
  {
<span style = "background-color:#fdd">    AccessByItk_1(input1, EstimateValueDifference, input2);
  }
  else if (input1-&gt;GetPixelType().GetNumberOfComponents() &gt; 1 &amp;&amp; input2-&gt;GetPixelType().GetNumberOfComponents() &gt; 1)</span>
  {
<span style = "background-color:#fdd">    this-&gt;ResetCompareResultsToInitial();</span>

<span style = "background-color:#fdd">    MultiComponentImageDataComparisonFilter::Pointer mcComparator = MultiComponentImageDataComparisonFilter::New();
    mcComparator-&gt;SetTestImage(input1);
    mcComparator-&gt;SetValidImage(input2);
    mcComparator-&gt;SetCompareFilterResult(&amp;m_CompareDetails);
    mcComparator-&gt;SetTolerance(m_Tolerance);
    mcComparator-&gt;Update();</span>

<span style = "background-color:#fdd">    m_CompareResult = mcComparator-&gt;GetResult();
  }
}</span>

bool mitk::CompareImageDataFilter::GetResult(size_t threshold)
<span style = "background-color:#fdd">{
  if (!m_CompareResult)</span>
  {
<span style = "background-color:#fdd">    return false;</span>
  }

<span style = "background-color:#fdd">  if (m_CompareDetails.m_PixelsWithDifference &gt; threshold)</span>
  {
<span style = "background-color:#fdd">    return false;</span>
  }

<span style = "background-color:#fdd">  return true;
}</span>

template &lt;typename TPixel, unsigned int VImageDimension&gt;
void mitk::CompareImageDataFilter::EstimateValueDifference(const itk::Image&lt;TPixel, VImageDimension&gt; *itkImage1,
                                                           const mitk::Image *referenceImage)
<span style = "background-color:#fdd">{</span>
  typedef itk::Image&lt;TPixel, VImageDimension&gt; InputImageType;
  typedef itk::Image&lt;double, VImageDimension&gt; OutputImageType;

<span style = "background-color:#fdd">  typename InputImageType::Pointer itk_reference = InputImageType::New();</span>

<span style = "background-color:#fdd">  mitk::CastToItkImage(referenceImage, itk_reference);</span>

  typedef itk::Testing::ComparisonImageFilter&lt;InputImageType, OutputImageType&gt; CompareFilterType;
<span style = "background-color:#fdd">  typename CompareFilterType::Pointer compare_filter = CompareFilterType::New();
  compare_filter-&gt;SetTestInput(itkImage1);
  compare_filter-&gt;SetValidInput(itk_reference);
  compare_filter-&gt;SetDifferenceThreshold(m_Tolerance);</span>

  try
  {
<span style = "background-color:#fdd">    compare_filter-&gt;Update();</span>
  }
  catch (const itk::ExceptionObject &amp;e)
<span style = "background-color:#fdd">  {
    m_CompareDetails.m_FilterCompleted = false;
    m_CompareDetails.m_ExceptionMessage = e.what();</span>

<span style = "background-color:#fdd">    MITK_WARN &lt;&lt; e.what();</span>

<span style = "background-color:#fdd">    m_CompareResult = false;
    return;
  }</span>

  // the filter has completed the calculation
<span style = "background-color:#fdd">  m_CompareResult = true;
  m_CompareDetails.m_FilterCompleted = true;</span>

<span style = "background-color:#fdd">  m_CompareDetails.m_MaximumDifference = compare_filter-&gt;GetMaximumDifference();
  m_CompareDetails.m_MinimumDifference = compare_filter-&gt;GetMinimumDifference();
  m_CompareDetails.m_MeanDifference = compare_filter-&gt;GetMeanDifference();
  m_CompareDetails.m_TotalDifference = compare_filter-&gt;GetTotalDifference();
  m_CompareDetails.m_PixelsWithDifference = compare_filter-&gt;GetNumberOfPixelsWithDifferences();</span>

<span style = "background-color:#fdd">  mitk::Image::Pointer output = mitk::GrabItkImageMemory(compare_filter-&gt;GetOutput());
  this-&gt;SetOutput(MakeNameFromOutputIndex(0), output.GetPointer());
}</span></pre>
	</body>
</html>
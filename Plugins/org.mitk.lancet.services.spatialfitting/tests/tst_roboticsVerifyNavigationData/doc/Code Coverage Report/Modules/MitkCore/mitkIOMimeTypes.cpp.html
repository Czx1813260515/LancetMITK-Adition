<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkIOMimeTypes.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkIOMimeTypes.h"

#include "mitkCustomMimeType.h"
#include "mitkLogMacros.h"
#include &lt;mitkUtf8Util.h&gt;

#include "itkGDCMImageIO.h"
#include "itkMetaDataObject.h"

#include &lt;itksys/SystemTools.hxx&gt;
#include &lt;itksys/Directory.hxx&gt;

namespace mitk
{
<span style = "background-color:#dfd">  IOMimeTypes::BaseDicomMimeType::BaseDicomMimeType(const std::string&amp; name) : CustomMimeType(name)
  {
    this-&gt;AddExtension("gdcm");
    this-&gt;AddExtension("dcm");
    this-&gt;AddExtension("DCM");
    this-&gt;AddExtension("dc3");
    this-&gt;AddExtension("DC3");
    this-&gt;AddExtension("ima");
    this-&gt;AddExtension("img");</span>

<span style = "background-color:#dfd">    this-&gt;SetCategory(CATEGORY_IMAGES());
    this-&gt;SetComment("DICOM");
  }</span>

  bool IOMimeTypes::BaseDicomMimeType::AppliesTo(const std::string &amp;path) const
<span style = "background-color:#fdd">  {</span>
    // check whether directory or file
    // if directory try to find first file within it instead
<span style = "background-color:#fdd">    bool pathIsDirectory = itksys::SystemTools::FileIsDirectory(Utf8Util::Local8BitToUtf8(path));</span>

<span style = "background-color:#fdd">    std::string filepath = path;</span>

<span style = "background-color:#fdd">    if (pathIsDirectory)</span>
    {
<span style = "background-color:#fdd">      itksys::Directory input;
      input.Load(path.c_str());</span>

<span style = "background-color:#fdd">      std::vector&lt;std::string&gt; files;
      for (unsigned long idx = 0; idx&lt;input.GetNumberOfFiles(); idx++)</span>
      {
<span style = "background-color:#fdd">        auto filename = Utf8Util::Local8BitToUtf8(input.GetFile(idx));</span>

<span style = "background-color:#fdd">        if (!itksys::SystemTools::FileIsDirectory(filename) &amp;&amp; this-&gt;MatchesExtension(filename))</span>
        {
<span style = "background-color:#fdd">          std::string fullpath = path + "/" + std::string(input.GetFile(idx));
          files.push_back(fullpath.c_str());
        }
      }
      if (!files.empty())</span>
      {
<span style = "background-color:#fdd">        filepath = files.front();</span>
      }
<span style = "background-color:#fdd">    }</span>

    // Ask the GDCM ImageIO class directly
<span style = "background-color:#fdd">    itk::GDCMImageIO::Pointer gdcmIO = itk::GDCMImageIO::New();
    gdcmIO-&gt;SetFileName(filepath);</span>
    try {
<span style = "background-color:#fdd">      gdcmIO-&gt;ReadImageInformation();</span>
    }
<span style = "background-color:#fdd">    catch (const itk::ExceptionObject &amp; /*err*/) {
      return false;
    }</span>

    //DICOMRT modalities have specific reader, don't read with normal DICOM readers
<span style = "background-color:#fdd">    std::string modality;
    itk::MetaDataDictionary&amp; dict = gdcmIO-&gt;GetMetaDataDictionary();
    itk::ExposeMetaData&lt;std::string&gt;(dict, "0008|0060", modality);
    MITK_DEBUG &lt;&lt; "DICOM Modality detected by MimeType "&lt;&lt; this-&gt;GetName() &lt;&lt; " is " &lt;&lt; modality;
    if (modality == "RTSTRUCT" || modality == "RTDOSE" || modality == "RTPLAN") {
      return false;
    }</span>
    else {
<span style = "background-color:#fdd">      return gdcmIO-&gt;CanReadFile(filepath.c_str());</span>
    }
<span style = "background-color:#fdd">  }</span>

<span style = "background-color:#fdd">  IOMimeTypes::BaseDicomMimeType*IOMimeTypes::BaseDicomMimeType::Clone() const { return new BaseDicomMimeType(*this); }</span>

<span style = "background-color:#dfd">  IOMimeTypes::DicomMimeType::DicomMimeType() : BaseDicomMimeType(DICOM_MIMETYPE_NAME())
  {
  }</span>

<span style = "background-color:#dfd">  IOMimeTypes::DicomMimeType* IOMimeTypes::DicomMimeType::Clone() const { return new DicomMimeType(*this); }</span>

  std::vector&lt;CustomMimeType *&gt; IOMimeTypes::Get()
<span style = "background-color:#dfd">  {
    std::vector&lt;CustomMimeType *&gt; mimeTypes;</span>

    // order matters here (descending rank for mime types)

<span style = "background-color:#dfd">    mimeTypes.push_back(NRRD_MIMETYPE().Clone());
    mimeTypes.push_back(NIFTI_MIMETYPE().Clone());</span>

<span style = "background-color:#dfd">    mimeTypes.push_back(VTK_IMAGE_MIMETYPE().Clone());
    mimeTypes.push_back(VTK_PARALLEL_IMAGE_MIMETYPE().Clone());
    mimeTypes.push_back(VTK_IMAGE_LEGACY_MIMETYPE().Clone());</span>

<span style = "background-color:#dfd">    mimeTypes.push_back(DICOM_MIMETYPE().Clone());</span>

<span style = "background-color:#dfd">    mimeTypes.push_back(VTK_POLYDATA_MIMETYPE().Clone());
    mimeTypes.push_back(VTK_PARALLEL_POLYDATA_MIMETYPE().Clone());
    mimeTypes.push_back(VTK_POLYDATA_LEGACY_MIMETYPE().Clone());</span>

<span style = "background-color:#dfd">    mimeTypes.push_back(STEREOLITHOGRAPHY_MIMETYPE().Clone());
    mimeTypes.push_back(WAVEFRONT_OBJ_MIMETYPE().Clone());
    mimeTypes.push_back(STANFORD_PLY_MIMETYPE().Clone());</span>

<span style = "background-color:#dfd">    mimeTypes.push_back(RAW_MIMETYPE().Clone());
    mimeTypes.push_back(POINTSET_MIMETYPE().Clone());
    return mimeTypes;
  }</span>

  CustomMimeType IOMimeTypes::VTK_IMAGE_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(VTK_IMAGE_NAME());
    mimeType.AddExtension("vti");
    mimeType.SetCategory(CATEGORY_IMAGES());
    mimeType.SetComment("VTK Image");
    return mimeType;
  }</span>

  CustomMimeType IOMimeTypes::VTK_IMAGE_LEGACY_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(VTK_IMAGE_LEGACY_NAME());
    mimeType.AddExtension("vtk");
    mimeType.SetCategory(CATEGORY_IMAGES());
    mimeType.SetComment("VTK Legacy Image");
    return mimeType;
  }</span>

  CustomMimeType IOMimeTypes::VTK_PARALLEL_IMAGE_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(VTK_PARALLEL_IMAGE_NAME());
    mimeType.AddExtension("pvti");
    mimeType.SetCategory(CATEGORY_IMAGES());
    mimeType.SetComment("VTK Parallel Image");
    return mimeType;
  }</span>

  CustomMimeType IOMimeTypes::VTK_POLYDATA_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(VTK_POLYDATA_NAME());
    mimeType.AddExtension("vtp");
    mimeType.SetCategory(CATEGORY_SURFACES());
    mimeType.SetComment("VTK PolyData");
    return mimeType;
  }</span>

  CustomMimeType IOMimeTypes::VTK_POLYDATA_LEGACY_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(VTK_POLYDATA_LEGACY_NAME());
    mimeType.AddExtension("vtk");
    mimeType.SetCategory(CATEGORY_SURFACES());
    mimeType.SetComment("VTK Legacy PolyData");
    return mimeType;
  }</span>

  CustomMimeType IOMimeTypes::VTK_PARALLEL_POLYDATA_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(VTK_PARALLEL_POLYDATA_NAME());
    mimeType.AddExtension("pvtp");
    mimeType.SetCategory(CATEGORY_SURFACES());
    mimeType.SetComment("VTK Parallel PolyData");
    return mimeType;
  }</span>

  CustomMimeType IOMimeTypes::STEREOLITHOGRAPHY_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(STEREOLITHOGRAPHY_NAME());
    mimeType.AddExtension("stl");
    mimeType.SetCategory(CATEGORY_SURFACES());
    mimeType.SetComment("Stereolithography");
    return mimeType;
  }</span>

  CustomMimeType IOMimeTypes::WAVEFRONT_OBJ_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(WAVEFRONT_OBJ_NAME());
    mimeType.AddExtension("obj");
    mimeType.SetCategory(CATEGORY_SURFACES());
    mimeType.SetComment("Wavefront OBJ");
    return mimeType;
  }</span>

  CustomMimeType IOMimeTypes::STANFORD_PLY_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(STANFORD_PLY_NAME());
    mimeType.AddExtension("ply");
    mimeType.SetCategory(CATEGORY_SURFACES());
    mimeType.SetComment("Stanford PLY");
    return mimeType;
  }</span>

  std::string IOMimeTypes::STEREOLITHOGRAPHY_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".stl";
    return name;
  }</span>

  std::string IOMimeTypes::WAVEFRONT_OBJ_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".obj";
    return name;
  }</span>

  std::string IOMimeTypes::STANFORD_PLY_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".ply";
    return name;
  }</span>

  std::string IOMimeTypes::DEFAULT_BASE_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = "application/vnd.mitk";
    return name;
  }</span>

  std::string IOMimeTypes::CATEGORY_IMAGES()
<span style = "background-color:#dfd">  {
    static std::string cat = "Images";
    return cat;
  }</span>

  std::string IOMimeTypes::CATEGORY_SURFACES()
<span style = "background-color:#dfd">  {
    static std::string cat = "Surfaces";
    return cat;
  }</span>

  std::string IOMimeTypes::VTK_IMAGE_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".vtk.image";
    return name;
  }</span>

  std::string IOMimeTypes::VTK_IMAGE_LEGACY_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".vtk.image.legacy";
    return name;
  }</span>

  std::string IOMimeTypes::VTK_PARALLEL_IMAGE_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".vtk.parallel.image";
    return name;
  }</span>

  std::string IOMimeTypes::VTK_POLYDATA_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".vtk.polydata";
    return name;
  }</span>

  std::string IOMimeTypes::VTK_POLYDATA_LEGACY_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".vtk.polydata.legacy";
    return name;
  }</span>

  std::string IOMimeTypes::VTK_PARALLEL_POLYDATA_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".vtk.parallel.polydata";
    return name;
  }</span>

  CustomMimeType IOMimeTypes::NRRD_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(NRRD_MIMETYPE_NAME());
    mimeType.AddExtension("nrrd");
    mimeType.AddExtension("nhdr");
    mimeType.SetCategory("Images");
    mimeType.SetComment("NRRD");
    return mimeType;
  }</span>

  CustomMimeType IOMimeTypes::NIFTI_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(NIFTI_MIMETYPE_NAME());
    mimeType.AddExtension("nii");
    mimeType.AddExtension("nii.gz");
    mimeType.AddExtension("hdr");
    mimeType.AddExtension("hdr.gz");
    mimeType.AddExtension("img");
    mimeType.AddExtension("img.gz");
    mimeType.AddExtension("nia");
    mimeType.SetCategory("Images");
    mimeType.SetComment("Nifti");
    return mimeType;
  }</span>

  CustomMimeType IOMimeTypes::RAW_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(RAW_MIMETYPE_NAME());
    mimeType.AddExtension("raw");
    mimeType.SetCategory("Images");
    mimeType.SetComment("Raw data");
    return mimeType;
  }</span>

<span style = "background-color:#dfd">  IOMimeTypes::DicomMimeType IOMimeTypes::DICOM_MIMETYPE() { return DicomMimeType(); }</span>
  std::string IOMimeTypes::NRRD_MIMETYPE_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".image.nrrd";
    return name;
  }</span>

  std::string IOMimeTypes::NIFTI_MIMETYPE_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".image.nifti";
    return name;
  }</span>

  std::string IOMimeTypes::RAW_MIMETYPE_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".image.raw";
    return name;
  }</span>

  std::string IOMimeTypes::DICOM_MIMETYPE_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".image.dicom";
    return name;
  }</span>

  CustomMimeType IOMimeTypes::POINTSET_MIMETYPE()
<span style = "background-color:#dfd">  {
    CustomMimeType mimeType(POINTSET_MIMETYPE_NAME());
    mimeType.AddExtension("mps");
    mimeType.SetCategory("Point Sets");
    mimeType.SetComment("MITK Point Set");
    return mimeType;
  }</span>

  std::string IOMimeTypes::POINTSET_MIMETYPE_NAME()
<span style = "background-color:#dfd">  {
    static std::string name = DEFAULT_BASE_NAME() + ".pointset";
    return name;
  }</span>

  CustomMimeType IOMimeTypes::GEOMETRY_DATA_MIMETYPE()
<span style = "background-color:#dfd">  {
    mitk::CustomMimeType mimeType(DEFAULT_BASE_NAME() + ".geometrydata");
    mimeType.AddExtension("mitkgeometry");
    mimeType.SetCategory("Geometries");
    mimeType.SetComment("GeometryData object");
    return mimeType;
  }</span>
}</pre>
	</body>
</html>
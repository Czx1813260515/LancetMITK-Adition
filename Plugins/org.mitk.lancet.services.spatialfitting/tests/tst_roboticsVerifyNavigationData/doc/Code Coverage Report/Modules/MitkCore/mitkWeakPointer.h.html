<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkWeakPointer.h</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#ifndef mitkWeakPointer_h
#define mitkWeakPointer_h

#include &lt;itkCommand.h&gt;
#include &lt;functional&gt;

namespace mitk
{
  template &lt;class T&gt;
  class WeakPointer final
  {
  public:
    using DeleteEventCallbackType = std::function&lt;void ()&gt;;

    WeakPointer() noexcept
<span style = "background-color:#fdd">      : m_RawPointer(nullptr)
    {
    }</span>

    WeakPointer(T *rawPointer)
<span style = "background-color:#fdd">      : m_RawPointer(rawPointer)
    {
      this-&gt;AddDeleteEventObserver();
    }</span>

    WeakPointer(const WeakPointer &amp;other)
<span style = "background-color:#fdd">      : m_RawPointer(other.m_RawPointer)
    {
      this-&gt;AddDeleteEventObserver();
    }</span>

    WeakPointer(WeakPointer &amp;&amp;other)
<span style = "background-color:#fdd">      : m_RawPointer(other.m_RawPointer)
    {
      other.RemoveDeleteEventObserver();
      other.m_RawPointer = nullptr;
      this-&gt;AddDeleteEventObserver();
    }</span>

    ~WeakPointer() noexcept
<span style = "background-color:#fdd">    {</span>
      try
      {
<span style = "background-color:#fdd">        this-&gt;RemoveDeleteEventObserver();</span>
      }
      catch (...)
<span style = "background-color:#fdd">      {</span>
        // Swallow. Otherwise, the application would terminate if another
        // exception is already propagating.
<span style = "background-color:#fdd">      }
    }</span>

    // Prefer classic implementation to copy-and-swap idiom. Swapping is
    // non-trivial for this class as the observed object is keeping references
    // to its observers.
    WeakPointer &amp; operator =(const WeakPointer &amp;other)
<span style = "background-color:#fdd">    {
      if (this != &amp;other)</span>
      {
<span style = "background-color:#fdd">        this-&gt;RemoveDeleteEventObserver();
        m_RawPointer = other.m_RawPointer;
        this-&gt;AddDeleteEventObserver();</span>
      }

<span style = "background-color:#fdd">      return *this;
    }</span>

    WeakPointer &amp; operator =(WeakPointer &amp;&amp;other)
    {
      // No check for self-assignment as it is allowed to assume that the
      // parameter is a unique reference to this argument.

      this-&gt;RemoveDeleteEventObserver();
      m_RawPointer = other.m_RawPointer;
      other.m_RawPointer = nullptr;
      this-&gt;AddDeleteEventObserver();

      return *this;
    }

    WeakPointer &amp; operator =(std::nullptr_t)
<span style = "background-color:#fdd">    {
      this-&gt;RemoveDeleteEventObserver();
      m_RawPointer = nullptr;</span>

<span style = "background-color:#fdd">      return *this;
    }</span>

    WeakPointer &amp; operator =(T *other)
<span style = "background-color:#fdd">    {
      if (m_RawPointer != other)</span>
      {
<span style = "background-color:#fdd">        this-&gt;RemoveDeleteEventObserver();
        m_RawPointer = other;
        this-&gt;AddDeleteEventObserver();</span>
      }

<span style = "background-color:#fdd">      return *this;
    }</span>

    explicit operator bool() const noexcept
<span style = "background-color:#fdd">    {
      return nullptr != m_RawPointer;
    }</span>

    bool IsExpired() const noexcept
<span style = "background-color:#fdd">    {
      return !*this;
    }</span>

    itk::SmartPointer&lt;T&gt; Lock() const
<span style = "background-color:#fdd">    {
      return m_RawPointer;
    }</span>

    void SetDeleteEventCallback(const DeleteEventCallbackType &amp;callback)
    {
      m_DeleteEventCallback = callback;
    }

  private:
    void AddDeleteEventObserver()
<span style = "background-color:#fdd">    {
      if (nullptr != m_RawPointer)</span>
      {
<span style = "background-color:#fdd">        auto command = itk::SimpleMemberCommand&lt;WeakPointer&gt;::New();
        command-&gt;SetCallbackFunction(this, &amp;WeakPointer::OnDeleteEvent);
        m_ObserverTag = m_RawPointer-&gt;AddObserver(itk::DeleteEvent(), command);
      }
    }</span>

    void RemoveDeleteEventObserver()
<span style = "background-color:#fdd">    {
      if (nullptr != m_RawPointer)
        m_RawPointer-&gt;RemoveObserver(m_ObserverTag);
    }</span>

    void OnDeleteEvent() noexcept
<span style = "background-color:#fdd">    {</span>
      // Don't remove any observers from the observed object as it is about to
      // die and can't handle this operation anymore.

<span style = "background-color:#fdd">      m_RawPointer = nullptr;</span>

<span style = "background-color:#fdd">      if (m_DeleteEventCallback)
        m_DeleteEventCallback();
    }</span>

    // The following comparison operators need access to class internals.
    // All remaining comparison operators are implemented as non-member
    // non-friend functions that use logical combinations of these non-member
    // friend functions.

    friend bool operator ==(const WeakPointer &amp;left, const WeakPointer &amp;right) noexcept
<span style = "background-color:#fdd">    {
      return left.m_RawPointer == right.m_RawPointer;
    }</span>

    // Also covers comparisons to T::Pointer and T::ConstPointer as
    // itk::SmartPointer can be implicitly converted to a raw pointer.
    friend bool operator ==(const WeakPointer &amp;left, const T *right) noexcept
<span style = "background-color:#fdd">    {
      return left.m_RawPointer == right;
    }</span>

    friend bool operator &lt;(const WeakPointer &amp;left, const WeakPointer &amp;right) noexcept
    {
      // The specialization of std::less for any pointer type yields a total
      // order, even if the built-in operator &lt; doesn't.
      return std::less&lt;T*&gt;()(left.m_RawPointer, right.m_RawPointer);
    }

    friend bool operator &lt;(const WeakPointer &amp;left, std::nullptr_t right) noexcept
    {
      return std::less&lt;T*&gt;()(left.m_RawPointer, right);
    }

    friend bool operator &lt;(std::nullptr_t left, const WeakPointer &amp;right) noexcept
    {
      return std::less&lt;T*&gt;()(left, right.m_RawPointer);
    }

    friend bool operator &lt;(const WeakPointer &amp;left, const T *right) noexcept
    {
      return std::less&lt;T*&gt;()(left.m_RawPointer, right);
    }

    friend bool operator &lt;(const T *left, const WeakPointer &amp;right) noexcept
    {
      return std::less&lt;T*&gt;()(left, right.m_RawPointer);
    }

    T *m_RawPointer;

    // m_ObserverTag is completely managed by the two methods
    // AddDeleteEventObserver() and RemoveDeleteEventObserver(). There
    // isn't any need to initialize or use it at all outside of these methods.
    unsigned long m_ObserverTag;

    DeleteEventCallbackType m_DeleteEventCallback;
  };
}

template &lt;class T&gt;
bool operator !=(const mitk::WeakPointer&lt;T&gt; &amp;left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(left == right);
}

template &lt;class T&gt;
bool operator &lt;=(const mitk::WeakPointer&lt;T&gt; &amp;left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(right &lt; left);
}

template &lt;class T&gt;
bool operator &gt;(const mitk::WeakPointer&lt;T&gt; &amp;left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return right &lt; left;
}

template &lt;class T&gt;
bool operator &gt;=(const mitk::WeakPointer&lt;T&gt; &amp;left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(left &lt; right);
}

template &lt;class T&gt;
bool operator ==(const mitk::WeakPointer&lt;T&gt; &amp;left, std::nullptr_t) noexcept
{
  return !left;
}

template &lt;class T&gt;
bool operator !=(const mitk::WeakPointer&lt;T&gt; &amp;left, std::nullptr_t right) noexcept
{
  return !(left == right);
}

template &lt;class T&gt;
bool operator ==(std::nullptr_t, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !right;
}

template &lt;class T&gt;
bool operator !=(std::nullptr_t left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(left == right);
}

template &lt;class T&gt;
bool operator &lt;=(const mitk::WeakPointer&lt;T&gt; &amp;left, std::nullptr_t right) noexcept
{
  return !(right &lt; left);
}

template &lt;class T&gt;
bool operator &gt;(const mitk::WeakPointer&lt;T&gt; &amp;left, std::nullptr_t right) noexcept
{
  return right &lt; left;
}

template &lt;class T&gt;
bool operator &gt;=(const mitk::WeakPointer&lt;T&gt; &amp;left, std::nullptr_t right) noexcept
{
  return !(left &lt; right);
}

template &lt;class T&gt;
bool operator &lt;=(std::nullptr_t left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(right &lt; left);
}

template &lt;class T&gt;
bool operator &gt;(std::nullptr_t left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return right &lt; left;
}

template &lt;class T&gt;
bool operator &gt;=(std::nullptr_t left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(left &lt; right);
}

template &lt;class T&gt;
bool operator !=(const mitk::WeakPointer&lt;T&gt; &amp;left, const T *right) noexcept
<span style = "background-color:#fdd">{
  return !(left == right);
}</span>

template &lt;class T&gt;
bool operator &lt;=(const mitk::WeakPointer&lt;T&gt; &amp;left, const T *right) noexcept
{
  return !(right &lt; left);
}

template &lt;class T&gt;
bool operator &gt;(const mitk::WeakPointer&lt;T&gt; &amp;left, const T *right) noexcept
{
  return right &lt; left;
}

template &lt;class T&gt;
bool operator &gt;=(const mitk::WeakPointer&lt;T&gt; &amp;left, const T *right) noexcept
{
  return !(left &lt; right);
}

template &lt;class T&gt;
bool operator ==(const T *left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return right == left;
}

template &lt;class T&gt;
bool operator !=(const T *left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(right == left);
}

template &lt;class T&gt;
bool operator &lt;=(const T *left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(right &lt; left);
}

template &lt;class T&gt;
bool operator &gt;(const T *left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return right &lt; left;
}

template &lt;class T&gt;
bool operator &gt;=(const T *left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(left &lt; right);
}

template &lt;class T&gt;
bool operator !=(const mitk::WeakPointer&lt;T&gt; &amp;left, itk::SmartPointer&lt;T&gt; right) noexcept
{
  return !(left == right);
}

template &lt;class T&gt;
bool operator &lt;=(const mitk::WeakPointer&lt;T&gt; &amp;left, itk::SmartPointer&lt;T&gt; right) noexcept
{
  return !(right &lt; left);
}

template &lt;class T&gt;
bool operator &gt;(const mitk::WeakPointer&lt;T&gt; &amp;left, itk::SmartPointer&lt;T&gt; right) noexcept
{
  return right &lt; left;
}

template &lt;class T&gt;
bool operator &gt;=(const mitk::WeakPointer&lt;T&gt; &amp;left, itk::SmartPointer&lt;T&gt; right) noexcept
{
  return !(left &lt; right);
}

template &lt;class T&gt;
bool operator ==(itk::SmartPointer&lt;T&gt; left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return right == left;
}

template &lt;class T&gt;
bool operator !=(itk::SmartPointer&lt;T&gt; left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(right == left);
}

template &lt;class T&gt;
bool operator &lt;=(itk::SmartPointer&lt;T&gt; left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(right &lt; left);
}

template &lt;class T&gt;
bool operator &gt;(itk::SmartPointer&lt;T&gt; left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return right &lt; left;
}

template &lt;class T&gt;
bool operator &gt;=(itk::SmartPointer&lt;T&gt; left, const mitk::WeakPointer&lt;T&gt; &amp;right) noexcept
{
  return !(left &lt; right);
}

#endif</pre>
	</body>
</html>
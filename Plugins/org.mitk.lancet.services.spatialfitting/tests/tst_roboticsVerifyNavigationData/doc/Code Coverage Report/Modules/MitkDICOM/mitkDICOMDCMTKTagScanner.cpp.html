<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkDICOMDCMTKTagScanner.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

#include "mitkDICOMDCMTKTagScanner.h"
#include "mitkDICOMGenericImageFrameInfo.h"

#include &lt;dcmtk/dcmdata/dcfilefo.h&gt;
#include &lt;dcmtk/dcmdata/dcpath.h&gt;

mitk::DICOMDCMTKTagScanner::DICOMDCMTKTagScanner()
<span style = "background-color:#fdd">{
}</span>

mitk::DICOMDCMTKTagScanner::~DICOMDCMTKTagScanner()
<span style = "background-color:#fdd">{
}</span>

void mitk::DICOMDCMTKTagScanner::AddTag( const DICOMTag&amp; tag )
<span style = "background-color:#fdd">{
  m_ScannedTags.insert( DICOMTagPath(tag) );
}</span>

void mitk::DICOMDCMTKTagScanner::AddTags( const DICOMTagList&amp; tags )
<span style = "background-color:#fdd">{
  for ( auto tagIter = tags.cbegin(); tagIter != tags.cend(); ++tagIter )</span>
  {
<span style = "background-color:#fdd">    this-&gt;AddTag( *tagIter );
  }
}</span>

void mitk::DICOMDCMTKTagScanner::AddTagPath(const DICOMTagPath&amp; path)
<span style = "background-color:#fdd">{
  m_ScannedTags.insert(path);
}</span>

void mitk::DICOMDCMTKTagScanner::AddTagPaths(const DICOMTagPathList&amp; paths)
<span style = "background-color:#fdd">{
  for (const auto&amp; path : paths)</span>
  {
<span style = "background-color:#fdd">    this-&gt;AddTagPath(path);
  }
}</span>

void mitk::DICOMDCMTKTagScanner::SetInputFiles( const StringList&amp; filenames )
<span style = "background-color:#fdd">{
  m_InputFilenames = filenames;
}</span>

mitk::DICOMTagPath DcmPathToTagPath(DcmPath * dcmpath)
<span style = "background-color:#fdd">{
  mitk::DICOMTagPath result;</span>

<span style = "background-color:#fdd">  OFListConstIterator(DcmPathNode*) it = dcmpath-&gt;begin();
  OFListConstIterator(DcmPathNode*) endOfList = dcmpath-&gt;end();
  OFString pathStr; DcmEVR vr; DcmObject* obj;</span>

<span style = "background-color:#fdd">  while (it != endOfList)</span>
  {
<span style = "background-color:#fdd">    if (((*it) == nullptr) || ((*it)-&gt;m_obj == nullptr))</span>
    {
<span style = "background-color:#fdd">      mitkThrow() &lt;&lt; "Error in DcmPathToTagPath(). Invalid search result";</span>
    }
<span style = "background-color:#fdd">    obj = (*it)-&gt;m_obj;
    vr = obj-&gt;ident();</span>

<span style = "background-color:#fdd">    if ((vr == EVR_SQ) || (obj-&gt;isLeaf()))</span>
    {
<span style = "background-color:#fdd">      result.AddElement(obj-&gt;getTag().getGroup(), obj-&gt;getTag().getElement());
    }
    else if ((vr == EVR_item) || (vr == EVR_dataset))</span>
    {
<span style = "background-color:#fdd">      if (result.Size() &gt; 0)</span>
      {
<span style = "background-color:#fdd">        result.GetLastNode().type = mitk::DICOMTagPath::NodeInfo::NodeType::SequenceSelection;
        result.GetLastNode().selection = (*it)-&gt;m_itemNo;
      }</span>
      else
      {
<span style = "background-color:#fdd">        mitkThrow() &lt;&lt; "Error in DcmPathToTagPath(). DCMTK path is illegal due to toplevel sequence item.";</span>
      }
<span style = "background-color:#fdd">    }</span>
    else
    {
<span style = "background-color:#fdd">      result.AddNode(mitk::DICOMTagPath::NodeInfo());</span>
    }
<span style = "background-color:#fdd">    ++it;
  }</span>

<span style = "background-color:#fdd">  return result;
}</span>

void mitk::DICOMDCMTKTagScanner::Scan()
<span style = "background-color:#fdd">{
  this-&gt;PushLocale();</span>

  try
  {
<span style = "background-color:#fdd">    DcmPathProcessor processor;
    processor.setItemWildcardSupport(true);</span>

<span style = "background-color:#fdd">    DICOMGenericTagCache::Pointer newCache = DICOMGenericTagCache::New();</span>

<span style = "background-color:#fdd">    for (const auto&amp; fileName : this-&gt;m_InputFilenames)</span>
    {
<span style = "background-color:#fdd">      DcmFileFormat dfile;
      OFCondition cond = dfile.loadFile(fileName.c_str());
      if (cond.bad())</span>
      {
<span style = "background-color:#fdd">        MITK_ERROR &lt;&lt; "Error when scanning for tags. Cannot open given file. File: " &lt;&lt; fileName;
      }</span>
      else
      {
<span style = "background-color:#fdd">        DICOMGenericImageFrameInfo::Pointer info = DICOMGenericImageFrameInfo::New(fileName);</span>

<span style = "background-color:#fdd">        for (const auto&amp; path : this-&gt;m_ScannedTags)</span>
        {
<span style = "background-color:#fdd">          std::string tagPath = DICOMTagPathToDCMTKSearchPath(path);
          cond = processor.findOrCreatePath(dfile.getDataset(), tagPath.c_str());
          if (cond.good())</span>
          {
<span style = "background-color:#fdd">            OFList&lt; DcmPath * &gt; findings;
            processor.getResults(findings);
            for (const auto&amp; finding : findings)</span>
            {
<span style = "background-color:#fdd">              auto element = dynamic_cast&lt;DcmElement*&gt;(finding-&gt;back()-&gt;m_obj);
              if (!element)</span>
              {
<span style = "background-color:#fdd">                auto item = dynamic_cast&lt;DcmItem*&gt;(finding-&gt;back()-&gt;m_obj);
                if (item)</span>
                {
<span style = "background-color:#fdd">                  element = item-&gt;getElement(finding-&gt;back()-&gt;m_itemNo);</span>
                }
              }

<span style = "background-color:#fdd">              if (element)</span>
              {
<span style = "background-color:#fdd">                OFString value;
                cond = element-&gt;getOFStringArray(value);
                if (cond.good())</span>
                {
<span style = "background-color:#fdd">                  info-&gt;SetTagValue(DcmPathToTagPath(finding), std::string(value.c_str()));</span>
                }
<span style = "background-color:#fdd">              }
            }
          }
        }
        newCache-&gt;AddFrameInfo(info);
      }
    }</span>

<span style = "background-color:#fdd">    m_Cache = newCache;</span>

<span style = "background-color:#fdd">    this-&gt;PopLocale();
  }</span>
  catch (...)
<span style = "background-color:#fdd">  {
    this-&gt;PopLocale();
    throw;
  }
}</span>

mitk::DICOMTagCache::Pointer
mitk::DICOMDCMTKTagScanner::GetScanCache() const
<span style = "background-color:#fdd">{
  return m_Cache.GetPointer();
}</span>

mitk::DICOMDatasetAccessingImageFrameList mitk::DICOMDCMTKTagScanner::GetFrameInfoList() const
<span style = "background-color:#fdd">{
  if (m_Cache.IsNotNull())</span>
  {
<span style = "background-color:#fdd">    return m_Cache-&gt;GetFrameInfoList();</span>
  }
<span style = "background-color:#fdd">  return mitk::DICOMDatasetAccessingImageFrameList();
}</span></pre>
	</body>
</html>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
        <meta charset="utf-8"/>
	    <title>mitkNavigationDataReaderCSV.cpp</title>
	    <link href="../../third-party/google-code-prettify/prettify-CppCoverage.css" type="text/css" rel="stylesheet" />
	    <script type="text/javascript" src="../../third-party/google-code-prettify/prettify.js"></script>
	</head>
	<body onload="prettyPrint()">
        <h4></h4>
		<pre class="prettyprint lang-cpp linenums">
/*============================================================================

The Medical Imaging Interaction Toolkit (MITK)

Copyright (c) German Cancer Research Center (DKFZ)
All rights reserved.

Use of this source code is governed by a 3-clause BSD license that can be
found in the LICENSE file.

============================================================================*/

// MITK
#include "mitkNavigationDataReaderCSV.h"
#include &lt;mitkIGTMimeTypes.h&gt;
#include &lt;mitkLocaleSwitch.h&gt;

// STL
#include &lt;fstream&gt;


<span style = "background-color:#dfd">mitk::NavigationDataReaderCSV::NavigationDataReaderCSV() : AbstractFileReader(</span>
  mitk::IGTMimeTypes::NAVIGATIONDATASETCSV_MIMETYPE(),
  "MITK NavigationData Reader (CSV)")
<span style = "background-color:#dfd">{
  RegisterService();
}</span>

<span style = "background-color:#fdd">mitk::NavigationDataReaderCSV::NavigationDataReaderCSV(const mitk::NavigationDataReaderCSV&amp; other) : AbstractFileReader(other)
{
}</span>

mitk::NavigationDataReaderCSV::~NavigationDataReaderCSV()
<span style = "background-color:#dfd">{
}</span>

mitk::NavigationDataReaderCSV* mitk::NavigationDataReaderCSV::Clone() const
<span style = "background-color:#fdd">{
  return new NavigationDataReaderCSV(*this);
}</span>

std::vector&lt;itk::SmartPointer&lt;mitk::BaseData&gt;&gt; mitk::NavigationDataReaderCSV::DoRead()
<span style = "background-color:#fdd">{
  std::vector&lt;std::string&gt; fileContent = GetFileContentLineByLine(GetInputLocation());
  int NumOfTools = getNumberOfToolsInLine(fileContent[0]);</span>

<span style = "background-color:#fdd">  mitk::NavigationDataSet::Pointer returnValue = mitk::NavigationDataSet::New(NumOfTools);
  std::vector&lt;mitk::BaseData::Pointer&gt; result;
  result.push_back(returnValue.GetPointer());</span>

  // start from line 1 to leave out header
<span style = "background-color:#fdd">  for (unsigned int i = 1; i&lt;fileContent.size(); i++)</span>
  {
<span style = "background-color:#fdd">    returnValue-&gt;AddNavigationDatas(parseLine(fileContent[i], NumOfTools));
  }</span>

<span style = "background-color:#fdd">  return result;
}</span>


int mitk::NavigationDataReaderCSV::getNumberOfToolsInLine(std::string line)
<span style = "background-color:#fdd">{
  std::vector&lt;std::string&gt; tokens=splitLine(line);
 int size = tokens.size();
 int NumOfTools = (size)/9;</span>

<span style = "background-color:#fdd"> if ( (size)%9 != 0 )</span>
 {
<span style = "background-color:#fdd">   MITK_ERROR("mitkNavigationDataReader") &lt;&lt; "Illegal csv-file! Unexpected number of columns found! Assuming " &lt;&lt; NumOfTools &lt;&lt; " tools!";</span>
 }

<span style = "background-color:#fdd"> return NumOfTools ;
}</span>

std::vector&lt;std::string&gt; mitk::NavigationDataReaderCSV::splitLine(std::string line)
<span style = "background-color:#fdd">{
   std::vector&lt;std::string&gt; elems;
   std::stringstream ss(line);
   std::string item;
   while (std::getline(ss, item, ';')) {
     elems.push_back(item);
   }
   return elems;
}</span>

mitk::NavigationData::Pointer mitk::NavigationDataReaderCSV::CreateNd(std::string timestamp, std::string valid, std::string X, std::string Y, std::string Z, std::string QX, std::string QY, std::string QZ, std::string QR)
<span style = "background-color:#fdd">{
  mitk::NavigationData::Pointer result= mitk::NavigationData::New();</span>

<span style = "background-color:#fdd">  mitk::Point3D position;</span>
  mitk::Quaternion orientation;
<span style = "background-color:#fdd">  bool isValid = false;</span>
  double time;

<span style = "background-color:#fdd">  time = StringToDouble(timestamp);</span>

<span style = "background-color:#fdd">  if (valid == "1") isValid = true;
  else isValid = false;</span>

<span style = "background-color:#fdd">  position[0] = StringToDouble(X);
  position[1] = StringToDouble(Y);
  position[2] = StringToDouble(Z);</span>

<span style = "background-color:#fdd">  orientation[0] = StringToDouble(QX);
  orientation[1] = StringToDouble(QY);
  orientation[2] = StringToDouble(QZ);
  orientation[3] = StringToDouble(QR);</span>

<span style = "background-color:#fdd">  result-&gt;SetIGTTimeStamp(time);
  result-&gt;SetDataValid(isValid);
  result-&gt;SetPosition(position);
  result-&gt;SetOrientation(orientation);
  return result;
}</span>

double mitk::NavigationDataReaderCSV::StringToDouble( const std::string&amp; s )
<span style = "background-color:#fdd">{
  std::istringstream i(s);</span>
  double x;
<span style = "background-color:#fdd">    if (!(i &gt;&gt; x))
      return 0;
    return x;
}</span>

std::vector&lt;mitk::NavigationData::Pointer&gt; mitk::NavigationDataReaderCSV::parseLine(std::string line, int NumOfTools)
<span style = "background-color:#fdd">{
  std::vector&lt;std::string&gt; parts = splitLine(line);
  std::vector&lt;mitk::NavigationData::Pointer&gt; result;</span>



<span style = "background-color:#fdd">  for (int n = 0; n &lt; NumOfTools; n++)</span>
  {
<span style = "background-color:#fdd">    mitk::NavigationData::Pointer nd;
    int offset = n * 9;
    nd = CreateNd(parts[offset], parts[offset + 1], parts[offset + 2], parts[offset + 3], parts[offset + 4], parts[offset + 5], parts[offset + 6], parts[offset + 7], parts[offset + 8]);
    result.push_back(nd);
  }
  return result;
}</span>


std::vector&lt;std::string&gt; mitk::NavigationDataReaderCSV::GetFileContentLineByLine(std::string filename)
<span style = "background-color:#fdd">{
std::vector&lt;std::string&gt; readData = std::vector&lt;std::string&gt;();</span>

//define own locale
<span style = "background-color:#fdd">mitk::LocaleSwitch localeSwitch("C");</span>

//read file
<span style = "background-color:#fdd">std::ifstream file;
file.open(filename.c_str(), std::ios::in);
if (file.good())</span>
    {
    //read out file
<span style = "background-color:#fdd">    file.seekg(0L, std::ios::beg);  // move to begin of file
    while (! file.eof())</span>
      {
<span style = "background-color:#fdd">      std::string buffer;
      std::getline(file,buffer);    // read out file line by line
      if (buffer.size() &gt; 0) readData.push_back(buffer);</span>

<span style = "background-color:#fdd">      }</span>
    }

<span style = "background-color:#fdd">file.close();</span>

<span style = "background-color:#fdd">return readData;
}</span></pre>
	</body>
</html>